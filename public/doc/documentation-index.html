<!DOCTYPE html>
<html lang="es" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentación StripeLabApp</title>
    <link rel="icon" type="image/svg+xml" href="../image/favicon.svg">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/documentation_styles.css">

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Highlight.js CSS para resaltado de código -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/img/favicon.png">
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Barra de navegación lateral -->
        <div class="col-md-3 col-lg-2 d-md-block sidebar">
            <div class="position-sticky pt-3">
                <div class="sidebar-header">
                    <a href="http://localhost:8000/"><h5>StripeLabApp</h5></a>
                    <p>Documentación</p>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#parte1">
                            <i class="fas fa-book me-2"></i>
                            Parte I: Entendiendo la Integración con Stripe API
                        </a>
                        <ul class="sub-nav">
                            <li><a href="#introduccion">1. Introducción a Stripe</a></li>
                            <li><a href="#webhooks">2. Webhooks de Stripe</a></li>
                            <li><a href="#eventos">3. Eventos de Stripe</a></li>
                            <li><a href="#stripecli">4. Stripe CLI</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#parte2">
                            <i class="fas fa-code me-2"></i>
                            Parte II: Arquitectura de StripeLabApp
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Contenido principal -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1>Documentación de StripeLabApp</h1>
            </div>

            <!-- Parte I -->
            <section id="parte1" class="mb-5">
                <h2>PARTE I: Entendiendo la Integración con Stripe API</h2>
                <p class="lead">
                    Esta sección cubre los conceptos fundamentales de Stripe y cómo se integran en StripeLabApp.
                </p>

                <!-- Sección 1 -->
                <section id="introduccion" class="mb-4">
                    <h3>1. Introducción a Stripe para Desarrolladores</h3>

                    <div id="que-es-stripe" class="subsection">

                        <p>
                            Stripe es una plataforma tecnológica de pagos que permite a empresas de todos los tamaños aceptar pagos y gestionar sus negocios en línea. A diferencia de otras soluciones de pago, Stripe está diseñado específicamente para desarrolladores, ofreciendo:
                        </p>
                        <ul>
                            <li><strong>APIs robustas y bien documentadas</strong> que facilitan la integración.</li>
                            <li><strong>Soporte para múltiples métodos de pago</strong> </li>
                            <li><strong>Herramientas de seguridad avanzadas</strong> con cumplimiento PCI DSS nivel 1.</li>
                            <li><strong>Gestión completa de suscripciones</strong> y modelos de negocio recurrentes.</li>
                            <li><strong>Detección de fraudes</strong> mediante Stripe Radar.</li>
                            <li><strong>Panel de control intuitivo</strong> para monitoreo y gestión de transacciones.</li>
                        </ul>
                        <p>
                            Para desarrolladores, Stripe proporciona bibliotecas cliente en los principales lenguajes de programación, webhooks para integraciones en tiempo real, y entornos de prueba completos que facilitan el desarrollo sin riesgos.
                        </p>
                    </div>

                    <div id="conceptos-clave" class="subsection">
                        <h4>1.2. Conceptos Clave de Stripe </h4>
                        <p>
                            Stripe está estructurado en torno a <strong>objetos</strong> que representan diferentes aspectos del proceso de pago. Entender estos objetos es crucial para trabajar eficientemente con la API:
                        </p>

                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>Customers (<code>cus_...</code>)</strong>
                            </div>
                            <div class="card-body">
                                <p>
                                    Representan a los clientes de tu negocio. Los objetos Customer almacenan información de contacto, métodos de pago y metadatos personalizados. Son especialmente útiles para transacciones recurrentes y análisis de clientes.
                                </p>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>PaymentIntents (<code>pi_...</code>)</strong>
                            </div>
                            <div class="card-body">
                                <p>
                                    Representan el intento de cobrar a un cliente. Gestionan todo el flujo de pago, incluyendo la autenticación 3D Secure y los reintentos automatizados. Es el objeto central para procesar pagos únicos de forma segura y cumpliendo con SCA (Strong Customer Authentication).
                                </p>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>SetupIntents (<code>seti_...</code>)</strong>
                            </div>
                            <div class="card-body">
                                <p>
                                    Similar a PaymentIntents, pero diseñado para configurar métodos de pago para su uso futuro sin realizar un cargo inmediato. Ideal para suscripciones o cuando necesitas autorizar una tarjeta antes de cobrar.
                                </p>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>Charges (<code>ch_...</code>)</strong>
                            </div>

                            <div class="card-body">
                                <p>
                                    Representan un cargo a una tarjeta u otra fuente de pago. Generalmente, es mejor usar PaymentIntents que interactuar directamente con Charges. En la API moderna de Stripe, los Charges se crean automáticamente a través de PaymentIntents.
                                </p>
                            </div>

                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>Invoices (<code>in_...</code>)</strong>
                            </div>
                            <div class="card-body">
                                <p>
                                    Documentos que detallan los importes adeudados por un cliente. Las facturas pueden generarse manual o automáticamente (para suscripciones). Stripe puede enviar facturas por correo electrónico, intentar cobrarlas automáticamente, y seguimiento de pagos.
                                </p>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>Subscriptions (<code>sub_...</code>)</strong>
                            </div>
                            <div class="card-body">
                                <p>
                                    Representan pagos recurrentes a intervalos regulares. Las suscripciones están vinculadas a un Customer y a un Price, y gestionan automáticamente la facturación recurrente, los ciclos de facturación, las actualizaciones/degradaciones, y los períodos de prueba.
                                </p>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>Products y Prices (<code>prod_...</code>, <code>price_...</code>, <code>lookup_key</code>)</strong>
                            </div>
                            <div class="card-body">
                                <p>
                                    Los Products representan los bienes o servicios que ofreces. Los Prices definen cuánto y con qué frecuencia se cobra por un Product específico. Un producto puede tener múltiples precios (por ejemplo, mensual vs. anual). El <code>lookup_key</code> permite identificar fácilmente un Price específico en tu código.
                                </p>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>Checkout Sessions (<code>cs_...</code>)</strong>
                            </div>
                            <div class="card-body">
                                <p>
                                    Representan una instancia de la página de pago alojada por Stripe (Stripe Checkout). Proporcionan una experiencia de pago optimizada sin necesidad de crear formularios personalizados. Las Checkout Sessions pueden configurarse para pagos únicos o suscripciones.
                                </p>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>Events (<code>evt_...</code>)</strong>
                            </div>
                            <div class="card-body">
                                <p>
                                    Notificaciones que Stripe envía cuando ocurre algo en tu cuenta. Los eventos son fundamentales para crear integraciones asíncronas mediante webhooks. Cada tipo de evento tiene un formato específico y contiene datos sobre el objeto afectado.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div id="claves-api" class="subsection">
                        <h4>1.3. Claves API (Publicable y Secreta)</h4>
                        <p>
                            Stripe utiliza un sistema de autenticación basado en claves API para identificar quién está realizando solicitudes. Existen dos tipos principales de claves:
                        </p>

                        <div class="row g-4 mb-3">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-success text-white">
                                        <strong>Clave Publicable (pk_...)</strong>
                                    </div>
                                    <div class="card-body">
                                        <p>
                                            <strong>Uso:</strong> En el Fronted.
                                        </p>
                                        <p>
                                            <strong>Propósito:</strong> Identifica tu cuenta Stripe pero no permite acciones sensibles. Se utiliza principalmente con Stripe.js para recopilar información de pago de forma segura.
                                        </p>
                                        <div class="alert alert-success">
                                            <i class="fas fa-info-circle"></i> Segura para exponer en el código del navegador.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-danger text-white">
                                        <strong>Clave Secreta (sk_...)</strong>
                                    </div>
                                    <div class="card-body">
                                        <p>
                                            <strong>Uso:</strong> Exclusivamente en el servidor.
                                        </p>
                                        <p>
                                            <strong>Propósito:</strong> Otorga acceso completo a tu cuenta de Stripe. Permite crear cargos, gestionar clientes, acceder a datos sensibles, y realizar cualquier operación con la API.
                                        </p>
                                        <div class="alert alert-danger">
                                            <i class="fas fa-exclamation-triangle"></i> Nunca debe ser expuesta al frontend o en repositorios públicos.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <p>
                            Ambos tipos de claves tienen versiones para entorno de prueba (prefijo <code>pk_test_</code> y <code>sk_test_</code>) y producción (prefijo <code>pk_live_</code> y <code>sk_live_</code>). Las claves de prueba permiten simular todas las funcionalidades sin procesar pagos reales.
                        </p>

                        <div class="alert alert-info">
                            <i class="fas fa-lightbulb"></i> <strong>Buena práctica:</strong> Almacena las claves secretas en variables de entorno o en un sistema seguro de gestión de secretos, nunca en archivos de configuración que puedan ser comprometidos.
                        </div>
                    </div>
                </section>

                <!-- Sección 2 -->
                <section id="webhooks" class="mb-4">
                    <h3>2. Webhooks de Stripe</h3>

                    <div id="que-son-webhooks" class="subsection">
                        <h4>2.1. ¿Qué son los Webhooks y por qué son cruciales?</h4>
                        <p>
                            Los webhooks son notificaciones <strong>HTTP POST que Stripe envía a tu servidor cuando ocurren eventos</strong> en tu cuenta. Funcionan como un sistema de "notificaciones push" para la aplicación, permitiendo la comunicación asíncrona entre Stripe y el backend.
                        </p>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <strong>¿Por qué son cruciales los webhooks?</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            <li><strong>Procesamiento asíncrono:</strong> Muchas operaciones de pago no son instantáneas (como pagos con confirmación diferida, disputas o reembolsos).</li>
                                            <li><strong>Fiabilidad:</strong> Garantizan que tu aplicación reciba actualizaciones incluso si el usuario cierra el navegador o pierde conexión.</li>
                                            <li><strong>Actualizaciones en tiempo real:</strong> Permiten que tu aplicación reaccione inmediatamente a cambios en el estado de pagos o suscripciones.</li>
                                            <li><strong>Gestión de errores:</strong> Notifican sobre fallos en los pagos, permitiendo acciones correctivas.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <strong>Casos de uso esenciales</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            <li>Actualizar el estado de la suscripción de un cliente cuando se procesa un pago recurrente.</li>
                                            <li>Enviar un correo electrónico de confirmación cuando un pago se completa correctamente.</li>
                                            <li>Activar acceso a un servicio cuando se confirma un pago.</li>
                                            <li>Detectar y gestionar pagos fallidos o tarjetas caducadas.</li>
                                            <li>Registrar eventos financieros en tu base de datos para conciliación.</li>
                                            <li>Reaccionar ante disputas o reembolsos.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <p>
                            En StripeLabApp, los webhooks son el mecanismo principal para mantener sincronizados nuestros registros con los eventos de pago, haciendo posible una arquitectura orientada a eventos donde cada cambio en Stripe desencadena las actualizaciones correspondientes en nuestra aplicación.
                        </p>
                    </div>

                    <div id="seguridad-webhooks" class="subsection">
                        <h4>2.2. Seguridad de los Webhooks</h4>
                        <p>
                            Los webhooks son endpoints públicos que reciben información potencialmente sensible, por lo que su seguridad es crítica. Stripe proporciona dos mecanismos principales de seguridad:
                        </p>

                        <div class="card mb-4">
                            <div class="card-header">
                                <strong>Verificación de Firmas (Webhook Secret)</strong>
                            </div>
                            <div class="card-body">
                                <p>
                                    Cada webhook incluye una firma criptográfica que permite verificar que la solicitud realmente proviene de Stripe y no ha sido alterada.
                                </p>

                                <div class="alert alert-warning">
                                    <i class="fas fa-shield-alt"></i> <strong>Importante:</strong> La verificación de firma es esencial para prevenir ataques de suplantación donde un atacante podría enviar eventos falsos a tu endpoint.
                                </div>

                                <h5>Proceso de verificación:</h5>
                                <ol>
                                    <li>Stripe proporciona un "Webhook Secret" único para cada endpoint configurado.</li>
                                    <li>Cada evento enviado incluye un encabezado <code>Stripe-Signature</code> con una firma generada usando ese secreto.</li>
                                    <li>Tu servidor debe utilizar la biblioteca de Stripe para verificar esta firma antes de procesar el evento.</li>
                                </ol>

                                <div class="code-snippet">
                                        <pre><code class="language-php">
                                        // Ejemplo de verificación en PHP
                                        $endpoint_secret = 'whsec_...';
                                        $payload = @file_get_contents('php://input');
                                        $sig_header = $_SERVER['HTTP_STRIPE_SIGNATURE'];

                                        try {
                                            $event = \Stripe\Webhook::constructEvent(
                                                $payload, $sig_header, $endpoint_secret
                                            );
                                            // El evento es verificado, procésalo con seguridad
                                        } catch(\UnexpectedValueException $e) {
                                            // Firma inválida
                                            http_response_code(400);
                                            exit();
                                        }
                                        </code></pre>
                                </div>
                            </div>
                        </div>
                        <div class="card mb-4">
                            <div class="card-header">
                                <strong>HTTPS</strong>
                            </div>
                            <div class="card-body">
                                <p>
                                    Stripe requiere que todos los endpoints de webhook utilicen HTTPS para garantizar que los datos se transmitan de forma cifrada entre Stripe y tu servidor.
                                </p>

                                <div class="alert alert-info">
                                    <i class="fas fa-lock"></i> <strong>Requisito:</strong> El servidor debe tener un certificado SSL válido. Stripe no enviará eventos a endpoints sin HTTPS en producción.
                                </div>

                            </div>
                        </div>

                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> <strong>Advertencia:</strong> Nunca almacenes el Webhook Secret en archivos públicos o repositorios de código. Al igual que la clave API secreta, debe mantenerse en variables de entorno o sistemas seguros de gestión de secretos.
                        </div>
                    </div>

                    <div id="reintentos-webhooks" class="subsection">
                        <h4>2.3. Reintentos y Mejores Prácticas para la Respuesta del Endpoint</h4>
                        <p>
                            Stripe utiliza un sistema sofisticado de reintentos para garantizar la entrega de webhooks, pero es crucial que tu endpoint responda correctamente:
                        </p>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <strong>Política de reintentos de Stripe</strong>
                                    </div>
                                    <div class="card-body">
                                        <p>Si tu servidor no responde con un código 2xx, Stripe reintentará el evento:</p>
                                        <ul>
                                            <li>Reintentos durante 3 días.</li>
                                            <li>Frecuencia: cada hora aproximadamente.</li>
                                            <li>Esquema exponencial: los intervalos aumentan con cada intento fallido.</li>
                                            <li>El mismo evento puede enviarse múltiples veces (idempotencia).</li>
                                        </ul>
                                        <p>Después de los reintentos, el evento se marca como fallido en el panel de Stripe.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <strong>Respuestas correctas del endpoint</strong>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Buenas respuestas (evitan reintentos):</strong></p>
                                        <ul>
                                            <li>HTTP 200: El evento se procesó correctamente.</li>
                                            <li>HTTP 204: El evento se recibió pero no requiere acción.</li>
                                        </ul>
                                        <p><strong>Respuestas que provocan reintentos:</strong></p>
                                        <ul>
                                            <li>HTTP 4xx (excepto 409): Error del cliente.</li>
                                            <li>HTTP 5xx: Error del servidor.</li>
                                            <li>Timeout: Sin respuesta en 30 segundos.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header">
                                <strong>Mejores prácticas para el procesamiento de webhooks</strong>
                            </div>
                            <div class="card-body">
                                <ol>
                                    <li>
                                        <strong>Implementa idempotencia:</strong>
                                        <p>Es muy importante diseñar el código con capacidad para manejar el mismo evento múltiples veces sin efectos secundarios indeseados. Debemos utilizar el ID del evento como identificador único.</p>
                                    </li>
                                    <li>
                                        <strong>Respuesta rápida:</strong>
                                        <p>Responde 200 lo antes posible, idealmente en menos de 10 segundos. Para tareas largas, confirma la recepción y luego procesa el evento en segundo plano.</p>
                                    </li>
                                    <li>
                                        <strong>Manejo de errores robusto:</strong>
                                        <p>Si encuentras un error que sabes que persistirá (como datos incompatibles), responde 200 pero registra el problema para revisión manual. Evita reintentos innecesarios.</p>
                                    </li>
                                    <li>
                                        <strong>Registro detallado:</strong>
                                        <p>Guarda los webhooks recibidos (sin datos sensibles de tarjetas) para diagnóstico y auditoría.</p>
                                    </li>
                                    <li>
                                        <strong>Monitoreo activo:</strong>
                                        <p>Configura alertas para eventos fallidos en el panel de Stripe o implementa tu propio sistema de monitoreo.</p>
                                    </li>
                                </ol>

                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle"></i> <strong>Consejo:</strong> En StripeLabApp, se ha utilizado una arquitectura basada en el <strong>patrón Strategy</strong> para procesar diferentes tipos de eventos, permitiendo un código organizado y mantenible.
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sección 3 -->
                <section id="eventos" class="mb-4">
                    <h3>3. Eventos de Stripe: Tipos y Uso</h3>

                    <div id="anatomia-evento" class="subsection">
                        <h4>3.1. Anatomía de un Objeto Evento de Stripe</h4>
                        <p>
                            Los eventos de Stripe son objetos JSON con una estructura específica que proporciona información detallada sobre qué ha ocurrido en tu cuenta. Comprender esta estructura es fundamental para procesar correctamente los webhooks.
                        </p>

                        <div class="card mb-4">
                            <div class="card-header">
                                <strong>Estructura básica de un evento</strong>
                            </div>
                            <div class="card-body">
                                <div class="code-snippet">
                                        <pre><code class="language-json">
                                            {
                                              "id": "evt_1OabCdEFghIJklMN",  // Identificador único del evento
                                              "object": "event",
                                              "api_version": "2023-10-16",   // Versión de la API usada
                                              "created": 1643043046,         // Timestamp Unix de creación
                                              "data": {
                                                "object": {
                                                  // El objeto afectado por este evento (payment_intent, subscription, etc.)
                                                  "id": "pi_1OabCdEFghIJklMN",
                                                  "object": "payment_intent",
                                                  // ... resto de propiedades del objeto
                                                },
                                                "previous_attributes": {
                                                  // Solo presente en eventos de actualización
                                                  // Contiene los valores anteriores de los atributos modificados
                                                  "status": "requires_payment_method"
                                                }
                                              },
                                              "livemode": false,             // false para el entorno de prueba, true para producción
                                              "pending_webhooks": 2,         // Número de webhooks pendientes para este evento
                                              "request": {
                                                "id": "req_1OabCdEFghIJklMN", // ID de la solicitud que generó el evento
                                                "idempotency_key": "key123"   // Clave de idempotencia si se proporcionó
                                              },
                                              "type": "payment_intent.succeeded" // Tipo de evento
}
                                        </code></pre>
                                </div>

                                <div class="mt-4">
                                    <h5>Campos clave:</h5>
                                    <ul>
                                        <li>
                                            <strong><code>id</code>:</strong> Identificador único del evento (comienza con <code>evt_</code>). Se usa para implementar la idempotencia y evitar procesamiento duplicado.
                                        </li>
                                        <li>
                                            <strong><code>type</code>:</strong> Especifica qué ha ocurrido. Estructura: <code>resource.event</code>, por ejemplo, <code>payment_intent.succeeded</code> indica que un PaymentIntent ha tenido éxito.
                                        </li>
                                        <li>
                                            <strong><code>data.object</code>:</strong> Contiene el objeto completo relacionado con el evento, con todos sus campos y valores actuales.
                                        </li>
                                        <li>
                                            <strong><code>data.previous_attributes</code>:</strong> Solo presente en eventos de actualización, muestra los valores anteriores de los campos que han cambiado.
                                        </li>
                                        <li>
                                            <strong><code>livemode</code>:</strong> Indica si el evento pertenece al entorno de producción (<code>true</code>) o al entorno de prueba (<code>false</code>).
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-lightbulb"></i> <strong>Consejo de implementación:</strong> En StripeLabApp, se mapean estos eventos a DTOs específicos para facilitar su procesamiento en la arquitectura por capas en la que está basada la aplicación.
                        </div>
                    </div>

                    <div id="categorias-eventos" class="subsection">
                        <h4>3.2. Categorías Principales de Eventos</h4>
                        <p>
                            Stripe genera muchísimos eventos diferentes, agrupados en categorías según el recurso afectado. Aquí están las categorías más relevantes para StripeLabApp y para nuestro proposito futuro en ILIAS:
                        </p>

                        <div class="table-responsive mb-4">
                            <table class="table table-striped table-hover">
                                <thead class="table-primary">
                                <tr>
                                    <th>Categoría</th>
                                    <th>Prefijo del evento</th>
                                    <th>Descripción</th>
                                    <th>Eventos típicos</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td><strong>Charges</strong></td>
                                    <td><code>charge.</code></td>
                                    <td>Eventos relacionados con cargos a métodos de pago.</td>
                                    <td><code>charge.succeeded</code>, <code>charge.failed</code>, <code>charge.refunded</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Payment Intents</strong></td>
                                    <td><code>payment_intent.</code></td>
                                    <td>Eventos que siguen el ciclo de vida de los intentos de pago.</td>
                                    <td><code>payment_intent.created</code>, <code>payment_intent.succeeded</code>, <code>payment_intent.payment_failed</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Checkout Sessions</strong></td>
                                    <td><code>checkout.session.</code></td>
                                    <td>Eventos relacionados con las sesiones de Stripe Checkout.</td>
                                    <td><code>checkout.session.completed</code>, <code>checkout.session.expired</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Customers</strong></td>
                                    <td><code>customer.</code></td>
                                    <td>Eventos relacionados con la creación y modificación de clientes.</td>
                                    <td><code>customer.created</code>, <code>customer.updated</code>, <code>customer.deleted</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Subscriptions</strong></td>
                                    <td><code>customer.subscription.</code></td>
                                    <td>Eventos del ciclo de vida de las suscripciones.</td>
                                    <td><code>customer.subscription.created</code>, <code>customer.subscription.updated</code>, <code>customer.subscription.deleted</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Invoices</strong></td>
                                    <td><code>invoice.</code></td>
                                    <td>Eventos relacionados con facturas, principalmente para suscripciones.</td>
                                    <td><code>invoice.created</code>, <code>invoice.paid</code>, <code>invoice.payment_failed</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i> <strong>Nota:</strong> Esta tabla muestra solo las categorías más comunes. Stripe puede añadir nuevos tipos de eventos en cualquier momento, por lo que es recomendable diseñar el sistema para manejar eventos desconocidos de manera elegante.
                        </div>

                        <p>
                            Durante el desarrollo de StripeLabApp, me he enfocado principalmente en los eventos relacionados con pagos únicos (<code>payment_intent</code>, <code>charge</code>) y suscripciones (<code>customer.subscription</code>, <code>invoice</code>), ya que estos son fundamentales para mantener el estado de las transacciones y suscripciones de los usuarios.
                        </p>
                    </div>

                    <div id="eventos-detallados" class="subsection">
                        <h4>3.3. Eventos Detallados</h4>
                        <p>
                            A continuación, analizamos en detalle los eventos más importantes que se manejan en la aplicación de prueba encomendada, agrupados por funcionalidad. Entender estos eventos y sus payloads es esencial para implementar correctamente las estrategias de procesamiento.
                        </p>

                        <!-- Checkout Events -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Checkout</h5>
                            </div>
                            <div class="card-body">
                                <p>
                                    Los eventos de Checkout proporcionan información sobre el proceso de pago mediante Stripe Checkout, incluyendo el resultado final y si la sesión expiró sin completarse.
                                </p>

                                <!-- checkout.session.completed -->
                                <div class="event-details mb-4">
                                    <h5><code>checkout.session.completed</code></h5>
                                    <div class="alert alert-success">
                                        <i class="fas fa-check-circle"></i> <strong>Descripción:</strong> Se dispara cuando un cliente completa el proceso de pago en Stripe Checkout. Este evento es crucial para activar productos o servicios después de un pago exitoso.
                                    </div>
                                    <p>
                                        Este evento contiene toda la información relevante sobre la transacción, incluyendo:
                                    </p>
                                    <ul>
                                        <li>Detalles del cliente (<code>customer</code>, <code>customer_details</code>)</li>
                                        <li>Monto del pago (<code>amount_total</code>)</li>
                                        <li>Modo de operación (<code>mode</code>: "payment" para pagos únicos, "subscription" para suscripciones)</li>
                                        <li>Estado del pago (<code>payment_status</code>)</li>
                                        <li>Referencias a objetos relacionados (<code>payment_intent</code>, <code>subscription</code>, <code>invoice</code>)</li>
                                    </ul>

                                    <p><strong>Payload de Ejemplo:</strong></p>
                                    <div class="code-snippet">
                                            <pre><code class="language-json">
                                                {
                                                    "id": "cs_test_a1pbv8QoyAgXUfa043e3KZqhIgtT3ve1aD7hPgqe73c2HTaNOjc13ki5XI",
                                                    "object": "checkout.session",
                                                    "adaptive_pricing": null,
                                                    "after_expiration": null,
                                                    "allow_promotion_codes": null,
                                                    "amount_subtotal": 1500,
                                                    "amount_total": 1500,
                                                    "automatic_tax": {
                                                        "enabled": false,
                                                        "liability": null,
                                                        "provider": null,
                                                        "status": null
                                                    },
                                                    "billing_address_collection": null,
                                                    "cancel_url": "http://localhost:8000/public/cancel.html",
                                                    "client_reference_id": null,
                                                    "client_secret": null,
                                                    "collected_information": {
                                                        "shipping_details": null
                                                    },
                                                    "consent": null,
                                                    "consent_collection": null,
                                                    "created": 1747091168,
                                                    "currency": "eur",
                                                    "currency_conversion": null,
                                                    "custom_fields": [],
                                                    "custom_text": {
                                                        "after_submit": null,
                                                        "shipping_address": null,
                                                        "submit": null,
                                                        "terms_of_service_acceptance": null
                                                    },
                                                    "customer": "cus_SIgoJvUF0ooe7U",
                                                    "customer_creation": "always",
                                                    "customer_details": {
                                                        "address": {
                                                            "city": null,
                                                            "country": "ES",
                                                            "line1": null,
                                                            "line2": null,
                                                            "postal_code": null,
                                                            "state": null
                                                        },
                                                        "email": "TESTanual@TEST.COM",
                                                        "name": "suscripcion anual",
                                                        "phone": null,
                                                        "tax_exempt": "none",
                                                        "tax_ids": []
                                                    },
                                                    "customer_email": null,
                                                    "discounts": [],
                                                    "expires_at": 1747177568,
                                                    "invoice": "in_1RO5QgP71JLI6sb9HSRdDSiW",
                                                    "invoice_creation": null,
                                                    "livemode": false,
                                                    "locale": null,
                                                    "metadata": [],
                                                    "mode": "subscription",
                                                    "payment_intent": null,
                                                    "payment_link": null,
                                                    "payment_method_collection": "always",
                                                    "payment_method_configuration_details": null,
                                                    "payment_method_options": {
                                                        "card": {
                                                            "request_three_d_secure": "automatic"
                                                        }
                                                    },
                                                    "payment_method_types": [
                                                        "card"
                                                    ],
                                                    "payment_status": "paid",
                                                    "permissions": null,
                                                    "phone_number_collection": {
                                                        "enabled": false
                                                    },
                                                    "recovered_from": null,
                                                    "saved_payment_method_options": {
                                                        "allow_redisplay_filters": [
                                                            "always"
                                                        ],
                                                        "payment_method_remove": "disabled",
                                                        "payment_method_save": null
                                                    },
                                                    "setup_intent": null,
                                                    "shipping_address_collection": null,
                                                    "shipping_cost": null,
                                                    "shipping_options": [],
                                                    "status": "complete",
                                                    "submit_type": null,
                                                    "subscription": "sub_1RO5QfP71JLI6sb9EKIosSQS",
                                                    "success_url": "http://localhost:8000/public/success.html?session_id={CHECKOUT_SESSION_ID}",
                                                    "total_details": {
                                                        "amount_discount": 0,
                                                        "amount_shipping": 0,
                                                        "amount_tax": 0
                                                    },
                                                    "ui_mode": "hosted",
                                                    "url": null,
                                                    "wallet_options": null
                                                }
                                                                                            </code></pre>
                                    </div>

                                    <div class="mt-3 alert alert-info">
                                        <i class="fas fa-lightbulb"></i> <strong>Implementación en StripeLabApp:</strong> Se ha utilizado este evento para crear registros de transacciones y activar suscripciones.
                                    </div>
                                </div>
                                <!-- checkout.session.expired -->
                                <div class="event-details">
                                    <h5><code>checkout.session.expired</code></h5>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-clock"></i> <strong>Descripción:</strong> Se dispara cuando una sesión de Checkout expira antes de que el cliente complete el pago.
                                    </div>
                                    <p>
                                        Este evento es útil para:
                                    </p>
                                    <ul>
                                        <li>Limpiar recursos reservados temporalmente para el cliente</li>
                                        <li>Enviar recordatorios de pago pendiente</li>
                                        <li>Realizar análisis de abandono del carrito</li>
                                    </ul>

                                    <p><strong>Payload de Ejemplo:</strong></p>
                                    <div class="code-snippet">
                                            <pre><code class="language-json">
                                            {
                                                "id": "cs_test_a1M54d8jxXa1ii0F5nl98GugMADB2OllRqFfnBGzLfrhOOCnyTtU0xtUdr",
                                                "object": "checkout.session",
                                                "adaptive_pricing": {
                                                    "enabled": true
                                                },
                                                "after_expiration": null,
                                                "allow_promotion_codes": null,
                                                "amount_subtotal": 1000,
                                                "amount_total": 1000,
                                                "automatic_tax": {
                                                    "enabled": false,
                                                    "liability": null,
                                                    "provider": null,
                                                    "status": null
                                                },
                                                "billing_address_collection": null,
                                                "cancel_url": "http://localhost:8000/public/cancel.html",
                                                "client_reference_id": null,
                                                "client_secret": null,
                                                "collected_information": null,
                                                "consent": null,
                                                "consent_collection": null,
                                                "created": 1747004962,
                                                "currency": "eur",
                                                "currency_conversion": null,
                                                "custom_fields": [],
                                                "custom_text": {
                                                    "after_submit": null,
                                                    "shipping_address": null,
                                                    "submit": null,
                                                    "terms_of_service_acceptance": null
                                                },
                                                "customer": null,
                                                "customer_creation": "if_required",
                                                "customer_details": null,
                                                "customer_email": null,
                                                "discounts": [],
                                                "expires_at": 1747091362,
                                                "invoice": null,
                                                "invoice_creation": {
                                                    "enabled": false,
                                                    "invoice_data": {
                                                        "account_tax_ids": null,
                                                        "custom_fields": null,
                                                        "description": null,
                                                        "footer": null,
                                                        "issuer": null,
                                                        "metadata": [],
                                                        "rendering_options": null
                                                    }
                                                },
                                                "livemode": false,
                                                "locale": null,
                                                "metadata": [],
                                                "mode": "payment",
                                                "payment_intent": null,
                                                "payment_link": null,
                                                "payment_method_collection": "if_required",
                                                "payment_method_configuration_details": null,
                                                "payment_method_options": {
                                                    "card": {
                                                        "request_three_d_secure": "automatic"
                                                    }
                                                },
                                                "payment_method_types": [
                                                    "card"
                                                ],
                                                "payment_status": "unpaid",
                                                "permissions": null,
                                                "phone_number_collection": {
                                                    "enabled": false
                                                },
                                                "recovered_from": null,
                                                "saved_payment_method_options": null,
                                                "setup_intent": null,
                                                "shipping_address_collection": null,
                                                "shipping_cost": null,
                                                "shipping_options": [],
                                                "status": "expired",
                                                "submit_type": null,
                                                "subscription": null,
                                                "success_url": "http://localhost:8000/public/success.html?session_id={CHECKOUT_SESSION_ID}",
                                                "total_details": {
                                                    "amount_discount": 0,
                                                    "amount_shipping": 0,
                                                    "amount_tax": 0
                                                },
                                                "ui_mode": "hosted",
                                                "url": null,
                                                "wallet_options": null
                                            }
                                            </code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Events -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Clientes (Customers)</h5>
                            </div>
                            <div class="card-body">
                                <p>
                                    Los eventos de Clientes proporcionan información sobre cambios en los objetos Customer, que son esenciales para gestionar la información de los usuarios y sus métodos de pago.
                                </p>

                                <!-- customer.created -->
                                <div class="event-details mb-4">
                                    <h5><code>customer.created</code></h5>
                                    <div class="alert alert-success">
                                        <i class="fas fa-user-plus"></i> <strong>Descripción:</strong> Se dispara cuando se crea un nuevo cliente en Stripe. Esto ocurre durante el registro del usuario, la primera compra, o cuando se crea explícitamente mediante la API.
                                    </div>
                                    <p>
                                        El payload incluye toda la información del cliente, como:
                                    </p>
                                    <ul>
                                        <li>Información de contacto (email, nombre, teléfono)</li>
                                        <li>Dirección de facturación</li>
                                        <li>Configuración de facturación predeterminada</li>
                                    </ul>

                                    <p><strong>Payload de Ejemplo:</strong></p>
                                    <div class="code-snippet">
                                            <pre><code class="language-json">
                                                {
                                                    "id": "cus_SIgjYjt5FKHVKG",
                                                    "object": "customer",
                                                    "address": {
                                                        "city": null,
                                                        "country": "ES",
                                                        "line1": null,
                                                        "line2": null,
                                                        "postal_code": null,
                                                        "state": null
                                                    },
                                                    "balance": 0,
                                                    "created": 1747090919,
                                                    "currency": null,
                                                    "default_source": null,
                                                    "delinquent": false,
                                                    "description": null,
                                                    "discount": null,
                                                    "email": "TEST@TEST.COM",
                                                    "invoice_prefix": "4ERGRE3J",
                                                    "invoice_settings": {
                                                        "custom_fields": null,
                                                        "default_payment_method": null,
                                                        "footer": null,
                                                        "rendering_options": null
                                                    },
                                                    "livemode": false,
                                                    "metadata": [],
                                                    "name": "suscripcion mensual",
                                                    "phone": null,
                                                    "preferred_locales": [
                                                        "es-ES"
                                                    ],
                                                    "shipping": null,
                                                    "tax_exempt": "none",
                                                    "test_clock": null
                                                }
                                            </code></pre>
                                    </div>

                                    <div class="mt-3 alert alert-info">
                                        <i class="fas fa-lightbulb"></i> <strong>Implementación en StripeLabApp:</strong> Importante para sincronizar los datos del cliente con nuestra base de datos para mantener así la coherencia entre nuestro sistema y Stripe.
                                    </div>
                                </div>

                                <!-- customer.updated -->
                                <div class="event-details mb-4">
                                    <h5><code>customer.updated</code></h5>
                                    <div class="alert alert-info">
                                        <i class="fas fa-user-edit"></i> <strong>Descripción:</strong> Se dispara cuando se actualiza cualquier información del cliente. Los cambios pueden incluir detalles de contacto, métodos de pago predeterminados o metadatos.
                                    </div>
                                    <p>
                                        Este evento es particularmente útil para mantener sincronizada la información del cliente entre Stripe y la base de datos. El payload incluye tanto los datos actualizados como el campo <code>previous_attributes</code> en el evento principal, que contiene los valores anteriores de los campos modificados.
                                    </p>

                                    <p><strong>Payload de Ejemplo:</strong></p>
                                    <div class="code-snippet">
                                            <pre><code class="language-json">
                                                {
                                                    "id": "cus_SIgjYjt5FKHVKG",
                                                    "object": "customer",
                                                    "address": {
                                                        "city": null,
                                                        "country": "ES",
                                                        "line1": null,
                                                        "line2": null,
                                                        "postal_code": null,
                                                        "state": null
                                                    },
                                                    "balance": 0,
                                                    "created": 1747090919,
                                                    "currency": "eur",
                                                    "default_source": null,
                                                    "delinquent": false,
                                                    "description": null,
                                                    "discount": null,
                                                    "email": "TEST@TEST.COM",
                                                    "invoice_prefix": "4ERGRE3J",
                                                    "invoice_settings": {
                                                        "custom_fields": null,
                                                        "default_payment_method": null,
                                                        "footer": null,
                                                        "rendering_options": null
                                                    },
                                                    "livemode": false,
                                                    "metadata": [],
                                                    "name": "suscripcion mensual",
                                                    "phone": null,
                                                    "preferred_locales": [
                                                        "es-ES"
                                                    ],
                                                    "shipping": null,
                                                    "tax_exempt": "none",
                                                    "test_clock": null
                                                }
                                            </code></pre>
                                    </div>
                                </div>

                                <!-- customer.deleted (brief mention) -->
                                <div class="event-details">
                                    <h5><code>customer.deleted</code></h5>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-user-slash"></i> <strong>Descripción:</strong> Se dispara cuando se elimina un cliente de Stripe. En StripeLab, se ha utilizado este evento para marcar al cliente como inactivo en nuestra base de datos, sin eliminar su registro completamente.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Events -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Pagos (PaymentIntents & Charges)</h5>
                            </div>
                            <div class="card-body">
                                <p>
                                    Los eventos de Pagos son fundamentales para rastrear el estado de las transacciones y confirmar cuando un pago ha sido procesado correctamente.
                                </p>

                                <!-- payment_intent.created (brief mention) -->
                                <div class="event-details mb-4">
                                    <h5><code>payment_intent.created</code></h5>
                                    <div class="alert alert-secondary">
                                        <i class="fas fa-info-circle"></i> <strong>Descripción:</strong> Se dispara cuando se crea un nuevo PaymentIntent. En StripeLabApp no se procesa este evento, ya que representa solo el inicio del proceso de pago.
                                    </div>

                                    <p><strong>Payload de Ejemplo:</strong></p>
                                    <div class="code-snippet">
                                            <pre><code class="language-json">
                                                {
                                                    "id": "pi_3RO5MBP71JLI6sb90nUSzhE7",
                                                    "object": "payment_intent",
                                                    "amount": 300,
                                                    "amount_capturable": 0,
                                                    "amount_details": {
                                                        "tip": []
                                                    },
                                                    "amount_received": 0,
                                                    "application": null,
                                                    "application_fee_amount": null,
                                                    "automatic_payment_methods": null,
                                                    "canceled_at": null,
                                                    "cancellation_reason": null,
                                                    "capture_method": "automatic",
                                                    "client_secret": "pi_3RO5MBP71JLI6sb90nUSzhE7_secret_vAWdJSFnikd4n7snnVLBXMDgW",
                                                    "confirmation_method": "automatic",
                                                    "created": 1747090919,
                                                    "currency": "eur",
                                                    "customer": "cus_SIgjYjt5FKHVKG",
                                                    "description": "Subscription creation",
                                                    "last_payment_error": null,
                                                    "latest_charge": null,
                                                    "livemode": false,
                                                    "metadata": [],
                                                    "next_action": null,
                                                    "on_behalf_of": null,
                                                    "payment_method": null,
                                                    "payment_method_configuration_details": null,
                                                    "payment_method_options": {
                                                        "card": {
                                                            "installments": null,
                                                            "mandate_options": null,
                                                            "network": null,
                                                            "request_three_d_secure": "automatic"
                                                        },
                                                        "link": {
                                                            "persistent_token": null
                                                        }
                                                    },
                                                    "payment_method_types": [
                                                        "card",
                                                        "link"
                                                    ],
                                                    "processing": null,
                                                    "receipt_email": null,
                                                    "review": null,
                                                    "setup_future_usage": "off_session",
                                                    "shipping": null,
                                                    "source": null,
                                                    "statement_descriptor": null,
                                                    "statement_descriptor_suffix": null,
                                                    "status": "requires_payment_method",
                                                    "transfer_data": null,
                                                    "transfer_group": null
                                                }
                                            </code></pre>
                                    </div>
                                </div>

                                <!-- payment_intent.succeeded -->
                                <div class="event-details mb-4">
                                    <h5><code>payment_intent.succeeded</code></h5>
                                    <div class="alert alert-success">
                                        <i class="fas fa-check-circle"></i> <strong>Descripción:</strong> Se dispara cuando un pago se completa con éxito. Este es <strong>uno de los eventos más importantes</strong> para confirmar que una transacción ha sido procesada correctamente.
                                    </div>
                                    <p>
                                        El payload contiene toda la información sobre el pago exitoso, incluyendo:
                                    </p>
                                    <ul>
                                        <li>El monto cobrado y la moneda</li>
                                        <li>El cliente (si está asociado)</li>
                                        <li>El método de pago utilizado</li>
                                        <li>La referencia al cargo (<code>latest_charge</code>) que contiene detalles adicionales</li>
                                    </ul>

                                    <p><strong>Payload de Ejemplo (pago único):</strong></p>
                                    <div class="code-snippet">
                                            <pre><code class="language-json">
                                                {
                                                    "id": "pi_3RO5KdP71JLI6sb91XFQkshR",
                                                    "object": "payment_intent",
                                                    "amount": 1000,
                                                    "amount_capturable": 0,
                                                    "amount_details": {
                                                        "tip": []
                                                    },
                                                    "amount_received": 1000,
                                                    "application": null,
                                                    "application_fee_amount": null,
                                                    "automatic_payment_methods": null,
                                                    "canceled_at": null,
                                                    "cancellation_reason": null,
                                                    "capture_method": "automatic_async",
                                                    "client_secret": "pi_3RO5KdP71JLI6sb91XFQkshR_secret_w5q9oPR0tmbNlYeULXUekzEYt",
                                                    "confirmation_method": "automatic",
                                                    "created": 1747090823,
                                                    "currency": "eur",
                                                    "customer": null,
                                                    "description": null,
                                                    "last_payment_error": null,
                                                    "latest_charge": "ch_3RO5KdP71JLI6sb91oRRGx4P",
                                                    "livemode": false,
                                                    "metadata": [],
                                                    "next_action": null,
                                                    "on_behalf_of": null,
                                                    "payment_method": "pm_1RO5KcP71JLI6sb9DAN632WU",
                                                    "payment_method_configuration_details": null,
                                                    "payment_method_options": {
                                                        "card": {
                                                            "installments": null,
                                                            "mandate_options": null,
                                                            "network": null,
                                                            "request_three_d_secure": "automatic"
                                                        }
                                                    },
                                                    "payment_method_types": [
                                                        "card"
                                                    ],
                                                    "processing": null,
                                                    "receipt_email": null,
                                                    "review": null,
                                                    "setup_future_usage": null,
                                                    "shipping": null,
                                                    "source": null,
                                                    "statement_descriptor": null,
                                                    "statement_descriptor_suffix": null,
                                                    "status": "succeeded",
                                                    "transfer_data": null,
                                                    "transfer_group": null
                                                }
                                            </code></pre>
                                    </div>

                                    <p><strong>Payload de Ejemplo (pago de suscripción):</strong></p>
                                    <div class="code-snippet">
                                            <pre><code class="language-json">
{
    "id": "pi_3RO5QeP71JLI6sb90iwvxrFW",
    "object": "payment_intent",
    "amount": 1500,
    "amount_capturable": 0,
    "amount_details": {
        "tip": []
    },
    "amount_received": 1500,
    "application": null,
    "application_fee_amount": null,
    "automatic_payment_methods": null,
    "canceled_at": null,
    "cancellation_reason": null,
    "capture_method": "automatic",
    "client_secret": "pi_3RO5QeP71JLI6sb90iwvxrFW_secret_jYRCh9uUSLrrbosrHRfOxYm9e",
    "confirmation_method": "automatic",
    "created": 1747091196,
    "currency": "eur",
    "customer": "cus_SIgoJvUF0ooe7U",
    "description": "Subscription creation",
    "last_payment_error": null,
    "latest_charge": "ch_3RO5QeP71JLI6sb90RTFOULQ",
    "livemode": false,
    "metadata": [],
    "next_action": null,
    "on_behalf_of": null,
    "payment_method": "pm_1RO5QdP71JLI6sb9E6WLHpfW",
    "payment_method_configuration_details": null,
    "payment_method_options": {
        "card": {
            "installments": null,
            "mandate_options": null,
            "network": null,
            "request_three_d_secure": "automatic",
            "setup_future_usage": "off_session"
        }
    },
    "payment_method_types": [
        "card"
    ],
    "processing": null,
    "receipt_email": null,
    "review": null,
    "setup_future_usage": "off_session",
    "shipping": null,
    "source": null,
    "statement_descriptor": null,
    "statement_descriptor_suffix": null,
    "status": "succeeded",
    "transfer_data": null,
    "transfer_group": null
}
                                            </code></pre>
                                    </div>

                                    <div class="mt-3 alert alert-info">
                                        <i class="fas fa-lightbulb"></i> <strong>Implementación en StripeLabApp:</strong> Se usa este evento para registrar transacciones exitosas. Es el desencadenante que nos indicará que hay que darle acceso a un usuario a un curso.
                                    </div>
                                </div>

                                <!-- payment_intent.payment_failed (brief mention) -->
                                <div class="event-details mb-4">
                                    <h5><code>payment_intent.payment_failed</code></h5>
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-circle"></i> <strong>Descripción:</strong> Se dispara cuando un intento de pago falla por cualquier motivo (tarjeta rechazada, fondos insuficientes, error de autenticación, etc.). En StripeLabApp no se maneja.
                                    </div>
                                </div>

                                <!-- charge.succeeded -->
                                <div class="event-details mb-4">
                                    <h5><code>charge.succeeded</code></h5>
                                    <div class="alert alert-success">
                                        <i class="fas fa-credit-card"></i> <strong>Descripción:</strong> Se dispara cuando un cargo a una tarjeta o método de pago se procesa correctamente. Está estrechamente relacionado con <code>payment_intent.succeeded</code>, este evento proporciona información adicional específica del cargo.
                                    </div>
                                    <p>
                                        La importancia de este evento reside en que contiene detalles adicionales como:
                                    </p>
                                    <ul>
                                        <li>El <code>receipt_url</code> (URL del recibo) <strong>CRUCIAL PARA NOSOTROS</strong></li>
                                        <li>Detalles específicos del método de pago (últimos 4 dígitos, marca, país de emisión)</li>
                                        <li>Resultados de verificaciones de seguridad (CVC, dirección...)</li>
                                        <li>Información detallada sobre el procesamiento del pago</li>
                                    </ul>

                                    <p><strong>Payload de Ejemplo:</strong></p>
                                    <div class="code-snippet">
                                            <pre><code class="language-json">
                                                {
                                                    "id": "ch_3RO5KdP71JLI6sb91oRRGx4P",
                                                    "object": "charge",
                                                    "amount": 1000,
                                                    "amount_captured": 1000,
                                                    "amount_refunded": 0,
                                                    "application": null,
                                                    "application_fee": null,
                                                    "application_fee_amount": null,
                                                    "balance_transaction": null,
                                                    "billing_details": {
                                                        "address": {
                                                            "city": null,
                                                            "country": "ES",
                                                            "line1": null,
                                                            "line2": null,
                                                            "postal_code": null,
                                                            "state": null
                                                        },
                                                        "email": "jccataluna@ddd.com",
                                                        "name": "Pago unico",
                                                        "phone": null,
                                                        "tax_id": null
                                                    },
                                                    "calculated_statement_descriptor": "Stripe",
                                                    "captured": true,
                                                    "created": 1747090823,
                                                    "currency": "eur",
                                                    "customer": null,
                                                    "description": null,
                                                    "destination": null,
                                                    "dispute": null,
                                                    "disputed": false,
                                                    "failure_balance_transaction": null,
                                                    "failure_code": null,
                                                    "failure_message": null,
                                                    "fraud_details": [],
                                                    "livemode": false,
                                                    "metadata": [],
                                                    "on_behalf_of": null,
                                                    "order": null,
                                                    "outcome": {
                                                        "advice_code": null,
                                                        "network_advice_code": null,
                                                        "network_decline_code": null,
                                                        "network_status": "approved_by_network",
                                                        "reason": null,
                                                        "risk_level": "normal",
                                                        "risk_score": 33,
                                                        "seller_message": "Payment complete.",
                                                        "type": "authorized"
                                                    },
                                                    "paid": true,
                                                    "payment_intent": "pi_3RO5KdP71JLI6sb91XFQkshR",
                                                    "payment_method": "pm_1RO5KcP71JLI6sb9DAN632WU",
                                                    "payment_method_details": {
                                                        "card": {
                                                            "amount_authorized": 1000,
                                                            "authorization_code": null,
                                                            "brand": "visa",
                                                            "checks": {
                                                                "address_line1_check": null,
                                                                "address_postal_code_check": null,
                                                                "cvc_check": "pass"
                                                            },
                                                            "country": "US",
                                                            "exp_month": 2,
                                                            "exp_year": 2026,
                                                            "extended_authorization": {
                                                                "status": "disabled"
                                                            },
                                                            "fingerprint": "H2RjQOzJ2vMTHb1p",
                                                            "funding": "credit",
                                                            "incremental_authorization": {
                                                                "status": "unavailable"
                                                            },
                                                            "installments": null,
                                                            "last4": "4242",
                                                            "mandate": null,
                                                            "multicapture": {
                                                                "status": "unavailable"
                                                            },
                                                            "network": "visa",
                                                            "network_token": {
                                                                "used": false
                                                            },
                                                            "network_transaction_id": "725082106817912",
                                                            "overcapture": {
                                                                "maximum_amount_capturable": 1000,
                                                                "status": "unavailable"
                                                            },
                                                            "regulated_status": "unregulated",
                                                            "three_d_secure": null,
                                                            "wallet": null
                                                        },
                                                        "type": "card"
                                                    },
                                                    "radar_options": [],
                                                    "receipt_email": null,
                                                    "receipt_number": null,
                                                    "receipt_url": "https://pay.stripe.com/receipts/payment/CAcaFwoVYWNjdF8xUkhKNjFQNzFKTEk2c2I5KIj7icEGMgZeDpPk1pQ6LBaNV8plHjPjyBGcptjwO_J4m04Rts0jrS-KR4rCdXiuo6L8ogY29dtVIBzV",
                                                    "refunded": false,
                                                    "review": null,
                                                    "shipping": null,
                                                    "source": null,
                                                    "source_transfer": null,
                                                    "statement_descriptor": null,
                                                    "statement_descriptor_suffix": null,
                                                    "status": "succeeded",
                                                    "transfer_data": null,
                                                    "transfer_group": null
                                                }
                                            </code></pre>
                                    </div>

                                    <div class="mt-3 alert alert-info">
                                        <i class="fas fa-lightbulb"></i> <strong>Implementación en StripeLabApp:</strong> El motivo principal es el campo <code>receipt_url</code> ya que nos permite proporcionarle al usuario la factura.
                                    </div>
                                </div>

                                <!-- charge.failed and charge.refunded (brief mention) -->
                                <div class="event-details">
                                    <h5><code>charge.failed</code> y <code>charge.refunded</code></h5>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i> <strong>Descripción:</strong>
                                        <ul>
                                            <li><code>charge.failed</code>: Se dispara cuando un cargo no puede procesarse. Contiene información detallada sobre el motivo del fallo.</li>
                                            <li><code>charge.refunded</code>: Se dispara cuando se reembolsa un cargo, ya sea parcial o totalmente. Importante para actualizar el estado de las transacciones y ajustar el inventario si es necesario.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-circle"></i> <strong>Consideraciones importantes:</strong>
                            <ul>
                                <li>Los eventos pueden llegar en cualquier orden, por lo que la implementación debe ser robusta ante eventos fuera de secuencia.</li>
                            </ul>
                        </div>
                    </div>
                </section>
                <!-- Invoice Events -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Facturas (Invoices)</h5>
                    </div>
                    <div class="card-body">
                        <p>
                            Los eventos de facturas proporcionan información sobre la creación, actualización y pago de facturas, elementos esenciales para gestionar y rastrear los pagos, especialmente en modelos de suscripción.
                        </p>

                        <!-- invoice.created -->
                        <div class="event-details mb-4">
                            <h5><code>invoice.created</code></h5>
                            <div class="alert alert-secondary">
                                <i class="fas fa-info-circle"></i> <strong>Descripción:</strong> Se dispara cuando se crea una nueva factura, generalmente como resultado de la creación de una suscripción o cuando se aproxima la fecha de renovación. En StripeLabApp no se procesa este evento, ya que se le ha dado más importancia al evento <code>invoice.paid</code>, el cual se describirá a continuación.
                            </div>

                            <p><strong>Payload de Ejemplo:</strong></p>
                            <div class="code-snippet">
                                            <pre><code class="language-json">
{
    "id": "in_1RO5MDP71JLI6sb9eWuwpvJj",
    "object": "invoice",
    "account_country": "ES",
    "account_name": "Stripe Lab App",
    "account_tax_ids": null,
    "amount_due": 300,
    "amount_overpaid": 0,
    "amount_paid": 300,
    "amount_remaining": 0,
    "amount_shipping": 0,
    "application": null,
    "attempt_count": 0,
    "attempted": true,
    "auto_advance": false,
    "automatic_tax": {
        "disabled_reason": null,
        "enabled": false,
        "liability": null,
        "provider": null,
        "status": null
    },
    "automatically_finalizes_at": null,
    "billing_reason": "subscription_create",
    "collection_method": "charge_automatically",
    "created": 1747090919,
    "currency": "eur",
    "custom_fields": null,
    "customer": "cus_SIgjYjt5FKHVKG",
    "customer_address": {
        "city": null,
        "country": "ES",
        "line1": null,
        "line2": null,
        "postal_code": null,
        "state": null
    },
    "customer_email": "TEST@TEST.COM",
    "customer_name": "suscripcion mensual",
    "customer_phone": null,
    "customer_shipping": null,
    "customer_tax_exempt": "none",
    "customer_tax_ids": [],
    "default_payment_method": null,
    "default_source": null,
    "default_tax_rates": [],
    "description": null,
    "discounts": [],
    "due_date": null,
    "effective_at": 1747090919,
    "ending_balance": 0,
    "footer": null,
    "from_invoice": null,
    "hosted_invoice_url": "https://invoice.stripe.com/i/acct_1RHJ61P71JLI6sb9/test_YWNjdF8xUkhKNjFQNzFKTEk2c2I5LF9TSWdqeU9vWU0ycktEOEQ1ZXdjakg4YXdTNlE1a0FJLDEzNzYzMTcyMg0200xYhbKGe5?s=ap",
    "invoice_pdf": "https://pay.stripe.com/invoice/acct_1RHJ61P71JLI6sb9/test_YWNjdF8xUkhKNjFQNzFKTEk2c2I5LF9TSWdqeU9vWU0ycktEOEQ1ZXdjakg4YXdTNlE1a0FJLDEzNzYzMTcyMg0200xYhbKGe5/pdf?s=ap",
    "issuer": {
        "type": "self"
    },
    "last_finalization_error": null,
    "latest_revision": null,
    "lines": {
        "object": "list",
        "data": [
            {
                "id": "il_1RO5MDP71JLI6sb9iN3orsCH",
                "object": "line_item",
                "amount": 300,
                "currency": "eur",
                "description": "1 × Test App (at €3.00 / month)",
                "discount_amounts": [],
                "discountable": true,
                "discounts": [],
                "invoice": "in_1RO5MDP71JLI6sb9eWuwpvJj",
                "livemode": false,
                "metadata": [],
                "parent": {
                    "invoice_item_details": null,
                    "subscription_item_details": {
                        "invoice_item": null,
                        "proration": false,
                        "proration_details": {
                            "credited_items": null
                        },
                        "subscription": "sub_1RO5MDP71JLI6sb9V5sdUJ8V",
                        "subscription_item": "si_SIgjYKrxsGix1W"
                    },
                    "type": "subscription_item_details"
                },
                "period": {
                    "end": 1749769319,
                    "start": 1747090919
                },
                "pretax_credit_amounts": [],
                "pricing": {
                    "price_details": {
                        "price": "price_1RLNcyP71JLI6sb92qc9ywRx",
                        "product": "prod_SFsxoaHLKoYbKj"
                    },
                    "type": "price_details",
                    "unit_amount_decimal": "300"
                },
                "quantity": 1,
                "taxes": []
            }
        ],
        "has_more": false,
        "total_count": 1,
        "url": "/v1/invoices/in_1RO5MDP71JLI6sb9eWuwpvJj/lines"
    },
    "livemode": false,
    "metadata": [],
    "next_payment_attempt": null,
    "number": "98CD073B-0044",
    "on_behalf_of": null,
    "parent": {
        "quote_details": null,
        "subscription_details": {
            "metadata": [],
            "subscription": "sub_1RO5MDP71JLI6sb9V5sdUJ8V"
        },
        "type": "subscription_details"
    },
    "payment_settings": {
        "default_mandate": null,
        "payment_method_options": {
            "acss_debit": null,
            "bancontact": null,
            "card": {
                "request_three_d_secure": "automatic"
            },
            "customer_balance": null,
            "konbini": null,
            "sepa_debit": null,
            "us_bank_account": null
        },
        "payment_method_types": [
            "card"
        ]
    },
    "period_end": 1747090919,
    "period_start": 1747090919,
    "post_payment_credit_notes_amount": 0,
    "pre_payment_credit_notes_amount": 0,
    "receipt_number": null,
    "rendering": null,
    "shipping_cost": null,
    "shipping_details": null,
    "starting_balance": 0,
    "statement_descriptor": null,
    "status": "paid",
    "status_transitions": {
        "finalized_at": 1747090919,
        "marked_uncollectible_at": null,
        "paid_at": 1747090920,
        "voided_at": null
    },
    "subtotal": 300,
    "subtotal_excluding_tax": 300,
    "test_clock": null,
    "total": 300,
    "total_discount_amounts": [],
    "total_excluding_tax": 300,
    "total_pretax_credit_amounts": [],
    "total_taxes": [],
    "webhooks_delivered_at": null
}
                                            </code></pre>
                            </div>
                        </div>

                        <!-- invoice.paid -->
                        <div class="event-details mb-4">
                            <h5><code>invoice.paid</code></h5>
                            <div class="alert alert-success">
                                <i class="fas fa-file-invoice-dollar"></i> <strong>Descripción:</strong> Se dispara cuando se paga una factura con éxito. Este <strong>evento es crucial</strong> para confirmar pagos recurrentes de suscripciones y actualizar el estado de las suscripciones en el sistema.
                            </div>
                            <p>
                                El payload contiene toda la información sobre la factura pagada, incluyendo:
                            </p>
                            <ul>
                                <li>Detalles de los elementos facturados (<code>lines</code>)</li>
                                <li>Enlaces a la <strong>factura en línea y PDF</strong> (<code>hosted_invoice_url</code>, <code>invoice_pdf</code>)</li>
                                <li>Información del periodo facturado (<code>period_start</code>, <code>period_end</code>)</li>
                                <li>Información del cliente y suscripción asociada</li>
                            </ul>

                            <p><strong>Payload de Ejemplo (para factura de suscripción):</strong></p>
                            <div class="code-snippet">
                                            <pre><code class="language-json">
{
    "id": "in_1RO5QgP71JLI6sb9HSRdDSiW",
    "object": "invoice",
    "account_country": "ES",
    "account_name": "Stripe Lab App",
    "account_tax_ids": null,
    "amount_due": 1500,
    "amount_overpaid": 0,
    "amount_paid": 1500,
    "amount_remaining": 0,
    "amount_shipping": 0,
    "application": null,
    "attempt_count": 0,
    "attempted": true,
    "auto_advance": false,
    "automatic_tax": {
        "disabled_reason": null,
        "enabled": false,
        "liability": null,
        "provider": null,
        "status": null
    },
    "automatically_finalizes_at": null,
    "billing_reason": "subscription_create",
    "collection_method": "charge_automatically",
    "created": 1747091196,
    "currency": "eur",
    "custom_fields": null,
    "customer": "cus_SIgoJvUF0ooe7U",
    "customer_address": {
        "city": null,
        "country": "ES",
        "line1": null,
        "line2": null,
        "postal_code": null,
        "state": null
    },
    "customer_email": "TESTanual@TEST.COM",
    "customer_name": "suscripcion anual",
    "customer_phone": null,
    "customer_shipping": null,
    "customer_tax_exempt": "none",
    "customer_tax_ids": [],
    "default_payment_method": null,
    "default_source": null,
    "default_tax_rates": [],
    "description": null,
    "discounts": [],
    "due_date": null,
    "effective_at": 1747091196,
    "ending_balance": 0,
    "footer": null,
    "from_invoice": null,
    "hosted_invoice_url": "https://invoice.stripe.com/i/acct_1RHJ61P71JLI6sb9/test_YWNjdF8xUkhKNjFQNzFKTEk2c2I5LF9TSWdvcVFJOGI2ZkQ2ZXRSV0IycE53YVczVGQwS2lkLDEzNzYzMTk5OQ02004O5XAkp5?s=ap",
    "invoice_pdf": "https://pay.stripe.com/invoice/acct_1RHJ61P71JLI6sb9/test_YWNjdF8xUkhKNjFQNzFKTEk2c2I5LF9TSWdvcVFJOGI2ZkQ2ZXRSV0IycE53YVczVGQwS2lkLDEzNzYzMTk5OQ02004O5XAkp5/pdf?s=ap",
    "issuer": {
        "type": "self"
    },
    "last_finalization_error": null,
    "latest_revision": null,
    "lines": {
        "object": "list",
        "data": [
            {
                "id": "il_1RO5QgP71JLI6sb9L5auB3lj",
                "object": "line_item",
                "amount": 1500,
                "currency": "eur",
                "description": "1 × Test App (at €15.00 / year)",
                "discount_amounts": [],
                "discountable": true,
                "discounts": [],
                "invoice": "in_1RO5QgP71JLI6sb9HSRdDSiW",
                "livemode": false,
                "metadata": [],
                "parent": {
                    "invoice_item_details": null,
                    "subscription_item_details": {
                        "invoice_item": null,
                        "proration": false,
                        "proration_details": {
                            "credited_items": null
                        },
                        "subscription": "sub_1RO5QfP71JLI6sb9EKIosSQS",
                        "subscription_item": "si_SIgoQLiytr2oW7"
                    },
                    "type": "subscription_item_details"
                },
                "period": {
                    "end": 1778627196,
                    "start": 1747091196
                },
                "pretax_credit_amounts": [],
                "pricing": {
                    "price_details": {
                        "price": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                        "product": "prod_SFsxoaHLKoYbKj"
                    },
                    "type": "price_details",
                    "unit_amount_decimal": "1500"
                },
                "quantity": 1,
                "taxes": []
            }
        ],
        "has_more": false,
        "total_count": 1,
        "url": "/v1/invoices/in_1RO5QgP71JLI6sb9HSRdDSiW/lines"
    },
    "livemode": false,
    "metadata": [],
    "next_payment_attempt": null,
    "number": "98CD073B-0046",
    "on_behalf_of": null,
    "parent": {
        "quote_details": null,
        "subscription_details": {
            "metadata": [],
            "subscription": "sub_1RO5QfP71JLI6sb9EKIosSQS"
        },
        "type": "subscription_details"
    },
    "payment_settings": {
        "default_mandate": null,
        "payment_method_options": {
            "acss_debit": null,
            "bancontact": null,
            "card": {
                "request_three_d_secure": "automatic"
            },
            "customer_balance": null,
            "konbini": null,
            "sepa_debit": null,
            "us_bank_account": null
        },
        "payment_method_types": [
            "card"
        ]
    },
    "period_end": 1747091196,
    "period_start": 1747091196,
    "post_payment_credit_notes_amount": 0,
    "pre_payment_credit_notes_amount": 0,
    "receipt_number": null,
    "rendering": null,
    "shipping_cost": null,
    "shipping_details": null,
    "starting_balance": 0,
    "statement_descriptor": null,
    "status": "paid",
    "status_transitions": {
        "finalized_at": 1747091196,
        "marked_uncollectible_at": null,
        "paid_at": 1747091196,
        "voided_at": null
    },
    "subtotal": 1500,
    "subtotal_excluding_tax": 1500,
    "test_clock": null,
    "total": 1500,
    "total_discount_amounts": [],
    "total_excluding_tax": 1500,
    "total_pretax_credit_amounts": [],
    "total_taxes": [],
    "webhooks_delivered_at": null
}
                                            </code></pre>
                            </div>

                            <div class="mt-3 alert alert-info">
                                <i class="fas fa-lightbulb"></i> <strong>Implementación en StripeLabApp:</strong> Se ha utilizado este evento para actualizar los registros de pago y poder visualizar los recibos de los clientes.
                            </div>
                        </div>

                        <!-- Other invoice events (brief mention) -->
                        <div class="event-details">
                            <h5>Otros eventos de facturación</h5>
                            <div class="alert alert-secondary">
                                <i class="fas fa-list-ul"></i> <strong>Descripción:</strong> Stripe genera varios eventos adicionales relacionados con facturas que pueden ser útiles en casos específicos:
                                <ul>
                                    <li><code>invoice.payment_failed</code>: Se dispara cuando falla el pago de una factura. Útil para notificar a los clientes y gestionar reintentos.</li>
                                    <li><code>invoice.finalized</code>: Se dispara cuando una factura se finaliza y está lista para ser pagada.</li>
                                    <li><code>invoice.upcoming</code>: Se dispara una hora antes de que Stripe genere una factura próxima. Útil para realizar validaciones previas.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subscription Events -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Suscripciones (Subscriptions)</h5>
                    </div>
                    <div class="card-body">
                        <p>
                            Los eventos de suscripciones son fundamentales para gestionar el ciclo de vida de las suscripciones, desde la creación hasta la cancelación.
                        </p>

                        <!-- customer.subscription.created -->
                        <div class="event-details mb-4">
                            <h5><code>customer.subscription.created</code></h5>
                            <div class="alert alert-success">
                                <i class="fas fa-calendar-check"></i> <strong>Descripción:</strong> Se dispara cuando se crea una nueva suscripción para un cliente, generalmente después de un pago exitoso mediante Checkout o cuando se crea mediante API.
                            </div>
                            <p>
                                El payload contiene toda la información sobre la nueva suscripción, incluyendo:
                            </p>
                            <ul>
                                <li>El plan y precio asociados (<code>plan</code>, <code>items</code>)</li>
                                <li>Datos del ciclo de facturación (<code>billing_cycle_anchor</code>, <code>current_period_start</code>, <code>current_period_end</code>)</li>
                                <li>El estado de la suscripción (<code>status</code>)</li>
                                <li>El método de pago predeterminado (<code>default_payment_method</code>)</li>
                            </ul>

                            <p><strong>Payload de Ejemplo:</strong></p>
                            <div class="code-snippet">
                                            <pre><code class="language-json">
{
    "id": "sub_1RO5QfP71JLI6sb9EKIosSQS",
    "object": "subscription",
    "application": null,
    "application_fee_percent": null,
    "automatic_tax": {
        "disabled_reason": null,
        "enabled": false,
        "liability": null
    },
    "billing_cycle_anchor": 1747091196,
    "billing_cycle_anchor_config": null,
    "cancel_at": null,
    "cancel_at_period_end": false,
    "canceled_at": null,
    "cancellation_details": {
        "comment": null,
        "feedback": null,
        "reason": null
    },
    "collection_method": "charge_automatically",
    "created": 1747091196,
    "currency": "eur",
    "customer": "cus_SIgoJvUF0ooe7U",
    "days_until_due": null,
    "default_payment_method": "pm_1RO5QdP71JLI6sb9E6WLHpfW",
    "default_source": null,
    "default_tax_rates": [],
    "description": null,
    "discounts": [],
    "ended_at": null,
    "invoice_settings": {
        "account_tax_ids": null,
        "issuer": {
            "type": "self"
        }
    },
    "items": {
        "object": "list",
        "data": [
            {
                "id": "si_SIgoQLiytr2oW7",
                "object": "subscription_item",
                "created": 1747091196,
                "current_period_end": 1778627196,
                "current_period_start": 1747091196,
                "discounts": [],
                "metadata": [],
                "plan": {
                    "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                    "object": "plan",
                    "active": true,
                    "amount": 1500,
                    "amount_decimal": "1500",
                    "billing_scheme": "per_unit",
                    "created": 1746447117,
                    "currency": "eur",
                    "interval": "year",
                    "interval_count": 1,
                    "livemode": false,
                    "metadata": [],
                    "meter": null,
                    "nickname": "Annual payment of the Test Surlabs product",
                    "product": "prod_SFsxoaHLKoYbKj",
                    "tiers_mode": null,
                    "transform_usage": null,
                    "trial_period_days": null,
                    "usage_type": "licensed"
                },
                "price": {
                    "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                    "object": "price",
                    "active": true,
                    "billing_scheme": "per_unit",
                    "created": 1746447117,
                    "currency": "eur",
                    "custom_unit_amount": null,
                    "livemode": false,
                    "lookup_key": "annual_payment",
                    "metadata": [],
                    "nickname": "Annual payment of the Test Surlabs product",
                    "product": "prod_SFsxoaHLKoYbKj",
                    "recurring": {
                        "interval": "year",
                        "interval_count": 1,
                        "meter": null,
                        "trial_period_days": null,
                        "usage_type": "licensed"
                    },
                    "tax_behavior": "unspecified",
                    "tiers_mode": null,
                    "transform_quantity": null,
                    "type": "recurring",
                    "unit_amount": 1500,
                    "unit_amount_decimal": "1500"
                },
                "quantity": 1,
                "subscription": "sub_1RO5QfP71JLI6sb9EKIosSQS",
                "tax_rates": []
            }
        ],
        "has_more": false,
        "total_count": 1,
        "url": "/v1/subscription_items?subscription=sub_1RO5QfP71JLI6sb9EKIosSQS"
    },
    "latest_invoice": "in_1RO5QgP71JLI6sb9HSRdDSiW",
    "livemode": false,
    "metadata": [],
    "next_pending_invoice_item_invoice": null,
    "on_behalf_of": null,
    "pause_collection": null,
    "payment_settings": {
        "payment_method_options": {
            "acss_debit": null,
            "bancontact": null,
            "card": {
                "network": null,
                "request_three_d_secure": "automatic"
            },
            "customer_balance": null,
            "konbini": null,
            "sepa_debit": null,
            "us_bank_account": null
        },
        "payment_method_types": [
            "card"
        ],
        "save_default_payment_method": "off"
    },
    "pending_invoice_item_interval": null,
    "pending_setup_intent": null,
    "pending_update": null,
    "plan": {
        "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
        "object": "plan",
        "active": true,
        "amount": 1500,
        "amount_decimal": "1500",
        "billing_scheme": "per_unit",
        "created": 1746447117,
        "currency": "eur",
        "interval": "year",
        "interval_count": 1,
        "livemode": false,
        "metadata": [],
        "meter": null,
        "nickname": "Annual payment of the Test Surlabs product",
        "product": "prod_SFsxoaHLKoYbKj",
        "tiers_mode": null,
        "transform_usage": null,
        "trial_period_days": null,
        "usage_type": "licensed"
    },
    "quantity": 1,
    "schedule": null,
    "start_date": 1747091196,
    "status": "active",
    "test_clock": null,
    "transfer_data": null,
    "trial_end": null,
    "trial_settings": {
        "end_behavior": {
            "missing_payment_method": "create_invoice"
        }
    },
    "trial_start": null
}
                                            </code></pre>
                            </div>

                            <div class="mt-3 alert alert-info">
                                <i class="fas fa-lightbulb"></i> <strong>Implementación en StripeLabApp:</strong> Se ha utlizado este evento para crear un nuevo registro de suscripción en nuestra base de datos.
                            </div>
                        </div>

                        <!-- customer.subscription.updated -->
                        <div class="event-details mb-4">
                            <h5><code>customer.subscription.updated</code></h5>
                            <div class="alert alert-info">
                                <i class="fas fa-sync"></i> <strong>Descripción:</strong> Se dispara cuando se actualiza algún aspecto de la suscripción, como el plan, la cantidad, el método de pago, o cuando se programa una cancelación futura mediante <code>cancel_at_period_end</code>.
                            </div>
                            <p>
                                Este evento es particularmente importante para detectar:
                            </p>
                            <ul>
                                <li>Cambios de plan (actualizaciones/degradaciones)</li>
                                <li>Cancelaciones programadas (<code>cancel_at_period_end: true</code>)</li>
                                <li>Cambios en el estado de la suscripción (<code>status</code>)</li>
                                <li>Actualizaciones del método de pago</li>
                            </ul>

                            <p><strong>Payload de Ejemplo (para <code>cancel_at_period_end</code>):</strong></p>
                            <div class="code-snippet">
                                            <pre><code class="language-json">
{
    "id": "sub_1RO5PaP71JLI6sb9JeUmU3lZ",
    "object": "subscription",
    "application": null,
    "application_fee_percent": null,
    "automatic_tax": {
        "disabled_reason": null,
        "enabled": false,
        "liability": null
    },
    "billing_cycle_anchor": 1747091129,
    "billing_cycle_anchor_config": null,
    "cancel_at": 1778627129,
    "cancel_at_period_end": true,
    "canceled_at": 1747091360,
    "cancellation_details": {
        "comment": null,
        "feedback": null,
        "reason": "cancellation_requested"
    },
    "collection_method": "charge_automatically",
    "created": 1747091129,
    "currency": "eur",
    "customer": "cus_SIgnD5ZnJtFkKF",
    "days_until_due": null,
    "default_payment_method": "pm_1RO5PYP71JLI6sb9WmxI8bzK",
    "default_source": null,
    "default_tax_rates": [],
    "description": null,
    "discounts": [],
    "ended_at": null,
    "invoice_settings": {
        "account_tax_ids": null,
        "issuer": {
            "type": "self"
        }
    },
    "items": {
        "object": "list",
        "data": [
            {
                "id": "si_SIgnlukijBew1r",
                "object": "subscription_item",
                "created": 1747091129,
                "current_period_end": 1778627129,
                "current_period_start": 1747091129,"discounts": [],
                "metadata": [],
                "plan": {
                    "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                    "object": "plan",
                    "active": true,
                    "amount": 1500,
                    "amount_decimal": "1500",
                    "billing_scheme": "per_unit",
                    "created": 1746447117,
                    "currency": "eur",
                    "interval": "year",
                    "interval_count": 1,
                    "livemode": false,
                    "metadata": [],
                    "meter": null,
                    "nickname": "Annual payment of the Test Surlabs product",
                    "product": "prod_SFsxoaHLKoYbKj",
                    "tiers_mode": null,
                    "transform_usage": null,
                    "trial_period_days": null,
                    "usage_type": "licensed"
                },
                "price": {
                    "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                    "object": "price",
                    "active": true,
                    "billing_scheme": "per_unit",
                    "created": 1746447117,
                    "currency": "eur",
                    "custom_unit_amount": null,
                    "livemode": false,
                    "lookup_key": "annual_payment",
                    "metadata": [],
                    "nickname": "Annual payment of the Test Surlabs product",
                    "product": "prod_SFsxoaHLKoYbKj",
                    "recurring": {
                        "interval": "year",
                        "interval_count": 1,
                        "meter": null,
                        "trial_period_days": null,
                        "usage_type": "licensed"
                    },
                    "tax_behavior": "unspecified",
                    "tiers_mode": null,
                    "transform_quantity": null,
                    "type": "recurring",
                    "unit_amount": 1500,
                    "unit_amount_decimal": "1500"
                },
                "quantity": 1,
                "subscription": "sub_1RO5PaP71JLI6sb9JeUmU3lZ",
                "tax_rates": []
            }
        ],
        "has_more": false,
        "total_count": 1,
        "url": "/v1/subscription_items?subscription=sub_1RO5PaP71JLI6sb9JeUmU3lZ"
    },
    "latest_invoice": "in_1RO5PaP71JLI6sb9hSZVU0YK",
    "livemode": false,
    "metadata": [],
    "next_pending_invoice_item_invoice": null,
    "on_behalf_of": null,
    "pause_collection": null,
    "payment_settings": {
        "payment_method_options": {
            "acss_debit": null,
            "bancontact": null,
            "card": {
                "network": null,
                "request_three_d_secure": "automatic"
            },
            "customer_balance": null,
            "konbini": null,
            "sepa_debit": null,
            "us_bank_account": null
        },
        "payment_method_types": [
            "card"
        ],
        "save_default_payment_method": "off"
    },
    "pending_invoice_item_interval": null,
    "pending_setup_intent": null,
    "pending_update": null,
    "plan": {
        "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
        "object": "plan",
        "active": true,
        "amount": 1500,
        "amount_decimal": "1500",
        "billing_scheme": "per_unit",
        "created": 1746447117,
        "currency": "eur",
        "interval": "year",
        "interval_count": 1,
        "livemode": false,
        "metadata": [],
        "meter": null,
        "nickname": "Annual payment of the Test Surlabs product",
        "product": "prod_SFsxoaHLKoYbKj",
        "tiers_mode": null,
        "transform_usage": null,
        "trial_period_days": null,
        "usage_type": "licensed"
    },
    "quantity": 1,
    "schedule": null,
    "start_date": 1747091129,
    "status": "active",
    "test_clock": null,
    "transfer_data": null,
    "trial_end": null,
    "trial_settings": {
        "end_behavior": {
            "missing_payment_method": "create_invoice"
        }
    },
    "trial_start": null
}
                                            </code></pre>
                            </div>

                            <div class="mt-3 alert alert-info">
                                <i class="fas fa-lightbulb"></i> <strong>Implementación en StripeLabApp:</strong> Este evento desencadena actualizaciones en nuestros registros de suscripción, concretamente se ha utilizado para indicarnos de manera ficticia que cancela la suscripción que actualmente disfruta al final del periodo de la misma.
                            </div>
                        </div>

                        <!-- customer.subscription.deleted -->
                        <div class="event-details mb-4">
                            <h5><code>customer.subscription.deleted</code></h5>
                            <div class="alert alert-danger">
                                <i class="fas fa-calendar-times"></i> <strong>Descripción:</strong> Se dispara cuando una suscripción es cancelada inmediatamente (no al final del periodo). Este evento indica que la suscripción ha finalizado y el cliente ya no tiene acceso a los servicios.
                            </div>
                            <p>
                                Es importante diferenciar entre:
                            </p>
                            <ul>
                                <li>Cancelación inmediata: genera este evento y el campo <code>status</code> cambia a "canceled"</li>
                                <li>Cancelación al final del periodo: genera primero un evento <code>customer.subscription.updated</code> con <code>cancel_at_period_end: true</code> y posteriormente, al llegar el final del periodo, un evento <code>customer.subscription.deleted</code></li>
                            </ul>

                            <p><strong>Payload de Ejemplo (cancelación inmediata):</strong></p>
                            <div class="code-snippet">
                                            <pre><code class="language-json">
{
    "id": "sub_1RO5QfP71JLI6sb9EKIosSQS",
    "object": "subscription",
    "application": null,
    "application_fee_percent": null,
    "automatic_tax": {
        "disabled_reason": null,
        "enabled": false,
        "liability": null
    },
    "billing_cycle_anchor": 1747091196,
    "billing_cycle_anchor_config": null,
    "cancel_at": null,
    "cancel_at_period_end": false,
    "canceled_at": 1747091349,
    "cancellation_details": {
        "comment": null,
        "feedback": null,
        "reason": "cancellation_requested"
    },
    "collection_method": "charge_automatically",
    "created": 1747091196,
    "currency": "eur",
    "customer": "cus_SIgoJvUF0ooe7U",
    "days_until_due": null,
    "default_payment_method": "pm_1RO5QdP71JLI6sb9E6WLHpfW",
    "default_source": null,
    "default_tax_rates": [],
    "description": null,
    "discounts": [],
    "ended_at": 1747091349,
    "invoice_settings": {
        "account_tax_ids": null,
        "issuer": {
            "type": "self"
        }
    },
    "items": {
        "object": "list",
        "data": [
            {
                "id": "si_SIgoQLiytr2oW7",
                "object": "subscription_item",
                "created": 1747091196,
                "current_period_end": 1778627196,
                "current_period_start": 1747091196,
                "discounts": [],
                "metadata": [],
                "plan": {
                    "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                    "object": "plan",
                    "active": true,
                    "amount": 1500,
                    "amount_decimal": "1500",
                    "billing_scheme": "per_unit",
                    "created": 1746447117,
                    "currency": "eur",
                    "interval": "year",
                    "interval_count": 1,
                    "livemode": false,
                    "metadata": [],
                    "meter": null,
                    "nickname": "Annual payment of the Test Surlabs product",
                    "product": "prod_SFsxoaHLKoYbKj",
                    "tiers_mode": null,
                    "transform_usage": null,
                    "trial_period_days": null,
                    "usage_type": "licensed"
                },
                "price": {
                    "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                    "object": "price",
                    "active": true,
                    "billing_scheme": "per_unit",
                    "created": 1746447117,
                    "currency": "eur",
                    "custom_unit_amount": null,
                    "livemode": false,
                    "lookup_key": "annual_payment",
                    "metadata": [],
                    "nickname": "Annual payment of the Test Surlabs product",
                    "product": "prod_SFsxoaHLKoYbKj",
                    "recurring": {
                        "interval": "year",
                        "interval_count": 1,
                        "meter": null,
                        "trial_period_days": null,
                        "usage_type": "licensed"
                    },
                    "tax_behavior": "unspecified",
                    "tiers_mode": null,
                    "transform_quantity": null,
                    "type": "recurring",
                    "unit_amount": 1500,
                    "unit_amount_decimal": "1500"
                },
                "quantity": 1,
                "subscription": "sub_1RO5QfP71JLI6sb9EKIosSQS",
                "tax_rates": []
            }
        ],
        "has_more": false,
        "total_count": 1,
        "url": "/v1/subscription_items?subscription=sub_1RO5QfP71JLI6sb9EKIosSQS"
    },
    "latest_invoice": "in_1RO5QgP71JLI6sb9HSRdDSiW",
    "livemode": false,
    "metadata": [],
    "next_pending_invoice_item_invoice": null,
    "on_behalf_of": null,
    "pause_collection": null,
    "payment_settings": {
        "payment_method_options": {
            "acss_debit": null,
            "bancontact": null,
            "card": {
                "network": null,
                "request_three_d_secure": "automatic"
            },
            "customer_balance": null,
            "konbini": null,
            "sepa_debit": null,
            "us_bank_account": null
        },
        "payment_method_types": [
            "card"
        ],
        "save_default_payment_method": "off"
    },
    "pending_invoice_item_interval": null,
    "pending_setup_intent": null,
    "pending_update": null,
    "plan": {
        "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
        "object": "plan",
        "active": true,
        "amount": 1500,
        "amount_decimal": "1500",
        "billing_scheme": "per_unit",
        "created": 1746447117,
        "currency": "eur",
        "interval": "year",
        "interval_count": 1,
        "livemode": false,
        "metadata": [],
        "meter": null,
        "nickname": "Annual payment of the Test Surlabs product",
        "product": "prod_SFsxoaHLKoYbKj",
        "tiers_mode": null,
        "transform_usage": null,
        "trial_period_days": null,
        "usage_type": "licensed"
    },
    "quantity": 1,
    "schedule": null,
    "start_date": 1747091196,
    "status": "canceled",
    "test_clock": null,
    "transfer_data": null,
    "trial_end": null,
    "trial_settings": {
        "end_behavior": {
            "missing_payment_method": "create_invoice"
        }
    },
    "trial_start": null
}
                                            </code></pre>
                            </div>

                            <div class="mt-3 alert alert-info">
                                <i class="fas fa-lightbulb"></i> <strong>Implementación en StripeLabApp:</strong> Este evento desencadena la actualización de estado de suscripción en nuestra base de datos. A diferencia del anterior este evento provoca la cancelación inmediata de la suscripción.
                            </div>
                        </div>

                        <!-- customer.subscription.trial_will_end (brief mention) -->
                        <div class="event-details">
                            <h5><code>customer.subscription.trial_will_end</code></h5>
                            <div class="alert alert-warning">
                                <i class="fas fa-hourglass-end"></i> <strong>Descripción:</strong> Se dispara tres días antes de que finalice el periodo de prueba de una suscripción. Este evento permite notificar proactivamente a los usuarios que su tarjeta será cobrada pronto, reduciendo las sorpresas y posibles disputas.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product and Price Events -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Productos y Precios (Informativo)</h5>
                    </div>
                    <div class="card-body">
                        <p>
                            Los eventos de Productos y Precios generalmente no se procesan activamente en la mayoría de las aplicaciones, ya que estos objetos suelen gestionarse manualmente a través del panel de control de Stripe o mediante scripts de configuración.
                        </p>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> <strong>Eventos disponibles:</strong>
                            <ul>
                                <li><code>product.created</code> y <code>product.updated</code>: Se disparan cuando se crea o actualiza un producto en Stripe.</li>
                                <li><code>price.created</code> y <code>price.updated</code>: Se disparan cuando se crea o actualiza un precio en Stripe.</li>
                            </ul>
                            <p>En StripeLabApp, no se procesan estos eventos, ya que nuestros "productos" y precios se han configurado manualmente en el dashboard de Stripe. Sin embargo, supongo deberemos utilizarlos para que los clientes puedan crear productos desde ILIAS sin salir de la plataforma.</p>
                        </div>
                    </div>
                </div>


    <div id="orden-eventos" class="subsection">
        <h4>3.4. Orden de los Eventos y Flujos Comunes</h4>
        <p>
            Stripe envía eventos en el orden en que ocurren en su sistema, pero debido a la naturaleza asíncrona de los webhooks, es importante diseñar el futuro plugin con capacidad para manejar eventos que puedan llegar en cualquier orden o incluso duplicados.
        </p>

        <p>
            A continuación, se muestran los flujos de eventos más comunes en Stripe, pero... <strong>IMPORTANTE!</strong> estos diagramas representan el orden <em>habitual</em>, pero pueden llegar de otro modo.
        </p>

        <!-- Flujo de Nueva Suscripción -->
        <div class="card mb-4">
            <div class="card-header">
                <strong>Flujo de Eventos: Nueva Suscripción</strong>
            </div>
            <div class="card-body">
                <p>Este flujo representa el proceso completo desde que un cliente selecciona un plan de suscripción hasta que se confirma y activa la suscripción.</p>

                <div class="mermaid-diagram">
                                        <pre class="mermaid">
                                            sequenceDiagram
                                                participant User
                                                participant FrontendApp as StripeLabApp Frontend
                                                participant BackendApp as StripeLabApp Backend
                                                participant Stripe
                                                User->>FrontendApp: Selecciona Plan de Suscripción
                                                FrontendApp->>BackendApp: Solicita crear Checkout Session (via /v1/create_subscription_session.php)
                                                BackendApp->>Stripe: POST /v1/checkout/sessions
                                                Stripe-->>BackendApp: Checkout Session ID
                                                BackendApp-->>FrontendApp: Checkout Session ID
                                                FrontendApp->>Stripe: redirectToCheckout(sessionId)
                                                User->>Stripe: Completa Formulario de Pago
                                                Stripe-->>User: Redirige a success_url
                                                Stripe-->>BackendApp: Webhook: checkout.session.completed
                                                Stripe-->>BackendApp: Webhook: customer.created (si nuevo)
                                                Stripe-->>BackendApp: Webhook: payment_intent.succeeded (pago inicial)
                                                Stripe-->>BackendApp: Webhook: invoice.paid (primera factura)
                                                Stripe-->>BackendApp: Webhook: customer.subscription.created
                                                BackendApp->>BackendApp: Procesa eventos con Estrategias
                                                BackendApp->>Database: Guarda/Actualiza Suscripción y Transacción
                                        </pre>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-lightbulb"></i> <strong>Consejo:</strong> En StripeLabApp, el evento <code>checkout.session.completed</code> se utiliza como punto de entrada principal para activar la suscripción, mientras que los demás eventos se utilizan para actualizar información adicional y confirmar el estado.
                </div>
            </div>
        </div>

        <!-- Flujo de Pago Único -->
        <div class="card mb-4">
            <div class="card-header">
                <strong>Flujo de Eventos: Pago Único</strong>
            </div>
            <div class="card-body">
                <p>Este flujo representa el proceso de un pago único, desde la selección del producto hasta la confirmación de la transacción.</p>

                <div class="mermaid-diagram">
                                        <pre class="mermaid">
sequenceDiagram
    participant User
    participant FrontendApp as StripeLabApp Frontend
    participant BackendApp as StripeLabApp Backend
    participant Stripe
    User->>FrontendApp: Selecciona Producto Pago Único
    FrontendApp->>BackendApp: Solicita crear Checkout Session (via /v1/create_payment_session.php)
    BackendApp->>Stripe: POST /v1/checkout/sessions
    Stripe-->>BackendApp: Checkout Session ID
    BackendApp-->>FrontendApp: Checkout Session ID
    FrontendApp->>Stripe: redirectToCheckout(sessionId)
    User->>Stripe: Completa Formulario de Pago
    Stripe-->>User: Redirige a success_url
    Stripe-->>BackendApp: Webhook: checkout.session.completed
    Stripe-->>BackendApp: Webhook: payment_intent.succeeded
    Stripe-->>BackendApp: Webhook: charge.succeeded
    BackendApp->>BackendApp: Procesa eventos con Estrategias
    BackendApp->>Database: Guarda Transacción
                                        </pre>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-lightbulb"></i> <strong>Consejo:</strong> En los pagos únicos, utilizamos el evento <code>checkout.session.completed</code> como principal desencadenante para registrar la transacción y proporcionar acceso al producto o servicio, mientras que <code>charge.succeeded</code> se utiliza para obtener el <code>receipt_url</code> y otros detalles específicos del cargo.
                </div>
            </div>
        </div>

    </div>
    </section>

    <!-- Sección 4 - Stripe CLI -->
    <section id="stripecli" class="mb-4">
        <h3>4. Stripe CLI: Herramienta Esencial para Desarrollo y Pruebas</h3>

        <div id="que-es-stripecli" class="subsection">
            <h4>4.1. ¿Qué es Stripe CLI y por qué es útil?</h4>
            <p>
                Stripe CLI (Command Line Interface) es una herramienta oficial de Stripe que simplifica significativamente el desarrollo y las pruebas de integraciones con Stripe, especialmente cuando se trabaja con webhooks.
            </p>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <strong>Funcionalidades principales</strong>
                        </div>
                        <div class="card-body">
                            <ul>
                                <li><strong>Reenvío de webhooks:</strong> Recibe eventos de Stripe y los reenvía a tu servidor local.</li>
                                <li><strong>Activador de eventos:</strong> Genera eventos de prueba sin necesidad de realizar acciones reales en el panel.</li>
                                <li><strong>Interacción con API:</strong> Realiza llamadas a la API de Stripe directamente desde la línea de comandos.</li>
                                <li><strong>Logs en tiempo real:</strong> Visualiza y filtra los eventos que ocurren en tu cuenta de Stripe.</li>
                                <li><strong>Depuración:</strong> Diagnostica problemas comunes en la integración.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <strong>Beneficios para el desarrollo</strong>
                        </div>
                        <div class="card-body">
                            <ul>
                                <li><strong>Desarrollo local:</strong> Prueba webhooks sin exponer tu localhost a internet ni configurar túneles.</li>
                                <li><strong>Ciclo de retroalimentación rápido:</strong> Observa inmediatamente cómo tu aplicación maneja los eventos.</li>
                                <li><strong>Simulación completa:</strong> Prueba flujos completos desde el pago hasta el webhook sin procesar pagos reales.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>


            <p>
                <strong>Instalación:</strong>La instalación es sencilla:
            </p>
            <ul>
                <li><strong>macOS (con Homebrew):</strong> <code>brew install stripe/stripe-cli/stripe</code></li>
                <li><strong>Windows (con scoop):</strong> <code>scoop bucket add stripe https://github.com/stripe/scoop-stripe-cli.git</code> seguido de <code>scoop install stripe</code></li>
            </ul>

            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> <strong>Nota:</strong> Para instrucciones detalladas, visita la <a href="https://stripe.com/docs/stripe-cli" target="_blank">documentación oficial</a>.
            </div>
        </div>

        <div id="configuracion-stripecli" class="subsection">
            <h4>4.2. Configuración y Autenticación</h4>
            <p>
                Antes de poder utilizar Stripe CLI, necesitas autenticarte con tu cuenta de Stripe.
            </p>

            <div class="card mb-4">
                <div class="card-header">
                    <strong>Proceso de autenticación</strong>
                </div>
                <div class="card-body">
                    <ol>
                        <li>
                            <strong>Iniciar el proceso de login:</strong>
                            <p>Ejecuta el siguiente comando en tu terminal:</p>
                            <div class="code-snippet">
                                <pre><code class="language-bash">stripe login</code></pre>
                            </div>
                        </li>
                        <li>
                            <strong>Autorizar en el navegador:</strong>
                            <p>Se abrirá una página en tu navegador donde deberás autorizar a Stripe CLI para acceder a tu cuenta.</p>
                        </li>
                        <li>
                            <strong>Verificar la conexión:</strong>
                            <p>Una vez autorizado, verás un mensaje de confirmación en la terminal y puedes verificar la conexión con:</p>
                            <div class="code-snippet">
                                <pre><code class="language-bash">stripe status</code></pre>
                            </div>
                        </li>
                    </ol>

                    <div class="alert alert-warning">
                        <i class="fas fa-lock"></i> <strong>Seguridad:</strong> La autenticación genera un par de claves API restringidas que se almacenan localmente. Estas claves tienen permisos limitados y expiran después de 90 días, por lo que deberemos volver a ejecutar <code>stripe login</code> periódicamente.
                    </div>
                </div>
            </div>

            <p>
                <strong>Configuración del modo (test/live):</strong> Por defecto, Stripe CLI opera en modo de prueba (<code>test</code>). Se puede cambiar el modo con los modificadores <code>--test</code> o <code>--live</code> en cualquier comando, o configurar el modo predeterminado:
            </p>

            <div class="code-snippet">
                <pre><code class="language-bash"># Establecer modo por defecto
stripe config set default_mode test

# Verificar configuración actual
stripe config list</code></pre>
            </div>

            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> <strong>Precaución:</strong> Utiliza el modo <code>live</code> con extrema precaución, ya que afectará a transacciones reales y datos de clientes en producción.
            </div>
        </div>

        <div id="reenvio-webhooks" class="subsection">
            <h4>4.3. Reenvío de Webhooks y Pruebas Locales</h4>
            <p>
                La funcionalidad más potente de Stripe CLI es su capacidad para reenviar webhooks de Stripe a tu servidor local, eliminando la necesidad de exponer tu entorno de desarrollo a internet o configurar túneles complejos.
            </p>

            <div class="card mb-4">
                <div class="card-header">
                    <strong>Iniciar el reenvío de webhooks</strong>
                </div>
                <div class="card-body">
                    <p>El comando básico para iniciar el reenvío es:</p>
                    <div class="code-snippet">
                        <pre><code class="language-bash">stripe listen --forward-to http://localhost:8000/public/v1/webhook.php</code></pre>
                    </div>

                    <p>
                        Esto inicia un proceso que:
                    </p>
                    <ol>
                        <li>Se suscribe a todos los eventos de tu cuenta de Stripe en modo de prueba.</li>
                        <li>Recibe los eventos en tiempo real cuando ocurren.</li>
                        <li>Reenvía cada evento a la URL especificada en tu servidor local.</li>
                    </ol>

                    <div class="alert alert-success mt-3">
                        <i class="fas fa-key"></i> <strong>Webhook signing secret:</strong> Al iniciar el reenvío, Stripe CLI genera automáticamente un secreto de firma (signing secret) y lo muestra en la terminal. Debe utilizarse en tu aplicación para verificar que las solicitudes son realmente de Stripe CLI.
                    </div>

                    <p><strong>Opciones útiles para el reenvío:</strong></p>
                    <ul>
                        <li><code>--events="payment_intent.succeeded,customer.subscription.created"</code>: Filtra para recibir solo eventos específicos.</li>
                        <li><code>--skip-verify</code>: Omite la verificación de SSL (útil para certificados autofirmados).</li>
                        <li><code>--latest</code>: Solo reenvía el evento más reciente de cada tipo.</li>
                        <li><code>--log-level=debug</code>: Muestra información detallada para depuración.</li>
                    </ul>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <strong>Simulación de eventos</strong>
                </div>
                <div class="card-body">
                    <p>
                        Stripe CLI también te permite simular eventos de webhook sin necesidad de realizar acciones reales en el panel de control. Esto es extremadamente útil para probar cómo la aplicación maneja diferentes escenarios sin procesar pagos de prueba.
                    </p>

                    <p><strong>Comando para activar eventos:</strong></p>
                    <div class="code-snippet">
                        <pre><code class="language-bash"># Estructura general
stripe trigger [evento]

# Ejemplos específicos
stripe trigger payment_intent.succeeded
stripe trigger customer.subscription.created
stripe trigger invoice.payment_failed</code></pre>
                    </div>

                    <p>
                        Al combinar <code>stripe listen</code> en una terminal y <code>stripe trigger</code> en otra, podemos simular todo el flujo de webhooks para probar nuestra futura implementación.
                    </p>

                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb"></i> <strong>Consejo:</strong> Podemos personalizar el payload del evento con el modificador <code>--add</code>. Por ejemplo: <code>stripe trigger payment_intent.succeeded --add "payment_intent:amount=2000"</code>.
                    </div>
                </div>
            </div>

            <div class="alert alert-success mb-4">
                <i class="fas fa-check-circle"></i> <strong>Beneficio clave:</strong> El reenvío de webhooks de Stripe CLI hace que el desarrollo y la depuración sean significativamente más rápidos y eficientes, reduciendo el tiempo necesario para verificar que tu aplicación maneja correctamente los eventos de Stripe.
            </div>
        </div>

        <div id="comandos-utiles" class="subsection">
            <h4>4.4. Otros Comandos Útiles para el Desarrollo</h4>
            <p>
                Además del reenvío de webhooks, Stripe CLI ofrece una amplia gama de comandos que pueden facilitar el desarrollo y las pruebas.
            </p>

            <div class="table-responsive mb-4">
                <table class="table table-striped table-hover">
                    <thead class="table-primary">
                    <tr>
                        <th>Categoría</th>
                        <th>Comando</th>
                        <th>Descripción</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td rowspan="3"><strong>Exploración de la API</strong></td>
                        <td><code>stripe get /v1/customers</code></td>
                        <td>Lista todos los clientes en tu cuenta.</td>
                    </tr>
                    <tr>
                        <td><code>stripe get /v1/subscriptions/sub_123</code></td>
                        <td>Obtiene detalles de una suscripción específica.</td>
                    </tr>
                    <tr>
                        <td><code>stripe get /v1/events --limit=5</code></td>
                        <td>Lista los 5 eventos más recientes.</td>
                    </tr>
                    <tr>
                        <td rowspan="3"><strong>Creación y modificación</strong></td>
                        <td><code>stripe post /v1/customers -d name="Test Customer"</code></td>
                        <td>Crea un nuevo cliente.</td>
                    </tr>
                    <tr>
                        <td><code>stripe post /v1/refunds -d charge=ch_123</code></td>
                        <td>Reembolsa un cargo específico.</td>
                    </tr>
                    <tr>
                        <td><code>stripe delete /v1/customers/cus_123</code></td>
                        <td>Elimina un cliente (cuando sea posible).</td>
                    </tr>
                    <tr>
                        <td rowspan="2"><strong>Depuración</strong></td>
                        <td><code>stripe logs tail</code></td>
                        <td>Muestra los logs de la API en tiempo real.</td>
                    </tr>
                    <tr>
                        <td><code>stripe logs list</code></td>
                        <td>Lista las solicitudes recientes a la API.</td>
                    </tr>
                    <tr>
                        <td rowspan="2"><strong>Datos de prueba</strong></td>
                        <td><code>stripe fixtures</code></td>
                        <td>Crea un conjunto de objetos de prueba en tu cuenta.</td>
                    </tr>
                    <tr>
                        <td><code>stripe samples create accept-a-card-payment</code></td>
                        <td>Descarga e instala ejemplos de integración.</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> <strong>Lista completa de comandos:</strong> Puedes ver todos los comandos disponibles ejecutando <code>stripe help</code> o consultando la <a href="https://stripe.com/docs/cli/commands" target="_blank">documentación de referencia</a>.
            </div>

            <p>
                En StripeLabApp, se ha utilizado Stripe CLI principalmente para:
            </p>
            <ul>
                <li>Reenviar webhooks durante el desarrollo con <code>stripe listen</code>.</li>
                <li>Probar diferentes escenarios de evento con <code>stripe trigger</code>.</li>
                <li>Monitorear logs para depurar problemas con <code>stripe listen --forward-to localhost:8000/public/v1/webhook.php --log-level=debug</code><strong>(FUNDAMENTAL)</strong></li>
            </ul>
        </div>

        <div class="alert alert-success">
            <i class="fas fa-graduation-cap"></i> <strong>Resumen:</strong> Stripe CLI es una herramienta indispensable para los desarrolladores que trabajan con Stripe. Simplifica significativamente el desarrollo local, las pruebas de integración y la depuración, especialmente para webhooks.
        </div>
    </section>
    </section>

    <!-- PARTE II -->
    <section id="parte2" class="mb-5">
        <h2>PARTE II: Arquitectura de StripeLabApp</h2>
        <p class="lead">
            Esta sección explora la arquitectura, configuración y funcionamiento interno de StripeLabApp, aplicación de demostración para integraciones con Stripe.
        </p>

        <!-- Sección 5 -->
        <section id="introduccion-stripelabapp" class="mb-4">
            <h3>5. Introducción a StripeLabApp</h3>

            <div id="objetivos-proyecto" class="subsection">
                <h4>5.1. Objetivos del Proyecto</h4>
                <p>
                    Proyecto con vistas a comprender más a fondo como trabaja la API de Stripe y así poder obtener información para aplicarla luego a nuestro verdadero campo de trabajo.
                </p>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Objetivos principales</strong>
                    </div>
                    <div class="card-body">
                        <ul>
                            <li>
                                <strong>Entorno de aprendizaje:</strong> Proporcionar un ejemplo funcional y bien documentado para nuestros desarrolladores y así poder implementar pagos en nuestro plugin.
                            </li>
                            <li>
                                <strong>Demostración de integración completa:</strong> Mostrar cómo implementar correctamente tanto pagos únicos como suscripciones, cubriendo todo el ciclo de vida de las transacciones.
                            </li>
                            <li>
                                <strong>Gestión robusta de webhooks:</strong> Ilustrar las mejores prácticas para procesar eventos de Stripe de manera asíncrona y resiliente.
                            </li>
                            <li>
                                <strong>Arquitectura modular y extensible:</strong> Presentar una estructura de código que sea fácil de entender, mantener y ampliar con nuevas funcionalidades.
                            </li>
                            <li>
                                <strong>Referencia de implementación segura:</strong> Demostrar cómo manejar secretos, verificar firmas de webhook y seguir las recomendaciones de seguridad de dadas en la tarea.
                            </li>
                        </ul>
                    </div>
                </div>


            </div>

            <div id="funcionalidades-implementadas" class="subsection">
                <h4>5.2. Funcionalidades Implementadas</h4>
                <p>
                    StripeLabApp implementa un conjunto de funcionalidades centradas en la integración con Stripe, con énfasis en los flujos de pago más comunes y su gestión a través de webhooks.
                </p>

                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <strong>Pagos Únicos y Suscripciones</strong>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li>Páginas para pago único y para suscripciones</li>
                                    <li>Integración con Stripe para procesamiento seguro de pagos</li>
                                    <li>Manejo de eventos <code>checkout.session.completed</code> y <code>payment_intent.succeeded</code> para pagos únicos</li>
                                    <li>Procesamiento de eventos de suscripción (<code>customer.subscription.created</code>, <code>invoice.paid</code>, etc.)</li>
                                    <li>Acceso a recibos generados por Stripe</li>
                                    <li>Visualización de suscripciones activas y su estado</li>
                                    <li>Cancelación de suscripciones (inmediata o al final del periodo)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <strong>Eventos manejados</strong>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li>Eventos de Chekout<code>checkout.session.completed</code></li>
                                    <li>Eventos de Customer<code>customer.created</code><code>customer.updated</code></li>
                                    <li>Eventos de Payment Intent<code>payment_intent.succeeded</code></li>
                                    <li>Eventos de Charge<code>charge.succeeded</code></li>
                                    <li>Eventos de Suscripción<code>customer.subscription.created</code>, <code>customer.subscription.updated</code> y <code>customer.subscription.deleted</code></li>
                                    <li>Eventos de Factura<code>invoice.paid</code></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-dark">
                                <strong>Gestión de Webhooks</strong>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li>Endpoint único para recibir todos los tipos de eventos</li>
                                    <li>Verificación criptográfica de firmas de webhook</li>
                                    <li>Sistema de estrategias para procesar diferentes tipos de eventos</li>
                                    <li>Manejo de idempotencia para evitar procesamiento duplicado</li>
                                    <li>Logging detallado de eventos recibidos y procesados</li>
                                    <li>Gestión robusta de errores y excepciones</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <strong>Interfaz y Utilidades</strong>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li>Panel para visualizar facturas y su estado</li>
                                    <li>Panel para gestionar suscripciones activas</li>
                                    <li>Endpoints API para obtener datos de transacciones y suscripciones</li>
                                    <li>Interfaz simple basada en Bootstrap para facilitar la interacción</li>
                                    <li>Mensajes de confirmación y error después de acciones clave</li>
                                    <li>Sistema de logs para depuración y auditoría</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> <strong>Alcance:</strong> StripeLabApp se enfoca en demostrar los aspectos técnicos de la integración con Stripe, por lo que carece de algunas funcionalidades que tendría una aplicación de producción, como autenticación de usuarios, sistemas de roles, o un panel de administración completo.
                </div>
            </div>

            <div id="estructura-directorios" class="subsection">
                <h4>5.3. Estructura de Directorios del Proyecto</h4>
                <p>
                    StripeLabApp sigue una estructura de directorios organizada que separa claramente las diferentes capas y responsabilidades de la aplicación, facilitando la navegación y el mantenimiento del código.
                </p>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Estructura completa del proyecto</strong>
                    </div>
                    <div class="card-body">
                        <div class="code-snippet">
                        <pre><code class="language-plaintext">
StripeLabApp/
│
├── config/
│   ├── Bootstrap.php
    ├──config.php
│   └── DatabaseConnection.php
│
├── database/
│   └── docker/docker-compose.yml
│
├── logs/(...)
│
├── public/
│   ├── index.php
│   ├── single-payment.php
│   ├── subscriptions-payment.php
│   ├── view-subscriptions.php
│   ├── invoices.php
│   ├── assets/(...)
    │── api/
│   │      ├── api-invoices.php
│   │      ├── api-subscriptions.php
│   │      └── api-manage-subscription.php
│   └── v1/
│       ├── create_payment_session.php
│       ├── create_subscription_session.php
│       ├── webhook.php
│
│
├── src/
│   ├── Controller/
    │   │       └──Impl/(...)
│   │   ├── StripeWebhookControllerInterface.php
        ├──StripeSubscriptionControllerInterface.php
│   │   └── StripeInvoiceControllerInterface.php
│   │
│   ├── Service/
│   │   │     └──Impl/(...)
│   │   ├── StripeWebhookServiceInterface.php
│   │   ├── StripeCheckoutSessionServiceInterface.php
│   │   └── StripeSubscriptionManagementServiceInterface.php
│   │
│   │
│   ├── Strategy/
│   │   │└─────Impl/
│   │   │          ├── StripeEventStrategyInterfaceImpl.php
│   │   │          ├── SubscriptionCreatedStrategyImpl.php
│   │   │          ├── SubscriptionDeletedStrategyImpl.php
│   │   │          ├── SubscriptionUpdatedStrategyImpl.php
│   │   │          ├── CheckoutSessionCompletedStrategyImpl.php
│   │   │          ├── PaymentIntentSucceededStrategyImpl.php
│   │   │          ├── CustomerCreatedOrUpdatedStrategyImpl
│   │   │          ├── InvoicePaidStrategyImpl.php
│   │   │          └── ChargeSucceededStrategyImpl.php
│   │   │
│   │   └──── StripeWebhookStrategyInterface.php
│   │
│   ├── Repository/
│   │   │       └─────Impl/(...)
│   │   ├── TransactionRepositoryInterface.php
│   │   ├── InvoiceRepositoryInterface.php
│   │   └── SubscriptionRepositoryInterface.php
│   │
│   ├── Mappers/
│   │        ├── ChargeMapper.php
│   │        ├── CheckoutSessionMapper.php
│   │        ├── CustomerMapper.php
│   │        ├──  InvoiceMapper.php
│   │        ├── PaymentIntentMapper.php
│   │        └── SubscriptionMapper.php
│   │
│   ├── Factories/
│   │   ├── TransactionModelFactory.php
│   │   └── SubscriptionModelFactory.php
│   │
│   ├── Models/
│   │   ├── TransactionsModel.php
│   │   └── SubscriptionsModel.php
│   │
│   ├── DTOs/
│   │   ├── TransactionDTO.php
│   │   ├── SubscriptionDTO.php
│   │   └── InvoiceDTO.php
│   │
│   ├── Enums/
│   │   ├── StripeEventTypeEnum.php
│   │   └── TransactionTypeEnum.php
│   │
│   ├── Exceptions/
│   │   ├── ConfigurationException.php
│   │   ├── DatabaseException.php
│   │   ├── InvalidWebhookPayloadException.php
│   │   └── WebhookProcessingException.php
│   │
│   └── Logger/
│       ├── EventLogger.php
│       ├── ErrorLogger.php
│       ├── DatabaseLogger.php
│       ├── StripePayloadLogger.php
│       └── UnhandledStripeEventLogger.php
│
├── .env
├── .gitignore
├── composer.json
└── README.md
                        </code></pre>
                        </div>
                    </div>
                </div>

                <p>
                    Esta estructura refleja un enfoque de arquitectura en capas, donde:
                </p>
                <ul>
                    <li><strong>Interfaz de usuario:</strong> Se encuentra en <code>public/</code> y actúa como punto de entrada para los usuarios.</li>
                    <li><strong>Controladores:</strong> Manejan las solicitudes y coordinan el flujo de la aplicación.</li>
                    <li><strong>Servicios:</strong> Implementan la lógica de negocio principal e interactúan con APIs externas.</li>
                    <li><strong>Repositorios:</strong> Abstracten el acceso a datos y las operaciones con la base de datos.</li>
                    <li><strong>Modelos y DTOs:</strong> Representan las entidades del dominio y facilitan la transferencia de datos entre capas.</li>
                </ul>

                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> <strong>Ventajas de esta estructura:</strong> Proporciona una clara separación de responsabilidades, facilita el testeo al momento de ocurrir los errores, y además permite que la aplicación sea fácilmente extensible con nuevas funcionalidades o con vistas a una futura adaptación a ILIAS.
                </div>
            </div>
        </section>

        <!-- Sección 6 -->
        <section id="configuracion-puesta-marcha" class="mb-4">
            <h3>6. Configuración y Puesta en Marcha de StripeLabApp</h3>

            <div id="requisitos-especificos" class="subsection">
                <h4>6.1. Requisitos Específicos de la Aplicación</h4>
                <p>
                    Antes de instalar y ejecutar StripeLabApp, asegúrate de que tu entorno de desarrollo cumple con los siguientes requisitos:
                </p>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <strong>Requisitos de software</strong>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li><strong>PHP 8.0.0 o superior</strong> con las siguientes extensiones:

                                    <li><strong>Composer</strong> para gestión de dependencias</li>
                                    <li><strong> BBDD MYSQL</strong> </li>
                                    <li><strong>Stripe CLI</strong> para pruebas de webhook</li>
                                    <li><strong>Servidor web</strong> (Apache, Nginx) o servidor PHP embedido tal y como trae PhpStorm</li>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <strong>Requisitos de Stripe</strong>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li><strong>Cuenta de Stripe</strong>: Necesitarás una cuenta para obtener claves API y configurar webhooks.</li>
                                    <li><strong>Claves API de prueba</strong>:
                                        <ul>
                                            <li>Clave publicable (<code>pk_test_...</code>)</li>
                                            <li>Clave secreta (<code>sk_test_...</code>)</li>
                                        </ul>
                                    </li>
                                    <li><strong>Productos y precios configurados</strong> en tu panel de Stripe:
                                        <ul>
                                            <li>Un producto para pago único</li>
                                            <li>Un producto para suscripción con planes mensual y anual</li>
                                        </ul>
                                    </li>
                                    <li><strong>Webhook endpoint</strong> configurado para desarrollo local o producción</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-lightbulb"></i> <strong>Recomendación:</strong> Para un entorno de desarrollo fluido, considera utilizar Docker para configurar MySQL y PHP, evitando así conflictos con otros proyectos o versiones instaladas en tu sistema.
                </div>
            </div>

            <div id="guia-instalacion" class="subsection">
                <h4>6.2. Guía de Instalación</h4>
                <p>
                    Sigue estos pasos para configurar StripeLabApp en tu entorno de desarrollo:
                </p>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Paso 1: Clonar el repositorio</strong>
                    </div>
                    <div class="card-body">
                        <p>Clona el repositorio de StripeLabApp desde GitHub:</p>
                        <div class="code-snippet">
                        <pre><code class="language-bash">git clone https://github.com/JosCarRub/StripeLabApp.git
cd StripeLabApp</code></pre>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Paso 2: Instalar dependencias</strong>
                    </div>
                    <div class="card-body">
                        <p>Utiliza Composer para instalar las dependencias del proyecto:</p>
                        <div class="code-snippet">
                            <pre><code class="language-bash">composer install</code></pre>
                        </div>
                        <p>Esto instalará principalmente:</p>
                        <ul>
                            <li><strong>stripe/stripe-php</strong>: Biblioteca oficial de Stripe para PHP</li>
                            <li><strong>vlucas/phpdotenv</strong>: Para gestionar variables de entorno</li>
                        </ul>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Paso 3: Configurar variables de entorno</strong>
                    </div>
                    <div class="card-body">
                        <p>Crea un archivo <code>.env</code> a partir del ejemplo proporcionado:</p>
                        <div class="code-snippet">
                            <pre><code class="language-bash">cp .env.example .env</code></pre>
                        </div>
                        <p>Edita el archivo <code>.env</code> con tu configuración:</p>
                        <div class="code-snippet">
                        <pre><code class="language-plaintext"># Configuración de la base de datos
DB_HOST=localhost
DB_PORT=3306
DB_NAME=stripelabapp
DB_USER=tu_usuario
DB_PASSWORD=tu_contraseña

# Claves de Stripe (modo de prueba)
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...  # Lo obtendrás al configurar el webhook

# IDs de productos y precios (cópialos de tu panel de Stripe)
STRIPE_SINGLE_PAYMENT_PRICE_ID=price_...
STRIPE_MONTHLY_SUBSCRIPTION_PRICE_ID=price_...
STRIPE_ANNUAL_SUBSCRIPTION_PRICE_ID=price_...

# URLs de redirección (ajusta según tu configuración)
SUCCESS_URL=http://localhost:8000/public/success.html
CANCEL_URL=http://localhost:8000/public/cancel.html

# Configuración de logs
LOG_ENABLED=true
LOG_LEVEL=debug  # debug, info, warning, error</code></pre>
                        </div>
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Importante:</strong> Nunca compartas o subas a repositorios públicos tu archivo <code>.env</code> con claves secretas. Asegúrate de que esté incluido en <code>.gitignore</code>.
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Paso 4: Configurar la base de datos</strong>
                    </div>
                    <div class="card-body">
                        <p><strong> Docker (recomendado para desarrollo)</strong></p>
                        <ol>
                            <li>Si tienes Docker instalado, puedes usar el siguiente comando estando dentro del directorio donde tienes el archivo docker-compose.yml alojado en el proyecto en: databae/docker/docker-compose.yml(Debes sacarlo del directorio raíz del proyecto para levantar el compose):
                                <div class="code-snippet">
                                    <pre><code class="language-bash">docker-compose up -d</code></pre>
                                    <p>Para entrar en el contenedor: </p>
                                    <pre><code class="language-bash">docker exec -it stripe_mysql bash</code></pre>
                                    <p>Introduce la contraseña: </p>
                                    <pre><code class="language-bash">mysql -u test_user -p</code></pre>
                                </div>
                            </li>
                            <li>Ejecuta el script SQL para crear las tablas proporcionado en database/docker/tables.txt
                                <div class="code-snippet">
                                    <pre><code class="language-bash">
                                        CREATE TABLE `StripeTransactions` (
                                            `transaction_id` BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
                                            `stripe_customer_id` VARCHAR(50) NULL,
                                            `customer_email` VARCHAR(255) NULL,
                                            `customer_name` VARCHAR(255) NULL,
                                            `transaction_type` ENUM('one_time_receipt', 'subscription_invoice') NOT NULL,
                                            `stripe_payment_intent_id` VARCHAR(50) UNIQUE NULL,
                                            `stripe_invoice_id` VARCHAR(50) UNIQUE NULL,
                                            `stripe_subscription_id` VARCHAR(50) NULL,
                                            `stripe_charge_id` VARCHAR(50) UNIQUE NULL,
                                            `amount` INT NOT NULL,
                                            `currency` VARCHAR(3) NOT NULL,
                                            `status` VARCHAR(50) NOT NULL,
                                            `description` VARCHAR(255) NULL,
                                            `document_url` VARCHAR(255) NULL,
                                            `pdf_url` VARCHAR(255) NULL,
                                            `period_start` TIMESTAMP NULL,
                                            `period_end` TIMESTAMP NULL,
                                            `transaction_date_stripe` TIMESTAMP NOT NULL,
                                            `created_at_local` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                                        );

                                        CREATE TABLE `StripeSubscriptions` (
                                            `subscription_id` VARCHAR(50) PRIMARY KEY,
                                            `stripe_customer_id` VARCHAR(50) NOT NULL,
                                            `customer_email` VARCHAR(255) NULL,
                                            `status` VARCHAR(50) NOT NULL,
                                            `stripe_price_id` VARCHAR(50) NOT NULL,
                                            `interval` VARCHAR(20) NULL,
                                            `current_period_start` TIMESTAMP NULL,
                                            `current_period_end` TIMESTAMP NULL,
                                            `cancel_at_period_end` BOOLEAN DEFAULT FALSE,
                                            `canceled_at` TIMESTAMP NULL,
                                            `ended_at` TIMESTAMP NULL,
                                            `latest_transaction_id` BIGINT UNSIGNED NULL,
                                            `created_at_stripe` TIMESTAMP NOT NULL,
                                            `created_at_local` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                                        );
                                    </code></pre>
                                </div>
                            </li>
                        </ol>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Paso 5: Iniciar el servidor</strong>
                    </div>
                    <div class="card-body">
                        <p>Para desarrollo local, puedes utilizar el servidor web incorporado de PHP:</p>
                        <div class="code-snippet">
                        <pre><code class="language-bash">
php -S localhost:8000</code></pre>
                        </div>
                        <p>Ahora puedes acceder a la aplicación en <a href="http://localhost:8000" target="_blank">http://localhost:8000</a></p>

                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle"></i> <strong>Nota:</strong> Para un entorno de producción, configura un servidor web como Apache o Nginx y asegúrate de que el directorio <code>public/</code> sea la raíz del sitio web.
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Paso 6: Verificar la instalación</strong>
                    </div>
                    <div class="card-body">
                        <p>Verifica que la aplicación esté funcionando correctamente:</p>
                        <ol>
                            <li>Accede a la página principal para ver las opciones de pago.</li>
                            <li>Verifica que no aparezcan errores de conexión a la base de datos.</li>
                            <li>Prueba la conexión a Stripe accediendo a las páginas de pago único o suscripción.</li>
                        </ol>
                        <p>Si encuentras errores, verifica los archivos de log en el directorio <code>logs/</code> para obtener más detalles.</p>
                    </div>
                </div>
            </div>

            <div id="configuracion-webhook" class="subsection">
                <h4>6.3. Configuración del Endpoint de Webhook para StripeLabApp</h4>
                <p>
                    Los webhooks son esenciales para StripeLabApp, ya que permiten recibir y procesar eventos de Stripe de manera asíncrona. Hay dos formas de configurar los webhooks: para desarrollo local con Stripe CLI o para un entorno de producción.
                </p>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Opción 1: Configuración para desarrollo local con Stripe CLI</strong>
                    </div>
                    <div class="card-body">
                        <p>Esta es la opción más sencilla para desarrollo, ya que no requiere exponer tu servidor local a internet:</p>
                        <ol>
                            <li>Asegúrate de tener Stripe CLI instalado y autenticado (como se explicó en la sección 4).</li>
                            <li>Inicia el reenvío de webhooks a tu servidor local:
                                <div class="code-snippet">
                                    <pre><code class="language-bash">stripe listen --forward-to http://localhost:8000/public/v1/webhook.php</code></pre>
                                </div>
                            </li>
                            <li>Stripe CLI generará un signing secret que deberás copiar y agregar a tu archivo <code>.env</code>:
                                <div class="code-snippet">
                                    <pre><code class="language-plaintext">STRIPE_WEBHOOK_SECRET=whsec_...</code></pre>
                                </div>
                            </li>
                        </ol>
                        <div class="alert alert-success mt-3">
                            <i class="fas fa-check-circle"></i> <strong>Ventaja:</strong> Con este método, los eventos se reenvían a tu servidor local incluso cuando está detrás de un firewall o NAT, y puedes simular eventos con <code>stripe trigger</code>.
                        </div>
                    </div>
                </div>


                <p>
                    Con estos pasos, StripeLabApp estará configurado y listo para procesar pagos y suscripciones con Stripe. La aplicación recibirá eventos a través del endpoint de webhook y los procesará según las estrategias implementadas.
                </p>
            </div>
        </section>

        <!-- Sección 7 -->
        <section id="arquitectura-detallada" class="mb-4">
            <h3>7. Arquitectura Detallada de StripeLabApp</h3>

            <div id="diagrama-componentes" class="subsection">
                <h4>7.1. Diagrama de Componentes de StripeLabApp</h4>
                <p>
                    El siguiente diagrama muestra la estructura de componentes de StripeLabApp y cómo interactúan entre sí. Esto proporciona una visión general de la arquitectura de la aplicación antes de profundizar en cada capa.
                </p>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Diagrama de componentes y flujo completo de la aplicación</strong>
                    </div>
                    <div class="card-body">
                        <div class="mermaid-diagram" id="diagram-src">
                        <pre class="mermaid">

                                flowchart TD
                                    %% Usuarios y Puntos de entrada
                                    User([Usuario]):::user

                                    %% Páginas de entrada
                                    User -->|Accede| Index["/index.php"]:::frontend
                                    Index -->|Selecciona| Single["/single-payment.php"]:::frontend
                                    Index -->|Selecciona| Subscriptions["/subscriptions-payment.php"]:::frontend

                                    %% Flujo de Pago Único
                                    Single -->|onClick| SinglePaymentJS["subscription-payment.js\nfetch()"]:::frontend
                                    SinglePaymentJS -->|POST| CreatePaymentSession["/v1/create_payment_session.php"]:::api

                                    %% Flujo de Suscripción
                                    Subscriptions -->|onClick| SubscriptionPaymentJS["subscription-payment.js\nfetch()"]:::frontend
                                    SubscriptionPaymentJS -->|POST| CreateSubscriptionSession["/v1/create_subscription_session.php"]:::api

                                    %% Servicios de Checkout
                                    CreatePaymentSession -->|instancia| CheckoutService["StripeCheckoutSessionServiceImpl"]:::service
                                    CreateSubscriptionSession -->|instancia| CheckoutService
                                    CheckoutService -->|API call| StripeAPI[("Stripe API")]:::external

                                    %% Redirección y Checkout de Stripe
                                    StripeAPI -->|redirect_to| StripeCheckout["Stripe Checkout\nFormulario de Pago"]:::external
                                    StripeCheckout -->|success_url| SuccessPage["/success.html"]:::frontend
                                    StripeCheckout -->|cancel_url| CancelPage["/cancel.html"]:::frontend

                                    %% Flujo de Webhook
                                    StripeAPI -->|Envía eventos| WebhookEndpoint["/v1/webhook.php"]:::api
                                    WebhookEndpoint -->|instancia| WebhookController["StripeWebhookControllerImpl"]:::controller
                                    WebhookController -->|procesa| WebhookService["StripeWebhookServiceImpl"]:::service
                                    WebhookService -->|verifica firma| StripeSig{{"¿Firma válida?"}}:::decision

                                    %% Logging de Payloads
                                    WebhookService -->|registra| PayloadLogger["StripePayloadLogger"]:::logger
                                    StripeSig -->|No| ErrorLogger["ErrorLogger"]:::logger

                                    %% Selección e implementación de estrategias
                                    StripeSig -->|Sí| EventType{{"Tipo de evento"}}:::decision

                                    %% Estrategias específicas
                                    EventType -->|checkout.session.completed| CheckoutStrategy["CheckoutSessionCompletedStrategyImpl"]:::strategy
                                    EventType -->|payment_intent.succeeded| PaymentIntentStrategy["PaymentIntentSucceededStrategyImpl"]:::strategy
                                    EventType -->|charge.succeeded| ChargeStrategy["ChargeSucceededStrategyImpl"]:::strategy
                                    EventType -->|customer.subscription.created| SubCreatedStrategy["SubscriptionCreatedStrategyImpl"]:::strategy
                                    EventType -->|customer.subscription.updated| SubUpdatedStrategy["SubscriptionUpdatedStrategyImpl"]:::strategy
                                    EventType -->|customer.subscription.deleted| SubDeletedStrategy["SubscriptionDeletedStrategyImpl"]:::strategy
                                    EventType -->|invoice.paid| InvoicePaidStrategy["InvoicePaidStrategyImpl"]:::strategy
                                    EventType -->|customer.created/updated| CustomerStrategy["CustomerCreatedOrUpdatedStrategyImpl"]:::strategy
                                    EventType -->|otros| UnhandledLogger["UnhandledStripeEventLogger"]:::logger

                                    %% Mapeo de datos
                                    CheckoutStrategy -->|usa| CheckoutMapper["CheckoutSessionMapper"]:::mapper
                                    PaymentIntentStrategy -->|usa| PaymentIntentMapper["PaymentIntentMapper"]:::mapper
                                    ChargeStrategy -->|usa| ChargeMapper["ChargeMapper"]:::mapper
                                    SubCreatedStrategy & SubUpdatedStrategy & SubDeletedStrategy -->|usa| SubscriptionMapper["SubscriptionMapper"]:::mapper
                                    InvoicePaidStrategy -->|usa| InvoiceMapper["InvoiceMapper"]:::mapper
                                    CustomerStrategy -->|usa| CustomerMapper["CustomerMapper"]:::mapper

                                    %% DTOs
                                    CheckoutMapper -->|crea| CheckoutDTO["CheckoutSessionCompletedDTO"]:::dto
                                    PaymentIntentMapper -->|crea| PaymentIntentDTO["PaymentIntentDTO"]:::dto
                                    ChargeMapper -->|crea| ChargeDTO["ChargeDTO"]:::dto
                                    SubscriptionMapper -->|crea| SubscriptionDTO["SubscriptionDTO"]:::dto
                                    InvoiceMapper -->|crea| InvoiceDTO["InvoiceDTO"]:::dto
                                    CustomerMapper -->|crea| CustomerDTO["CustomerDTO"]:::dto

                                    %% Factories y creación de modelos
                                    PaymentIntentStrategy & ChargeStrategy & InvoicePaidStrategy -->|usa| TransactionFactory["TransactionModelFactory"]:::factory
                                    SubCreatedStrategy & SubUpdatedStrategy & SubDeletedStrategy -->|usa| SubscriptionFactory["SubscriptionModelFactory"]:::factory

                                    %% Modelos/Entidades
                                    TransactionFactory -->|crea| TransactionModel["TransactionsModel"]:::entity
                                    SubscriptionFactory -->|crea| SubscriptionModel["SubscriptionsModel"]:::entity

                                    %% Repositorios
                                    TransactionModel -->|persistido por| TransactionRepo["TransactionRepositoryImpl"]:::repository
                                    SubscriptionModel -->|persistido por| SubscriptionRepo["SubscriptionRepositoryImpl"]:::repository
                                    InvoiceDTO -->|consultado por| InvoiceRepo["InvoiceRepositoryImpl"]:::repository

                                    %% Base de datos
                                    TransactionRepo & SubscriptionRepo & InvoiceRepo -->|operaciones| Database[("Base de Datos\nMySQL")]:::database

                                    %% Visualización de datos
                                    User -->|Consulta| InvoicesPage["/invoices.php"]:::frontend
                                    User -->|Consulta| SubscriptionsPage["/view-subscriptions.php"]:::frontend

                                    %% APIs para consultas
                                    InvoicesPage -->|fetch| ApiInvoices["/api/api-invoices.php"]:::api
                                    SubscriptionsPage -->|fetch| ApiSubscriptions["/api/api-subscriptions.php"]:::api
                                    SubscriptionsPage -->|administra| ApiManageSub["/api/api-manage-subscription.php"]:::api

                                    %% Controladores para visualización
                                    ApiInvoices -->|instancia| InvoiceController["StripeInvoiceControllerImpl"]:::controller
                                    ApiSubscriptions & ApiManageSub -->|instancia| SubscriptionController["StripeSubscriptionControllerImpl"]:::controller

                                    %% Servicios para gestión de suscripciones
                                    SubscriptionController -->|usa| SubscriptionService["StripeSubscriptionManagementServiceImpl"]:::service
                                    SubscriptionService -->|API call| StripeAPI

                                    %% Panel de administración
                                    User -->|Acceso admin| AdminPanel["/admin/panel.php"]:::frontend
                                    AdminPanel -->|fetch| PanelApi["/admin/api/panel_api.php"]:::api

                                    %% Definición de estilos
                                    classDef user fill:#ECF0F1,stroke:#95A5A6,stroke-width:2px,color:#34495E,font-weight:bold;
                                    classDef frontend fill:#D5F5E3,stroke:#2ECC71,stroke-width:2px,color:#27AE60;
                                    classDef api fill:#D6EAF8,stroke:#3498DB,stroke-width:2px,color:#2980B9;
                                    classDef controller fill:#E8DAEF,stroke:#8E44AD,stroke-width:2px,color:#8E44AD;
                                    classDef service fill:#FADBD8,stroke:#E74C3C,stroke-width:2px,color:#C0392B;
                                    classDef strategy fill:#FCF3CF,stroke:#F1C40F,stroke-width:2px,color:#F39C12;
                                    classDef mapper fill:#FEF9E7,stroke:#F7DC6F,stroke-width:2px,color:#D4AC0D;
                                    classDef dto fill:#FDEBD0,stroke:#F5B041,stroke-width:2px,color:#D35400;
                                    classDef factory fill:#EBDEF0,stroke:#A569BD,stroke-width:2px,color:#8E44AD;
                                    classDef entity fill:#D6DBDF,stroke:#85929E,stroke-width:2px,color:#2C3E50;
                                    classDef repository fill:#F4ECF7,stroke:#BB8FCE,stroke-width:2px,color:#8E44AD;
                                    classDef database fill:#E5E8E8,stroke:#99A3A4,stroke-width:2px,color:#2C3E50,font-weight:bold;
                                    classDef external fill:#F2D7D5,stroke:#EC7063,stroke-width:2px,color:#CB4335;
                                    classDef logger fill:#D0ECE7,stroke:#45B39D,stroke-width:2px,color:#16A085;
                                    classDef decision fill:#F5EEF8,stroke:#AF7AC5,stroke-width:2px,color:#8E44AD,shape:diamond;




                        </pre>
                        </div>
                    </div>
                </div>

                <p>
                    Como se muestra en el diagrama, StripeLabApp sigue una arquitectura en capas con una clara separación de responsabilidades:
                </p>
                <ul>
                    <li><strong>Capa de Presentación:</strong> Interfaz de usuario y puntos de entrada API.</li>
                    <li><strong>Capa de Controladores:</strong> Manejan las solicitudes HTTP y coordinan las operaciones.</li>
                    <li><strong>Capa de Servicios:</strong> Implementan la lógica de negocio y orquestan las operaciones complejas.</li>
                    <li><strong>Capa de Estrategias:</strong> Encapsulan la lógica específica para cada tipo de evento de Stripe.</li>
                    <li><strong>Capa de Mappers y Factories:</strong> Facilitan la conversión entre formatos de datos y la creación de objetos.</li>
                    <li><strong>Capa de Repositorios:</strong> Proporcionan acceso a datos y abstraen la capa de persistencia.</li>
                    <li><strong>Capa de Commons:</strong> Contiene componentes transversales utilizados por toda la aplicación.</li>
                </ul>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> <strong>Patrón de diseño:</strong> La arquitectura combina varios patrones y está dividido en capas, Repository, Strategy y Factory. Esta combinación proporciona flexibilidad y facilita la extensión del sistema para manejar nuevos tipos de eventos o funcionalidades.
                </div>
            </div>


            <div id="capa-frontend" class="subsection">
                <h4>7.2.1 Capa Frontend</h4>
                <p>
                    La capa Frontend de StripeLabApp está diseñada para ser intuitiva y fácil de usar, permitiendo a los usuarios realizar pagos únicos y suscripciones de manera sencilla. Utiliza HTML, CSS y JavaScript para crear una experiencia de usuario fluida.
                </p>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Componentes Frontend</strong>
                    </div>
                    <div class="card-body">
                        <p>Los principales componentes frontend incluyen:</p>
                        <ul>
                            <li><strong>index.php:</strong> Página principal que permite al usuario elegir entre pago único o suscripción.</li>
                            <li><strong>single-payment.php:</strong> Página para realizar un pago único.</li>
                            <li><strong>subscriptions-payment.php:</strong> Página realizar pagos de suscripciones.</li>
                            <li><strong>invoices.php:</strong> Página para visualizar las facturas generadas.</li>
                            <li><strong>view-subscriptions.php:</strong> Página para ver las suscripciones activas del usuario.</li>
                            <li><strong>admin/panel.php:</strong> Panel de administración para visualizar las tablas de base de datos ya que al estar en un contenedor de Docker su visualización en terminal no suele ser cómoda.</li>
                        </ul>
                        <div class="card-body">
                            <div class="mermaid-diagram" id="diagram-frontend">
                        <pre class="mermaid">

                                graph TD
                                    %% Diagrama de componentes Frontend
                                    User([Usuario]):::user

                                    %% Páginas de entrada
                                    User -->|Accede| Index["/index.php"]:::frontend
                                    Index -->|Selecciona| Single["/single-payment.php"]:::frontend
                                    Index -->|Selecciona| Subscriptions["/subscriptions-payment.php"]:::frontend

                                    %% Flujo de Pago Único
                                    Single -->|onClick| SinglePaymentJS["subscription-payment.js\nfetch()"]:::frontend
                                    SinglePaymentJS -->|POST| CreatePaymentSession["/v1/create_payment_session.php"]:::api

                                    %% Flujo de Suscripción
                                    Subscriptions -->|onClick| SubscriptionPaymentJS["subscription-payment.js\nfetch()"]:::frontend
                                    SubscriptionPaymentJS -->|POST| CreateSubscriptionSession["/v1/create_subscription_session.php"]:::api

                                    %% Redirección y Checkout de Stripe
                                    StripeAPI[("Stripe API")]:::external
                                    StripeAPI -->|redirect_to| StripeCheckout["Stripe Checkout\nFormulario de Pago"]:::external
                                    StripeCheckout -->|success_url| SuccessPage["/success.html"]:::frontend
                                    StripeCheckout -->|cancel_url| CancelPage["/cancel.html"]:::frontend

                                    %% Visualización de datos
                                    User -->|Consulta| InvoicesPage["/invoices.php"]:::frontend
                                    User -->|Consulta| SubscriptionsPage["/view-subscriptions.php"]:::frontend

                                    %% APIs para consultas
                                    InvoicesPage -->|fetch| ApiInvoices["/api/api-invoices.php"]:::api
                                    SubscriptionsPage -->|fetch| ApiSubscriptions["/api/api-subscriptions.php"]:::api

                                    %% Panel de administración
                                    User -->|Acceso admin| AdminPanel["/admin/panel.php"]:::frontend

                                    %% Definición de estilos
                                    classDef user fill:#ECF0F1,stroke:#95A5A6,stroke-width:2px,color:#34495E,font-weight:bold;
                                    classDef frontend fill:#D5F5E3,stroke:#2ECC71,stroke-width:2px,color:#27AE60;




                        </pre>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3">
                            <i class="fas fa-lightbulb"></i> <strong>Nota:</strong> El frontend utiliza Bootstrap 5 para el diseño responsivo para facilitar la manipulación del DOM y las solicitudes AJAX.
                        </div>
                    </div>
                </div>

                <div id="capa-backend" class="subsection">
                    <h4>7.2.2 Capa Backend</h4>
                    <p>
                        La capa Backend de StripeLabApp está diseñada para ser robusta y escalable, gestionando la lógica de negocio y la interacción con la API de Stripe. Está dividida en capas Repository, Strategy y Factory.
                        El motivo de esta división es que la aplicación está diseñada para ser extensible. Cada capa tiene una responsabilidad clara, lo que facilita la extensión de cualquier funcionalidad y el adaptarse a su futura implementación en un plugin.
                    </p>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Componentes Backend</strong>
                        </div>
                        <div class="card-body">
                            <p>Los principales componentes backend incluyen:</p>
                            <ul>
                                <li><strong>Controllers:</strong>  Recibir petición, delegar a servicio, manejar códigos HTTP. </li>
                                <li><strong>Services:</strong>  Orquestar validación y enrutamiento de webhooks a Estrategias, manejo de excepciones de estrategias </li>
                                <li><strong>Repository:</strong>  Abstracción de la capa de persistencia de datos.</li>
                                <li><strong>Strategy:</strong>  Procesa el evento según el tipo y actúa en consecuencia al mismo.</li>
                                <li><strong>Mappers:</strong>  Mapea el Payload crudo a DTO para posteriormente servir como parámetro constructor a la capa Factory.</li>
                                <li><strong>Factory:</strong>  Transforma los DTOs a entidades que representan a nuestras tablas en Base de Datos.</li>
                                <li><strong>Commons:</strong>  Componentes transversales a toda la aplicación.</li>
                            </ul>
                            <div class="card-body">
                                <div class="mermaid-diagram" id="diagram-backend">
                        <pre class="mermaid">

                                                           flowchart TD
                                StripeWebhookEvent[Evento Webhook de Stripe] -->|HTTP POST| A[public/v1/webhook.php]
                                A -->|Usa| B[config/Bootstrap]
                                B -->|Obtiene| C[StripeWebhookControllerImpl]
                                C -->| payload, signature| D[StripeWebhookServiceImpl  -constructEvent-]
                                D -- Devuelve Evento Stripe verificado --> C
                                C -->|2. Evento Stripe| E[StripeWebhookServiceImpl -processWebhookEvent-]
                                E -->|Loguea Payload| PL[StripePayloadLogger]
                                E -->|Itera y llama isApplicable| F{Selección de Estrategia}

                                subgraph "Proceso de Estrategia Aplicable"
                                    direction LR
                                    G[Estrategia Específica]
                                    G --> H[Mapper Específico]
                                    H --> I[DTO Específico]
                                    I --> J[Factory Específico]
                                    J --> K[Entidad/Modelo]
                                    K --> L[Repositorio Específico -save-]
                                    L --> M[(Base de Datos MySQL)]
                                end

                                F -- Evento Aplicable --> G
                                F -- Evento No Aplicable --> UL[UnhandledStripeEventLogger]

                                %% Estilos
                                classDef default fill:#fff,stroke:#333,stroke-width:1.5px;
                                classDef api fill:#D6EAF8,stroke:#3498DB;
                                classDef config fill:#FADBD8,stroke:#E74C3C;
                                classDef controller fill:#E8DAEF,stroke:#8E44AD;
                                classDef service fill:#D5F5E3,stroke:#2ECC71;
                                classDef strategy fill:#FCF3CF,stroke:#F1C40F,font-style:italic;
                                classDef mapper fill:#FEF9E7,stroke:#F7DC6F;
                                classDef dto fill:#FDEBD0,stroke:#F5B041;
                                classDef factory fill:#EBDEF0,stroke:#A569BD;
                                classDef entity fill:#D6DBDF,stroke:#85929E;
                                classDef repository fill:#F4ECF7,stroke:#BB8FCE;
                                classDef database fill:#E5E8E8,stroke:#99A3A4,font-weight:bold;
                                classDef logger fill:#D0ECE7,stroke:#45B39D;
                                classDef decision fill:#fff,stroke:#333,shape:diamond;

                                class A api
                                class B config
                                class C controller
                                class D,E service
                                class F decision
                                class G strategy
                                class H mapper
                                class I dto
                                class J factory
                                class K entity
                                class L repository
                                class M database
                                class PL,UL logger




                        </pre>
                                </div>
                            </div>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-lightbulb"></i> <strong>Nota:</strong> El logger se antoja crucial para comprender el flujo de eventos de Stripe (Payloads completos, orden de la llegada de los eventos...) y depurar la aplicación.
                            </div>
                        </div>
                    </div>
                </div>

                <div id="capa-database" class="subsection">
                    <h4>7.2.3 Capa Base de Datos</h4>
                    <p>
                        La capa Backend de StripeLabApp está diseñada para ser robusta y escalable, gestionando la lógica de negocio y la interacción con la API de Stripe. Está dividida en capas Repository, Strategy y Factory.
                        El motivo de esta división es que la aplicación está diseñada para ser extensible. Cada capa tiene una responsabilidad clara, lo que facilita la extensión de cualquier funcionalidad y el adaptarse a su futura implementación en un plugin.
                    </p>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Esquema de la Base de Datos</strong>
                    </div>
                    <div class="card-body">
                        <p>La aplicación utiliza dos tablas principales para almacenar la información de transacciones y suscripciones de Stripe:</p>
                        <ul>
                            <li><strong>StripeTransactions:</strong> Almacena todas las transacciones de pago, tanto de pagos únicos como de facturas de suscripción.</li>
                            <br>
                            <li><strong>StripeSubscriptions:</strong> Registra información sobre las suscripciones activas, canceladas o finalizadas.</li>
                        </ul>
                        <p>La relación entre ambas tablas se establece mediante el campo <code>latest_transaction_id</code> en la tabla de suscripciones, que hace referencia a la última transacción asociada.</p>

                        <div class="card-body">
                            <div class="mermaid-diagram" id="diagram-database">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <strong>Tablas de la Base de Datos</strong>
                                    </div>
                                    <div class="card-body">

                                        <div class="row mt-4">
                                            <div class="col-md-6">
                                                <div class="card" style="border-left: 5px solid #2ECC71;">
                                                    <div class="card-header bg-light">
                                                        <strong>StripeTransactions</strong>
                                                    </div>
                                                    <div class="card-body p-0">
                                                        <div class="table-responsive">
                                                            <table class="table table-sm table-striped mb-0">
                                                                <thead>
                                                                <tr>
                                                                    <th>Campo</th>
                                                                    <th>Tipo</th>
                                                                    <th>Restricción</th>
                                                                </tr>
                                                                </thead>
                                                                <tbody>
                                                                <tr>
                                                                    <td>transaction_id</td>
                                                                    <td>BIGINT</td>
                                                                    <td><span class="badge bg-primary">PK</span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>stripe_customer_id</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>customer_email</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>customer_name</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>transaction_type</td>
                                                                    <td>ENUM</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>stripe_payment_intent_id</td>
                                                                    <td>VARCHAR</td>
                                                                    <td><span class="badge bg-info">UK</span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>stripe_invoice_id</td>
                                                                    <td>VARCHAR</td>
                                                                    <td><span class="badge bg-info">UK</span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>stripe_subscription_id</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>stripe_charge_id</td>
                                                                    <td>VARCHAR</td>
                                                                    <td><span class="badge bg-info">UK</span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>amount</td>
                                                                    <td>INT</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>currency</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>status</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>description</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>document_url</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>pdf_url</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>period_start</td>
                                                                    <td>TIMESTAMP</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>period_end</td>
                                                                    <td>TIMESTAMP</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>transaction_date_stripe</td>
                                                                    <td>TIMESTAMP</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>created_at_local</td>
                                                                    <td>TIMESTAMP</td>
                                                                    <td></td>
                                                                </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card" style="border-left: 5px solid #8E44AD;">
                                                    <div class="card-header bg-light">
                                                        <strong>StripeSubscriptions</strong>
                                                    </div>
                                                    <div class="card-body p-0">
                                                        <div class="table-responsive">
                                                            <table class="table table-sm table-striped mb-0">
                                                                <thead>
                                                                <tr>
                                                                    <th>Campo</th>
                                                                    <th>Tipo</th>
                                                                    <th>Restricción</th>
                                                                </tr>
                                                                </thead>
                                                                <tbody>
                                                                <tr>
                                                                    <td>subscription_id</td>
                                                                    <td>VARCHAR</td>
                                                                    <td><span class="badge bg-primary">PK</span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>stripe_customer_id</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>customer_email</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>status</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>stripe_price_id</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>interval</td>
                                                                    <td>VARCHAR</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>current_period_start</td>
                                                                    <td>TIMESTAMP</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>current_period_end</td>
                                                                    <td>TIMESTAMP</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>cancel_at_period_end</td>
                                                                    <td>BOOLEAN</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>canceled_at</td>
                                                                    <td>TIMESTAMP</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>ended_at</td>
                                                                    <td>TIMESTAMP</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>latest_transaction_id</td>
                                                                    <td>BIGINT</td>
                                                                    <td><span class="badge bg-success">FK</span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>created_at_stripe</td>
                                                                    <td>TIMESTAMP</td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>created_at_local</td>
                                                                    <td>TIMESTAMP</td>
                                                                    <td></td>
                                                                </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3">
                            <i class="fas fa-lightbulb"></i> <strong>Nota:</strong> Es importante mantener la integridad referencial entre estas tablas para garantizar la consistencia de los datos de transacciones y suscripciones.
                        </div>
                    </div>
                </div>
                </div>

                <div id="capa-commons" class="subsection">
                    <h4>7.2. Capa Commons</h4>
                    <p>
                        La capa Commons contiene componentes fundamentales utilizados en toda la aplicación, proporcionando estructura, tipado y funcionalidades comunes. Estos componentes son la base sobre la que se construyen las demás capas.
                    </p>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>DTOs (Data Transfer Objects)</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                Los DTOs en StripeLabApp facilitan la transferencia de datos entre las diferentes capas de la aplicación sin exponer los detalles de implementación de las entidades de dominio. También proporcionan una estructura clara para los datos que se envían al frontend.
                            </p>

                            <p><strong>Ejemplos de DTOs:</strong></p>
                            <ul>
                                <li>
                                    <strong>SubscriptionDTO:</strong> Representa una suscripción con todos los datos necesarios para la visualización y gestión.
                                </li>
                                <li>
                                    <strong>InvoiceDTO:</strong> Contiene la información de una factura para mostrar en la interfaz.
                                </li>
                                <li>
                                    <strong>TransactionDTO:</strong> Representa una transacción de pago, ya sea única o parte de una suscripción.
                                </li>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-lightbulb"></i> <strong>Beneficio:</strong> Los DTOs proporcionan una capa de abstracción que facilita la evolución de las entidades internas sin afectar a las interfaces externas. También simplifican la serialización a JSON para las respuestas API.
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Continuación de la sección 7.2 Capa Commons -->
                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Entidades (Models)</strong>
                    </div>
                    <div class="card-body">
                        <p>
                            Las entidades o modelos representan los objetos de dominio principales de la aplicación y corresponden directamente a las tablas de la base de datos. Contienen la lógica específica del dominio y las reglas de negocio.
                        </p>

                        <p><strong>Principales modelos:</strong></p>
                        <ul>
                            <li>
                                <strong>TransactionsModel:</strong> Representa una transacción financiera en el sistema.
                            </li>
                            <li>
                                <strong>SubscriptionsModel:</strong> Representa una suscripción de un cliente.
                            </li>
                        </ul>

                        <div class="alert alert-info mt-3">
                            <i class="fas fa-database"></i> <strong>Relación con la base de datos:</strong>
                            <p>Cada campo de estos modelos corresponde directamente a una columna en las tablas <code>transactions</code> y <code>subscriptions</code> respectivamente. La tabla <code>transactions</code> utiliza un <code>transaction_id</code> autoincremental como clave primaria, mientras que <code>subscriptions</code> utiliza el <code>subscription_id</code> de Stripe como clave primaria natural.</p>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Enums</strong>
                    </div>
                    <div class="card-body">
                        <p>
                            Las enumeraciones proporcionan un tipado fuerte para valores constantes en la aplicación, mejorando la legibilidad del código y reduciendo errores por el uso de strings literales.
                        </p>

                        <p><strong>Principales enumeraciones:</strong></p>
                        <ul>
                            <li>
                                <strong>StripeEventTypeEnum:</strong> Define los tipos de eventos de Stripe que la aplicación maneja.
                            </li>
                            <li>
                                <strong>TransactionTypeEnum:</strong> Define los tipos de transacciones financieras.
                            </li>
                            <li>
                                <strong>TransactionStatusEnum:</strong> Define los posibles estados de una transacción.
                            </li>
                        </ul>

                        <div class="alert alert-success mt-3">
                            <i class="fas fa-check-circle"></i> <strong>Beneficio:</strong> El uso de enums mejora la legibilidad del código, proporciona autocompletado en IDEs, y evita errores por el uso de strings incorrectos. También facilita la evolución del código, ya que los cambios en los valores se reflejan automáticamente en todas partes donde se utiliza el enum.
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Excepciones Personalizadas</strong>
                    </div>
                    <div class="card-body">
                        <p>
                            StripeLabApp utiliza excepciones personalizadas para manejar diferentes tipos de errores de manera específica, facilitando su captura y tratamiento adecuado.
                        </p>

                        <p><strong>Principales excepciones:</strong></p>
                        <ul>
                            <li>
                                <strong>ConfigurationException:</strong> Lanzada cuando hay un problema con la configuración de la aplicación (variables de entorno faltantes, valores incorrectos).
                            </li>
                            <li>
                                <strong>DatabaseException:</strong> Encapsula errores de la base de datos, proporcionando contexto adicional sobre la operación que falló.
                            </li>
                            <li>
                                <strong>InvalidWebhookPayloadException:</strong> Lanzada cuando el payload de un webhook no tiene el formato esperado o falta información crítica.
                            </li>
                            <li>
                                <strong>WebhookProcessingException:</strong> Indica un error durante el procesamiento de un webhook por parte de una estrategia específica.
                            </li>
                        </ul>

                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle"></i> <strong>Nota:</strong> Además de estas excepciones personalizadas, StripeLabApp también maneja las excepciones nativas de la biblioteca de Stripe, como <code>Stripe\Exception\SignatureVerificationException</code> para errores de verificación de firma de webhook, o <code>Stripe\Exception\ApiErrorException</code> para errores de la API de Stripe.
                        </div>

                        <p>
                            El uso de excepciones personalizadas permite un manejo más granular de los errores, facilitando respuestas específicas según el tipo de problema que ocurra.
                        </p>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Loggers</strong>
                    </div>
                    <div class="card-body">
                        <p>
                            StripeLabApp implementa un sistema de logging especializado para diferentes aspectos de la aplicación, facilitando la depuración y la auditoría de operaciones críticas.
                        </p>

                        <p><strong>Loggers especializados:</strong></p>
                        <ul>
                            <li>
                                <strong>EventLogger:</strong> Registra información general sobre los eventos de la aplicación, como inicializaciones, procesos completados, o cambios de estado.
                            </li>
                            <li>
                                <strong>ErrorLogger:</strong> Captura y registra errores y excepciones, incluyendo trazas completas para facilitar la depuración.
                            </li>
                            <li>
                                <strong>DatabaseLogger:</strong> Registra operaciones críticas de base de datos, como inserciones, actualizaciones y errores específicos de la capa de persistencia.
                            </li>
                            <li>
                                <strong>StripePayloadLogger:</strong> Guarda los payloads recibidos de Stripe (omitiendo información sensible), lo que facilita el diagnóstico de problemas relacionados con webhooks.
                            </li>
                            <li>
                                <strong>UnhandledStripeEventLogger:</strong> Registra eventos de Stripe para los que no hay una estrategia implementada, facilitando la identificación de eventos que podrían requerir soporte en el futuro.
                            </li>
                        </ul>

                        <div class="alert alert-success mt-3">
                            <i class="fas fa-shield-alt"></i> <strong>Importancia:</strong> Un buen sistema de logging es crucial para aplicaciones que manejan pagos, ya que permite auditar todas las operaciones financieras, facilita la detección y solución de problemas, y proporciona evidencia para la reconciliación financiera y resolución de disputas.
                        </div>
                    </div>
                </div>

                <div id="capa-configuracion" class="subsection">
                    <h4>7.3. Capa de Configuración (config/)</h4>
                    <p>
                        La capa de configuración proporciona la infraestructura básica para inicializar la aplicación, cargar configuraciones y gestionar dependencias.
                    </p>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Bootstrap.php</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <code>Bootstrap.php</code> actúa como un Service Locator simple, gestionando la inicialización de la aplicación y la instanciación perezosa (lazy loading) de las dependencias principales. Sus responsabilidades incluyen:
                            </p>
                            <ul>
                                <li><strong>Carga de variables de entorno</strong> desde el archivo <code>.env</code> utilizando la biblioteca PHPDotEnv.</li>
                                <li><strong>Definición de constantes globales</strong> basadas en variables de entorno.</li>
                                <li><strong>Inicialización de Stripe</strong> con la clave API secreta.</li>
                                <li><strong>Provisión de instancias de servicios, controladores y repositorios</strong> mediante métodos de acceso.</li>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-lightbulb"></i> <strong>Enfoque:</strong> Aunque esta implementación es más simple que un contenedor de inyección de dependencias completo, proporciona muchos de los mismos beneficios: centralización de la creación de objetos, lazy loading, y gestión de dependencias sin acoplamiento rígido.
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>DatabaseConnection.php</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <code>DatabaseConnection.php</code> implementa un patrón Singleton para proporcionar una única instancia de conexión PDO a la base de datos MySQL. Sus responsabilidades incluyen:
                            </p>
                            <ul>
                                <li><strong>Establecer la conexión a la base de datos</strong> utilizando los parámetros de configuración del archivo <code>.env</code>.</li>
                                <li><strong>Configurar opciones de PDO</strong> para manejo de errores y codificación.</li>
                                <li><strong>Proporcionar acceso a la instancia PDO</strong> para los repositorios.</li>
                                <li><strong>Manejar errores de conexión</strong> y lanzar excepciones apropiadas.</li>
                            </ul>

                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle"></i> <strong>Consideración:</strong> Aunque el patrón Singleton es adecuado para este caso de uso, en aplicaciones más complejas podría ser preferible utilizar un sistema de inyección de dependencias más sofisticado para gestionar las conexiones a la base de datos.
                            </div>
                        </div>
                    </div>
                </div>

                <div id="capa-presentacion" class="subsection">
                    <h4>7.4. Capa de Presentación y Puntos de Entrada (public/)</h4>
                    <p>
                        La capa de presentación contiene los puntos de entrada de la aplicación, incluyendo páginas web, endpoints API y el endpoint de webhook. Esta capa se encarga de la interacción con el usuario y la comunicación con sistemas externos.
                    </p>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Páginas de Interfaz de Usuario</strong>
                        </div>
                        <div class="card-body">
                            <p><strong>Páginas principales para iniciar flujos de pago:</strong></p>
                            <ul>
                                <li>
                                    <strong>index.php:</strong> Página principal que muestra las opciones disponibles (pago único o suscripción).
                                </li>
                                <li>
                                    <strong>single-payment.php:</strong> Muestra el producto de pago único con opciones para proceder al checkout.
                                </li>
                                <li>
                                    <strong>subscriptions-payment.php:</strong> Presenta los planes de suscripción disponibles (mensual y anual) y permite iniciar el proceso de suscripción.
                                </li>
                            </ul>

                            <p><strong>Páginas para visualización y gestión:</strong></p>
                            <ul>
                                <li>
                                    <strong>invoices.php:</strong> Muestra un listado de facturas y recibos, con opciones de filtrado por cliente y acceso a los documentos PDF.
                                </li>
                                <li>
                                    <strong>view-subscriptions.php:</strong> Permite ver y gestionar las suscripciones activas, incluyendo opciones para cancelación inmediata o al final del periodo.
                                </li>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-paint-brush"></i> <strong>Diseño:</strong> Todas las páginas utilizan Bootstrap 5 para el diseño y la maquetación, lo que proporciona una interfaz responsiva y moderna. También utilizan JavaScript para cargar datos de manera asíncrona desde los endpoints API.
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Endpoints de Checkout</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                Estos endpoints son responsables de crear sesiones de Checkout en Stripe cuando el usuario decide realizar un pago o suscribirse a un plan.
                            </p>
                            <ul>
                                <li>
                                    <strong>v1/create_payment_session.php:</strong> Crea una sesión de Checkout para un pago único. Recibe parámetros como cantidad, moneda y datos del cliente, y utiliza el <code>StripeCheckoutSessionService</code> para generar la sesión en Stripe.
                                </li>
                                <br>
                                <li>
                                    <strong>v1/create_subscription_session.php:</strong> Crea una sesión de Checkout para una suscripción. Recibe el ID del plan (mensual o anual) y datos del cliente, y utiliza el <code>StripeCheckoutSessionService</code> para configurar la suscripción en Stripe.
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Endpoint de Webhook</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <strong>v1/webhook.php:</strong> Este es el punto de entrada más crítico de la aplicación, responsable de recibir todos los webhooks enviados por Stripe. Sus responsabilidades incluyen:
                            </p>
                            <ul>
                                <li>Recibir el payload JSON completo del webhook de Stripe.</li>
                                <li>Verificar la firma criptográfica utilizando el signing secret de Stripe.</li>
                                <li>Delegar el procesamiento al <code>StripeWebhookController</code>.</li>
                                <li>Manejar errores y devolver códigos de estado HTTP apropiados.</li>
                            </ul>

                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-shield-alt"></i> <strong>Seguridad crítica:</strong> La verificación de la firma es esencial para garantizar que las peticiones provienen realmente de Stripe y no han sido manipuladas. Sin esta verificación, un atacante podría enviar eventos falsos que podrían resultar en fraude o manipulación de datos sensibles.
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Endpoints API</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                Estos endpoints proporcionan acceso a los datos de la aplicación para que la interfaz de usuario pueda mostrarlos y permitir interacciones con ellos.
                            </p>
                            <ul>
                                <li>
                                    <strong>api/api-invoices.php:</strong> Proporciona acceso a los datos de facturas y recibos. Admite acciones como <code>list_all</code> (listar todas las facturas) y <code>list_customer</code> (listar facturas de un cliente específico).
                                </li>
                                <br>
                                <li>
                                    <strong>api/api-subscriptions.php:</strong> Permite acceder a los datos de suscripciones. Soporta acciones como <code>list_all_system</code> (todas las suscripciones) y <code>list_customer</code> (suscripciones de un cliente).
                                </li>
                                <br>
                                <li>
                                    <strong>api/api-manage-subscription.php:</strong> Gestiona operaciones sobre suscripciones, principalmente la cancelación (inmediata o al final del periodo) utilizando el <code>StripeSubscriptionManagementService</code>.
                                </li>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-code"></i> <strong>Arquitectura:</strong> Estos endpoints API siguen un patrón simple pero efectivo: validar la entrada, delegar la lógica a servicios especializados, y devolver respuestas JSON estructuradas que pueden ser consumidas fácilmente por el frontend.
                            </div>
                        </div>
                    </div>
                </div>

                <div id="controladores" class="subsection">
                    <h4>7.5. Controladores (src/Controller/ e src/Controller/Impl/)</h4>
                    <p>
                        Los controladores coordinan el flujo de la aplicación, recibiendo peticiones HTTP, delegando la lógica de negocio a los servicios apropiados, y devolviendo respuestas estructuradas. La arquitectura se basa en interfaces y separación de responsabilidades, siguiendo el Principio de Inversión de Dependencias (DIP) de SOLID.
                    </p>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>StripeWebhookController</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <strong>Rol principal:</strong> Actúa como punto de entrada para los eventos de webhook de Stripe, verificando la firma y delegando el procesamiento al servicio adecuado.
                            </p>
                            <p><strong>Implementación basada en interfaces:</strong></p>
                            <ul>
                                <li><strong>StripeWebhookControllerInterface:</strong> Define el contrato para manejar webhooks de Stripe.</li>
                                <li><strong>StripeWebhookControllerImpl:</strong> Implementación concreta que delega en StripeWebhookService.</li>
                            </ul>
                            <p><strong>Responsabilidades:</strong></p>
                            <ul>
                                <li>Recibir y validar los payloads de webhook entrantes.</li>
                                <li>Verificar la firma criptográfica del webhook utilizando el signing secret.</li>
                                <li>Delegar el procesamiento del evento al <code>StripeWebhookService</code>.</li>
                                <li>Manejar excepciones y errores que puedan ocurrir durante el procesamiento.</li>
                                <li>Devolver respuestas HTTP apropiadas (200 OK para procesamiento exitoso, 4xx para errores del cliente, 5xx para errores del servidor).</li>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle"></i> <strong>Importancia:</strong> Este controlador es crítico para el funcionamiento de la aplicación, ya que gestiona toda la comunicación asíncrona con Stripe. Su diseño robusto para el manejo de errores asegura que los webhooks sean procesados correctamente o que se proporcionen respuestas adecuadas en caso de fallos.
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>StripeInvoiceController</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <strong>Rol principal:</strong> Proporciona endpoints para que la interfaz de usuario obtenga datos sobre facturas y recibos.
                            </p>
                            <p><strong>Implementación basada en interfaces:</strong></p>
                            <ul>
                                <li><strong>StripeInvoiceControllerInterface:</strong> Define el contrato para manejar solicitudes relacionadas con facturas.</li>
                                <li><strong>StripeInvoiceControllerImpl:</strong> Implementación concreta que utiliza el InvoiceRepository.</li>
                            </ul>
                            <p><strong>Responsabilidades:</strong></p>
                            <ul>
                                <li>Validar y procesar parámetros de solicitud (filtros, paginación, etc.).</li>
                                <li>Delegar la recuperación de datos al <code>InvoiceRepository</code>.</li>
                                <li>Formatear y devolver datos en formato JSON para su consumo por el frontend.</li>
                                <li>Gestionar errores y excepciones que puedan ocurrir durante la recuperación de datos.</li>
                            </ul>

                            <div class="alert alert-success mt-3">
                                <i class="fas fa-check-circle"></i> <strong>Diseño:</strong> Este controlador sigue el principio de responsabilidad única, centrándose exclusivamente en la coordinación de las solicitudes relacionadas con facturas. Toda la lógica de negocio y acceso a datos se delega al repositorio y servicio, manteniendo el código limpio y modular.
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>StripeSubscriptionController</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <strong>Rol principal:</strong> Gestiona las operaciones relacionadas con la obtención y visualización de datos de suscripciones.
                            </p>
                            <p><strong>Implementación basada en interfaces:</strong></p>
                            <ul>
                                <li><strong>StripeSubscriptionControllerInterface:</strong> Define el contrato para manejar solicitudes relacionadas con suscripciones.</li>
                                <li><strong>StripeSubscriptionControllerImpl:</strong> Implementación concreta que utiliza el SubscriptionRepository.</li>
                            </ul>
                            <p><strong>Responsabilidades:</strong></p>
                            <ul>
                                <li>Obtener listas completas de suscripciones o filtradas por cliente.</li>
                                <li>Proporcionar endpoints para ver detalles específicos de suscripciones.</li>
                                <li>Delegar las operaciones de acceso a datos al <code>SubscriptionRepository</code>.</li>
                                <li>Formatear los datos para que sean consumidos por la interfaz de usuario.</li>
                                <li>Manejar errores específicos relacionados con la obtención de datos de suscripciones.</li>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-lightbulb"></i> <strong>Arquitectura:</strong> La implementación basada en interfaces permite una mayor flexibilidad y testabilidad. Los controladores dependen de abstracciones (interfaces) y no de implementaciones concretas, siguiendo el Principio de Inversión de Dependencias de SOLID.
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-primary mt-3">
                        <i class="fas fa-code-branch"></i> <strong>Principios de Diseño:</strong> La arquitectura de controladores refleja claramente:
                        <ul>
                            <li><strong>Principios SOLID</strong>, especialmente el Principio de Inversión de Dependencias (DIP).</li>
                            <li><strong>Separación de capas</strong> (controlador, servicio, repositorio).</li>
                            <li><strong>Uso de interfaces</strong> para definir contratos claros entre componentes.</li>
                            <li><strong>Patrón Controlador → Servicio → Repositorio</strong> para una estructura mantenible y extensible.</li>
                        </ul>
                    </div>
                </div>


                <div id="servicios" class="subsection">
                    <h4>7.6. Servicios (src/Service/ e src/Service/Impl/)</h4>
                    <p>
                        Los servicios implementan la lógica de negocio principal de la aplicación, coordinando operaciones complejas, interactuando con APIs externas y orquestando el flujo de datos entre diferentes componentes. Siguen principios SOLID y patrones de diseño establecidos.
                    </p>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>StripeWebhookService</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <strong>Rol principal:</strong> Orquestar la validación y el procesamiento de los webhooks de Stripe, enrutando cada tipo de evento a la estrategia apropiada.
                            </p>
                            <p><strong>Implementación basada en interfaces:</strong></p>
                            <ul>
                                <li><strong>StripeWebhookServiceInterface:</strong> Define el contrato para la validación y procesamiento de webhooks.</li>
                                <li><strong>StripeWebhookServiceImpl:</strong> Implementación concreta que utiliza el SDK de Stripe y las estrategias.</li>
                            </ul>
                            <p><strong>Funcionalidades principales:</strong></p>
                            <ul>
                                <li><strong>constructEvent():</strong> Verifica la firma criptográfica de los webhooks utilizando el signing secret de Stripe y parsea el evento.</li>
                                <li><strong>processWebhookEvent():</strong> Analiza el tipo de evento recibido, loguea el payload con <code>StripePayloadLogger</code>, e itera sobre las estrategias registradas para encontrar la aplicable.</li>
                                <li>Llama a <code>isApplicable()</code> para cada estrategia y ejecuta <code>process()</code> en la primera que aplique.</li>
                                <li>Gestiona errores durante el procesamiento y lanza excepciones apropiadas (<code>WebhookProcessingException</code>).</li>
                                <li>Registra eventos no manejados con <code>UnhandledStripeEventLogger</code> para análisis futuro.</li>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-cogs"></i> <strong>Diseño:</strong> Este servicio actúa como un coordinador central para el procesamiento de webhooks, siguiendo el principio de alta cohesión y bajo acoplamiento. Implementa el Patrón Estrategia (Strategy Pattern) para delegar el procesamiento específico de cada tipo de evento.
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>StripeCheckoutSessionService</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <strong>Rol principal:</strong> Crear y configurar sesiones de Checkout de Stripe para pagos únicos y suscripciones.
                            </p>
                            <p><strong>Implementación basada en interfaces:</strong></p>
                            <ul>
                                <li><strong>StripeCheckoutServiceInterface:</strong> Define el contrato para la creación de sesiones de Checkout.</li>
                                <li><strong>StripeCheckoutSessionServiceImpl:</strong> Implementación concreta que interactúa con la API de Stripe.</li>
                            </ul>
                            <p><strong>Funcionalidades principales:</strong></p>
                            <ul>
                                <li>Interactuar con la API de Stripe (<code>checkout->sessions->create</code>) para crear sesiones de Checkout.</li>
                                <li>Configurar parámetros específicos para diferentes tipos de sesiones (pago único vs. suscripción).</li>
                                <li>Utilizar <code>lookup_keys</code> para obtener IDs de precios.</li>
                                <li>Gestionar la información del cliente (email, nombre) y pasarla a Stripe.</li>
                                <li>Configurar URLs de redirección para éxito y cancelación.</li>
                                <li>Manejar errores de la API de Stripe y convertirlos en excepciones amigables.</li>
                            </ul>

                            <div class="alert alert-success mt-3">
                                <i class="fas fa-shield-alt"></i> <strong>Ventaja:</strong> Stripe Checkout simplifica enormemente el proceso de pago, ya que maneja automáticamente la validación de tarjetas, la autenticación 3D Secure, y ofrece una experiencia de usuario optimizada y consistente. Este servicio funciona como una fachada (Facade Pattern) que esconde la complejidad del SDK de Stripe y proporciona una interfaz limpia para el resto de la aplicación.
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>StripeSubscriptionManagementService</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <strong>Rol principal:</strong> Gestionar operaciones relacionadas con suscripciones existentes, como la cancelación o actualización.
                            </p>
                            <p><strong>Implementación basada en interfaces:</strong></p>
                            <ul>
                                <li><strong>StripeSubscriptionManagementServiceInterface:</strong> Define el contrato para la gestión de suscripciones.</li>
                                <li><strong>StripeSubscriptionManagementServiceImpl:</strong> Implementación concreta que interactúa con la API de Stripe.</li>
                            </ul>
                            <p><strong>Funcionalidades principales:</strong></p>
                            <ul>
                                <li>Interactuar con la API de Stripe para modificar suscripciones existentes (<code>subscriptions->cancel()</code> o <code>subscriptions->update()</code>).</li>
                                <li>Proporcionar opciones para cancelar suscripciones inmediatamente o al final del periodo (<code>cancel_at_period_end</code>).</li>
                                <li>Manejar errores y excepciones específicas de la API de Stripe relacionadas con suscripciones.</li>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-sync-alt"></i> <strong>Principio de Responsabilidad Única:</strong> Este servicio se enfoca exclusivamente en la gestión de suscripciones existentes, siguiendo el Principio de Responsabilidad Única (SRP) de SOLID. Su única responsabilidad es modificar suscripciones a través de la API de Stripe, sin mezclarse con otras funcionalidades.
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-primary mt-3">
                        <i class="fas fa-book"></i> <strong>Patrones y Principios Aplicados:</strong>
                        <ul>
                            <li><strong>Principio de Responsabilidad Única (SRP):</strong> Cada servicio tiene una única responsabilidad bien definida.</li>
                            <li><strong>Patrón Estrategia (Strategy Pattern):</strong> Utilizado en el <code>StripeWebhookService</code> para separar el manejo de distintos tipos de eventos en clases diferentes.</li>
                            <li><strong>Inversión de Dependencias (DIP):</strong> Uso de interfaces para programar contra abstracciones, no implementaciones concretas.</li>
                            <li><strong>Arquitectura por Capas:</strong> Clara separación entre controladores, servicios e infraestructura.</li>
                            <li><strong>Patrón Facade:</strong> Los servicios funcionan como fachadas ante la complejidad del SDK de Stripe, proporcionando una interfaz simplificada.</li>
                        </ul>
                    </div>
                </div>

                <div id="estrategias" class="subsection">
                    <h4>7.7. Estrategias (src/Strategy/)</h4>
                    <p>
                        El patrón Strategy se utiliza extensivamente en la aplicación para manejar los diferentes tipos de eventos de webhook de Stripe de forma modular y extensible. Cada estrategia encapsula la lógica específica para procesar un tipo particular de evento.
                    </p>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Patrón Strategy en la Aplicación</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <strong>¿Por qué usar el patrón Strategy?</strong> Stripe puede enviar más de 100 tipos diferentes de eventos de webhook, cada uno requiriendo un procesamiento específico. El patrón Strategy permite:
                            </p>
                            <ul>
                                <li>Encapsular la lógica de procesamiento de cada tipo de evento en clases separadas.</li>
                                <li>Añadir soporte para nuevos tipos de eventos sin modificar el código existente (principio Open/Closed).</li>
                                <li>Facilitar las pruebas unitarias al aislar la lógica específica de cada tipo de evento.</li>
                                <li>Mantener una estructura de código clara y organizada, evitando funciones monolíticas con múltiples declaraciones switch/case.</li>
                            </ul>

                            <p><strong>Implementación:</strong></p>
                            <p>Se definió <code>StripeWebhookStrategyInterface</code> con métodos clave:</p>
                            <ul>
                                <li><code>isApplicable(StripeEvent $event)</code>: Determina si la estrategia puede manejar el evento.</li>
                                <li><code>process(StripeEvent $event)</code>: Procesa el evento específico.</li>
                                <li><code>getSupportedEventType()</code>: Método estático que devuelve el tipo de evento soportado.</li>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-cogs"></i> <strong>Flujo Interno Típico de una Estrategia:</strong>
                                <ol>
                                    <li>La estrategia recibe un evento Stripe.</li>
                                    <li>Utiliza un <strong>Mapper</strong> para convertir el payload de Stripe en un <strong>DTO</strong> estructurado.</li>
                                    <li>Pasa el DTO a un <strong>Factory</strong> que crea una <strong>Entidad</strong> de dominio.</li>
                                    <li>Utiliza un <strong>Repository</strong> para persistir la entidad en la base de datos.</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Detalle de cada Estrategia Implementada</strong>
                        </div>
                        <div class="card-body">
                            <div class="accordion" id="accordionStrategies">
                                <!-- CheckoutSessionCompletedStrategy -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingCheckoutSession">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCheckoutSession" aria-expanded="true" aria-controls="collapseCheckoutSession">
                                            CheckoutSessionCompletedStrategyImpl
                                        </button>
                                    </h2>
                                    <div id="collapseCheckoutSession" class="accordion-collapse collapse show" aria-labelledby="headingCheckoutSession" data-bs-parent="#accordionStrategies">
                                        <div class="accordion-body">
                                            <p><strong>Eventos manejados:</strong> <code>checkout.session.completed</code> (referencia a <code>StripeEventTypeEnum</code>)</p>
                                            <p><strong>Dependencias principales:</strong> <code>CheckoutSessionMapper</code>, <code>TransactionModelFactory</code>, <code>TransactionRepository</code></p>
                                            <p><strong>Lógica principal:</strong></p>
                                            <ul>
                                                <li>Maneja la confirmación del checkout.</li>
                                                <li>Determina si la sesión de Checkout es para un pago único o una suscripción, basándose en el campo <code>mode</code>.</li>
                                                <li>Para pagos únicos: crea transacciones preliminares utilizando <code>TransactionModelFactory</code>.</li>
                                                <li>Actualiza emails en suscripciones si corresponde.</li>
                                                <li>Guarda referencias al cliente, pago o suscripción asociados.</li>
                                            </ul>
                                            <div class="alert alert-info mt-3">
                                                <i class="fas fa-info-circle"></i> <strong>Nota:</strong> Este evento es importante porque confirma que el usuario ha completado el flujo de pago en Stripe Checkout. Sin embargo, para pagos de suscripción, este evento se complementa con <code>invoice.paid</code> y <code>customer.subscription.created</code>, que proporcionan información adicional sobre la transacción.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- PaymentIntentSucceededStrategy -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingPaymentIntent">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePaymentIntent" aria-expanded="false" aria-controls="collapsePaymentIntent">
                                            PaymentIntentSucceededStrategyImpl
                                        </button>
                                    </h2>
                                    <div id="collapsePaymentIntent" class="accordion-collapse collapse" aria-labelledby="headingPaymentIntent" data-bs-parent="#accordionStrategies">
                                        <div class="accordion-body">
                                            <p><strong>Eventos manejados:</strong> <code>payment_intent.succeeded</code></p>
                                            <p><strong>Dependencias principales:</strong> <code>PaymentIntentMapper</code>, <code>TransactionModelFactory</code>, <code>TransactionRepository</code></p>
                                            <p><strong>Lógica principal:</strong></p>
                                            <ul>
                                                <li>Se ha refinado significativamente para evitar crear transacciones "duplicadas".</li>
                                                <li>Extrae detalles del pago como importe, moneda, cliente, y estado.</li>
                                                <li>Utiliza una heurística para determinar si el PaymentIntent ya ha sido procesado:</li>
                                                <ul>
                                                    <li>Verifica basándose en la descripción del PI o la presencia de un invoiceId en el DTO.</li>
                                                    <li>Comprueba si el PaymentIntent está asociado a una suscripción, en cuyo caso se deja el procesamiento a <code>InvoicePaidStrategyImpl</code>.</li>
                                                </ul>
                                                <li>Su rol principal es registrar pagos únicos directos o enriquecer transacciones de facturas existentes.</li>
                                            </ul>
                                            <div class="alert alert-warning mt-3">
                                                <i class="fas fa-exclamation-triangle"></i> <strong>Desafío:</strong> La correcta gestión de pagos de suscripción requiere evitar duplicaciones, ya que tanto <code>payment_intent.succeeded</code> como <code>invoice.paid</code> pueden referirse a la misma transacción. La estrategia resuelve esto comprobando la vinculación del PaymentIntent con una factura y delegando el procesamiento cuando corresponde.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ChargeSucceededStrategy -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingCharge">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCharge" aria-expanded="false" aria-controls="collapseCharge">
                                            ChargeSucceededStrategyImpl
                                        </button>
                                    </h2>
                                    <div id="collapseCharge" class="accordion-collapse collapse" aria-labelledby="headingCharge" data-bs-parent="#accordionStrategies">
                                        <div class="accordion-body">
                                            <p><strong>Eventos manejados:</strong> <code>charge.succeeded</code></p>
                                            <p><strong>Dependencias principales:</strong> <code>ChargeMapper</code>, <code>TransactionRepository</code></p>
                                            <p><strong>Lógica principal:</strong></p>
                                            <ul>
                                                <li>Enriquece transacciones existentes con <code>receipt_url</code>.</li>
                                                <li>Añade detalles del método de pago (últimos 4 dígitos, marca, etc.)</li>
                                                <li>Incluye resultados de validaciones (verificación de CVC, dirección)</li>
                                                <li>Actualiza la transacción en la base de datos con estos datos adicionales.</li>
                                            </ul>
                                            <div class="alert alert-info mt-3">
                                                <i class="fas fa-lightbulb"></i> <strong>Diseño:</strong> Esta estrategia se enfoca en enriquecer datos, no en crear nuevos registros. Funciona bajo la premisa de que la transacción ya existe en la base de datos, creada previamente por <code>PaymentIntentSucceededStrategyImpl</code> o <code>InvoicePaidStrategyImpl</code>.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- CustomerCreatedOrUpdatedStrategy -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingCustomer">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCustomer" aria-expanded="false" aria-controls="collapseCustomer">
                                            CustomerCreatedOrUpdatedStrategyImpl
                                        </button>
                                    </h2>
                                    <div id="collapseCustomer" class="accordion-collapse collapse" aria-labelledby="headingCustomer" data-bs-parent="#accordionStrategies">
                                        <div class="accordion-body">
                                            <p><strong>Eventos manejados:</strong> <code>customer.created</code>, <code>customer.updated</code></p>
                                            <p><strong>Dependencias principales:</strong> <code>CustomerMapper</code>, repositorios relevantes para actualización de datos</p>
                                            <p><strong>Lógica principal:</strong></p>
                                            <ul>
                                                <li>Actualiza datos denormalizados del cliente (email) en otras entidades.</li>
                                                <li>Mapea los datos del cliente a un DTO estructurado.</li>
                                                <li>Sincroniza información como email, nombre, o dirección de facturación.</li>
                                            </ul>
                                            <div class="alert alert-secondary mt-3">
                                                <i class="fas fa-info-circle"></i> <strong>Utilidad:</strong> Esta estrategia asegura que los cambios en la información del cliente en Stripe (como un cambio de email) se reflejen en todas las entidades relacionadas del sistema.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- SubscriptionCreatedStrategy -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingSubscriptionCreated">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSubscriptionCreated" aria-expanded="false" aria-controls="collapseSubscriptionCreated">
                                            SubscriptionCreatedStrategyImpl
                                        </button>
                                    </h2>
                                    <div id="collapseSubscriptionCreated" class="accordion-collapse collapse" aria-labelledby="headingSubscriptionCreated" data-bs-parent="#accordionStrategies">
                                        <div class="accordion-body">
                                            <p><strong>Eventos manejados:</strong> <code>customer.subscription.created</code></p>
                                            <p><strong>Dependencias principales:</strong> <code>SubscriptionMapper</code>, <code>SubscriptionModelFactory</code>, <code>SubscriptionRepository</code></p>
                                            <p><strong>Lógica principal:</strong></p>
                                            <ul>
                                                <li>Procesa la creación de nuevas suscripciones, extrayendo información detallada.</li>
                                                <li>Utiliza <code>SubscriptionMapper</code> para crear un DTO con los datos de la suscripción.</li>
                                                <li>Utiliza <code>SubscriptionModelFactory</code> para crear la entidad de suscripción.</li>
                                                <li>Incluye lógica para obtener el email del cliente vía API si es necesario.</li>
                                                <li>Persiste la nueva suscripción usando <code>SubscriptionRepository</code>.</li>
                                            </ul>
                                            <div class="alert alert-info mt-3">
                                                <i class="fas fa-info-circle"></i> <strong>Flujo:</strong> Esta estrategia suele ejecutarse después de <code>checkout.session.completed</code> y antes de <code>invoice.paid</code> cuando un cliente se suscribe a un plan. Registra los detalles de la suscripción que serán utilizados para gestionar el acceso a funcionalidades premium o contenido restringido.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- SubscriptionUpdatedStrategy -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingSubscriptionUpdated">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSubscriptionUpdated" aria-expanded="false" aria-controls="collapseSubscriptionUpdated">
                                            SubscriptionUpdatedStrategyImpl
                                        </button>
                                    </h2>
                                    <div id="collapseSubscriptionUpdated" class="accordion-collapse collapse" aria-labelledby="headingSubscriptionUpdated" data-bs-parent="#accordionStrategies">
                                        <div class="accordion-body">
                                            <p><strong>Eventos manejados:</strong> <code>customer.subscription.updated</code></p>
                                            <p><strong>Dependencias principales:</strong> <code>SubscriptionMapper</code>, <code>SubscriptionRepository</code></p>
                                            <p><strong>Lógica principal:</strong></p>
                                            <ul>
                                                <li>Procesa actualizaciones de suscripciones existentes, detectando diversos cambios.</li>
                                                <li>Utiliza <code>SubscriptionMapper</code> para crear un DTO con los datos actualizados.</li>
                                                <li>Actualiza el registro de suscripción en la base de datos mediante <code>SubscriptionRepository</code>.</li>
                                                <li>Presta especial atención a la detección de cancelaciones programadas, para reflejar correctamente que la suscripción terminará al final del periodo actual.</li>
                                            </ul>
                                            <div class="alert alert-warning mt-3">
                                                <i class="fas fa-exclamation-triangle"></i> <strong>Caso especial:</strong> Cuando un usuario solicita cancelar su suscripción al final del periodo actual, Stripe envía un evento <code>customer.subscription.updated</code> con <code>cancel_at_period_end = true</code>, no un evento de cancelación inmediata. Esta estrategia maneja ese escenario específico.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- SubscriptionDeletedStrategy -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingSubscriptionDeleted">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSubscriptionDeleted" aria-expanded="false" aria-controls="collapseSubscriptionDeleted">
                                            SubscriptionDeletedStrategyImpl
                                        </button>
                                    </h2>
                                    <div id="collapseSubscriptionDeleted" class="accordion-collapse collapse" aria-labelledby="headingSubscriptionDeleted" data-bs-parent="#accordionStrategies">
                                        <div class="accordion-body">
                                            <p><strong>Eventos manejados:</strong> <code>customer.subscription.deleted</code></p>
                                            <p><strong>Dependencias principales:</strong> <code>SubscriptionMapper</code>, <code>SubscriptionRepository</code></p>
                                            <p><strong>Lógica principal:</strong></p>
                                            <ul>
                                                <li>Procesa la cancelación definitiva de una suscripción, ya sea por cancelación inmediata o finalización programada.</li>
                                                <li>Utiliza <code>SubscriptionMapper</code> para mapear los datos del evento.</li>
                                                <li>Actualiza el estado de la suscripción a "canceled" en la base de datos mediante <code>SubscriptionRepository</code>.</li>
                                                <li>Registra las fechas de cancelación y finalización.</li>
                                            </ul>
                                            <div class="alert alert-info mt-3">
                                                <i class="fas fa-info-circle"></i> <strong>Impacto:</strong> El procesamiento correcto de este evento es crucial para actualizar los permisos de acceso del usuario. Cuando se recibe este evento, se debe revocar el acceso a funcionalidades premium o contenido restringido que requería una suscripción activa.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- InvoicePaidStrategy -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingInvoicePaid">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInvoicePaid" aria-expanded="false" aria-controls="collapseInvoicePaid">
                                            InvoicePaidStrategyImpl
                                        </button>
                                    </h2>
                                    <div id="collapseInvoicePaid" class="accordion-collapse collapse" aria-labelledby="headingInvoicePaid" data-bs-parent="#accordionStrategies">
                                        <div class="accordion-body">
                                            <p><strong>Eventos manejados:</strong> <code>invoice.paid</code></p>
                                            <p><strong>Dependencias principales:</strong> <code>InvoiceMapper</code>, <code>TransactionModelFactory</code>, <code>TransactionRepository</code>, <code>SubscriptionRepository</code></p>
                                            <p><strong>Lógica principal:</strong></p>
                                            <ul>
                                                <li>Crea la transacción principal para las facturas, especialmente de suscripciones.</li>
                                                <li>Utiliza <code>InvoiceMapper</code> para mapear los datos de la factura a un DTO.</li>
                                                <li>Crea un registro de transacción de tipo SUBSCRIPTION usando <code>TransactionModelFactory</code>.</li>
                                                <li>Actualiza <code>latest_transaction_id</code> en la suscripción correspondiente.</li>
                                                <li>Si la factura corresponde a una renovación, actualiza el periodo actual de la suscripción.</li>
                                            </ul>
                                            <div class="alert alert-success mt-3">
                                                <i class="fas fa-check-circle"></i> <strong>Importancia:</strong> Este evento es fundamental para el seguimiento financiero de las suscripciones, ya que confirma cada pago recurrente. También permite mantener un historial completo de todos los pagos realizados por cada suscripción.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-primary mt-3">
                        <i class="fas fa-book"></i> <strong>Patrones y Principios Aplicados:</strong>
                        <br>
                        <br>
                        <ul>
                            <li><strong>Patrón Strategy:</strong> Cada clase (XxxStrategyImpl) implementa la interfaz común y encapsula una forma específica de manejar un evento Stripe.</li>
                            <br>
                            <li><strong>Principio de Responsabilidad Única (SRP):</strong> Cada estrategia hace una sola cosa bien: manejar un único tipo de evento Stripe.</li>
                            <br>
                            <li><strong>Inyección de Dependencias (DI) + DIP:</strong> Cada estrategia recibe sus dependencias (mappers, factories, repositorios) por constructor.</li>
                            <br>
                            <li><strong>Patrón Mapper / DTO:</strong> Las estrategias utilizan Mappers para convertir el StripePayload en DTOs estructurados.</li>
                            <br>
                            <li><strong>Patrón Factory:</strong> Los Factories toman los DTOs y crean Entidades de Dominio listas para persistir.</li>
                            <br>
                            <li><strong>Patrón Repository:</strong> Las estrategias usan Repositories para abstraer el acceso a la base de datos.</li>
                            <br>
                            <li><strong>Chain of Responsibility (implícito):</strong> El servicio StripeWebhookService recorre todas las estrategias hasta encontrar una aplicable.</li>
                            <br>
                            <li><strong>Principio Open/Closed (OCP):</strong> El sistema está abierto a extensión (nuevas estrategias) pero cerrado a modificación.</li>
                            <br>
                        </ul>
                    </div>
                </div>

                <div id="mappers" class="subsection">
                    <h4>7.8. Mappers (src/Mappers/)</h4>
                    <p>
                        Los Mappers son responsables de transformar entre diferentes representaciones de datos, principalmente de convertir el objeto <code>data.object</code> del payload de un evento de Stripe a un DTO específico de la aplicación.
                    </p>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Rol principal de los Mappers</strong>
                        </div>
                        <div class="card-body">
                            <p>Los Mappers en la aplicación cumplen varias funciones clave:</p>
                            <ul>
                                <li><strong>Traducir la estructura</strong> del objeto <code>data.object</code> del payload de un evento de Stripe a un DTO específico de la aplicación.</li>
                                <br>
                                <li><strong>Manejar campos opcionales</strong> y validar campos esenciales, lanzando <code>InvalidWebhookPayloadException</code> cuando sea necesario.</li>
                                <br>
                                <li><strong>Acceder de forma segura</strong> a propiedades de objetos Stripe que usan métodos mágicos (<code>__get</code>, <code>__isset</code>).</li>
                                <br>
                                <li><strong>Extraer información de estructuras anidadas</strong> complejas en el payload de Stripe.</li>
                                <br>
                                <li><strong>Estandarizar formatos</strong> para fechas, monedas y valores enumerados.</li>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle"></i> <strong>Métodos mágicos en Stripe:</strong> Las clases del SDK de Stripe (como <code>\Stripe\Subscription</code>, <code>\Stripe\Invoice</code>) utilizan métodos mágicos de PHP (<code>__get</code>, <code>__isset</code>, <code>__set</code>) para simular el acceso a propiedades. Esto puede causar problemas con <code>isset()</code> y valores <code>null</code>, que los Mappers resuelven con lógica robusta de acceso a datos.
                            </div>

                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle"></i> <strong>Desafío:</strong> Los payloads de Stripe pueden variar significativamente en estructura según el tipo de evento y la versión de la API. Los Mappers deben ser robustos ante estas variaciones, manejando correctamente campos opcionales y estructuras anidadas (por ejemplo, extrayendo <code>priceId</code> de <code>items</code> o <code>plan</code> en <code>Subscription</code>).
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Implementación específica de Mappers</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                Se creó un Mapper por cada DTO principal para manejar las diferentes estructuras de datos. Algunos ejemplos clave:
                            </p>

                            <h5 class="mt-3">SubscriptionMapper</h5>
                            <p>Responsable de convertir eventos relacionados con suscripciones a <code>SubscriptionDTO</code>.</p>
                            <ul>
                                <li>Extrae <code>price_id</code> de diferentes ubicaciones posibles (<code>items</code> o <code>plan</code>).</li>
                                <li>Convierte timestamps Unix de Stripe a objetos <code>DateTime</code>.</li>
                                <li>Maneja campos opcionales como <code>canceled_at</code> y <code>ended_at</code>.</li>
                                <li>Extrae información del plan como nombre, importe, intervalo y moneda.</li>
                            </ul>

                            <h5 class="mt-4">InvoiceMapper</h5>
                            <p>Convierte eventos de factura a <code>InvoiceDTO</code>, manejando las complejidades específicas de las facturas Stripe.</p>
                            <ul>
                                <li>Busca <code>subscription_id</code> en diferentes ubicaciones del payload según el contexto.</li>
                                <li>Extrae URLs de factura y recibo cuando están disponibles.</li>
                                <li>Maneja la conversión de importes de centavos (formato Stripe) a unidades.</li>
                                <li>Extrae metadatos importantes como descripciones e información del cliente.</li>
                            </ul>

                            <h5 class="mt-4">PaymentIntentMapper</h5>
                            <p>Transforma eventos de intención de pago a <code>TransactionDTO</code>.</p>
                            <ul>
                                <li>Determina el tipo de transacción (pago único o suscripción) basándose en propiedades del PaymentIntent.</li>
                                <li>Extrae información esencial como importe, moneda, cliente y estado.</li>
                                <li>Verifica si el PaymentIntent está asociado a una factura específica.</li>
                            </ul>

                            <h5 class="mt-4">ChargeMapper</h5>
                            <p>Especializado en extraer información detallada de pagos completados.</p>
                            <ul>
                                <li>Obtiene la URL del recibo (<code>receipt_url</code>) para visualización posterior.</li>
                                <li>Extrae detalles del método de pago (últimos 4 dígitos, marca, fecha de caducidad).</li>
                                <li>Captura resultados de verificaciones (CVC, dirección, código postal).</li>
                            </ul>

                            <div class="alert alert-success mt-3">
                                <i class="fas fa-check-circle"></i> <strong>Ventajas del patrón Data Mapper:</strong>
                                <br>
                                <br>
                                <ul>
                                    <li><strong>Desacoplamiento:</strong> Separa la lógica de negocio de la estructura de datos externa (Stripe).</li>
                                    <br>
                                    <li><strong>Robustez ante cambios:</strong> Si Stripe modifica su API, solo hay que ajustar los Mappers, no toda la aplicación.</li>
                                    <br>
                                    <li><strong>Centralización de validaciones:</strong> Los campos obligatorios se verifican una sola vez, en el Mapper.</li>
                                    <br>
                                    <li><strong>Simplificación para el resto del sistema:</strong> Las estrategias trabajan con DTOs limpios, sin preocuparse por la estructura original de Stripe.</li>
                                    <br>
                                    <li><strong>Manejo de errores controlado:</strong> Problemas en la estructura de datos se capturan temprano con excepciones específicas.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-primary mt-3">
                        <i class="fas fa-code-branch"></i> <strong>Mejoras implementadas:</strong>
                        <br>
                        <br>
                        <ul>
                            <li>Se refinó la lógica de acceso a propiedades de los objetos de Stripe para evitar problemas con <code>isset()</code> y manejar correctamente los valores <code>null</code>.</li>
                            <br>
                            <li>Se añadió logging de depuración para facilitar el seguimiento de problemas en la conversión de datos.</li>
                            <br>
                            <li>Se implementó validación de campos esenciales, lanzando <code>InvalidWebhookPayloadException</code> cuando falta información crítica.</li>
                            <br>
                            <li>Se ajustaron los Mappers para extraer datos de estructuras anidadas en diferentes ubicaciones posibles, aumentando la robustez.</li>
                        </ul>
                    </div>
                </div>

                <div id="factories" class="subsection">
                    <h4>7.9. Factories (src/Factories/)</h4>
                    <p>
                        Las Factories son responsables de crear instancias de objetos complejos, especialmente entidades de dominio (Models), a partir de DTOs o datos externos como los payloads de Stripe.
                    </p>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Rol principal de las Factories</strong>
                        </div>
                        <div class="card-body">
                            <p>Las Factories en la aplicación cumplen varias funciones importantes:</p>
                            <ul>
                                <li><strong>Construir objetos Entidad</strong> (<code>TransactionsModel</code>, <code>SubscriptionsModel</code>) a partir de los DTOs.</li>
                                <br>
                                <li><strong>Encapsular la lógica de instanciación</strong>, incluyendo conversiones complejas (timestamps a <code>DateTimeImmutable</code>, strings a Enums).</li>
                                <br>
                                <li><strong>Garantizar la integridad de los datos</strong> aplicando validaciones y valores por defecto.</li>
                                <br>
                                <li><strong>Centralizar la lógica de creación</strong> para evitar duplicación en el código.</li>
                                <br>
                                <li><strong>Facilitar las pruebas unitarias</strong> al aislar la lógica de creación.</li>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-lightbulb"></i> <strong>Principios SOLID aplicados:</strong>
                                <br>
                                <br>
                                <ul>
                                    <li><strong>Responsabilidad Única (SRP):</strong> Cada Factory se encarga exclusivamente de crear y configurar objetos de un dominio específico.</li>
                                    <br>
                                    <li><strong>Abierto/Cerrado (OCP):</strong> Se pueden extender las Factories para nuevos modelos o crear variaciones sin modificar el código existente.</li>
                                    <br>
                                    <li><strong>Inversión de Dependencias (DIP):</strong> Las capas superiores (estrategias, servicios) dependen de abstracciones, no de implementaciones concretas.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>TransactionModelFactory</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <code>TransactionModelFactory</code> es responsable de crear instancias de <code>TransactionsModel</code> a partir de diferentes fuentes de datos. Sus responsabilidades específicas incluyen:
                            </p>
                            <ul>
                                <li>Crear objetos <code>TransactionsModel</code> a partir de DTOs o directamente de objetos Stripe.</li>
                                <li>Convertir tipos primitivos a tipos complejos (como strings a Enums).</li>
                                <li>Transformar fechas de timestamp a objetos <code>DateTimeImmutable</code>.</li>
                                <li>Convertir importes de centavos (formato Stripe) a unidades monetarias.</li>
                                <br>
                                <br>
                            </ul>
                            <p><strong>Cambios importantes:</strong></p>
                            <ul>
                                <li>Ya no genera <code>transaction_id</code> (ahora es responsabilidad de la base de datos con el autoincremental).</li>
                                <li>Maneja la conversión de estado y tipo de transacción a sus respectivos Enums.</li>
                            </ul>

                            <div class="alert alert-success mt-3">
                                <i class="fas fa-check-circle"></i> <strong>Ventajas:</strong> Al centralizar la lógica de creación, se evita la duplicación de código en diferentes partes de la aplicación. También asegura que todas las entidades de transacción se creen de manera consistente, con las mismas conversiones y validaciones.
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>SubscriptionModelFactory</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <code>SubscriptionModelFactory</code> maneja la creación y actualización de objetos <code>SubscriptionsModel</code>. Sus responsabilidades específicas incluyen:
                            </p>
                            <ul>
                                <li>Crear entidades <code>SubscriptionsModel</code> a partir de DTOs o eventos Stripe.</li>
                                <br>
                                <li>Actualizar entidades existentes con nuevos datos (actuando también como <em>Updater</em>).</li>
                                <br>
                                <li>Convertir strings de estado a <code>SubscriptionStatusEnum</code>.</li>
                                <br>
                                <li>Transformar timestamps a objetos <code>DateTimeImmutable</code> para todas las fechas relevantes.</li>
                                <br>
                                <li>Garantizar que todos los campos requeridos estén presentes y sean válidos.</li>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-cogs"></i> <strong>Funcionalidad dual:</strong> A diferencia de otras factories que solo crean nuevas instancias, <code>SubscriptionModelFactory</code> también puede actualizar modelos existentes, adaptándose a la naturaleza de las suscripciones que evolucionan a lo largo del tiempo (cambios de estado, cancelaciones, renovaciones).
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Beneficios del patrón Factory</strong>
                        </div>
                        <div class="card-body">
                            <p>El uso del patrón Factory en esta aplicación proporciona varios beneficios clave:</p>
                            <ul>
                                <li><strong>Centralización de la lógica de construcción:</strong> Las entidades requieren parsing, validación y adaptación. Centralizar esto evita código sucio y duplicado en estrategias y servicios.</li>
                                <br>
                                <li><strong>Transformación de datos sin contaminar entidades:</strong> Las entidades (<code>TransactionModel</code>, <code>SubscriptionModel</code>) permanecen como simples POPOs (Plain Old PHP Objects), sin lógica de parsing interna.</li>
                                <br>
                                <li><strong>Facilitación del testing:</strong> Se puede probar que una factory genera correctamente una entidad con una entrada específica sin tocar la base de datos.</li>
                                <br>
                                <li><strong>Mantenimiento del principio DRY:</strong> Se evita duplicar lógica como <code>new DateTimeImmutable($dto->timestamp)</code> o <code>SubscriptionStatusEnum::from($dto->status)</code>.</li>
                                <br>
                                <li><strong>Consistencia en la creación de objetos:</strong> Todas las entidades se crean siguiendo el mismo patrón y validaciones.</li>
                            </ul>

                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle"></i> <strong>Consideración importante:</strong> Las factories deben permanecer agnósticas a la persistencia. Su responsabilidad termina con la creación del objeto; la persistencia es responsabilidad exclusiva de los repositorios.
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-primary mt-3">
                        <i class="fas fa-book"></i> <strong>Patrones aplicados:</strong>
                        <br>
                        <br>
                        <ul>
                            <li><strong>Factory Method:</strong> Cada factory proporciona múltiples métodos para crear objetos del mismo tipo desde diferentes fuentes.</li>
                            <br>
                            <li><strong>Separación de responsabilidades:</strong> Las factories se encargan exclusivamente de la creación, dejando la persistencia a los repositorios y la lógica de negocio a los servicios.</li>
                        </ul>
                    </div>
                </div>

                <div id="repositories" class="subsection">
                    <h4>7.10. Repositories (src/Repository/ e src/Repository/Impl/)</h4>
                    <p>
                        Los Repositories proveen una abstracción de la capa de persistencia de datos, separando la lógica de dominio de los detalles técnicos de acceso a la base de datos.
                    </p>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Rol principal de los Repositories</strong>
                        </div>
                        <div class="card-body">
                            <p>Los Repositories en la aplicación cumplen varias funciones clave:</p>
                            <ul>
                                <li><strong>Abstraer la capa de persistencia</strong> (PDO para MySQL).</li><br>
                                <li><strong>Proporcionar una interfaz orientada al dominio</strong> para operaciones de datos.</li><br>
                                <li><strong>Encapsular consultas SQL</strong> y manejo de conexiones a la base de datos.</li><br>
                                <li><strong>Transformar datos de la base de datos</strong> en objetos de dominio (entidades).</li><br>
                                <li><strong>Manejar excepciones específicas de la base de datos</strong> y convertirlas en excepciones de dominio.</li><br>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-cogs"></i> <strong>Estructura:</strong> Todos los repositorios siguen una estructura basada en interfaces e implementaciones concretas:
                                <ul><br>
                                    <li>Interfaces (<code>TransactionRepositoryInterface</code>, <code>SubscriptionRepositoryInterface</code>, <code>InvoiceRepositoryInterface</code>) definen los contratos.</li><br>
                                    <li>Implementaciones concretas (<code>TransactionRepositoryImpl</code>, etc.) en el subdirectorio <code>Impl/</code> proporcionan la funcionalidad real con PDO.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>TransactionRepositoryImpl</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <code>TransactionRepositoryImpl</code> se encarga de gestionar la persistencia de transacciones en la tabla <code>StripeTransactions</code>.
                                Sus responsabilidades específicas incluyen:
                            </p>
                            <ul>
                                <li>Ejecutar operaciones <code>INSERT</code> para nuevas transacciones, obteniendo <code>lastInsertId()</code> para el <code>transaction_id</code> autoincremental.</li><br>
                                <li>Realizar operaciones <code>UPDATE</code> para transacciones existentes que reciben información adicional.</li><br>
                                <li>Implementar métodos de búsqueda como <code>findByStripeId()</code>, <code>findByCustomerId()</code>, etc.</li><br>
                                <li>Convertir filas de la base de datos en objetos <code>TransactionsModel</code>.</li><br>
                                <li>Manejar <code>PDOException</code> y relanzarlas como <code>DatabaseException</code> con contexto adicional.</li><br>
                                <li>Implementar logging de consultas para facilitar la depuración.</li><br>
                            </ul>

                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-database"></i> <strong>Característica clave:</strong> A diferencia de otros repositorios, <code>TransactionRepositoryImpl</code> maneja la asignación del <code>transaction_id</code> autoincremental obteniendo el último ID insertado de la base de datos después de una operación <code>INSERT</code>.
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>SubscriptionRepositoryImpl</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <code>SubscriptionRepositoryImpl</code> gestiona la persistencia de suscripciones en la tabla <code>StripeSubscriptions</code>. Sus responsabilidades específicas incluyen:
                            </p><br>
                            <ul>
                                <li>Utilizar <code>INSERT ... ON DUPLICATE KEY UPDATE</code> para operaciones <code>save()</code>, ya que el <code>subscription_id</code> de Stripe es la clave primaria natural.</li><br>
                                <li>Buscar suscripciones por ID, cliente, estado, etc.</li><br>
                                <li>Actualizar el estado de suscripciones (cancelación, renovación, etc.).</li><br>
                                <li>Relacionar suscripciones con su transacción más reciente (<code>latest_transaction_id</code>).</li><br>
                                <li>Convertir filas de la base de datos en objetos <code>SubscriptionsModel</code>.</li><br>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-sync-alt"></i> <strong>Patrón UPSERT:</strong> A diferencia de las transacciones, las suscripciones utilizan el ID proporcionado por Stripe como clave primaria, por lo que se implementa un patrón UPSERT (INSERT o UPDATE según si ya existe) mediante <code>INSERT ... ON DUPLICATE KEY UPDATE</code>.
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>InvoiceRepositoryImpl</strong>
                        </div>
                        <div class="card-body">
                            <p>
                                <code>InvoiceRepositoryImpl</code> está especializado en consultas de lectura para la visualización de facturas y recibos. Sus responsabilidades específicas incluyen:
                            </p><br><br>
                            <ul>
                                <li>Proporcionar métodos para consultar la tabla <code>StripeTransactions</code> con el propósito específico de listar facturas/recibos.</li><br>
                                <li>Implementar consultas optimizadas para diferentes vistas (todas las facturas, facturas de un cliente específico, etc.).</li><br>
                                <li>Aplicar filtros y paginación para listados de facturas en la interfaz de usuario.</li><br>
                                <li>Devolver datos en un formato adecuado para la visualización en la interfaz.</li><br>
                            </ul>

                            <div class="alert alert-success mt-3">
                                <i class="fas fa-columns"></i> <strong>CQRS implícito:</strong> La creación de <code>InvoiceRepositoryImpl</code> para consultas específicas de lectura, separadas de las operaciones de escritura, refleja el principio de Command Query Responsibility Segregation (CQRS), separando las responsabilidades de lectura y escritura.
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-primary mt-3">
                        <i class="fas fa-book"></i> <strong>Patrón Repository y principios aplicados:</strong><br><br>
                        <ul>
                            <li><strong>Abstracción de la persistencia:</strong> Oculta los detalles técnicos de PDO, SQL, etc., frente al dominio.</li><br>
                            <li><strong>API rica de colección:</strong> Métodos como <code>findById()</code>, <code>findAll()</code>, <code>save()</code>, <code>update()</code> se comportan como si trabajaras con una colección de objetos.</li><br>
                            <li><strong>Separación de Concerns:</strong> La lógica de negocio (estrategias, servicios) no conoce nada sobre la base de datos.</li><br>
                            <li><strong>Principio de Responsabilidad Única (SRP):</strong> Solo manejan acceso a datos, no hacen lógica de negocio.</li><br>
                            <li><strong>Inversión de Dependencias (DIP):</strong> Los servicios/estrategias dependen de la interfaz, no de la implementación concreta.</li><br>
                        </ul>
                    </div>

                    <div class="alert alert-success mt-3">
                        <i class="fas fa-check-circle"></i> <strong>Ventajas prácticas:</strong><br><br>
                        <ul>
                            <li><strong>Mockeo sencillo en tests:</strong> Se pueden mockear las interfaces sin instanciar la base de datos.</li><br>
                            <li><strong>Reusabilidad:</strong> Cualquier servicio o estrategia que necesite guardar o leer una entidad puede reutilizar los métodos.</li><br>
                            <li><strong>Evolución sin dolor:</strong> Se puede migrar de PDO a otro ORM o incluso a una API REST sin tocar el código que usa los repositorios.</li><br>
                            <li><strong>Logging y errores centralizados:</strong> Se pueden loguear y capturar excepciones en un solo lugar.</li><br>
                        </ul>
                    </div>
                </div>

                <!-- Sección 8 -->
                <section id="flujos-datos" class="mb-4">
                    <h3>8. Flujos de Datos Específicos en StripeLabApp</h3>
                    <p>
                        En esta sección exploraremos los principales flujos de datos en StripeLabApp, siguiendo el recorrido completo desde la interfaz de usuario hasta la base de datos, pasando por todos los componentes relevantes.
                    </p>

                    <div id="flujo-pago-unico" class="subsection">
                        <h4>8.1. Flujo de Pago Único</h4>
                        <p>
                            El flujo de pago único muestra cómo la aplicación procesa un pago desde que el usuario lo inicia hasta que se completa y se registra en la base de datos.
                        </p>

                        <div class="card mb-4">
                            <div class="card-header">
                                <strong>Diagrama de Secuencia: Flujo de Pago Único</strong>
                            </div>
                            <div class="card-body">
                                <div class="mermaid-diagram">
                <pre class="mermaid">
sequenceDiagram
   participant User as Usuario
   participant Frontend as Frontend (single-payment.php)
   participant CheckoutEndpoint as v1/create_payment_session.php
   participant CheckoutService as StripeCheckoutSessionServiceImpl
   participant Stripe as Stripe API
   participant StripeCheckout as Stripe Checkout (Navegador)
   participant WebhookEndpoint as v1/webhook.php
   participant WebhookController as StripeWebhookControllerImpl
   participant WebhookService as StripeWebhookServiceImpl
   participant PIStrategy as PaymentIntentSucceededStrategyImpl
   participant ChargeStrategy as ChargeSucceededStrategyImpl
   participant Repository as TransactionRepositoryImpl
   participant DB as Base de Datos

   User->>Frontend: 1. Selecciona Producto y Hace Clic en "Pagar"
   Frontend->>CheckoutEndpoint: 2. Solicita sesión de pago (POST)
   CheckoutEndpoint->>CheckoutService: 3. Llama a createPaymentSession()
   CheckoutService->>Stripe: 4. Crea Checkout Session (API call)
   Stripe-->>CheckoutService: 5. Devuelve Session ID
   CheckoutService-->>CheckoutEndpoint: 6. Devuelve Session ID
   CheckoutEndpoint-->>Frontend: 7. Devuelve Session ID (JSON)
   Frontend->>StripeCheckout: 8. Redirecciona con sessionId
   User->>StripeCheckout: 9. Completa formulario de pago
   StripeCheckout->>Stripe: 10. Envía datos de pago
   Stripe-->>StripeCheckout: 11. Confirma pago exitoso
   StripeCheckout->>Frontend: 12. Redirecciona a success_url

   Note over Stripe,WebhookEndpoint: Proceso asíncrono

   Stripe->>WebhookEndpoint: 13a. Envía evento payment_intent.succeeded
   WebhookEndpoint->>WebhookController: 14a. Pasa payload y firma
   WebhookController->>WebhookService: 15a. Verifica firma y procesa evento
   WebhookService->>PIStrategy: 16a. Delega a PaymentIntentSucceededStrategyImpl
   PIStrategy->>Repository: 17a. Crea registro de transacción
   Repository->>DB: 18a. INSERT en tabla StripeTransactions
   Repository-->>PIStrategy: 19a. Confirma éxito
   PIStrategy-->>WebhookService: 20a. Devuelve éxito
   WebhookService-->>WebhookController: 21a. Devuelve éxito
   WebhookController-->>WebhookEndpoint: 22a. Devuelve código 200
   WebhookEndpoint-->>Stripe: 23a. Responde con código 200

   Stripe->>WebhookEndpoint: 13b. Envía evento charge.succeeded
   WebhookEndpoint->>WebhookController: 14b. Pasa payload y firma
   WebhookController->>WebhookService: 15b. Verifica firma y procesa evento
   WebhookService->>ChargeStrategy: 16b. Delega a ChargeSucceededStrategyImpl
   ChargeStrategy->>Repository: 17b. Busca transacción por stripe_transaction_id
   Repository-->>ChargeStrategy: 18b. Devuelve modelo de transacción
   ChargeStrategy->>ChargeStrategy: 19b. Añade receipt_url y detalles de pago
   ChargeStrategy->>Repository: 20b. Actualiza la transacción
   Repository->>DB: 21b. UPDATE en tabla StripeTransactions
   Repository-->>ChargeStrategy: 22b. Confirma éxito
   ChargeStrategy-->>WebhookService: 23b. Devuelve éxito
   WebhookService-->>WebhookController: 24b. Devuelve éxito
   WebhookController-->>WebhookEndpoint: 25b. Devuelve código 200
   WebhookEndpoint-->>Stripe: 26b. Responde con código 200
                </pre>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> <strong>Puntos clave en el flujo de pago único:</strong>
                            <ul>
                                <li>La interfaz de usuario inicia el flujo solicitando una sesión de Checkout a través del endpoint <code>create_payment_session.php</code>.</li>
                                <li>Stripe Checkout proporciona una interfaz segura y optimizada para la entrada de datos de tarjeta.</li>
                                <li>El procesamiento real ocurre de forma asíncrona mediante webhooks después de que el pago se complete.</li>
                                <li>Dos estrategias principales intervienen: <code>PaymentIntentSucceededStrategyImpl</code> crea el registro inicial, y <code>ChargeSucceededStrategyImpl</code> lo enriquece con detalles adicionales como la URL del recibo.</li>
                                <li>Todo el estado del pago se mantiene en Stripe hasta que llegan los webhooks, lo que hace que el flujo sea robusto ante interrupciones de red o recargas de página.</li>
                            </ul>
                        </div>
                    </div>

                    <div id="flujo-nueva-suscripcion" class="subsection">
                        <h4>8.2. Flujo de Nueva Suscripción</h4>
                        <p>
                            El flujo de nueva suscripción es más complejo que el de pago único, ya que involucra múltiples eventos de webhook y afecta a varias entidades del sistema.
                        </p>

                        <div class="card mb-4">
                            <div class="card-header">
                                <strong>Diagrama de Secuencia: Flujo de Nueva Suscripción</strong>
                            </div>
                            <div class="card-body">
                                <div class="mermaid-diagram">
                <pre class="mermaid">
sequenceDiagram
   participant User as Usuario
   participant Frontend as Frontend (subscriptions-payment.php)
   participant SubEndpoint as v1/create_subscription_session.php
   participant CheckoutService as StripeCheckoutSessionServiceImpl
   participant Stripe as Stripe API
   participant StripeCheckout as Stripe Checkout (Navegador)
   participant WebhookEndpoint as v1/webhook.php
   participant WebhookController as StripeWebhookControllerImpl
   participant WebhookService as StripeWebhookServiceImpl
   participant CSStrategy as CheckoutSessionCompletedStrategyImpl
   participant SubStrategy as SubscriptionCreatedStrategyImpl
   participant IPStrategy as InvoicePaidStrategyImpl
   participant SubRepo as SubscriptionRepositoryImpl
   participant TransRepo as TransactionRepositoryImpl
   participant DB as Base de Datos

   User->>Frontend: 1. Selecciona Plan y Hace Clic en "Suscribirse"
   Frontend->>SubEndpoint: 2. Solicita sesión de suscripción (POST)
   SubEndpoint->>CheckoutService: 3. Llama a createSubscriptionSession()
   CheckoutService->>Stripe: 4. Crea Checkout Session (API call)
   Stripe-->>CheckoutService: 5. Devuelve Session ID
   CheckoutService-->>SubEndpoint: 6. Devuelve Session ID
   SubEndpoint-->>Frontend: 7. Devuelve Session ID (JSON)
   Frontend->>StripeCheckout: 8. Redirecciona con sessionId
   User->>StripeCheckout: 9. Completa formulario de pago
   StripeCheckout->>Stripe: 10. Envía datos de pago
   Stripe-->>StripeCheckout: 11. Confirma suscripción exitosa
   StripeCheckout->>Frontend: 12. Redirecciona a success_url

   Note over Stripe,WebhookEndpoint: Proceso asíncrono (múltiples eventos)

   Stripe->>WebhookEndpoint: 13. Envía evento checkout.session.completed
   WebhookEndpoint->>WebhookController: 14. Pasa payload y firma
   WebhookController->>WebhookService: 15. Verifica firma y procesa evento
   WebhookService->>CSStrategy: 16. Delega a CheckoutSessionCompletedStrategyImpl
   CSStrategy->>CSStrategy: 17. Registra metadata de la sesión
   CSStrategy-->>WebhookService: 18. Devuelve éxito
   WebhookService-->>WebhookController: 19. Devuelve éxito
   WebhookController-->>WebhookEndpoint: 20. Devuelve código 200
   WebhookEndpoint-->>Stripe: 21. Responde con código 200

   Stripe->>WebhookEndpoint: 22. Envía evento customer.subscription.created
   WebhookEndpoint->>WebhookController: 23. Pasa payload y firma
   WebhookController->>WebhookService: 24. Verifica firma y procesa evento
   WebhookService->>SubStrategy: 25. Delega a SubscriptionCreatedStrategyImpl
   SubStrategy->>SubRepo: 26. Crea registro de suscripción
   SubRepo->>DB: 27. INSERT en tabla StripeSubscriptions
   SubRepo-->>SubStrategy: 28. Confirma éxito
   SubStrategy-->>WebhookService: 29. Devuelve éxito
   WebhookService-->>WebhookController: 30. Devuelve éxito
   WebhookController-->>WebhookEndpoint: 31. Devuelve código 200
   WebhookEndpoint-->>Stripe: 32. Responde con código 200

   Stripe->>WebhookEndpoint: 33. Envía evento invoice.paid
   WebhookEndpoint->>WebhookController: 34. Pasa payload y firma
   WebhookController->>WebhookService: 35. Verifica firma y procesa evento
   WebhookService->>IPStrategy: 36. Delega a InvoicePaidStrategyImpl
   IPStrategy->>TransRepo: 37. Crea registro de transacción de suscripción
   TransRepo->>DB: 38. INSERT en tabla StripeTransactions
   TransRepo-->>IPStrategy: 39. Confirma éxito y devuelve transaction_id
   IPStrategy->>SubRepo: 40. Actualiza latest_transaction_id en suscripción
   SubRepo->>DB: 41. UPDATE latest_transaction_id en StripeSubscriptions
   SubRepo-->>IPStrategy: 42. Confirma éxito
   IPStrategy-->>WebhookService: 43. Devuelve éxito
   WebhookService-->>WebhookController: 44. Devuelve éxito
   WebhookController-->>WebhookEndpoint: 45. Devuelve código 200
   WebhookEndpoint-->>Stripe: 46. Responde con código 200
                </pre>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> <strong>Puntos clave en el flujo de nueva suscripción:</strong>
                            <ul>
                                <li>Similar al flujo de pago único, el proceso comienza con la creación de una sesión de Checkout, pero configurada para suscripciones.</li>
                                <li>Tres eventos principales de webhook son procesados por diferentes estrategias:</li>
                                <ul>
                                    <li><code>checkout.session.completed</code>: Indica que el usuario ha completado el formulario de pago.</li>
                                    <li><code>customer.subscription.created</code>: Registra la nueva suscripción en la tabla <code>StripeSubscriptions</code>.</li>
                                    <li><code>invoice.paid</code>: Registra el pago inicial de la suscripción como una transacción en <code>StripeTransactions</code> y actualiza el campo <code>latest_transaction_id</code> en la suscripción.</li>
                                </ul>
                                <li>El orden de llegada de estos eventos no está garantizado, por lo que cada estrategia debe ser independiente y resistente a recibir eventos fuera de secuencia.</li>
                                <li><code>InvoicePaidStrategyImpl</code> juega un papel crucial al crear la entrada en <code>StripeTransactions</code> y enlazarla con <code>StripeSubscriptions</code> mediante el campo <code>latest_transaction_id</code>.</li>
                                <li>Se crean entradas tanto en la tabla <code>StripeSubscriptions</code> como en <code>StripeTransactions</code>, vinculadas por el ID del cliente y de la suscripción.</li>
                            </ul>
                        </div>
                    </div>

                    <div id="flujo-cancelacion-suscripcion" class="subsection">
                        <h4>8.3. Flujo de Cancelación de Suscripción</h4>
                        <p>
                            El flujo de cancelación de suscripción muestra cómo la aplicación maneja las solicitudes de cancelación, ya sea inmediata o al final del periodo actual.
                        </p>

                        <div class="card mb-4">
                            <div class="card-header">
                                <strong>Diagrama de Secuencia: Flujo de Cancelación de Suscripción</strong>
                            </div>
                            <div class="card-body">
                                <div class="mermaid-diagram">
                <pre class="mermaid">
sequenceDiagram
   participant User as Usuario
   participant Frontend as Frontend (view-subscriptions.php)
   participant ManageEndpoint as v1/api/api-manage-subscription.php
   participant ManageController as SubscriptionManagementControllerImpl
   participant ManageService as StripeSubscriptionManagementServiceImpl
   participant Stripe as Stripe API
   participant WebhookEndpoint as v1/webhook.php
   participant WebhookController as StripeWebhookControllerImpl
   participant WebhookService as StripeWebhookServiceImpl
   participant UpdStrategy as SubscriptionUpdatedStrategyImpl
   participant DelStrategy as SubscriptionDeletedStrategyImpl
   participant SubRepo as SubscriptionRepositoryImpl
   participant DB as Base de Datos

   alt Cancelación al final del periodo
       User->>Frontend: 1. Hace clic en "Cancelar al final del periodo"
       Frontend->>ManageEndpoint: 2. POST con subscription_id y cancel_at_period_end=true
       ManageEndpoint->>ManageController: 3. Llama a cancelSubscription()
       ManageController->>ManageService: 4. Llama a cancelSubscription(id, true)
       ManageService->>Stripe: 5. update() con cancel_at_period_end=true
       Stripe-->>ManageService: 6. Devuelve suscripción actualizada
       ManageService->>SubRepo: 7. Actualiza suscripción localmente
       SubRepo->>DB: 8. UPDATE tabla StripeSubscriptions
       SubRepo-->>ManageService: 9. Confirma éxito
       ManageService-->>ManageController: 10. Devuelve datos actualizados
       ManageController-->>ManageEndpoint: 11. Devuelve respuesta de éxito
       ManageEndpoint-->>Frontend: 12. Devuelve JSON con estado
       Frontend->>User: 13. Muestra confirmación

       Note over Stripe,WebhookEndpoint: Proceso asíncrono

       Stripe->>WebhookEndpoint: 14. Envía evento customer.subscription.updated
       WebhookEndpoint->>WebhookController: 15. Pasa payload y firma
       WebhookController->>WebhookService: 16. Verifica firma y procesa evento
       WebhookService->>UpdStrategy: 17. Delega a SubscriptionUpdatedStrategyImpl
       UpdStrategy->>UpdStrategy: 18. Detecta cancel_at_period_end=true
       UpdStrategy->>SubRepo: 19. Busca suscripción por ID
       SubRepo-->>UpdStrategy: 20. Devuelve modelo de suscripción
       UpdStrategy->>SubRepo: 21. Actualiza estado de cancelación
       SubRepo->>DB: 22. UPDATE cancel_at_period_end=1
       SubRepo-->>UpdStrategy: 23. Confirma éxito
       UpdStrategy-->>WebhookService: 24. Devuelve éxito
       WebhookService-->>WebhookController: 25. Devuelve éxito
       WebhookController-->>WebhookEndpoint: 26. Devuelve código 200
       WebhookEndpoint-->>Stripe: 27. Responde con código 200

       Note over Stripe,WebhookEndpoint: Al finalizar el periodo

       Stripe->>WebhookEndpoint: 28. Envía evento customer.subscription.deleted
       WebhookEndpoint->>WebhookController: 29. Pasa payload y firma
       WebhookController->>WebhookService: 30. Verifica firma y procesa evento
       WebhookService->>DelStrategy: 31. Delega a SubscriptionDeletedStrategyImpl
       DelStrategy->>SubRepo: 32. Busca suscripción por ID
       SubRepo-->>DelStrategy: 33. Devuelve modelo de suscripción
       DelStrategy->>SubRepo: 34. Actualiza estado a "canceled"
       SubRepo->>DB: 35. UPDATE status="canceled", ended_at=now()
       SubRepo-->>DelStrategy: 36. Confirma éxito
       DelStrategy-->>WebhookService: 37. Devuelve éxito
       WebhookService-->>WebhookController: 38. Devuelve éxito
       WebhookController-->>WebhookEndpoint: 39. Devuelve código 200
       WebhookEndpoint-->>Stripe: 40. Responde con código 200
   else Cancelación inmediata
       User->>Frontend: 1. Hace clic en "Cancelar ahora"
       Frontend->>ManageEndpoint: 2. POST con subscription_id y cancel_at_period_end=false
       ManageEndpoint->>ManageController: 3. Llama a cancelSubscription()
       ManageController->>ManageService: 4. Llama a cancelSubscription(id, false)
       ManageService->>Stripe: 5. retrieve() + cancel()
       Stripe-->>ManageService: 6. Devuelve suscripción cancelada
       ManageService->>SubRepo: 7. Actualiza suscripción localmente
       SubRepo->>DB: 8. UPDATE tabla StripeSubscriptions
       SubRepo-->>ManageService: 9. Confirma éxito
       ManageService-->>ManageController: 10. Devuelve datos actualizados
       ManageController-->>ManageEndpoint: 11. Devuelve respuesta de éxito
       ManageEndpoint-->>Frontend: 12. Devuelve JSON con estado
       Frontend->>User: 13. Muestra confirmación

       Note over Stripe,WebhookEndpoint: Proceso asíncrono

       Stripe->>WebhookEndpoint: 14. Envía evento customer.subscription.deleted
       WebhookEndpoint->>WebhookController: 15. Pasa payload y firma
       WebhookController->>WebhookService: 16. Verifica firma y procesa evento
       WebhookService->>DelStrategy: 17. Delega a SubscriptionDeletedStrategyImpl
       DelStrategy->>SubRepo: 18. Busca suscripción por ID
       SubRepo-->>DelStrategy: 19. Devuelve modelo de suscripción
       DelStrategy->>SubRepo: 20. Actualiza estado a "canceled"
       SubRepo->>DB: 21. UPDATE status="canceled", ended_at=now()
       SubRepo-->>DelStrategy: 22. Confirma éxito
       DelStrategy-->>WebhookService: 23. Devuelve éxito
       WebhookService-->>WebhookController: 24. Devuelve éxito
       WebhookController-->>WebhookEndpoint: 25. Devuelve código 200
       WebhookEndpoint-->>Stripe: 26. Responde con código 200
   end
                </pre>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> <strong>Puntos clave en el flujo de cancelación de suscripción:</strong>
                            <ul>
                                <li>La aplicación soporta dos tipos de cancelación:</li>
                                <ul>
                                    <li><strong>Cancelación al final del periodo</strong>: La suscripción permanece activa hasta el final del periodo pagado, y luego no se renueva.</li>
                                    <li><strong>Cancelación inmediata</strong>: La suscripción se cancela inmediatamente, sin esperar al final del periodo actual (generalmente sin reembolso).</li>
                                </ul>
                                <li>La cancelación se inicia desde la interfaz de usuario (<code>view-subscriptions.php</code>) y se procesa a través del endpoint API <code>api-manage-subscription.php</code>.</li>
                                <li>El controlador <code>SubscriptionManagementControllerImpl</code> delega la operación al servicio <code>StripeSubscriptionManagementServiceImpl</code>, que interactúa con la API de Stripe.</li>
                                <li>La aplicación actualiza inmediatamente el registro local de la suscripción mediante <code>SubscriptionRepositoryImpl</code>.</li>
                                <li>Diferentes eventos llegan según el tipo de cancelación:</li>
                                <ul>
                                    <li>Cancelación al final del periodo: Primero <code>customer.subscription.updated</code> procesado por <code>SubscriptionUpdatedStrategyImpl</code> con <code>cancel_at_period_end=true</code>, y luego <code>customer.subscription.deleted</code> procesado por <code>SubscriptionDeletedStrategyImpl</code> cuando finaliza el periodo.</li>
                                    <li>Cancelación inmediata: Solo <code>customer.subscription.deleted</code> procesado por <code>SubscriptionDeletedStrategyImpl</code> inmediatamente.</li>
                                </ul>
                            </ul>
                        </div>
                    </div>
                </section>





    </section>

    <!-- Scripts de Bootstrap, jQuery, etc. -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
    <!-- Highlight.js para resaltado de código -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <!-- Mermaid para diagramas -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js"></script>
    <script>
        // Inicializar highlight.js
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });

            // Inicializar Mermaid
            mermaid.initialize({
                startOnLoad: true,
                theme: 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                }
            });
        });
    </script>
</div>
    </body>
</html>
