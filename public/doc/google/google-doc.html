<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentación StripeLabApp</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/documentation_styles.css">
    <style>
        /* Estilos básicos para asegurar la funcionalidad del sidebar mientras se desarrolla documentation_styles.css */
        body {
            padding-top: 56px; /* Ajuste para navbar fija si se añade una superior */
        }
        .sidebar {
            position: sticky;
            top: 56px; /* Ajuste para navbar fija */
            height: calc(100vh - 56px);
            overflow-y: auto;
            background-color: #f8f9fa; /* Color de fondo claro para el sidebar */
            border-right: 1px solid #dee2e6;
            padding-top: 1.5rem;
        }
        .main-content {
            padding: 2rem;
        }
        .nav-link.active {
            font-weight: bold;
            color: #0d6efd !important;
        }
        .nav-link {
            color: #495057;
        }
        .nav-link:hover {
            color: #0d6efd;
        }
        /* Estilo para los prefijos de objetos Stripe */
        .stripe-object-prefix {
            font-family: monospace;
            background-color: #e9ecef;
            padding: 0.1em 0.4em;
            border-radius: 0.2em;
            font-size: 0.9em;
        }
        /* Estilos para diagramas Mermaid */
        .mermaid {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 1.5rem;
            text-align: center; /* Para centrar el diagrama si es más pequeño que el contenedor */
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <!-- Barra de Navegación Lateral -->
        <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
            <div class="position-sticky pt-3">
                <h5 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                    <span>StripeLabApp</span>
                </h5>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#parte1">
                            PARTE I: Stripe API
                        </a>
                        <ul class="nav flex-column ms-3">
                            <li class="nav-item"><a class="nav-link" href="#parte1-seccion1">1. Intro a Stripe</a></li>
                            <li class="nav-item"><a class="nav-link" href="#parte1-seccion1-2">1.2 Conceptos Clave</a></li>
                            <li class="nav-item"><a class="nav-link" href="#parte1-seccion1-3">1.3 Claves API</a></li>
                            <li class="nav-item"><a class="nav-link" href="#parte1-seccion2">2. Webhooks</a></li>
                            <li class="nav-item"><a class="nav-link" href="#parte1-seccion3">3. Eventos</a>
                                <ul class="nav flex-column ms-3">
                                    <li class="nav-item"><a class="nav-link" href="#parte1-seccion3-1">3.1 Anatomía</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#parte1-seccion3-2">3.2 Categorías</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#parte1-seccion3-3">3.3 Eventos Detallados</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#parte1-seccion3-4">3.4 Orden de Eventos</a></li>
                                </ul>
                            </li>
                            <li class="nav-item"><a class="nav-link" href="#parte1-seccion4">4. Stripe CLI</a>
                                <ul class="nav flex-column ms-3">
                                    <li class="nav-item"><a class="nav-link" href="#parte1-seccion4-1">4.1 ¿Qué es?</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#parte1-seccion4-2">4.2 Instalación</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#parte1-seccion4-3">4.3 Reenvío Webhooks</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#parte1-seccion4-4">4.4 Disparo Eventos</a></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#parte2">
                            PARTE II: StripeLabApp (Próximamente)
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#parte3">
                            PARTE III: Casos de Uso (Próximamente)
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Área de Contenido Principal -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1>Documentación de StripeLabApp</h1>
            </div>

            <!-- ============================================================================== -->
            <!-- PARTE I: ENTENDIENDO LA INTEGRACIÓN CON STRIPE API                             -->
            <!-- ============================================================================== -->
            <section id="parte1" class="mb-5">
                <h2>PARTE I: Entendiendo la Integración con Stripe API</h2>
                <hr>

                <section id="parte1-seccion1" class="mb-4">
                    <h3>1. Introducción a Stripe para Desarrolladores</h3>

                    <h4 id="parte1-seccion1-1">1.1. ¿Qué es Stripe y por qué usarlo?</h4>
                    <p>Stripe es una plataforma tecnológica global que permite a empresas de todos los tamaños aceptar y gestionar pagos en línea. Va más allá de ser una simple pasarela de pagos, ofreciendo un conjunto completo de herramientas para desarrolladores que facilitan la creación de productos y servicios con funcionalidades de pago integradas, gestión de suscripciones, prevención de fraude, y mucho más.</p>
                    <p><strong>¿Por qué usar Stripe?</strong></p>
                    <ul>
                        <li><strong>Foco en el Desarrollador:</strong> Stripe ofrece APIs robustas y bien documentadas, bibliotecas cliente en múltiples lenguajes (incluyendo PHP), y herramientas como Stripe CLI que simplifican el desarrollo y las pruebas.</li>
                        <li><strong>Seguridad y Cumplimiento:</strong> Stripe maneja la complejidad del cumplimiento PCI DSS, reduciendo la carga para los desarrolladores. Utiliza las mejores prácticas de seguridad para proteger los datos sensibles de las tarjetas.</li>
                        <li><strong>Escalabilidad Global:</strong> Permite aceptar pagos en múltiples monedas y de diversas fuentes de pago, facilitando la expansión internacional.</li>
                        <li><strong>Ecosistema Completo:</strong> Ofrece soluciones para pagos únicos, suscripciones, facturación, marketplaces, y más, todo integrado en una única plataforma.</li>
                        <li><strong>Innovación Constante:</strong> Stripe actualiza y mejora continuamente su plataforma, añadiendo nuevas funcionalidades y adaptándose a los cambios en el panorama de los pagos digitales.</li>
                    </ul>
                    <p>En el contexto de <strong>StripeLabApp</strong>, utilizamos Stripe para demostrar cómo implementar flujos de pago comunes, como la creación de clientes, el procesamiento de pagos únicos, y la gestión de suscripciones, utilizando su potente API y webhooks.</p>
                </section>

                <section id="parte1-seccion1-2" class="mb-4">
                    <h4>1.2. Conceptos Clave de Stripe (Objetos Comunes):</h4>
                    <p>La API de Stripe está organizada en torno a objetos RESTful. Comprender estos objetos es fundamental para trabajar eficazmente con Stripe. A continuación, se describen algunos de los más comunes que encontrarás en StripeLabApp:</p>
                    <ul>
                        <li><strong>Customers (<span class="stripe-object-prefix">cus_...</span>):</strong> Representa a un cliente de tu negocio. Almacena información como la dirección de correo electrónico, métodos de pago guardados, y suscripciones activas. Es crucial para pagos recurrentes y para guardar información de pago para futuras transacciones.</li>
                        <li><strong>PaymentIntents (<span class="stripe-object-prefix">pi_...</span>):</strong> Objeto que rastrea el ciclo de vida de un intento de pago de un cliente, desde su creación hasta su finalización (exitosa o fallida). Es la forma moderna y recomendada para manejar pagos, ya que se adapta a flujos de autenticación robusta de clientes (SCA).</li>
                        <li><strong>SetupIntents (<span class="stripe-object-prefix">seti_...</span>):</strong> Similar a un PaymentIntent, pero se utiliza para configurar y guardar un método de pago para uso futuro, sin realizar un cargo inmediato. Esencial para suscripciones o para que los clientes guarden sus tarjetas.</li>
                        <li><strong>Charges (<span class="stripe-object-prefix">ch_...</span>):</strong> Representa un intento de cargo real a una tarjeta de crédito u otra fuente de pago. Aunque todavía existe, para nuevas integraciones se recomienda usar PaymentIntents, ya que estos pueden generar múltiples Charges si, por ejemplo, un pago requiere varios intentos.</li>
                        <li><strong>Invoices (<span class="stripe-object-prefix">in_...</span>):</strong> Son declaraciones de las cantidades adeudadas por un cliente. Se generan automáticamente para las suscripciones y también pueden crearse manualmente para facturación única.</li>
                        <li><strong>Subscriptions (<span class="stripe-object-prefix">sub_...</span>):</strong> Permiten cobrar a un cliente de forma recurrente según un plan (definido por Productos y Precios). Gestionan la lógica de facturación periódica, reintentos de pago, y el estado del ciclo de vida de la suscripción.</li>
                        <li><strong>Products y Prices (<span class="stripe-object-prefix">prod_...</span>, <span class="stripe-object-prefix">price_...</span>, <span class="stripe-object-prefix">lookup_key</span>):</strong>
                            <ul>
                                <li><strong>Products:</strong> Representan los bienes o servicios que vendes.</li>
                                <li><strong>Prices:</strong> Definen cuánto y con qué frecuencia cobrar por un Producto. Un Producto puede tener múltiples Precios (por ejemplo, diferentes monedas, diferentes niveles de servicio, o facturación mensual vs. anual).</li>
                                <li><strong>Lookup Keys:</strong> Claves amigables definidas por el usuario para recuperar Precios sin necesidad de recordar sus IDs (ej: `plan_premium_mensual`).</li>
                            </ul>
                        </li>
                        <li><strong>Checkout Sessions (<span class="stripe-object-prefix">cs_...</span>):</strong> Facilita la creación de flujos de pago alojados en Stripe. Rediriges a tus clientes a una página de pago segura y personalizable gestionada por Stripe, simplificando el cumplimiento PCI y la experiencia de usuario. Ideal para pagos únicos y para iniciar suscripciones.</li>
                        <li><strong>Events (<span class="stripe-object-prefix">evt_...</span>):</strong> Notificaciones que Stripe envía a tu aplicación (a través de webhooks) cuando ocurren cambios en tu cuenta, como un pago exitoso, un error en una suscripción, la creación de un nuevo cliente, etc. Son cruciales para mantener tu sistema sincronizado con Stripe.</li>
                    </ul>
                </section>

                <section id="parte1-seccion1-3" class="mb-4">
                    <h4>1.3. Claves API (Publicable y Secreta)</h4>
                    <p>Para interactuar con la API de Stripe, necesitarás un par de claves API: una clave publicable y una clave secreta. Estas claves se encuentran en tu Dashboard de Stripe, en la sección "Desarrolladores" -> "Claves API".</p>
                    <ul>
                        <li>
                            <strong>Clave Publicable (Publishable Key - <span class="stripe-object-prefix">pk_test_...</span> o <span class="stripe-object-prefix">pk_live_...</span>):</strong>
                            Esta clave está destinada a ser utilizada en el código del lado del cliente (frontend). Se utiliza para tokenizar la información de pago sensible (como los números de tarjeta de crédito) directamente desde el navegador del cliente, sin que esta información toque el servidor.
                        </li>
                        <li>
                            <strong>Clave Secreta (Secret Key - <span class="stripe-object-prefix">sk_test_...</span> o <span class="stripe-object-prefix">sk_live_...</span>):</strong>
                            Esta clave debe mantenerse confidencial y usarse solo en el código del lado del servidor (backend). Con esta clave, el servidor puede realizar cualquier llamada a la API en nombre de tu cuenta, como crear cargos, gestionar clientes o suscripciones, emitir reembolsos, etc. <strong>NUNCA EXPONERLA EN CLIENTE.</strong>
                        </li>
                    </ul>
                    <p>Stripe proporciona claves separadas para los entornos de prueba (test mode) y producción (live mode). Es fundamental utilizar las claves de prueba durante el desarrollo y las pruebas, y cambiarlas por las claves de producción solo cuando la aplicación esté lista para procesar pagos reales.</p>
                </section>

                <hr class="my-4">

                <section id="parte1-seccion2" class="mb-4">
                    <h3>2. Webhooks de Stripe</h3>

                    <h4 id="parte1-seccion2-1">2.1. ¿Qué son los Webhooks y por qué son cruciales?</h4>
                    <p>Los webhooks son una forma en que Stripe notifica a tu aplicación sobre eventos que ocurren en tu cuenta de Stripe de manera asíncrona. En lugar de que tu aplicación tenga que consultar (poll) constantemente a la API de Stripe para ver si algo ha cambiado, Stripe envía una solicitud HTTP (generalmente un POST) a un endpoint específico que configuras en tu aplicación cuando ocurre un evento.</p>
                    <p><strong>¿Por qué son cruciales?</strong></p>
                    <ul>
                        <li><strong>Notificaciones en Tiempo Real (o casi):</strong> Permiten que tu aplicación reaccione inmediatamente a eventos importantes, como un pago completado, una disputa iniciada, una suscripción cancelada, etc.</li>
                        <li><strong>Sincronización de Datos:</strong> Ayudan a mantener la base de datos de tu aplicación (por ejemplo, el estado de un pedido o una suscripción en StripeLabApp) sincronizada con la información en Stripe.</li>
                        <li><strong>Automatización de Procesos:</strong> Facilitan la automatización de acciones basadas en eventos de Stripe. Por ejemplo, enviar un correo electrónico de confirmación cuando un `payment_intent.succeeded` es recibido, o provisionar acceso a un servicio tras un `invoice.paid`.</li>
                        <li><strong>Manejo de Eventos Asíncronos:</strong> Muchos procesos de pago son asíncronos (por ejemplo, pagos con débito directo o métodos que requieren confirmación del cliente). Los webhooks son esenciales para saber cuándo estos procesos se completan.</li>
                    </ul>
                    <p>En StripeLabApp, los webhooks se utilizan para actualizar el estado de los pagos y las suscripciones en nuestra base de datos MySQL, asegurando que la información local refleje fielmente lo que sucede en Stripe.</p>
                </section>

                <section id="parte1-seccion2-2" class="mb-4">
                    <h4>2.2. Seguridad de los Webhooks:</h4>
                    <p>Dado que los endpoints de webhook son URL públicas, es vital asegurar que las solicitudes recibidas provengan genuinamente de Stripe y no de un actor malicioso. Stripe proporciona mecanismos para esto:</p>
                    <ul>
                        <li>
                            <strong>Verificación de Firmas (Importancia del "Webhook Secret"):</strong>
                            <p>Cada evento que Stripe envía a tu endpoint de webhook está firmado. Stripe incluye una firma en la cabecera `Stripe-Signature` de la solicitud HTTP. Tu aplicación debe verificar esta firma utilizando un "secreto de webhook" (<span class="stripe-object-prefix">whsec_...</span>) que obtienes de la configuración de tu endpoint de webhook en el Dashboard de Stripe.</p>
                            <p>El proceso implica:</p>
                            <ol>
                                <li>Obtener el payload JSON crudo de la solicitud.</li>
                                <li>Obtener la cabecera `Stripe-Signature`.</li>
                                <li>Utilizar la biblioteca de Stripe (por ejemplo, `\Stripe\Webhook::constructEvent()`) junto con el payload, la firma y tu secreto de webhook para verificar la autenticidad del evento.</li>
                            </ol>
                            <p>Si la firma no es válida, la solicitud debe ser descartada, ya que podría ser fraudulenta. <strong>Nunca proceses un evento de webhook sin verificar su firma.</strong></p>
                        </li>
                        <li>
                            <strong>HTTPS:</strong>
                            <p>Tu endpoint de webhook debe usar HTTPS. Esto asegura que la comunicación entre los servidores de Stripe y tu servidor esté encriptada, protegiendo la integridad y confidencialidad de los datos del evento durante el tránsito.</p>
                        </li>
                    </ul>
                </section>

                <section id="parte1-seccion2-3" class="mb-4">
                    <h4>2.3. Reintentos y Mejores Prácticas para la Respuesta del Endpoint.</h4>
                    <p>Es crucial que tu endpoint de webhook responda rápidamente a las solicitudes de Stripe y maneje los eventos de manera robusta.</p>
                    <ul>
                        <li><strong>Respuesta Rápida (Código de Estado 200):</strong> Tu endpoint debe enviar una respuesta HTTP con código de estado `200 OK` a Stripe tan pronto como haya recibido el evento, incluso antes de procesarlo completamente si el procesamiento es largo. Stripe considera cualquier respuesta fuera del rango 2xx como un fallo.</li>
                        <li><strong>Reintentos de Stripe:</strong> Si tu endpoint no responde con un código 2xx en un tiempo razonable, o si hay un error de red, Stripe interpretará que el evento no fue recibido y lo reenviará. Stripe reintenta el envío de webhooks con una política de retroceso exponencial durante varios días (o hasta que tu endpoint responda con éxito).</li>
                        <li><strong>Idempotencia:</strong> Debido a los reintentos (y otras posibles causas de duplicación), tu manejador de eventos debe ser idempotente. Esto significa que procesar el mismo evento múltiples veces debe tener el mismo efecto que procesarlo una sola vez. Por ejemplo, si un evento `invoice.paid` ya fue procesado y activó el envío de un correo, un segundo procesamiento del mismo evento no debería enviar otro correo. Puedes lograr la idempotencia verificando si el ID del evento (`evt_...`) ya ha sido procesado.</li>
                        <li><strong>Procesamiento Asíncrono (para tareas largas):</strong> Si el procesamiento de un evento implica tareas largas (llamadas a otras APIs, operaciones de base de datos complejas), es una buena práctica acusar recibo a Stripe (respuesta 200) y luego pasar el evento a una cola de trabajos o un proceso en segundo plano para su manejo. Esto evita timeouts en la conexión con Stripe.</li>
                        <li><strong>Monitoreo y Alertas:</strong> Monitorea tus endpoints de webhook para detectar fallos y configura alertas. El Dashboard de Stripe también proporciona información sobre los intentos de entrega de webhooks y los errores.</li>
                    </ul>
                </section>

                <hr class="my-4">

                <section id="parte1-seccion3" class="mb-4">
                    <h3>3. Eventos de Stripe: Tipos y Uso</h3>
                    <p>Los eventos son el mecanismo central por el cual Stripe comunica cambios y actividades en tu cuenta. Comprender la estructura de los eventos y los tipos de eventos más comunes es esencial para construir una integración robusta, especialmente cuando se utilizan webhooks.</p>

                    <h4 id="parte1-seccion3-1">3.1. Anatomía de un Objeto Evento de Stripe (<code class="stripe-object-prefix">id</code>, <code class="stripe-object-prefix">type</code>, <code class="stripe-object-prefix">data.object</code>).</h4>
                    <p>Cuando Stripe envía un evento a tu endpoint de webhook (o cuando recuperas eventos vía API), este viene como un objeto JSON con una estructura estándar. Los campos más importantes son:</p>
                    <ul>
                        <li><strong><code class="stripe-object-prefix">id</code>:</strong> Un identificador único para el objeto Evento (ej: <code class="stripe-object-prefix">evt_1J2a3b4C5D6e7F8g9H0i</code>). Útil para el registro y para evitar el procesamiento duplicado (idempotencia).</li>
                        <li><strong><code class="stripe-object-prefix">type</code>:</strong> Una cadena que describe el tipo de evento ocurrido (ej: <code class="stripe-object-prefix">payment_intent.succeeded</code>, <code class="stripe-object-prefix">customer.subscription.updated</code>). Este es el campo principal que usarás para decidir cómo manejar el evento.</li>
                        <li><strong><code class="stripe-object-prefix">api_version</code>:</strong> La versión de la API de Stripe que se utilizó para generar el evento. Esto es importante para asegurar la compatibilidad si estás utilizando una versión de API diferente en tu integración.</li>
                        <li><strong><code class="stripe-object-prefix">created</code>:</strong> Timestamp de cuándo se creó el evento.</li>
                        <li><strong><code class="stripe-object-prefix">livemode</code>:</strong> Booleano que indica si el evento ocurrió en modo de producción (`true`) o de prueba (`false`).</li>
                        <li><strong><code class="stripe-object-prefix">data.object</code>:</strong> Este es un campo crucial. Contiene el objeto de Stripe que es relevante para el evento. Por ejemplo, si el `type` es <code class="stripe-object-prefix">payment_intent.succeeded</code>, entonces `data.object` contendrá el objeto PaymentIntent completo que tuvo éxito. Si el `type` es <code class="stripe-object-prefix">customer.created</code>, `data.object` contendrá el objeto Customer recién creado.</li>
                        <li><strong><code class="stripe-object-prefix">data.previous_attributes</code> (opcional):</strong> Para eventos de tipo `*.updated`, este campo puede contener los atributos del objeto tal como estaban antes del cambio. Útil para ver qué cambió exactamente.</li>
                        <li><strong><code class="stripe-object-prefix">request</code> (opcional):</strong> Información sobre la solicitud API que originó el evento, si aplica. Puede incluir un `idempotency_key`.</li>
                    </ul>
                    <p>En tu manejador de webhooks, normalmente inspeccionarás el `type` del evento y luego trabajarás con el objeto contenido en `data.object`.</p>
                </section>

                <section id="parte1-seccion3-2" class="mb-4">
                    <h4>3.2. Categorías Principales de Eventos.</h4>
                    <p>Stripe genera una gran cantidad de tipos de eventos, que se pueden agrupar en categorías según el objeto principal al que se refieren. Algunas categorías importantes incluyen:</p>
                    <ul>
                        <li><strong>PaymentIntents:</strong> <code class="stripe-object-prefix">payment_intent.created</code>, <code class="stripe-object-prefix">payment_intent.succeeded</code>, <code class="stripe-object-prefix">payment_intent.payment_failed</code>, <code class="stripe-object-prefix">payment_intent.processing</code>, <code class="stripe-object-prefix">payment_intent.requires_action</code>, etc.</li>
                        <li><strong>SetupIntents:</strong> <code class="stripe-object-prefix">setup_intent.created</code>, <code class="stripe-object-prefix">setup_intent.succeeded</code>, <code class="stripe-object-prefix">setup_intent.setup_failed</code>, etc.</li>
                        <li><strong>Charges:</strong> <code class="stripe-object-prefix">charge.succeeded</code>, <code class="stripe-object-prefix">charge.failed</code>, <code class="stripe-object-prefix">charge.refunded</code>, <code class="stripe-object-prefix">charge.dispute.created</code>, etc.</li>
                        <li><strong>Customers:</strong> <code class="stripe-object-prefix">customer.created</code>, <code class="stripe-object-prefix">customer.updated</code>, <code class="stripe-object-prefix">customer.deleted</code>.</li>
                        <li><strong>Subscriptions:</strong> <code class="stripe-object-prefix">customer.subscription.created</code>, <code class="stripe-object-prefix">customer.subscription.updated</code> (para cambios de plan, cantidad, etc.), <code class="stripe-object-prefix">customer.subscription.deleted</code> (cancelación), <code class="stripe-object-prefix">customer.subscription.trial_will_end</code>.</li>
                        <li><strong>Invoices:</strong> <code class="stripe-object-prefix">invoice.created</code>, <code class="stripe-object-prefix">invoice.paid</code>, <code class="stripe-object-prefix">invoice.payment_failed</code>, <code class="stripe-object-prefix">invoice.upcoming</code>.</li>
                        <li><strong>Checkout Sessions:</strong> <code class="stripe-object-prefix">checkout.session.completed</code>, <code class="stripe-object-prefix">checkout.session.async_payment_succeeded</code>, <code class="stripe-object-prefix">checkout.session.async_payment_failed</code>.</li>
                        <li><strong>Products y Prices:</strong> <code class="stripe-object-prefix">product.created</code>, <code class="stripe-object-prefix">price.updated</code>, etc. (generalmente menos manejados vía webhooks, más por gestión directa).</li>
                        <li><strong>PaymentMethods:</strong> <code class="stripe-object-prefix">payment_method.attached</code>, <code class="stripe-object-prefix">payment_method.detached</code>.</li>
                    </ul>
                    <p>La lista completa de tipos de eventos está disponible en la documentación oficial de Stripe. Es importante suscribirse solo a los eventos que tu aplicación necesita procesar para evitar una carga innecesaria en tu endpoint de webhook.</p>
                </section>

                <section id="parte1-seccion3-3" class="mb-4">
                    <h4 class="mt-4">3.3. Eventos Detallados:</h4>
                    <p>A continuación, se detallan algunos de los eventos más comunes que StripeLabApp maneja o que son relevantes para entender los flujos de pago y suscripciones.</p>

                    <h5 class="mt-4">Checkout:</h5>
                    <p>Los eventos de Checkout están relacionados con el uso de Stripe Checkout, la página de pago alojada por Stripe.</p>

                    <div class="event-detail mb-4">
                        <h6><code class="stripe-object-prefix">checkout.session.completed</code></h6>
                        <p>Se dispara cuando un cliente completa con éxito una sesión de Stripe Checkout. Este es un evento crucial para confirmar que el pago (o la configuración de una suscripción) se ha realizado.</p>
                        <p><strong>Información Clave:</strong></p>
                        <ul>
                            <li><code>id</code> (de la Checkout Session, <code class="stripe-object-prefix">cs_...</code>)</li>
                            <li><code>customer</code> (ID del cliente, <code class="stripe-object-prefix">cus_...</code>, si se creó o usó uno)</li>
                            <li><code>payment_intent</code> (ID del PaymentIntent, <code class="stripe-object-prefix">pi_...</code>, para pagos únicos)</li>
                            <li><code>subscription</code> (ID de la Suscripción, <code class="stripe-object-prefix">sub_...</code>, si la sesión era para una suscripción)</li>
                            <li><code>payment_status</code> (debería ser <code>paid</code> para la mayoría de los casos de éxito inmediato)</li>
                            <li><code>mode</code> (<code>payment</code>, <code>setup</code>, o <code>subscription</code>)</li>
                            <li><code>metadata</code> (si se envió alguna durante la creación de la sesión)</li>
                        </ul>
                        <p><strong>Payload de Ejemplo:</strong></p>
                        <pre><code class="language-json">
[STRIPE_PAYLOAD] Event Type: checkout.session.completed, Event ID: evt_1RO5QhP71JLI6sb9P1YkiSWK
{
    "id": "cs_test_a1pbv8QoyAgXUfa043e3KZqhIgtT3ve1aD7hPgqe73c2HTaNOjc13ki5XI",
    "object": "checkout.session",
    "adaptive_pricing": null,
    "after_expiration": null,
    "allow_promotion_codes": null,
    "amount_subtotal": 1500,
    "amount_total": 1500,
    "automatic_tax": {
        "enabled": false,
        "liability": null,
        "provider": null,
        "status": null
    },
    "billing_address_collection": null,
    "cancel_url": "http://localhost:8000/public/cancel.html",
    "client_reference_id": null,
    "client_secret": null,
    "collected_information": {
        "shipping_details": null
    },
    "consent": null,
    "consent_collection": null,
    "created": 1747091168,
    "currency": "eur",
    "currency_conversion": null,
    "custom_fields": [],
    "custom_text": {
        "after_submit": null,
        "shipping_address": null,
        "submit": null,
        "terms_of_service_acceptance": null
    },
    "customer": "cus_SIgoJvUF0ooe7U",
    "customer_creation": "always",
    "customer_details": {
        "address": {
            "city": null,
            "country": "ES",
            "line1": null,
            "line2": null,
            "postal_code": null,
            "state": null
        },
        "email": "TESTanual@TEST.COM",
        "name": "suscripcion anual",
        "phone": null,
        "tax_exempt": "none",
        "tax_ids": []
    },
    "customer_email": null,
    "discounts": [],
    "expires_at": 1747177568,
    "invoice": "in_1RO5QgP71JLI6sb9HSRdDSiW",
    "invoice_creation": null,
    "livemode": false,
    "locale": null,
    "metadata": [],
    "mode": "subscription",
    "payment_intent": null,
    "payment_link": null,
    "payment_method_collection": "always",
    "payment_method_configuration_details": null,
    "payment_method_options": {
        "card": {
            "request_three_d_secure": "automatic"
        }
    },
    "payment_method_types": [
        "card"
    ],
    "payment_status": "paid",
    "permissions": null,
    "phone_number_collection": {
        "enabled": false
    },
    "recovered_from": null,
    "saved_payment_method_options": {
        "allow_redisplay_filters": [
            "always"
        ],
        "payment_method_remove": "disabled",
        "payment_method_save": null
    },
    "setup_intent": null,
    "shipping_address_collection": null,
    "shipping_cost": null,
    "shipping_options": [],
    "status": "complete",
    "submit_type": null,
    "subscription": "sub_1RO5QfP71JLI6sb9EKIosSQS",
    "success_url": "http://localhost:8000/public/success.html?session_id={CHECKOUT_SESSION_ID}",
    "total_details": {
        "amount_discount": 0,
        "amount_shipping": 0,
        "amount_tax": 0
    },
    "ui_mode": "hosted",
    "url": null,
    "wallet_options": null
}</code></pre>
                    </div>

                    <div class="event-detail mb-4">
                        <h6><code class="stripe-object-prefix">checkout.session.expired</code></h6>
                        <p>Se dispara cuando una sesión de Stripe Checkout caduca antes de que el cliente la complete. Las sesiones suelen caducar después de un período determinado (por ejemplo, 24 horas para sesiones de pago único, o menos para otras). Es útil para la limpieza o análisis.</p>
                        <p><strong>Información Clave:</strong></p>
                        <ul>
                            <li><code>id</code> (de la Checkout Session, <code class="stripe-object-prefix">cs_...</code>)</li>
                            <li><code>status</code> (será <code>expired</code>)</li>
                            <li><code>expires_at</code> (timestamp de cuándo expiró)</li>
                        </ul>
                        <p><strong>Payload de Ejemplo:</strong></p>
                        <pre><code class="language-json">[2025-05-12 23:09:23] [STRIPE_PAYLOAD] Event Type: checkout.session.expired, Event ID: evt_1RO5TKP71JLI6sb9IV9zNCwu
{
    "id": "cs_test_a1M54d8jxXa1ii0F5nl98GugMADB2OllRqFfnBGzLfrhOOCnyTtU0xtUdr",
    "object": "checkout.session",
    "adaptive_pricing": {
        "enabled": true
    },
    "after_expiration": null,
    "allow_promotion_codes": null,
    "amount_subtotal": 1000,
    "amount_total": 1000,
    "automatic_tax": {
        "enabled": false,
        "liability": null,
        "provider": null,
        "status": null
    },
    "billing_address_collection": null,
    "cancel_url": "http://localhost:8000/public/cancel.html",
    "client_reference_id": null,
    "client_secret": null,
    "collected_information": null,
    "consent": null,
    "consent_collection": null,
    "created": 1747004962,
    "currency": "eur",
    "currency_conversion": null,
    "custom_fields": [],
    "custom_text": {
        "after_submit": null,
        "shipping_address": null,
        "submit": null,
        "terms_of_service_acceptance": null
    },
    "customer": null,
    "customer_creation": "if_required",
    "customer_details": null,
    "customer_email": null,
    "discounts": [],
    "expires_at": 1747091362,
    "invoice": null,
    "invoice_creation": {
        "enabled": false,
        "invoice_data": {
            "account_tax_ids": null,
            "custom_fields": null,
            "description": null,
            "footer": null,
            "issuer": null,
            "metadata": [],
            "rendering_options": null
        }
    },
    "livemode": false,
    "locale": null,
    "metadata": [],
    "mode": "payment",
    "payment_intent": null,
    "payment_link": null,
    "payment_method_collection": "if_required",
    "payment_method_configuration_details": null,
    "payment_method_options": {
        "card": {
            "request_three_d_secure": "automatic"
        }
    },
    "payment_method_types": [
        "card"
    ],
    "payment_status": "unpaid",
    "permissions": null,
    "phone_number_collection": {
        "enabled": false
    },
    "recovered_from": null,
    "saved_payment_method_options": null,
    "setup_intent": null,
    "shipping_address_collection": null,
    "shipping_cost": null,
    "shipping_options": [],
    "status": "expired",
    "submit_type": null,
    "subscription": null,
    "success_url": "http://localhost:8000/public/success.html?session_id={CHECKOUT_SESSION_ID}",
    "total_details": {
        "amount_discount": 0,
        "amount_shipping": 0,
        "amount_tax": 0
    },
    "ui_mode": "hosted",
    "url": null,
    "wallet_options": null
}</code></pre>
                    </div>

                    <hr class="my-4">
                    <h5 class="mt-4">Clientes (Customers):</h5>
                    <p>Estos eventos se relacionan con la creación y modificación de objetos Customer.</p>

                    <div class="event-detail mb-4">
                        <h6><code class="stripe-object-prefix">customer.created</code></h6>
                        <p>Se dispara cada vez que se crea un nuevo objeto Customer. Esto puede ocurrir explícitamente a través de la API, o implícitamente cuando un nuevo cliente realiza una compra a través de Stripe Checkout y se elige crear un cliente.</p>
                        <p><strong>Información Clave:</strong> El objeto Customer completo (<code class="stripe-object-prefix">data.object</code>) con su <code>id</code>, <code>email</code>, <code>name</code>, <code>metadata</code>, etc.</p>
                        <p><strong>Payload de Ejemplo:</strong></p>
                        <pre><code class="language-json">[2025-05-12 23:02:02] [STRIPE_PAYLOAD] Event Type: customer.created, Event ID: evt_1RO5MEP71JLI6sb9EHp4fuCw
{
    "id": "cus_SIgjYjt5FKHVKG",
    "object": "customer",
    "address": {
        "city": null,
        "country": "ES",
        "line1": null,
        "line2": null,
        "postal_code": null,
        "state": null
    },
    "balance": 0,
    "created": 1747090919,
    "currency": null,
    "default_source": null,
    "delinquent": false,
    "description": null,
    "discount": null,
    "email": "TEST@TEST.COM",
    "invoice_prefix": "4ERGRE3J",
    "invoice_settings": {
        "custom_fields": null,
        "default_payment_method": null,
        "footer": null,
        "rendering_options": null
    },
    "livemode": false,
    "metadata": [],
    "name": "suscripcion mensual",
    "phone": null,
    "preferred_locales": [
        "es-ES"
    ],
    "shipping": null,
    "tax_exempt": "none",
    "test_clock": null
}</code></pre>
                    </div>

                    <div class="event-detail mb-4">
                        <h6><code class="stripe-object-prefix">customer.updated</code></h6>
                        <p>Se dispara cuando se actualiza un objeto Customer. Esto puede incluir cambios en el email, descripción, metadatos, método de pago predeterminado, etc.</p>
                        <p><strong>Información Clave:</strong> El objeto Customer actualizado. El campo <code>data.previous_attributes</code> puede indicar qué campos cambiaron.</p>
                        <p><strong>Payload de Ejemplo:</strong></p>
                        <pre><code class="language-json">[2025-05-12 23:02:02] [STRIPE_PAYLOAD] Event Type: customer.updated, Event ID: evt_1RO5MEP71JLI6sb9GSi2jCvy
{
    "id": "cus_SIgjYjt5FKHVKG",
    "object": "customer",
    "address": {
        "city": null,
        "country": "ES",
        "line1": null,
        "line2": null,
        "postal_code": null,
        "state": null
    },
    "balance": 0,
    "created": 1747090919,
    "currency": "eur",
    "default_source": null,
    "delinquent": false,
    "description": null,
    "discount": null,
    "email": "TEST@TEST.COM",
    "invoice_prefix": "4ERGRE3J",
    "invoice_settings": {
        "custom_fields": null,
        "default_payment_method": null,
        "footer": null,
        "rendering_options": null
    },
    "livemode": false,
    "metadata": [],
    "name": "suscripcion mensual",
    "phone": null,
    "preferred_locales": [
        "es-ES"
    ],
    "shipping": null,
    "tax_exempt": "none",
    "test_clock": null
}</code></pre>
                    </div>
                    <p>Otro evento importante de clientes es <code class="stripe-object-prefix">customer.deleted</code>, que se dispara cuando un cliente es eliminado. StripeLabApp también maneja eventos relacionados con las suscripciones del cliente, como <code class="stripe-object-prefix">customer.subscription.created</code>, <code class="stripe-object-prefix">customer.subscription.updated</code>, y <code class="stripe-object-prefix">customer.subscription.deleted</code>, que se detallarán en la sección de eventos de suscripción.</p>

                    <hr class="my-4">
                    <h5 class="mt-4">Pagos (PaymentIntents &amp; Charges):</h5>
                    <p>Estos eventos son fundamentales para rastrear el ciclo de vida de los pagos.</p>

                    <div class="event-detail mb-4">
                        <h6><code class="stripe-object-prefix">payment_intent.created</code></h6>
                        <p>Se dispara cuando se crea un PaymentIntent. Un PaymentIntent representa la intención de cobrar a un cliente y rastrea el ciclo de vida del pago. Aunque StripeLabApp no maneja activamente este evento específico para la lógica de negocio principal (ya que a menudo la creación es solo el primer paso), es útil para el registro o seguimiento.</p>
                        <p><strong>Información Clave:</strong> El objeto PaymentIntent (<code class="stripe-object-prefix">data.object</code>) con su <code>id</code>, <code>amount</code>, <code>currency</code>, <code>customer</code> (si aplica), y <code>status</code> (inicialmente suele ser <code>requires_payment_method</code> o <code>requires_confirmation</code>).</p>
                        <p><strong>Payload de Ejemplo:</strong></p>
                        <pre><code class="language-json">[2025-05-12 23:02:02] [STRIPE_PAYLOAD] Event Type: payment_intent.created, Event ID: evt_3RO5MBP71JLI6sb90aDUPIig
{
    "id": "pi_3RO5MBP71JLI6sb90nUSzhE7",
    "object": "payment_intent",
    "amount": 300,
    "amount_capturable": 0,
    "amount_details": {
        "tip": []
    },
    "amount_received": 0,
    "application": null,
    "application_fee_amount": null,
    "automatic_payment_methods": null,
    "canceled_at": null,
    "cancellation_reason": null,
    "capture_method": "automatic",
    "client_secret": "pi_3RO5MBP71JLI6sb90nUSzhE7_secret_vAWdJSFnikd4n7snnVLBXMDgW",
    "confirmation_method": "automatic",
    "created": 1747090919,
    "currency": "eur",
    "customer": "cus_SIgjYjt5FKHVKG",
    "description": "Subscription creation",
    "last_payment_error": null,
    "latest_charge": null,
    "livemode": false,
    "metadata": [],
    "next_action": null,
    "on_behalf_of": null,
    "payment_method": null,
    "payment_method_configuration_details": null,
    "payment_method_options": {
        "card": {
            "installments": null,
            "mandate_options": null,
            "network": null,
            "request_three_d_secure": "automatic"
        },
        "link": {
            "persistent_token": null
        }
    },
    "payment_method_types": [
        "card",
        "link"
    ],
    "processing": null,
    "receipt_email": null,
    "review": null,
    "setup_future_usage": "off_session",
    "shipping": null,
    "source": null,
    "statement_descriptor": null,
    "statement_descriptor_suffix": null,
    "status": "requires_payment_method",
    "transfer_data": null,
    "transfer_group": null
}</code></pre>
                    </div>

                    <div class="event-detail mb-4">
                        <h6><code class="stripe-object-prefix">payment_intent.succeeded</code></h6>
                        <p>Este es uno de los eventos más importantes. Se dispara cuando el pago asociado a un PaymentIntent se completa con éxito. Es la confirmación definitiva de que se ha recibido el dinero (o está en proceso de ser capturado, si la captura es manual).</p>
                        <p>En StripeLabApp, este evento se usa para:</p>
                        <ul>
                            <li>Marcar un pedido como pagado.</li>
                            <li>Activar una suscripción.</li>
                            <li>Enviar confirmaciones al cliente.</li>
                            <li>Actualizar el estado del pago en la base de datos local.</li>
                        </ul>
                        <p><strong>Información Clave:</strong> El objeto PaymentIntent con <code>status: succeeded</code>, <code>amount_received</code>, <code>latest_charge</code> (ID del Charge asociado, <code class="stripe-object-prefix">ch_...</code>), y el <code>customer</code>.</p>

                        <p class="mt-3"><strong>Payload de Ejemplo (para pago único):</strong></p>
                        <pre><code class="language-json">[2025-05-12 23:00:26] [STRIPE_PAYLOAD] Event Type: payment_intent.succeeded, Event ID: evt_3RO5KdP71JLI6sb91yQofxm9
{
    "id": "pi_3RO5KdP71JLI6sb91XFQkshR",
    "object": "payment_intent",
    "amount": 1000,
    "amount_capturable": 0,
    "amount_details": {
        "tip": []
    },
    "amount_received": 1000,
    "application": null,
    "application_fee_amount": null,
    "automatic_payment_methods": null,
    "canceled_at": null,
    "cancellation_reason": null,
    "capture_method": "automatic_async",
    "client_secret": "pi_3RO5KdP71JLI6sb91XFQkshR_secret_w5q9oPR0tmbNlYeULXUekzEYt",
    "confirmation_method": "automatic",
    "created": 1747090823,
    "currency": "eur",
    "customer": null,
    "description": null,
    "last_payment_error": null,
    "latest_charge": "ch_3RO5KdP71JLI6sb91oRRGx4P",
    "livemode": false,
    "metadata": [],
    "next_action": null,
    "on_behalf_of": null,
    "payment_method": "pm_1RO5KcP71JLI6sb9DAN632WU",
    "payment_method_configuration_details": null,
    "payment_method_options": {
        "card": {
            "installments": null,
            "mandate_options": null,
            "network": null,
            "request_three_d_secure": "automatic"
        }
    },
    "payment_method_types": [
        "card"
    ],
    "processing": null,
    "receipt_email": null,
    "review": null,
    "setup_future_usage": null,
    "shipping": null,
    "source": null,
    "statement_descriptor": null,
    "statement_descriptor_suffix": null,
    "status": "succeeded",
    "transfer_data": null,
    "transfer_group": null
}</code></pre>

                        <p class="mt-3"><strong>Payload de Ejemplo (para pago de suscripción):</strong></p>
                        <p>Este evento también ocurre cuando se paga la factura inicial de una suscripción o una factura de renovación.</p>
                        <pre><code class="language-json">[2025-05-12 23:06:39] [STRIPE_PAYLOAD] Event Type: payment_intent.succeeded, Event ID: evt_3RO5QeP71JLI6sb901YvX6mc
{
    "id": "pi_3RO5QeP71JLI6sb90iwvxrFW",
    "object": "payment_intent",
    "amount": 1500,
    "amount_capturable": 0,
    "amount_details": {
        "tip": []
    },
    "amount_received": 1500,
    "application": null,
    "application_fee_amount": null,
    "automatic_payment_methods": null,
    "canceled_at": null,
    "cancellation_reason": null,
    "capture_method": "automatic",
    "client_secret": "pi_3RO5QeP71JLI6sb90iwvxrFW_secret_jYRCh9uUSLrrbosrHRfOxYm9e",
    "confirmation_method": "automatic",
    "created": 1747091196,
    "currency": "eur",
    "customer": "cus_SIgoJvUF0ooe7U",
    "description": "Subscription creation",
    "last_payment_error": null,
    "latest_charge": "ch_3RO5QeP71JLI6sb90RTFOULQ",
    "livemode": false,
    "metadata": [],
    "next_action": null,
    "on_behalf_of": null,
    "payment_method": "pm_1RO5QdP71JLI6sb9E6WLHpfW",
    "payment_method_configuration_details": null,
    "payment_method_options": {
        "card": {
            "installments": null,
            "mandate_options": null,
            "network": null,
            "request_three_d_secure": "automatic",
            "setup_future_usage": "off_session"
        }
    },
    "payment_method_types": [
        "card"
    ],
    "processing": null,
    "receipt_email": null,
    "review": null,
    "setup_future_usage": "off_session",
    "shipping": null,
    "source": null,
    "statement_descriptor": null,
    "statement_descriptor_suffix": null,
    "status": "succeeded",
    "transfer_data": null,
    "transfer_group": null
}</code></pre>
                    </div>
                    <p>Otros eventos de PaymentIntent relevantes incluyen <code class="stripe-object-prefix">payment_intent.payment_failed</code> (cuando un pago falla), <code class="stripe-object-prefix">payment_intent.processing</code> (para métodos de pago asíncronos), y <code class="stripe-object-prefix">payment_intent.requires_action</code> (si se necesita intervención del cliente, como autenticación 3D Secure).</p>

                    <div class="event-detail mb-4">
                        <h6><code class="stripe-object-prefix">charge.succeeded</code></h6>
                        <p>Se dispara cuando un cargo específico (un intento de tomar fondos de un método de pago) tiene éxito. Cada PaymentIntent exitoso tendrá al menos un Charge exitoso asociado (accesible a través de <code>latest_charge</code> en el PaymentIntent).</p>
                        <p>Aunque <code class="stripe-object-prefix">payment_intent.succeeded</code> es a menudo el evento principal para confirmar el pago, el evento <code class="stripe-object-prefix">charge.succeeded</code> puede ser útil para obtener detalles específicos del cargo, como la <code>receipt_url</code> (URL del recibo alojado por Stripe) o información detallada del método de pago utilizado.</p>
                        <p><strong>Información Clave:</strong> El objeto Charge (<code class="stripe-object-prefix">data.object</code>) con su <code>id</code>, <code>amount</code>, <code>payment_intent</code> (ID del PaymentIntent padre), <code>receipt_url</code>, y <code>payment_method_details</code>.</p>
                        <p><strong>Payload de Ejemplo:</strong></p>
                        <pre><code class="language-json">[2025-05-12 23:00:24] [STRIPE_PAYLOAD] Event Type: charge.succeeded, Event ID: evt_3RO5KdP71JLI6sb9133PVEJF
{
    "id": "ch_3RO5KdP71JLI6sb91oRRGx4P",
    "object": "charge",
    "amount": 1000,
    "amount_captured": 1000,
    "amount_refunded": 0,
    "application": null,
    "application_fee": null,
    "application_fee_amount": null,
    "balance_transaction": null,
    "billing_details": {
        "address": {
            "city": null,
            "country": "ES",
            "line1": null,
            "line2": null,
            "postal_code": null,
            "state": null
        },
        "email": "jccataluna@ddd.com",
        "name": "Pago unico",
        "phone": null,
        "tax_id": null
    },
    "calculated_statement_descriptor": "Stripe",
    "captured": true,
    "created": 1747090823,
    "currency": "eur",
    "customer": null,
    "description": null,
    "destination": null,
    "dispute": null,
    "disputed": false,
    "failure_balance_transaction": null,
    "failure_code": null,
    "failure_message": null,
    "fraud_details": [],
    "livemode": false,
    "metadata": [],
    "on_behalf_of": null,
    "order": null,
    "outcome": {
        "advice_code": null,
        "network_advice_code": null,
        "network_decline_code": null,
        "network_status": "approved_by_network",
        "reason": null,
        "risk_level": "normal",
        "risk_score": 33,
        "seller_message": "Payment complete.",
        "type": "authorized"
    },
    "paid": true,
    "payment_intent": "pi_3RO5KdP71JLI6sb91XFQkshR",
    "payment_method": "pm_1RO5KcP71JLI6sb9DAN632WU",
    "payment_method_details": {
        "card": {
            "amount_authorized": 1000,
            "authorization_code": null,
            "brand": "visa",
            "checks": {
                "address_line1_check": null,
                "address_postal_code_check": null,
                "cvc_check": "pass"
            },
            "country": "US",
            "exp_month": 2,
            "exp_year": 2026,
            "extended_authorization": {
                "status": "disabled"
            },
            "fingerprint": "H2RjQOzJ2vMTHb1p",
            "funding": "credit",
            "incremental_authorization": {
                "status": "unavailable"
            },
            "installments": null,
            "last4": "4242",
            "mandate": null,
            "multicapture": {
                "status": "unavailable"
            },
            "network": "visa",
            "network_token": {
                "used": false
            },
            "network_transaction_id": "725082106817912",
            "overcapture": {
                "maximum_amount_capturable": 1000,
                "status": "unavailable"
            },
            "regulated_status": "unregulated",
            "three_d_secure": null,
            "wallet": null
        },
        "type": "card"
    },
    "radar_options": [],
    "receipt_email": null,
    "receipt_number": null,
    "receipt_url": "https://pay.stripe.com/receipts/payment/CAcaFwoVYWNjdF8xUkhKNjFQNzFKTEk2c2I5KIj7icEGMgZeDpPk1pQ6LBaNV8plHjPjyBGcptjwO_J4m04Rts0jrS-KR4rCdXiuo6L8ogY29dtVIBzV",
    "refunded": false,
    "review": null,
    "shipping": null,
    "source": null,
    "source_transfer": null,
    "statement_descriptor": null,
    "statement_descriptor_suffix": null,
    "status": "succeeded",
    "transfer_data": null,
    "transfer_group": null
}</code></pre>
                    </div>
                    <p>Otros eventos importantes de Charges incluyen <code class="stripe-object-prefix">charge.failed</code> (si un cargo específico falla, incluso si el PaymentIntent general luego tiene éxito con otro cargo) y <code class="stripe-object-prefix">charge.refunded</code> (cuando se procesa un reembolso total o parcial para un cargo).</p>

                    <!-- INICIO DE NUEVO CONTENIDO PARA 3.3 -->
                    <hr class="my-4">
                    <h5 class="mt-4">Facturas (Invoices):</h5>
                    <p>Los eventos de Invoice son cruciales para la facturación recurrente (suscripciones) y la facturación manual.</p>

                    <div class="event-detail mb-4">
                        <h6><code class="stripe-object-prefix">invoice.created</code></h6>
                        <p>Se dispara cada vez que se crea una nueva factura. Esto ocurre automáticamente para las suscripciones (al inicio de un ciclo de facturación) o cuando se crea una factura manualmente. No necesariamente implica que la factura ha sido pagada.</p>
                        <p>StripeLabApp puede no manejar activamente este evento para la lógica de negocio principal, pero es útil para el seguimiento o si se necesita realizar alguna acción preparatoria antes del intento de pago.</p>
                        <p><strong>Información Clave:</strong> El objeto Invoice (<code class="stripe-object-prefix">data.object</code>) con su <code>id</code>, <code>customer</code>, <code>subscription</code> (si aplica), <code>amount_due</code>, <code>status</code> (inicialmente puede ser <code>draft</code> o <code>open</code>).</p>
                        <p><strong>Payload de Ejemplo:</strong></p>
                        <pre><code class="language-json">[STRIPE_PAYLOAD] Event Type: invoice.created, Event ID: evt_1RO5MEP71JLI6sb9qQO3IFbb
{
    "id": "in_1RO5MDP71JLI6sb9eWuwpvJj",
    "object": "invoice",
    "account_country": "ES",
    "account_name": "Stripe Lab App",
    "account_tax_ids": null,
    "amount_due": 300,
    "amount_overpaid": 0,
    "amount_paid": 300,
    "amount_remaining": 0,
    "amount_shipping": 0,
    "application": null,
    "attempt_count": 0,
    "attempted": true,
    "auto_advance": false,
    "automatic_tax": {
        "disabled_reason": null,
        "enabled": false,
        "liability": null,
        "provider": null,
        "status": null
    },
    "automatically_finalizes_at": null,
    "billing_reason": "subscription_create",
    "collection_method": "charge_automatically",
    "created": 1747090919,
    "currency": "eur",
    "custom_fields": null,
    "customer": "cus_SIgjYjt5FKHVKG",
    "customer_address": {
        "city": null,
        "country": "ES",
        "line1": null,
        "line2": null,
        "postal_code": null,
        "state": null
    },
    "customer_email": "TEST@TEST.COM",
    "customer_name": "suscripcion mensual",
    "customer_phone": null,
    "customer_shipping": null,
    "customer_tax_exempt": "none",
    "customer_tax_ids": [],
    "default_payment_method": null,
    "default_source": null,
    "default_tax_rates": [],
    "description": null,
    "discounts": [],
    "due_date": null,
    "effective_at": 1747090919,
    "ending_balance": 0,
    "footer": null,
    "from_invoice": null,
    "hosted_invoice_url": "https://invoice.stripe.com/i/acct_1RHJ61P71JLI6sb9/test_YWNjdF8xUkhKNjFQNzFKTEk2c2I5LF9TSWdqeU9vWU0ycktEOEQ1ZXdjakg4YXdTNlE1a0FJLDEzNzYzMTcyMg0200xYhbKGe5?s=ap",
    "invoice_pdf": "https://pay.stripe.com/invoice/acct_1RHJ61P71JLI6sb9/test_YWNjdF8xUkhKNjFQNzFKTEk2c2I5LF9TSWdqeU9vWU0ycktEOEQ1ZXdjakg4YXdTNlE1a0FJLDEzNzYzMTcyMg0200xYhbKGe5/pdf?s=ap",
    "issuer": {
        "type": "self"
    },
    "last_finalization_error": null,
    "latest_revision": null,
    "lines": {
        "object": "list",
        "data": [
            {
                "id": "il_1RO5MDP71JLI6sb9iN3orsCH",
                "object": "line_item",
                "amount": 300,
                "currency": "eur",
                "description": "1 × Test App (at €3.00 / month)",
                "discount_amounts": [],
                "discountable": true,
                "discounts": [],
                "invoice": "in_1RO5MDP71JLI6sb9eWuwpvJj",
                "livemode": false,
                "metadata": [],
                "parent": {
                    "invoice_item_details": null,
                    "subscription_item_details": {
                        "invoice_item": null,
                        "proration": false,
                        "proration_details": {
                            "credited_items": null
                        },
                        "subscription": "sub_1RO5MDP71JLI6sb9V5sdUJ8V",
                        "subscription_item": "si_SIgjYKrxsGix1W"
                    },
                    "type": "subscription_item_details"
                },
                "period": {
                    "end": 1749769319,
                    "start": 1747090919
                },
                "pretax_credit_amounts": [],
                "pricing": {
                    "price_details": {
                        "price": "price_1RLNcyP71JLI6sb92qc9ywRx",
                        "product": "prod_SFsxoaHLKoYbKj"
                    },
                    "type": "price_details",
                    "unit_amount_decimal": "300"
                },
                "quantity": 1,
                "taxes": []
            }
        ],
        "has_more": false,
        "total_count": 1,
        "url": "/v1/invoices/in_1RO5MDP71JLI6sb9eWuwpvJj/lines"
    },
    "livemode": false,
    "metadata": [],
    "next_payment_attempt": null,
    "number": "98CD073B-0044",
    "on_behalf_of": null,
    "parent": {
        "quote_details": null,
        "subscription_details": {
            "metadata": [],
            "subscription": "sub_1RO5MDP71JLI6sb9V5sdUJ8V"
        },
        "type": "subscription_details"
    },
    "payment_settings": {
        "default_mandate": null,
        "payment_method_options": {
            "acss_debit": null,
            "bancontact": null,
            "card": {
                "request_three_d_secure": "automatic"
            },
            "customer_balance": null,
            "konbini": null,
            "sepa_debit": null,
            "us_bank_account": null
        },
        "payment_method_types": [
            "card"
        ]
    },
    "period_end": 1747090919,
    "period_start": 1747090919,
    "post_payment_credit_notes_amount": 0,
    "pre_payment_credit_notes_amount": 0,
    "receipt_number": null,
    "rendering": null,
    "shipping_cost": null,
    "shipping_details": null,
    "starting_balance": 0,
    "statement_descriptor": null,
    "status": "paid",
    "status_transitions": {
        "finalized_at": 1747090919,
        "marked_uncollectible_at": null,
        "paid_at": 1747090920,
        "voided_at": null
    },
    "subtotal": 300,
    "subtotal_excluding_tax": 300,
    "test_clock": null,
    "total": 300,
    "total_discount_amounts": [],
    "total_excluding_tax": 300,
    "total_pretax_credit_amounts": [],
    "total_taxes": [],
    "webhooks_delivered_at": null
}</code></pre>
                    </div>

                    <div class="event-detail mb-4">
                        <h6><code class="stripe-object-prefix">invoice.paid</code></h6>
                        <p>Se dispara cuando una factura se paga con éxito. Este es un evento crítico para registrar transacciones, actualizar el estado de la suscripción (si la factura es de una suscripción), otorgar acceso a servicios, etc.</p>
                        <p><strong>Información Clave:</strong> El objeto Invoice con <code>status: paid</code>, <code>amount_paid</code>, <code>payment_intent</code> (ID del PaymentIntent asociado al pago de esta factura), <code>billing_reason</code> (ej: <code>subscription_cycle</code>, <code>subscription_create</code>), y <code>hosted_invoice_url</code>.</p>
                        <p><strong>Payload de Ejemplo (para factura de suscripción):</strong></p>
                        <pre><code class="language-json">[STRIPE_PAYLOAD] Event Type: invoice.paid, Event ID: evt_1RO5QhP71JLI6sb9SWgjHtQL
{
    "id": "in_1RO5QgP71JLI6sb9HSRdDSiW",
    "object": "invoice",
    "account_country": "ES",
    "account_name": "Stripe Lab App",
    "account_tax_ids": null,
    "amount_due": 1500,
    "amount_overpaid": 0,
    "amount_paid": 1500,
    "amount_remaining": 0,
    "amount_shipping": 0,
    "application": null,
    "attempt_count": 0,
    "attempted": true,
    "auto_advance": false,
    "automatic_tax": {
        "disabled_reason": null,
        "enabled": false,
        "liability": null,
        "provider": null,
        "status": null
    },
    "automatically_finalizes_at": null,
    "billing_reason": "subscription_create",
    "collection_method": "charge_automatically",
    "created": 1747091196,
    "currency": "eur",
    "custom_fields": null,
    "customer": "cus_SIgoJvUF0ooe7U",
    "customer_address": {
        "city": null,
        "country": "ES",
        "line1": null,
        "line2": null,
        "postal_code": null,
        "state": null
    },
    "customer_email": "TESTanual@TEST.COM",
    "customer_name": "suscripcion anual",
    "customer_phone": null,
    "customer_shipping": null,
    "customer_tax_exempt": "none",
    "customer_tax_ids": [],
    "default_payment_method": null,
    "default_source": null,
    "default_tax_rates": [],
    "description": null,
    "discounts": [],
    "due_date": null,
    "effective_at": 1747091196,
    "ending_balance": 0,
    "footer": null,
    "from_invoice": null,
    "hosted_invoice_url": "https://invoice.stripe.com/i/acct_1RHJ61P71JLI6sb9/test_YWNjdF8xUkhKNjFQNzFKTEk2c2I5LF9TSWdvcVFJOGI2ZkQ2ZXRSV0IycE53YVczVGQwS2lkLDEzNzYzMTk5OQ02004O5XAkp5?s=ap",
    "invoice_pdf": "https://pay.stripe.com/invoice/acct_1RHJ61P71JLI6sb9/test_YWNjdF8xUkhKNjFQNzFKTEk2c2I5LF9TSWdvcVFJOGI2ZkQ2ZXRSV0IycE53YVczVGQwS2lkLDEzNzYzMTk5OQ02004O5XAkp5/pdf?s=ap",
    "issuer": {
        "type": "self"
    },
    "last_finalization_error": null,
    "latest_revision": null,
    "lines": {
        "object": "list",
        "data": [
            {
                "id": "il_1RO5QgP71JLI6sb9L5auB3lj",
                "object": "line_item",
                "amount": 1500,
                "currency": "eur",
                "description": "1 × Test App (at €15.00 / year)",
                "discount_amounts": [],
                "discountable": true,
                "discounts": [],
                "invoice": "in_1RO5QgP71JLI6sb9HSRdDSiW",
                "livemode": false,
                "metadata": [],
                "parent": {
                    "invoice_item_details": null,
                    "subscription_item_details": {
                        "invoice_item": null,
                        "proration": false,
                        "proration_details": {
                            "credited_items": null
                        },
                        "subscription": "sub_1RO5QfP71JLI6sb9EKIosSQS",
                        "subscription_item": "si_SIgoQLiytr2oW7"
                    },
                    "type": "subscription_item_details"
                },
                "period": {
                    "end": 1778627196,
                    "start": 1747091196
                },
                "pretax_credit_amounts": [],
                "pricing": {
                    "price_details": {
                        "price": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                        "product": "prod_SFsxoaHLKoYbKj"
                    },
                    "type": "price_details",
                    "unit_amount_decimal": "1500"
                },
                "quantity": 1,
                "taxes": []
            }
        ],
        "has_more": false,
        "total_count": 1,
        "url": "/v1/invoices/in_1RO5QgP71JLI6sb9HSRdDSiW/lines"
    },
    "livemode": false,
    "metadata": [],
    "next_payment_attempt": null,
    "number": "98CD073B-0046",
    "on_behalf_of": null,
    "parent": {
        "quote_details": null,
        "subscription_details": {
            "metadata": [],
            "subscription": "sub_1RO5QfP71JLI6sb9EKIosSQS"
        },
        "type": "subscription_details"
    },
    "payment_settings": {
        "default_mandate": null,
        "payment_method_options": {
            "acss_debit": null,
            "bancontact": null,
            "card": {
                "request_three_d_secure": "automatic"
            },
            "customer_balance": null,
            "konbini": null,
            "sepa_debit": null,
            "us_bank_account": null
        },
        "payment_method_types": [
            "card"
        ]
    },
    "period_end": 1747091196,
    "period_start": 1747091196,
    "post_payment_credit_notes_amount": 0,
    "pre_payment_credit_notes_amount": 0,
    "receipt_number": null,
    "rendering": null,
    "shipping_cost": null,
    "shipping_details": null,
    "starting_balance": 0,
    "statement_descriptor": null,
    "status": "paid",
    "status_transitions": {
        "finalized_at": 1747091196,
        "marked_uncollectible_at": null,
        "paid_at": 1747091196,
        "voided_at": null
    },
    "subtotal": 1500,
    "subtotal_excluding_tax": 1500,
    "test_clock": null,
    "total": 1500,
    "total_discount_amounts": [],
    "total_excluding_tax": 1500,
    "total_pretax_credit_amounts": [],
    "total_taxes": [],
    "webhooks_delivered_at": null
}</code></pre>
                    </div>
                    <p>Otros eventos de Invoice relevantes son <code class="stripe-object-prefix">invoice.payment_failed</code> (cuando el pago de una factura falla), <code class="stripe-object-prefix">invoice.finalized</code> (cuando una factura se finaliza y no puede ser modificada), y <code class="stripe-object-prefix">invoice.upcoming</code> (notificación de una próxima factura de suscripción, útil para avisar al cliente).</p>


                    <hr class="my-4">
                    <h5 class="mt-4">Suscripciones (Subscriptions):</h5>
                    <p>Estos eventos son el núcleo de la gestión de ingresos recurrentes.</p>

                    <div class="event-detail mb-4">
                        <h6><code class="stripe-object-prefix">customer.subscription.created</code></h6>
                        <p>Se dispara cuando se crea una nueva entidad de suscripción. Esto ocurre generalmente después de que un cliente completa una sesión de Checkout para un plan de suscripción o cuando se crea una suscripción directamente vía API. La primera factura y el pago pueden ocurrir en eventos subsecuentes.</p>
                        <p><strong>Información Clave:</strong> El objeto Subscription (<code class="stripe-object-prefix">data.object</code>) con su <code>id</code>, <code>customer</code>, <code>status</code> (inicialmente puede ser <code>incomplete</code>, <code>trialing</code>, o <code>active</code> si el pago inicial es exitoso), <code>items</code> (que detallan los precios y productos), y <code>latest_invoice</code>.</p>
                        <p><strong>Payload de Ejemplo:</strong></p>
                        <pre><code class="language-json">[STRIPE_PAYLOAD] Event Type: customer.subscription.created, Event ID: evt_1RO5QhP71JLI6sb98NwCeJDG
{
    "id": "sub_1RO5QfP71JLI6sb9EKIosSQS",
    "object": "subscription",
    "application": null,
    "application_fee_percent": null,
    "automatic_tax": {
        "disabled_reason": null,
        "enabled": false,
        "liability": null
    },
    "billing_cycle_anchor": 1747091196,
    "billing_cycle_anchor_config": null,
    "cancel_at": null,
    "cancel_at_period_end": false,
    "canceled_at": null,
    "cancellation_details": {
        "comment": null,
        "feedback": null,
        "reason": null
    },
    "collection_method": "charge_automatically",
    "created": 1747091196,
    "currency": "eur",
    "customer": "cus_SIgoJvUF0ooe7U",
    "days_until_due": null,
    "default_payment_method": "pm_1RO5QdP71JLI6sb9E6WLHpfW",
    "default_source": null,
    "default_tax_rates": [],
    "description": null,
    "discounts": [],
    "ended_at": null,
    "invoice_settings": {
        "account_tax_ids": null,
        "issuer": {
            "type": "self"
        }
    },
    "items": {
        "object": "list",
        "data": [
            {
                "id": "si_SIgoQLiytr2oW7",
                "object": "subscription_item",
                "created": 1747091196,
                "current_period_end": 1778627196,
                "current_period_start": 1747091196,
                "discounts": [],
                "metadata": [],
                "plan": {
                    "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                    "object": "plan",
                    "active": true,
                    "amount": 1500,
                    "amount_decimal": "1500",
                    "billing_scheme": "per_unit",
                    "created": 1746447117,
                    "currency": "eur",
                    "interval": "year",
                    "interval_count": 1,
                    "livemode": false,
                    "metadata": [],
                    "meter": null,
                    "nickname": "Annual payment of the Test Surlabs product",
                    "product": "prod_SFsxoaHLKoYbKj",
                    "tiers_mode": null,
                    "transform_usage": null,
                    "trial_period_days": null,
                    "usage_type": "licensed"
                },
                "price": {
                    "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                    "object": "price",
                    "active": true,
                    "billing_scheme": "per_unit",
                    "created": 1746447117,
                    "currency": "eur",
                    "custom_unit_amount": null,
                    "livemode": false,
                    "lookup_key": "annual_payment",
                    "metadata": [],
                    "nickname": "Annual payment of the Test Surlabs product",
                    "product": "prod_SFsxoaHLKoYbKj",
                    "recurring": {
                        "interval": "year",
                        "interval_count": 1,
                        "meter": null,
                        "trial_period_days": null,
                        "usage_type": "licensed"
                    },
                    "tax_behavior": "unspecified",
                    "tiers_mode": null,
                    "transform_quantity": null,
                    "type": "recurring",
                    "unit_amount": 1500,
                    "unit_amount_decimal": "1500"
                },
                "quantity": 1,
                "subscription": "sub_1RO5QfP71JLI6sb9EKIosSQS",
                "tax_rates": []
            }
        ],
        "has_more": false,
        "total_count": 1,
        "url": "/v1/subscription_items?subscription=sub_1RO5QfP71JLI6sb9EKIosSQS"
    },
    "latest_invoice": "in_1RO5QgP71JLI6sb9HSRdDSiW",
    "livemode": false,
    "metadata": [],
    "next_pending_invoice_item_invoice": null,
    "on_behalf_of": null,
    "pause_collection": null,
    "payment_settings": {
        "payment_method_options": {
            "acss_debit": null,
            "bancontact": null,
            "card": {
                "network": null,
                "request_three_d_secure": "automatic"
            },
            "customer_balance": null,
            "konbini": null,
            "sepa_debit": null,
            "us_bank_account": null
        },
        "payment_method_types": [
            "card"
        ],
        "save_default_payment_method": "off"
    },
    "pending_invoice_item_interval": null,
    "pending_setup_intent": null,
    "pending_update": null,
    "plan": {
        "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
        "object": "plan",
        "active": true,
        "amount": 1500,
        "amount_decimal": "1500",
        "billing_scheme": "per_unit",
        "created": 1746447117,
        "currency": "eur",
        "interval": "year",
        "interval_count": 1,
        "livemode": false,
        "metadata": [],
        "meter": null,
        "nickname": "Annual payment of the Test Surlabs product",
        "product": "prod_SFsxoaHLKoYbKj",
        "tiers_mode": null,
        "transform_usage": null,
        "trial_period_days": null,
        "usage_type": "licensed"
    },
    "quantity": 1,
    "schedule": null,
    "start_date": 1747091196,
    "status": "active",
    "test_clock": null,
    "transfer_data": null,
    "trial_end": null,
    "trial_settings": {
        "end_behavior": {
            "missing_payment_method": "create_invoice"
        }
    },
    "trial_start": null
}</code></pre>
                    </div>

                    <div class="event-detail mb-4">
                        <h6><code class="stripe-object-prefix">customer.subscription.updated</code></h6>
                        <p>Se dispara cuando cualquier atributo de una suscripción cambia. Esto incluye cambios de estado (ej. de <code>trialing</code> a <code>active</code>, o a <code>past_due</code>), cambios de plan, actualizaciones de cantidad, o cuando se establece <code>cancel_at_period_end</code>.</p>
                        <p><strong>Información Clave:</strong> El objeto Subscription actualizado. El campo <code>data.previous_attributes</code> es muy útil aquí para determinar qué cambió exactamente.</p>
                        <p><strong>Payload de Ejemplo (para <code>cancel_at_period_end</code> establecido a true):</strong></p>
                        <pre><code class="language-json">[STRIPE_PAYLOAD] Event Type: customer.subscription.updated, Event ID: evt_1RO5TIP71JLI6sb9VAxuiPuw
{
    "id": "sub_1RO5PaP71JLI6sb9JeUmU3lZ",
    "object": "subscription",
    "application": null,
    "application_fee_percent": null,
    "automatic_tax": {
        "disabled_reason": null,
        "enabled": false,
        "liability": null
    },
    "billing_cycle_anchor": 1747091129,
    "billing_cycle_anchor_config": null,
    "cancel_at": 1778627129,
    "cancel_at_period_end": true,
    "canceled_at": 1747091360,
    "cancellation_details": {
        "comment": null,
        "feedback": null,
        "reason": "cancellation_requested"
    },
    "collection_method": "charge_automatically",
    "created": 1747091129,
    "currency": "eur",
    "customer": "cus_SIgnD5ZnJtFkKF",
    "days_until_due": null,
    "default_payment_method": "pm_1RO5PYP71JLI6sb9WmxI8bzK",
    "default_source": null,
    "default_tax_rates": [],
    "description": null,
    "discounts": [],
    "ended_at": null,
    "invoice_settings": {
        "account_tax_ids": null,
        "issuer": {
            "type": "self"
        }
    },
    "items": {
        "object": "list",
        "data": [
            {
                "id": "si_SIgnlukijBew1r",
                "object": "subscription_item",
                "created": 1747091129,
                "current_period_end": 1778627129,
                "current_period_start": 1747091129,
                "discounts": [],
                "metadata": [],
                "plan": {
                    "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                    "object": "plan",
                    "active": true,
                    "amount": 1500,
                    "amount_decimal": "1500",
                    "billing_scheme": "per_unit",
                    "created": 1746447117,
                    "currency": "eur",
                    "interval": "year",
                    "interval_count": 1,
                    "livemode": false,
                    "metadata": [],
                    "meter": null,
                    "nickname": "Annual payment of the Test Surlabs product",
                    "product": "prod_SFsxoaHLKoYbKj",
                    "tiers_mode": null,
                    "transform_usage": null,
                    "trial_period_days": null,
                    "usage_type": "licensed"
                },
                "price": {
                    "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                    "object": "price",
                    "active": true,
                    "billing_scheme": "per_unit",
                    "created": 1746447117,
                    "currency": "eur",
                    "custom_unit_amount": null,
                    "livemode": false,
                    "lookup_key": "annual_payment",
                    "metadata": [],
                    "nickname": "Annual payment of the Test Surlabs product",
                    "product": "prod_SFsxoaHLKoYbKj",
                    "recurring": {
                        "interval": "year",
                        "interval_count": 1,
                        "meter": null,
                        "trial_period_days": null,
                        "usage_type": "licensed"
                    },
                    "tax_behavior": "unspecified",
                    "tiers_mode": null,
                    "transform_quantity": null,
                    "type": "recurring",
                    "unit_amount": 1500,
                    "unit_amount_decimal": "1500"
                },
                "quantity": 1,
                "subscription": "sub_1RO5PaP71JLI6sb9JeUmU3lZ",
                "tax_rates": []
            }
        ],
        "has_more": false,
        "total_count": 1,
        "url": "/v1/subscription_items?subscription=sub_1RO5PaP71JLI6sb9JeUmU3lZ"
    },
    "latest_invoice": "in_1RO5PaP71JLI6sb9hSZVU0YK",
    "livemode": false,
    "metadata": [],
    "next_pending_invoice_item_invoice": null,
    "on_behalf_of": null,
    "pause_collection": null,
    "payment_settings": {
        "payment_method_options": {
            "acss_debit": null,
            "bancontact": null,
            "card": {
                "network": null,
                "request_three_d_secure": "automatic"
            },
            "customer_balance": null,
            "konbini": null,
            "sepa_debit": null,
            "us_bank_account": null
        },
        "payment_method_types": [
            "card"
        ],
        "save_default_payment_method": "off"
    },
    "pending_invoice_item_interval": null,
    "pending_setup_intent": null,
    "pending_update": null,
    "plan": {
        "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
        "object": "plan",
        "active": true,
        "amount": 1500,
        "amount_decimal": "1500",
        "billing_scheme": "per_unit",
        "created": 1746447117,
        "currency": "eur",
        "interval": "year",
        "interval_count": 1,
        "livemode": false,
        "metadata": [],
        "meter": null,
        "nickname": "Annual payment of the Test Surlabs product",
        "product": "prod_SFsxoaHLKoYbKj",
        "tiers_mode": null,
        "transform_usage": null,
        "trial_period_days": null,
        "usage_type": "licensed"
    },
    "quantity": 1,
    "schedule": null,
    "start_date": 1747091129,
    "status": "active",
    "test_clock": null,
    "transfer_data": null,
    "trial_end": null,
    "trial_settings": {
        "end_behavior": {
            "missing_payment_method": "create_invoice"
        }
    },
    "trial_start": null
}</code></pre>
                    </div>

                    <div class="event-detail mb-4">
                        <h6><code class="stripe-object-prefix">customer.subscription.deleted</code></h6>
                        <p>Se dispara cuando una suscripción es cancelada. Esto puede ser una cancelación inmediata o una cancelación programada para el final del período de facturación actual (si <code>cancel_at_period_end</code> era true y el período ha terminado).</p>
                        <p><strong>Información Clave:</strong> El objeto Subscription con <code>status: canceled</code> y <code>ended_at</code> (timestamp de cuándo terminó).</p>
                        <p><strong>Payload de Ejemplo (cancelación inmediata):</strong></p>
                        <pre><code class="language-json">[STRIPE_PAYLOAD] Event Type: customer.subscription.deleted, Event ID: evt_1RO5T7P71JLI6sb99KZV8W0y
{
    "id": "sub_1RO5QfP71JLI6sb9EKIosSQS",
    "object": "subscription",
    "application": null,
    "application_fee_percent": null,
    "automatic_tax": {
        "disabled_reason": null,
        "enabled": false,
        "liability": null
    },
    "billing_cycle_anchor": 1747091196,
    "billing_cycle_anchor_config": null,
    "cancel_at": null,
    "cancel_at_period_end": false,
    "canceled_at": 1747091349,
    "cancellation_details": {
        "comment": null,
        "feedback": null,
        "reason": "cancellation_requested"
    },
    "collection_method": "charge_automatically",
    "created": 1747091196,
    "currency": "eur",
    "customer": "cus_SIgoJvUF0ooe7U",
    "days_until_due": null,
    "default_payment_method": "pm_1RO5QdP71JLI6sb9E6WLHpfW",
    "default_source": null,
    "default_tax_rates": [],
    "description": null,
    "discounts": [],
    "ended_at": 1747091349,
    "invoice_settings": {
        "account_tax_ids": null,
        "issuer": {
            "type": "self"
        }
    },
    "items": {
        "object": "list",
        "data": [
            {
                "id": "si_SIgoQLiytr2oW7",
                "object": "subscription_item",
                "created": 1747091196,
                "current_period_end": 1778627196,
                "current_period_start": 1747091196,
                "discounts": [],
                "metadata": [],
                "plan": {
                    "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                    "object": "plan",
                    "active": true,
                    "amount": 1500,
                    "amount_decimal": "1500",
                    "billing_scheme": "per_unit",
                    "created": 1746447117,
                    "currency": "eur",
                    "interval": "year",
                    "interval_count": 1,
                    "livemode": false,
                    "metadata": [],
                    "meter": null,
                    "nickname": "Annual payment of the Test Surlabs product",
                    "product": "prod_SFsxoaHLKoYbKj",
                    "tiers_mode": null,
                    "transform_usage": null,
                    "trial_period_days": null,
                    "usage_type": "licensed"
                },
                "price": {
                    "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
                    "object": "price",
                    "active": true,
                    "billing_scheme": "per_unit",
                    "created": 1746447117,
                    "currency": "eur",
                    "custom_unit_amount": null,
                    "livemode": false,
                    "lookup_key": "annual_payment",
                    "metadata": [],
                    "nickname": "Annual payment of the Test Surlabs product",
                    "product": "prod_SFsxoaHLKoYbKj",
                    "recurring": {
                        "interval": "year",
                        "interval_count": 1,
                        "meter": null,
                        "trial_period_days": null,
                        "usage_type": "licensed"
                    },
                    "tax_behavior": "unspecified",
                    "tiers_mode": null,
                    "transform_quantity": null,
                    "type": "recurring",
                    "unit_amount": 1500,
                    "unit_amount_decimal": "1500"
                },
                "quantity": 1,
                "subscription": "sub_1RO5QfP71JLI6sb9EKIosSQS",
                "tax_rates": []
            }
        ],
        "has_more": false,
        "total_count": 1,
        "url": "/v1/subscription_items?subscription=sub_1RO5QfP71JLI6sb9EKIosSQS"
    },
    "latest_invoice": "in_1RO5QgP71JLI6sb9HSRdDSiW",
    "livemode": false,
    "metadata": [],
    "next_pending_invoice_item_invoice": null,
    "on_behalf_of": null,
    "pause_collection": null,
    "payment_settings": {
        "payment_method_options": {
            "acss_debit": null,
            "bancontact": null,
            "card": {
                "network": null,
                "request_three_d_secure": "automatic"
            },
            "customer_balance": null,
            "konbini": null,
            "sepa_debit": null,
            "us_bank_account": null
        },
        "payment_method_types": [
            "card"
        ],
        "save_default_payment_method": "off"
    },
    "pending_invoice_item_interval": null,
    "pending_setup_intent": null,
    "pending_update": null,
    "plan": {
        "id": "price_1RLNsHP71JLI6sb9ez8HJsHt",
        "object": "plan",
        "active": true,
        "amount": 1500,
        "amount_decimal": "1500",
        "billing_scheme": "per_unit",
        "created": 1746447117,
        "currency": "eur",
        "interval": "year",
        "interval_count": 1,
        "livemode": false,
        "metadata": [],
        "meter": null,
        "nickname": "Annual payment of the Test Surlabs product",
        "product": "prod_SFsxoaHLKoYbKj",
        "tiers_mode": null,
        "transform_usage": null,
        "trial_period_days": null,
        "usage_type": "licensed"
    },
    "quantity": 1,
    "schedule": null,
    "start_date": 1747091196,
    "status": "canceled",
    "test_clock": null,
    "transfer_data": null,
    "trial_end": null,
    "trial_settings": {
        "end_behavior": {
            "missing_payment_method": "create_invoice"
        }
    },
    "trial_start": null
}</code></pre>
                    </div>
                    <p>Otro evento relevante es <code class="stripe-object-prefix">customer.subscription.trial_will_end</code>, que se envía unos días antes de que finalice un período de prueba, permitiendo notificar al cliente.</p>

                    <hr class="my-4">
                    <h5 class="mt-4">Productos y Precios (Informativo):</h5>
                    <p>Los eventos relacionados con Productos (<code class="stripe-object-prefix">product.*</code>) y Precios (<code class="stripe-object-prefix">price.*</code>) como <code class="stripe-object-prefix">product.created</code>, <code class="stripe-object-prefix">product.updated</code>, <code class="stripe-object-prefix">price.created</code>, <code class="stripe-object-prefix">price.updated</code>, etc., se disparan cuando estos objetos son modificados en tu cuenta de Stripe.</p>
                    <p>Generalmente, estos eventos no son manejados activamente por aplicaciones como StripeLabApp a través de webhooks para la lógica de negocio principal, ya que la gestión de productos y precios suele hacerse directamente a través del Dashboard de Stripe o mediante scripts de aprovisionamiento. Sin embargo, pueden ser útiles para sistemas de auditoría o para sincronizar catálogos de productos con sistemas externos si es necesario.</p>
                    <p>En StripeLabApp, los IDs de Precios se usan directamente al crear sesiones de Checkout o suscripciones, asumiendo que estos ya existen en la cuenta de Stripe.</p>
                    <!-- FIN DE NUEVO CONTENIDO PARA 3.3 -->
                </section>


                <section id="parte1-seccion3-4" class="mb-4">
                    <h4 class="mt-4">3.4. Orden de los Eventos y Flujos Comunes:</h4>
                    <p>Es importante entender que los eventos de Stripe, aunque a menudo llegan rápidamente, no tienen una garantía estricta de orden de llegada para eventos distintos que ocurren casi simultáneamente. Sin embargo, para un flujo específico (como el pago de una factura), Stripe suele enviar los eventos en una secuencia lógica.</p>
                    <p>Tu manejador de webhooks debe ser robusto y, preferiblemente, idempotente (capaz de procesar el mismo evento múltiples veces sin efectos secundarios no deseados). Usar el ID del evento (<code class="stripe-object-prefix">evt_...</code>) para rastrear los eventos procesados es una buena práctica.</p>
                    <p>A continuación, se muestran diagramas de secuencia (usando sintaxis Mermaid) para ilustrar flujos comunes y los eventos de webhook esperados en StripeLabApp.</p>

                    <h5 class="mt-4">Flujo de Nueva Suscripción con Stripe Checkout:</h5>
                    <p>Este diagrama muestra los pasos desde que el usuario selecciona un plan hasta que la suscripción está activa y registrada en el backend.</p>
                    <div class="mermaid">
                        sequenceDiagram
                        participant User
                        participant FrontendApp as StripeLabApp Frontend
                        participant BackendApp as StripeLabApp Backend
                        participant StripeAPI as Stripe API
                        participant StripeWebhook as Stripe Webhook Endpoint

                        User->>FrontendApp: Selecciona Plan de Suscripción
                        FrontendApp->>BackendApp: POST /v1/create_subscription_session.php (priceId)
                        BackendApp->>StripeAPI: Crear Checkout Session (mode: 'subscription', price: priceId)
                        StripeAPI-->>BackendApp: Checkout Session (id, url)
                        BackendApp-->>FrontendApp: { sessionId: 'cs_...' }
                        FrontendApp->>StripeAPI: stripe.redirectToCheckout({ sessionId })

                        User->>StripeAPI: Completa Formulario de Pago en Stripe
                        StripeAPI-->>User: Redirige a success_url

                        StripeAPI->>StripeWebhook: Evento: checkout.session.completed
                        Note right of StripeWebhook: Contiene: customer_id, subscription_id, invoice_id
                        StripeWebhook->>BackendApp: (Procesar checkout.session.completed)

                        StripeAPI->>StripeWebhook: Evento: customer.created (si nuevo)
                        StripeWebhook->>BackendApp: (Procesar customer.created)

                        StripeAPI->>StripeWebhook: Evento: invoice.created
                        StripeWebhook->>BackendApp: (Opcional: Registrar)

                        StripeAPI->>StripeWebhook: Evento: invoice.paid
                        StripeWebhook->>BackendApp: (Procesar invoice.paid: Actualizar estado factura)
                        Note right of StripeWebhook: Contiene: payment_intent_id

                        StripeAPI->>StripeWebhook: Evento: payment_intent.succeeded (pago inicial)
                        StripeWebhook->>BackendApp: (Procesar payment_intent.succeeded: Registrar pago)
                        Note right of StripeWebhook: Contiene: charge_id

                        StripeAPI->>StripeWebhook: Evento: charge.succeeded
                        StripeWebhook->>BackendApp: (Opcional: Registrar detalles del cargo)

                        StripeAPI->>StripeWebhook: Evento: customer.subscription.created
                        StripeWebhook->>BackendApp: (Procesar customer.subscription.created: Activar suscripción en DB)

                        BackendApp->>Database: Guardar/Actualizar Cliente, Suscripción, Factura, Transacción
                    </div>

                    <h5 class="mt-4">Flujo de Pago Único con Stripe Checkout:</h5>
                    <p>Este diagrama ilustra un pago único simple.</p>
                    <div class="mermaid">
                        sequenceDiagram
                        participant User
                        participant FrontendApp as StripeLabApp Frontend
                        participant BackendApp as StripeLabApp Backend
                        participant StripeAPI as Stripe API
                        participant StripeWebhook as Stripe Webhook Endpoint

                        User->>FrontendApp: Selecciona Producto (Pago Único)
                        FrontendApp->>BackendApp: POST /v1/create_payment_session.php (priceId)
                        BackendApp->>StripeAPI: Crear Checkout Session (mode: 'payment', price: priceId)
                        StripeAPI-->>BackendApp: Checkout Session (id, url)
                        BackendApp-->>FrontendApp: { sessionId: 'cs_...' }
                        FrontendApp->>StripeAPI: stripe.redirectToCheckout({ sessionId })

                        User->>StripeAPI: Completa Formulario de Pago en Stripe
                        StripeAPI-->>User: Redirige a success_url

                        StripeAPI->>StripeWebhook: Evento: checkout.session.completed
                        Note right of StripeWebhook: Contiene: payment_intent_id
                        StripeWebhook->>BackendApp: (Procesar checkout.session.completed)

                        StripeAPI->>StripeWebhook: Evento: payment_intent.succeeded
                        StripeWebhook->>BackendApp: (Procesar payment_intent.succeeded: Confirmar pago, registrar transacción)
                        Note right of StripeWebhook: Contiene: charge_id

                        StripeAPI->>StripeWebhook: Evento: charge.succeeded
                        StripeWebhook->>BackendApp: (Opcional: Registrar detalles del cargo, receipt_url)

                        BackendApp->>Database: Guardar Transacción de Pago
                    </div>
                    <p>Estos son ejemplos simplificados. Flujos más complejos, como aquellos que involucran autenticación 3D Secure o métodos de pago con retraso en la notificación, pueden generar secuencias de eventos adicionales (ej. <code class="stripe-object-prefix">payment_intent.requires_action</code>, <code class="stripe-object-prefix">payment_intent.processing</code>).</p>
                </section>

            </section> <!-- Fin de sección 3 -->

            <hr class="my-4">

            <section id="parte1-seccion4" class="mb-4">
                <h3>4. Stripe CLI: Herramienta Esencial para Desarrollo y Pruebas</h3>
                <p>La Stripe Command Line Interface (CLI) es una herramienta poderosa que te permite interactuar con la API de Stripe directamente desde tu terminal. Facilita enormemente el desarrollo, las pruebas y la gestión de tu integración con Stripe sin necesidad de escribir código para tareas comunes o navegar por el Dashboard de Stripe para todo.</p>

                <h4 id="parte1-seccion4-1">4.1. ¿Qué es Stripe CLI y por qué es útil?</h4>
                <p>Stripe CLI es una aplicación de línea de comandos que puedes instalar en tu entorno de desarrollo. Una vez configurada y conectada a tu cuenta de Stripe (ya sea en modo de prueba o producción, aunque se recomienda encarecidamente usarla principalmente con el modo de prueba para desarrollo), ofrece una variedad de funcionalidades:</p>
                <ul>
                    <li><strong>Reenvío de Webhooks (Webhook Forwarding):</strong> Esta es una de sus características más valiosas. Permite reenviar eventos de webhook desde Stripe a tu aplicación que se ejecuta localmente (por ejemplo, en `localhost`). Esto es crucial para probar tus manejadores de webhook sin tener que desplegar tu aplicación en un servidor público. Comando: `stripe listen --forward-to localhost:PUERTO/tu-endpoint`.</li>
                    <li><strong>Disparo de Eventos (Triggering Events):</strong> Puedes simular y disparar eventos de Stripe directamente desde la CLI para probar cómo reacciona tu aplicación. Por ejemplo, puedes disparar un `payment_intent.succeeded` o un `customer.subscription.deleted` para verificar la lógica de tu manejador de webhooks. Comando: `stripe trigger payment_intent.succeeded`.</li>
                    <li><strong>Llamadas a la API:</strong> Permite realizar llamadas directas a la API de Stripe, como crear clientes, listar pagos, recuperar objetos, etc. Esto es útil para inspeccionar datos o realizar acciones administrativas rápidas. Ejemplo: `stripe customers list`.</li>
                    <li><strong>Gestión de Recursos:</strong> Puedes crear, recuperar, actualizar y eliminar objetos de Stripe (Productos, Precios, Cupones, etc.).</li>
                    <li><strong>Streaming de Logs de API y Eventos:</strong> Puedes ver en tiempo real los logs de las solicitudes a la API y los eventos que ocurren en tu cuenta. Comando: `stripe logs tail` o `stripe events tail`.</li>
                    <li><strong>Muestras de Código:</strong> Stripe CLI puede ayudarte a generar fragmentos de código para interactuar con los recursos de Stripe.</li>
                </ul>
                <p>El uso de Stripe CLI acelera significativamente el ciclo de desarrollo y depuración al trabajar con Stripe, especialmente para la funcionalidad de webhooks y la simulación de diversos escenarios de pago.</p>

                <h4 id="parte1-seccion4-2" class="mt-4">4.2. Instalación y Configuración</h4>
                <p>La instalación de Stripe CLI varía según tu sistema operativo. Puedes encontrar las instrucciones detalladas en la <a href="https://stripe.com/docs/stripe-cli" target="_blank">documentación oficial de Stripe CLI</a>.</p>
                <p>Una vez instalada, el primer paso es autenticar la CLI con tu cuenta de Stripe. Esto se hace con el comando:</p>
                <pre><code class="language-bash">stripe login</code></pre>
                <p>Este comando te abrirá una ventana en tu navegador para que inicies sesión en tu cuenta de Stripe y autorices a la CLI. Al finalizar, la CLI guardará tus claves API de forma segura para futuras sesiones. Por defecto, se conectará a tu cuenta en modo de prueba.</p>
                <p>Puedes verificar la configuración y la cuenta conectada con:</p>
                <pre><code class="language-bash">stripe status</code></pre>

                <h4 id="parte1-seccion4-3" class="mt-4">4.3. Reenvío de Webhooks a Entornos Locales</h4>
                <p>Una de las funciones más potentes de Stripe CLI es la capacidad de reenviar eventos de webhook desde los servidores de Stripe a tu entorno de desarrollo local. Esto te permite probar tu endpoint de webhook sin necesidad de desplegar tu aplicación en un servidor con acceso público a Internet.</p>
                <p>Para iniciar el reenvío, utiliza el comando `listen`:</p>
                <pre><code class="language-bash">stripe listen --forward-to localhost:PUERTO/ruta/a/tu/webhook-endpoint.php</code></pre>
                <p>Reemplaza `PUERTO` con el puerto en el que se ejecuta tu servidor web local (ej. `8000` para el servidor de desarrollo de PHP) y `/ruta/a/tu/webhook-endpoint.php` con la ruta real a tu script manejador de webhooks (en StripeLabApp, sería algo como `localhost:8000/src/Webhook/stripe_webhook_endpoint.php`).</p>
                <p>Cuando ejecutas este comando, Stripe CLI te proporcionará un <strong>secreto de webhook temporal</strong> (con prefijo <code class="stripe-object-prefix">whsec_...</code>). Este secreto es específico para esta sesión de `listen`. <strong>Debes usar este secreto temporal en la configuración de tu aplicación local para verificar las firmas de los webhooks mientras pruebas</strong>, en lugar del secreto de webhook de tu endpoint de producción o de prueba configurado en el Dashboard de Stripe.</p>
                <p>La CLI mostrará en tiempo real los eventos que Stripe envía y que son reenviados a tu aplicación local.</p>

                <h4 id="parte1-seccion4-4" class="mt-4">4.4. Disparo de Eventos de Prueba</h4>
                <p>Stripe CLI te permite disparar eventos de prueba directamente desde la línea de comandos. Esto es extremadamente útil para simular diferentes escenarios y probar la lógica de tu manejador de webhooks sin tener que realizar acciones reales (como completar un pago).</p>
                <p>El comando básico es:</p>
                <pre><code class="language-bash">stripe trigger &lt;nombre_del_evento&gt;</code></pre>
                <p>Por ejemplo, para simular un pago exitoso:</p>
                <pre><code class="language-bash">stripe trigger payment_intent.succeeded</code></pre>
                <p>Para simular la cancelación de una suscripción:</p>
                <pre><code class="language-bash">stripe trigger customer.subscription.deleted</code></pre>
                <p>O la finalización de una sesión de checkout:</p>
                <pre><code class="language-bash">stripe trigger checkout.session.completed</code></pre>
                <p>La CLI creará los objetos necesarios (como un PaymentIntent, un Cliente, una Suscripción, etc., según el evento) en modo de prueba y luego disparará el evento especificado. Si tienes `stripe listen` ejecutándose, verás cómo este evento es reenviado a tu endpoint local.</p>
                <p>Puedes encontrar una lista de eventos que puedes disparar en la <a href="https://stripe.com/docs/cli/trigger" target="_blank">documentación de `stripe trigger`</a>. Algunos eventos pueden requerir parámetros adicionales para personalizar el objeto que se crea.</p>
                <p>Combinar `stripe listen` y `stripe trigger` es una forma poderosa de desarrollar y depurar tu integración de webhooks de manera eficiente.</p>
            </section>
            </section> <!-- Fin de PARTE I -->
            <!-- ============================================================================== -->
            <!-- PARTE II: STRIPELABAPP                                                       -->
            <!-- ============================================================================== -->
            <section id="parte2" class="mb-5">
                <h2>PARTE II: StripeLabApp</h2>
                <hr>

                <section id="parte2-seccion5" class="mb-4">
                    <h3>5. Introducción a StripeLabApp</h3>

                    <h4 id="parte2-seccion5-1">5.1. Objetivos del Proyecto</h4>
                    <p>StripeLabApp es una aplicación PHP diseñada con los siguientes objetivos principales:</p>
                    <ul>
                        <li><strong>Aprendizaje Práctico:</strong> Servir como un entorno de laboratorio para explorar y entender la integración con la API de Stripe, especialmente en el contexto de una aplicación PHP.</li>
                        <li><strong>Demostración de Flujos de Pago:</strong> Ilustrar la implementación de flujos de pago comunes, incluyendo:
                            <ul>
                                <li>Pagos Únicos (one-time payments) utilizando Stripe Checkout.</li>
                                <li>Suscripciones (recurrentes) gestionadas a través de Stripe Billing y Stripe Checkout.</li>
                            </ul>
                        </li>
                        <li><strong>Manejo de Webhooks:</strong> Demostrar un sistema robusto para recibir, verificar y procesar webhooks de Stripe, que son cruciales para mantener la sincronización entre la aplicación y Stripe.</li>
                        <li><strong>Arquitectura por Capas:</strong> Mostrar un ejemplo de una arquitectura de aplicación PHP organizada y modular, facilitando la comprensión, el mantenimiento y la extensibilidad.</li>
                        <li><strong>Persistencia de Datos:</strong> Ilustrar cómo persistir información relevante de Stripe (como transacciones y suscripciones) en una base deatos MySQL local.</li>
                    </ul>
                    <p>El proyecto no pretende ser una solución de comercio electrónico completa y lista para producción, sino más bien un recurso educativo y un punto de partida para desarrolladores que deseen integrar Stripe en sus propias aplicaciones PHP.</p>
                </section>

                <section id="parte2-seccion5-2" class="mb-4">
                    <h4>5.2. Funcionalidades Implementadas</h4>
                    <p>StripeLabApp implementa las siguientes funcionalidades clave:</p>
                    <ul>
                        <li><strong>Flujo de Pago Único:</strong>
                            <ul>
                                <li>Selección de un producto de demostración para pago único.</li>
                                <li>Creación de una sesión de Stripe Checkout para procesar el pago.</li>
                                <li>Redirección a la página de éxito/cancelación de Stripe.</li>
                                <li>Manejo del webhook <code>checkout.session.completed</code> para confirmar el pago.</li>
                                <li>Persistencia de la transacción en la base de datos local.</li>
                            </ul>
                        </li>
                        <li><strong>Flujo de Suscripciones:</strong>
                            <ul>
                                <li>Selección de un plan de suscripción de demostración (mensual/anual).</li>
                                <li>Creación de una sesión de Stripe Checkout para iniciar la suscripción.</li>
                                <li>Redirección a la página de éxito/cancelación de Stripe.</li>
                                <li>Manejo de webhooks relevantes:
                                    <ul>
                                        <li><code>checkout.session.completed</code> para la creación inicial.</li>
                                        <li><code>customer.subscription.created</code> para registrar la nueva suscripción.</li>
                                        <li><code>invoice.paid</code> para registrar los pagos de las facturas (inicial y renovaciones).</li>
                                        <li><code>customer.subscription.updated</code> para cambios de estado.</li>
                                        <li><code>customer.subscription.deleted</code> para cancelaciones.</li>
                                    </ul>
                                </li>
                                <li>Persistencia de los detalles de la suscripción y las transacciones asociadas en la base de datos local.</li>
                            </ul>
                        </li>
                        <li><strong>Manejo Avanzado de Webhooks:</strong>
                            <ul>
                                <li>Endpoint dedicado para recibir todos los eventos de Stripe.</li>
                                <li>Verificación de la firma del webhook para seguridad.</li>
                                <li>Sistema de estrategias para delegar el procesamiento de cada tipo de evento a un manejador específico.</li>
                                <li>Logging detallado de eventos recibidos, procesados y errores.</li>
                            </ul>
                        </li>
                        <li><strong>Persistencia en Base de Datos:</strong>
                            <ul>
                                <li>Uso de MySQL para almacenar información de clientes (simplificado), suscripciones y transacciones.</li>
                                <li>Mapeo de objetos de Stripe a entidades locales.</li>
                            </ul>
                        </li>
                        <li><strong>Visualización de Datos:</strong>
                            <ul>
                                <li>Páginas para listar facturas (recibos) y suscripciones almacenadas localmente.</li>
                                <li>Obtención de URLs de facturas alojadas en Stripe.</li>
                            </ul>
                        </li>
                        <li><strong>Gestión Básica de Suscripciones:</strong>
                            <ul>
                                <li>Funcionalidad para que un usuario (simulado) cancele una suscripción activa (inmediata o al final del período).</li>
                                <li>Funcionalidad para que un usuario (simulado) reactive una suscripción cancelada (si está configurada para cancelarse al final del período).</li>
                            </ul>
                        </li>
                        <li><strong>Configuración Flexible:</strong>
                            <ul>
                                <li>Uso de un archivo <code>.env</code> para gestionar claves API y otras configuraciones sensibles.</li>
                            </ul>
                        </li>
                        <li><strong>Logging Robusto:</strong>
                            <ul>
                                <li>Múltiples loggers para diferentes aspectos de la aplicación (eventos, errores, base de datos, payloads de Stripe).</li>
                            </ul>
                        </li>
                    </ul>
                </section>

                <section id="parte2-seccion5-3" class="mb-4">
                    <h4>5.3. Estructura de Directorios del Proyecto</h4>
                    <p>La organización de los archivos y directorios en StripeLabApp sigue una estructura modular para promover la claridad y el mantenimiento. A continuación se presenta el árbol de directorios principal:</p>
                    <pre><code class="plaintext">
StripeLabApp/
├── assets/
│   ├── css/
│   │   └── documentation_styles.css
│   └── js/
├── config/
│   ├── Bootstrap.php
│   └── DatabaseConnection.php
├── database/
│   └── tables.txt
├── logs/             # Directorio para archivos de log (creado por la aplicación)
├── public/
│   ├── assets/       # (CSS, JS, Imágenes para el frontend de la app)
│   ├── v1/
│   │   ├── api/
│   │   │   ├── api-invoices.php
│   │   │   ├── api-manage-subscription.php
│   │   │   └── api-subscriptions.php
│   │   ├── create_payment_session.php
│   │   ├── create_subscription_session.php
│   │   └── webhook.php
│   ├── cancel.html
│   ├── index.php
│   ├── invoices.php
│   ├── single-payment.php
│   ├── success.html
│   ├── subscriptions-payment.php
│   └── view-subscriptions.php
├── src/
│   ├── Commons/
│   │   ├── DTO/
│   │   │   ├── InvoiceDTO.php
│   │   │   ├── StripeEventDTO.php
│   │   │   └── SubscriptionDTO.php
│   │   ├── Enums/
│   │   │   ├── InvoiceStatusEnum.php
│   │   │   ├── PaymentStatusEnum.php
│   │   │   ├── StripeEventTypeEnum.php
│   │   │   ├── SubscriptionStatusEnum.php
│   │   │   └── TransactionTypeEnum.php
│   │   ├── Exceptions/
│   │   │   ├── ConfigurationException.php
│   │   │   ├── DatabaseException.php
│   │   │   ├── InvalidArgumentException.php
│   │   │   ├── InvalidWebhookPayloadException.php
│   │   │   └── WebhookProcessingException.php
│   │   ├── Loggers/
│   │   │   ├── DatabaseLogger.php
│   │   │   ├── ErrorLogger.php
│   │   │   ├── EventLogger.php
│   │   │   ├── LoggerInterface.php
│   │   │   ├── StripePayloadLogger.php
│   │   │   └── UnhandledStripeEventLogger.php
│   │   └── Models/         # Entidades de la base de datos
│   │       ├── SubscriptionsModel.php
│   │       └── TransactionsModel.php
│   ├── Controller/
│   │   ├── StripeSubscriptionManagementController.php
│   │   └── StripeWebhookController.php
│   ├── Factories/
│   │   ├── EventStrategyFactory.php
│   │   ├── LoggerFactory.php
│   │   └── StrategyFactoryInterface.php
│   ├── Mappers/
│   │   ├── InvoiceMapper.php
│   │   ├── StripeEventMapper.php
│   │   └── SubscriptionMapper.php
│   ├── Repository/
│   │   ├── InvoiceRepository.php
│   │   ├── SubscriptionRepository.php
│   │   └── TransactionRepository.php
│   ├── Service/
│   │   ├── InvoiceService.php
│   │   ├── StripeCheckoutSessionService.php
│   │   ├── StripeSubscriptionManagementService.php
│   │   └── SubscriptionService.php
│   └── Strategy/         # Estrategias para manejar eventos de webhook
│       ├── ChargeSucceededStrategy.php
│       ├── CheckoutSessionCompletedStrategy.php
│       ├── CustomerCreatedStrategy.php
│       ├── CustomerSubscriptionCreatedStrategy.php
│       ├── CustomerSubscriptionDeletedStrategy.php
│       ├── CustomerSubscriptionUpdatedStrategy.php
│       ├── InvoiceCreatedStrategy.php
│       ├── InvoicePaidStrategy.php
│       ├── InvoicePaymentFailedStrategy.php
│       ├── PaymentIntentSucceededStrategy.php
│       ├── StripeEventStrategyInterface.php
│       └── UnhandledEventStrategy.php
├── vendor/           # Dependencias de Composer
├── .env.example
├── .gitignore
├── composer.json
├── composer.lock
└── README.md
                    </code></pre>
                    <p>Una descripción más detallada de los componentes clave se encuentra en la sección de Arquitectura.</p>
                </section>

                <hr class="my-4">

                <section id="parte2-seccion6" class="mb-4">
                    <h3>6. Configuración y Puesta en Marcha de StripeLabApp</h3>

                    <h4 id="parte2-seccion6-1">6.1. Requisitos Específicos de la Aplicación</h4>
                    <p>Para ejecutar StripeLabApp en tu entorno local, necesitarás lo siguiente:</p>
                    <ul>
                        <li><strong>PHP:</strong> Versión 8.0.0 o superior.</li>
                        <li><strong>Composer:</strong> Para gestionar las dependencias del proyecto (como la biblioteca PHP de Stripe). <a href="https://getcomposer.org/" target="_blank">Instalar Composer</a>.</li>
                        <li><strong>Servidor Web:</strong> Un servidor web como Apache o Nginx, o puedes usar el servidor web incorporado de PHP para desarrollo.</li>
                        <li><strong>Base de Datos MySQL:</strong> Para persistir los datos de transacciones y suscripciones.
                            <ul>
                                <li>Se recomienda usar Docker para una configuración rápida (se proporciona un ejemplo básico en el `README.md` del proyecto).</li>
                                <li>Alternativamente, una instancia de MySQL local o remota.</li>
                            </ul>
                        </li>
                        <li><strong>Stripe CLI (Recomendado):</strong> Para facilitar el reenvío de webhooks a tu entorno local y para disparar eventos de prueba. <a href="https://stripe.com/docs/stripe-cli" target="_blank">Instalar Stripe CLI</a>.</li>
                        <li><strong>Cuenta de Stripe:</strong> Necesitarás una cuenta de Stripe para obtener tus claves API (publicable y secreta) y el secreto de webhook. Puedes crear una cuenta gratuita en <a href="https://dashboard.stripe.com/register" target="_blank">Stripe</a>.</li>
                    </ul>
                </section>

                <section id="parte2-seccion6-2" class="mb-4">
                    <h4>6.2. Guía de Instalación</h4>
                    <ol>
                        <li>
                            <strong>Clonar el Repositorio:</strong>
                            <pre><code class="language-bash">git clone <URL_DEL_REPOSITORIO_STRIPELABAPP/> StripeLabApp
                            cd StripeLabApp</code></pre>
                        </li>
                        <li>
                            <strong>Instalar Dependencias con Composer:</strong>
                            <pre><code class="language-bash">composer install</code></pre>
                            Esto instalará la biblioteca `stripe/stripe-php` y cualquier otra dependencia definida en `composer.json`.
                        </li>
                        <li>
                            <strong>Configurar el Archivo de Entorno <code>.env</code>:</strong>
                            <p>Copia el archivo <code>.env.example</code> a <code>.env</code>:</p>
                            <pre><code class="language-bash">cp .env.example .env</code></pre>
                            <p>Luego, edita el archivo <code>.env</code> y completa las siguientes variables clave con tus propios valores:</p>
                            <ul>
                                <li><code>STRIPE_PUBLISHABLE_KEY</code>: Tu clave publicable de Stripe (ej. <code class="stripe-object-prefix">pk_test_...</code>).</li>
                                <li><code>STRIPE_SECRET_KEY</code>: Tu clave secreta de Stripe (ej. <code class="stripe-object-prefix">sk_test_...</code>).</li>
                                <li><code>STRIPE_WEBHOOK_SECRET</code>: El secreto de tu endpoint de webhook configurado en el Dashboard de Stripe (ej. <code class="stripe-object-prefix">whsec_...</code>). <em>Nota: Al usar `stripe listen`, este secreto será reemplazado temporalmente por el que proporciona la CLI.</em></li>
                                <li><code>PRICE_ID_SINGLE_PAYMENT</code>: El ID del Precio de Stripe para el producto de pago único (ej. <code class="stripe-object-prefix">price_...</code>).</li>
                                <li><code>PRICE_ID_SUBSCRIPTION_MONTHLY</code>: El ID del Precio de Stripe para la suscripción mensual (ej. <code class="stripe-object-prefix">price_...</code>).</li>
                                <li><code>PRICE_ID_SUBSCRIPTION_ANNUAL</code>: El ID del Precio de Stripe para la suscripción anual (ej. <code class="stripe-object-prefix">price_...</code>).</li>
                                <li><code>DB_HOST</code>: Host de tu base de datos MySQL (ej. `localhost` o `mysql_db` si usas el Docker Compose de ejemplo).</li>
                                <li><code>DB_PORT</code>: Puerto de tu base de datos MySQL (ej. `3306`).</li>
                                <li><code>DB_NAME</code>: Nombre de tu base de datos (ej. `stripelab_db`).</li>
                                <li><code>DB_USER</code>: Usuario de tu base de datos (ej. `stripelab_user`).</li>
                                <li><code>DB_PASS</code>: Contraseña de tu base de datos (ej. `stripelab_pass`).</li>
                                <li><code>APP_BASE_URL</code>: La URL base de tu aplicación local (ej. `http://localhost:8000`).</li>
                                <li><code>LOG_PATH</code>: Ruta al directorio donde se guardarán los logs (por defecto `../logs/`). Asegúrate de que este directorio exista y tenga permisos de escritura.</li>
                            </ul>
                            <p><em>Deberás crear los Productos y Precios correspondientes en tu Dashboard de Stripe (en modo de prueba) y copiar sus IDs en el archivo <code>.env</code>.</em></p>
                        </li>
                        <li>
                            <strong>Configuración de la Base de Datos:</strong>
                            <ul>
                                <li><strong>Opción Docker (Recomendada):</strong> Si tienes Docker y Docker Compose instalados, puedes usar el archivo `docker-compose.yml` (si se proporciona en el proyecto) para levantar un contenedor MySQL preconfigurado. Generalmente, un comando como `docker-compose up -d` bastaría.</li>
                                <li><strong>Opción Manual:</strong> Crea una base de datos y un usuario en tu instancia de MySQL con los detalles que especificaste en el archivo <code>.env</code>.</li>
                            </ul>
                        </li>
                        <li>
                            <strong>Crear Tablas en la Base de Datos:</strong>
                            <p>La estructura de las tablas necesarias se encuentra en el archivo <code>database/tables.txt</code>. Ejecuta las sentencias SQL de este archivo en tu base de datos MySQL (usando una herramienta como phpMyAdmin, DBeaver, o la línea de comandos de MySQL) para crear las tablas <code>transactions</code> y <code>subscriptions</code>.</p>
                        </li>
                        <li>
                            <strong>Iniciar el Servidor PHP:</strong>
                            <p>Puedes usar el servidor web incorporado de PHP para desarrollo. Navega al directorio <code>public/</code> y ejecuta:</p>
                            <pre><code class="language-bash">cd public
php -S localhost:8000</code></pre>
                            <p>Ahora deberías poder acceder a la aplicación en <a href="http://localhost:8000" target="_blank">http://localhost:8000</a> (o la URL base que configuraste).</p>
                        </li>
                    </ol>
                </section>

                <section id="parte2-seccion6-3" class="mb-4">
                    <h4>6.3. Configuración del Endpoint de Webhook para StripeLabApp</h4>
                    <p>Para que StripeLabApp reciba y procese eventos de Stripe, necesitas configurar un endpoint de webhook en tu Dashboard de Stripe y, para desarrollo local, usar Stripe CLI para reenviar estos eventos.</p>
                    <ol>
                        <li><strong>Definir el Endpoint en el Dashboard de Stripe:</strong>
                            <ul>
                                <li>Ve a tu Dashboard de Stripe > Desarrolladores > Webhooks.</li>
                                <li>Haz clic en "Añadir endpoint".</li>
                                <li>Para desarrollo local, la URL del endpoint será la que te proporcione `stripe listen` más adelante. Para un entorno de producción, sería tu URL pública (ej. `https://tuapp.com/public/v1/webhook.php`).</li>
                                <li>Selecciona los eventos a los que deseas suscribirte. Para StripeLabApp, necesitarás al menos:
                                    <ul>
                                        <li><code>checkout.session.completed</code></li>
                                        <li><code>invoice.paid</code></li>
                                        <li><code>invoice.payment_failed</code></li>
                                        <li><code>customer.subscription.created</code></li>
                                        <li><code>customer.subscription.updated</code></li>
                                        <li><code>customer.subscription.deleted</code></li>
                                        <li>(Opcionalmente, para más detalle: <code>payment_intent.succeeded</code>, <code>charge.succeeded</code>, <code>customer.created</code>, etc.)</li>
                                    </ul>
                                </li>
                                <li>Copia el <strong>Secreto de firma</strong> (<code class="stripe-object-prefix">whsec_...</code>) que te proporciona Stripe. Este es el valor que debes poner en la variable <code>STRIPE_WEBHOOK_SECRET</code> de tu archivo <code>.env</code> para entornos de producción o cuando no uses `stripe listen`.</li>
                            </ul>
                        </li>
                        <li><strong>Usar `stripe listen` para Desarrollo Local:</strong>
                            <p>Como tu aplicación local no es accesible públicamente, usa Stripe CLI:</p>
                            <pre><code class="language-bash">stripe listen --forward-to http://localhost:8000/v1/webhook.php</code></pre>
                            <p>(Asegúrate de que la URL y el puerto coincidan con cómo estás ejecutando StripeLabApp y la ubicación de `webhook.php`).</p>
                            <p>Stripe CLI te proporcionará un <strong>nuevo secreto de webhook temporal</strong> (ej. <code class="stripe-object-prefix">whsec_test_TEMPORAL...</code>). <strong>Importante:</strong> Cuando uses `stripe listen`, debes actualizar temporalmente la variable <code>STRIPE_WEBHOOK_SECRET</code> en tu archivo <code>.env</code> local con este secreto temporal proporcionado por la CLI para que la verificación de la firma funcione correctamente durante tus pruebas locales. No olvides revertirlo al secreto "real" de tu endpoint si despliegas o pruebas sin `stripe listen`.</p>
                        </li>
                    </ol>
                </section>

                <hr class="my-4">

                <section id="parte2-seccion7" class="mb-4">
                    <h3>7. Arquitectura Detallada de StripeLabApp</h3>

                    <h4 id="parte2-seccion7-1" class="mt-4">7.1. Diagrama de Componentes de StripeLabApp</h4>
                    <p>El siguiente diagrama ilustra los principales componentes de StripeLabApp y cómo interactúan entre sí y con servicios externos como la API de Stripe y la base de datos MySQL.</p>
                    <div class="mermaid">
                        graph LR
                        subgraph "User Interaction"
                        direction LR
                        UserInterface["Frontend (public/)<br>HTML, CSS, JS"]
                        end

                        subgraph "Application Core (src/)"
                        direction TB
                        Controllers["Controllers (src/Controller)<br>StripeWebhookController<br>StripeSubscriptionManagementController"]
                        Services["Services (src/Service)<br>StripeCheckoutSessionService<br>SubscriptionService, InvoiceService<br>StripeSubscriptionManagementService"]
                        Strategies["Strategies (src/Strategy)<br>Manejadores de Eventos Webhook"]
                        MappersFactories["Mappers & Factories (src/Mappers, src/Factories)<br>Data Transformation & Object Creation"]
                        Repositories["Repositories (src/Repository)<br>SubscriptionRepository<br>TransactionRepository, InvoiceRepository"]
                        Commons["Commons (src/Commons)<br>DTOs, Entities (Models)<br>Enums, Exceptions, Loggers"]
                        end

                        subgraph "Configuration"
                        direction LR
                        Bootstrap["config/Bootstrap.php<br>Service Locator, Init"]
                        EnvFile[".env File<br>Credentials, Configs"]
                        end

                        subgraph "External Services"
                        direction LR
                        StripeAPI[("Stripe API")]
                        Database[("MySQL DB")]
                        end

                        UserInterface -- HTTP Requests --> EndpointsApi["Endpoints API (public/v1/api)<br>api-*.php"]
                        UserInterface -- HTTP Requests --> EndpointsCheckout["Endpoints Checkout (public/v1/)<br>create_*-session.php"]

                        EndpointsApi --> Controllers
                        EndpointsCheckout --> Services // Directamente para creación de sesiones de checkout

                        StripeAPI -- Webhooks --> WebhookEndpoint["Webhook Endpoint (public/v1/webhook.php)"]
                        WebhookEndpoint --> Controllers // StripeWebhookController

                        Controllers --> Services

                        Services --> Strategies // StripeWebhookController delega a Strategies vía Factory
                        Services --> Repositories  // Para servicios de display/gestión
                        Services --> StripeAPI     // Para StripeCheckoutSessionService, StripeSubscriptionManagementService

                        Strategies --> MappersFactories
                        MappersFactories --> CommonsDtoEntity["DTOs / Entities (Models)"]
                        Strategies --> Repositories
                        Strategies --> CommonsLoggersStrategy["Loggers (via Bootstrap)"]

                        Repositories --> Database
                        Repositories --> CommonsEntities["Entities (Models)"]

                        Bootstrap -- Manages/Provides Dependencies --> Controllers
                        Bootstrap -- Manages/Provides Dependencies --> Services
                        Bootstrap -- Manages/Provides Dependencies --> Strategies
                        Bootstrap -- Manages/Provides Dependencies --> MappersFactories
                        Bootstrap -- Manages/Provides Dependencies --> Repositories
                        Bootstrap -- Reads Configuration --> EnvFile
                        Bootstrap -- Initializes --> CommonsLoggers["Loggers"]

                        Commons -- Used By --> Controllers
                        Commons -- Used By --> Services
                        Commons -- Used By --> Strategies
                        Commons -- Used By --> MappersFactories
                        Commons -- Used By --> Repositories

                        classDef default fill:#fff,stroke:#333,stroke-width:1.5px,font-size:12px;
                        classDef subgraph_style fill:#f4f4f4,stroke:#ccc,stroke-width:1px;
                        class UserInterface,EndpointsApi,EndpointsCheckout,WebhookEndpoint,StripeAPI,Database,EnvFile,Bootstrap subgraph_style;
                    </div>
                    <p>Este diagrama muestra un flujo de solicitud típico comenzando desde la interfaz de usuario (o un webhook de Stripe), pasando por los controladores y servicios, interactuando con la lógica de negocio en las estrategias y repositorios, y finalmente comunicándose con la base de datos o la API de Stripe.</p>
                </section>

                <section id="parte2-seccion7-2" class="mb-4">
                    <h4 id="parte2-seccion7-2-title">7.2. Capa `Commons`</h4>
                    <p>El directorio <code>src/Commons/</code> alberga clases y estructuras de datos transversales utilizadas en toda la aplicación para asegurar la consistencia, el tipado fuerte y la reutilización de código.</p>

                    <h5>DTOs (Data Transfer Objects)</h5>
                    <p>Los DTOs se utilizan para transferir datos entre capas de forma estructurada y desacoplada de las entidades de la base de datos o los objetos de la API de Stripe. Ayudan a definir contratos claros para los datos que se mueven a través del sistema.</p>
                    <ul>
                        <li><strong><code>InvoiceDTO.php</code>:</strong> Representa los datos esenciales de una factura que se pueden mostrar al usuario o devolver en una API. Incluye propiedades como ID de factura, ID de cliente, monto, estado, fecha de creación, URL del recibo, etc.</li>
                        <li><strong><code>SubscriptionDTO.php</code>:</strong> Contiene los datos clave de una suscripción para su visualización o manipulación, como ID de suscripción, ID de cliente, ID de precio, estado, fecha de inicio, fecha de finalización del período actual, y si está configurada para cancelarse al final del período.</li>
                        <li><strong><code>StripeEventDTO.php</code>:</strong> Un DTO simple para encapsular el objeto evento de Stripe (`\Stripe\Event`) después de ser validado y construido desde el payload del webhook. Facilita el paso del evento a las estrategias.</li>
                    </ul>

                    <h5>Entidades (`Models`)</h5>
                    <p>Las entidades, ubicadas en <code>src/Commons/Models/</code>, representan la estructura de los datos tal como se almacenan en la base de datos. Son objetos simples que mapean directamente a las tablas de la base de datos.</p>
                    <ul>
                        <li><strong><code>TransactionsModel.php</code>:</strong> Representa una fila en la tabla <code>transactions</code>. Incluye propiedades como <code>id</code> (autoincremental), <code>stripe_transaction_id</code> (ej. ID del PaymentIntent o Charge), <code>customer_id</code>, <code>amount</code>, <code>currency</code>, <code>status</code>, <code>type</code> (pago único, suscripción), <code>created_at</code>.</li>
                        <li><strong><code>SubscriptionsModel.php</code>:</strong> Representa una fila en la tabla <code>subscriptions</code>. Incluye propiedades como <code>id</code> (autoincremental), <code>stripe_subscription_id</code>, <code>stripe_customer_id</code>, <code>stripe_price_id</code>, <code>status</code>, <code>current_period_start</code>, <code>current_period_end</code>, <code>cancel_at_period_end</code>, <code>created_at</code>, <code>updated_at</code>.</li>
                    </ul>
                    <p>El campo <code>transaction_id</code> en `TransactionsModel` y el `id` en `SubscriptionsModel` son claves primarias autoincrementales gestionadas por MySQL.</p>

                    <h5>Enums (Enumerations)</h5>
                    <p>Los Enums se utilizan para definir un conjunto de constantes con nombre, mejorando la legibilidad del código y evitando errores por "magic strings" o números. Facilitan el tipado y la claridad al representar estados o tipos específicos.</p>
                    <ul>
                        <li><strong><code>StripeEventTypeEnum.php</code>:</strong> Define los tipos de eventos de webhook de Stripe que la aplicación maneja o reconoce (ej. <code>CHECKOUT_SESSION_COMPLETED</code>, <code>INVOICE_PAID</code>).</li>
                        <li><strong><code>TransactionTypeEnum.php</code>:</strong> Especifica el tipo de transacción (ej. <code>SINGLE_PAYMENT</code>, <code>SUBSCRIPTION_PAYMENT</code>).</li>
                        <li><strong><code>SubscriptionStatusEnum.php</code>:</strong> Define los posibles estados de una suscripción (ej. <code>ACTIVE</code>, <code>CANCELED</code>, <code>PAST_DUE</code>, <code>INCOMPLETE</code>).</li>
                        <li><strong><code>InvoiceStatusEnum.php</code>:</strong> Estados posibles para una factura (ej. <code>PAID</code>, <code>OPEN</code>, <code>VOID</code>, <code>DRAFT</code>).</li>
                        <li><strong><code>PaymentStatusEnum.php</code>:</strong> Estados de pago (ej. <code>SUCCEEDED</code>, <code>PENDING</code>, <code>FAILED</code>).</li>
                    </ul>

                    <h5>Excepciones Personalizadas</h5>
                    <p>Se utilizan excepciones personalizadas para manejar errores específicos de la aplicación de una manera más granular y significativa que las excepciones genéricas. Esto facilita la depuración y permite implementar lógicas de manejo de errores más específicas.</p>
                    <ul>
                        <li><strong><code>ConfigurationException.php</code>:</strong> Se lanza cuando hay un problema con la configuración de la aplicación (ej. una variable de entorno requerida falta).</li>
                        <li><strong><code>DatabaseException.php</code>:</strong> Se lanza para errores relacionados con operaciones de base de datos (ej. fallo en la conexión, error en una consulta).</li>
                        <li><strong><code>InvalidWebhookPayloadException.php</code>:</strong> Se lanza si el payload de un webhook recibido es inválido, malformado o no se puede parsear.</li>
                        <li><strong><code>WebhookProcessingException.php</code>:</strong> Una excepción más general para errores que ocurren durante el procesamiento de un webhook por una estrategia específica.</li>
                        <li><strong><code>InvalidArgumentException.php</code>:</strong> (Más genérica) Para argumentos inválidos pasados a funciones o métodos.</li>
                    </ul>
                    <p>Además de estas, la aplicación también maneja excepciones específicas lanzadas por la biblioteca <code>stripe/stripe-php</code> (ej. <code>\Stripe\Exception\ApiErrorException</code>, <code>\Stripe\Exception\SignatureVerificationException</code>).</p>

                    <h5>Loggers</h5>
                    <p>StripeLabApp utiliza un sistema de logging para registrar información importante, errores y eventos. Cada logger tiene un propósito específico y escribe en su propio archivo de log (o según la configuración).</p>
                    <ul>
                        <li><strong><code>EventLogger.php</code>:</strong> Registra información sobre eventos de negocio significativos dentro de la aplicación (ej. "Suscripción creada con ID X", "Pago procesado para factura Y").</li>
                        <li><strong><code>ErrorLogger.php</code>:</strong> Registra todas las excepciones capturadas y errores inesperados que ocurren en la aplicación, incluyendo stack traces.</li>
                        <li><strong><code>DatabaseLogger.php</code>:</strong> Registra consultas SQL ejecutadas (opcional, útil para depuración) y errores específicos de la base de datos.</li>
                        <li><strong><code>StripePayloadLogger.php</code>:</strong> Registra el payload JSON completo de cada webhook de Stripe recibido. Esto es invaluable para depurar problemas con webhooks.</li>
                        <li><strong><code>UnhandledStripeEventLogger.php</code>:</strong> Registra información sobre eventos de webhook de Stripe que fueron recibidos pero para los cuales no existe una estrategia de manejo definida (utiliza `UnhandledEventStrategy`).</li>
                    </ul>
                    <p>La <code>LoggerFactory</code> es responsable de crear instancias de estos loggers.</p>
                </section>

                <section id="parte2-seccion7-3" class="mb-4">
                    <h4 id="parte2-seccion7-3-title">7.3. Capa de Configuración (`config/`)</h4>
                    <p>El directorio <code>config/</code> contiene los scripts responsables de la inicialización y configuración global de la aplicación.</p>

                    <h5>Rol de `Bootstrap.php`</h5>
                    <p><code>Bootstrap.php</code> es el corazón de la configuración de la aplicación. Realiza las siguientes tareas clave:</p>
                    <ul>
                        <li><strong>Carga del Entorno:</strong> Utiliza la biblioteca `vlucas/phpdotenv` para cargar las variables de entorno desde el archivo <code>.env</code> a <code>$_ENV</code> y <code>$_SERVER</code>.</li>
                        <li><strong>Definición de Constantes:</strong> Define constantes globales necesarias para la aplicación, como las claves API de Stripe, los IDs de precios, las credenciales de la base de datos, y la URL base de la aplicación, obteniéndolas de las variables de entorno.</li>
                        <li><strong>Inicialización de Loggers:</strong> A través de <code>LoggerFactory</code>, inicializa los diferentes loggers que se utilizarán en toda la aplicación.</li>
                        <li><strong>Service Locator / Inyección de Dependencias Simple:</strong> Actúa como un contenedor de dependencias muy simple o un Service Locator. Proporciona métodos para obtener instancias de las clases principales (Controladores, Servicios, Repositorios, Mappers, Factories). Implementa un patrón de instanciación perezosa (lazy instantiation), creando los objetos solo cuando se solicitan por primera vez y reutilizando la misma instancia en solicitudes subsecuentes dentro del mismo ciclo de vida de la petición. Esto ayuda a gestionar las dependencias de manera centralizada.</li>
                    </ul>
                    <p>Es el primer archivo que se incluye en los puntos de entrada de la aplicación (como <code>index.php</code> o <code>webhook.php</code>) para asegurar que toda la configuración y las dependencias necesarias estén disponibles.</p>

                    <h5>`DatabaseConnection.php`</h5>
                    <p>Esta clase es responsable de gestionar la conexión a la base de datos MySQL.</p>
                    <ul>
                        <li><strong>Conexión PDO:</strong> Establece una conexión PDO (PHP Data Objects) a la base de datos utilizando las credenciales definidas en las constantes (cargadas por <code>Bootstrap.php</code> desde el <code>.env</code>).</li>
                        <li><strong>Patrón Singleton:</strong> Implementa el patrón Singleton para asegurar que solo exista una instancia de la conexión PDO en toda la aplicación durante un ciclo de petición. El método estático `getInstance()` devuelve la conexión activa o crea una nueva si no existe.</li>
                        <li><strong>Configuración de PDO:</strong> Configura atributos de PDO, como el modo de error para lanzar excepciones (<code>PDO::ERRMODE_EXCEPTION</code>) y el modo de obtención predeterminado (<code>PDO::FETCH_ASSOC</code>).</li>
                    </ul>
                    <p>Los Repositorios utilizan esta clase para obtener la instancia de PDO y realizar consultas a la base de datos.</p>
                </section>

                <section id="parte2-seccion7-4" class="mb-4">
                    <h4 id="parte2-seccion7-4-title">7.4. Capa de Presentación y Puntos de Entrada (`public/`)</h4>
                    <p>El directorio <code>public/</code> es la raíz web de la aplicación y contiene todos los scripts y assets accesibles directamente por el navegador o por los webhooks de Stripe.</p>

                    <h5>Vistas y Flujos de Usuario:</h5>
                    <ul>
                        <li><strong><code>index.php</code>:</strong> Página principal de la aplicación, generalmente presenta las opciones para iniciar un pago único o una suscripción.</li>
                        <li><strong><code>single-payment.php</code>:</strong> Página que presenta el producto de demostración para pago único y un botón para "Pagar ahora", que iniciará el flujo de Stripe Checkout.</li>
                        <li><strong><code>subscriptions-payment.php</code>:</strong> Página que presenta los planes de suscripción de demostración (mensual/anual) y botones para "Suscribirse", que iniciarán el flujo de Stripe Checkout para suscripciones.</li>
                        <li><strong><code>success.html</code> y <code>cancel.html</code>:</strong> Páginas estáticas a las que Stripe redirige al usuario después de una sesión de Checkout (exitosa o cancelada).</li>
                        <li><strong><code>invoices.php</code>:</strong> Vista que consume el endpoint <code>api-invoices.php</code> para mostrar una lista de las facturas/transacciones del usuario (simulado) recuperadas de la base de datos local.</li>
                        <li><strong><code>view-subscriptions.php</code>:</strong> Vista que consume el endpoint <code>api-subscriptions.php</code> para mostrar las suscripciones activas o pasadas del usuario (simulado) desde la base de datos local, y ofrece opciones para gestionarlas (ej. cancelar).</li>
                    </ul>

                    <h5>Endpoints de API y Lógica de Backend:</h5>
                    <p>Estos scripts PHP manejan la lógica del lado del servidor y las interacciones con Stripe.</p>
                    <h6>Directorio `public/v1/`:</h6>
                    <ul>
                        <li><strong><code>create_payment_session.php</code>:</strong> Endpoint llamado por el frontend (ej. desde <code>single-payment.php</code>) cuando un usuario quiere hacer un pago único. Interactúa con <code>StripeCheckoutSessionService</code> para crear una sesión de Stripe Checkout en modo <code>payment</code> y devuelve el ID de la sesión al frontend para la redirección.</li>
                        <li><strong><code>create_subscription_session.php</code>:</strong> Endpoint llamado por el frontend (ej. desde <code>subscriptions-payment.php</code>) para iniciar una nueva suscripción. Interactúa con <code>StripeCheckoutSessionService</code> para crear una sesión de Stripe Checkout en modo <code>subscription</code> y devuelve el ID de la sesión al frontend.</li>
                        <li><strong><code>webhook.php</code>:</strong> Es el punto de entrada crucial para todos los webhooks enviados por Stripe.
                            <ol>
                                <li>Recibe la solicitud POST de Stripe.</li>
                                <li>Utiliza <code>StripeWebhookController</code> para manejar la lógica.</li>
                                <li>El controlador primero verifica la firma del webhook utilizando el <code>STRIPE_WEBHOOK_SECRET</code>.</li>
                                <li>Si la firma es válida, parsea el payload JSON en un objeto <code>\Stripe\Event</code> y luego en un <code>StripeEventDTO</code>.</li>
                                <li>Utiliza <code>EventStrategyFactory</code> para obtener la estrategia de manejo apropiada para el tipo de evento recibido.</li>
                                <li>Ejecuta la estrategia, que contiene la lógica de negocio específica para ese evento (ej. actualizar la base de datos, enviar correos electrónicos, etc.).</li>
                                <li>Devuelve una respuesta HTTP 200 a Stripe si el evento se recibe y se reconoce (incluso si el procesamiento posterior se delega o falla internamente, aunque los errores críticos en la validación o construcción del evento pueden devolver un error).</li>
                            </ol>
                        </li>
                    </ul>
                    <h6>Directorio `public/v1/api/`:</h6>
                    <p>Estos endpoints son consumidos por el frontend (generalmente mediante JavaScript `fetch` o AJAX) para obtener datos o realizar acciones.</p>
                    <ul>
                        <li><strong><code>api-invoices.php</code>:</strong> Endpoint que, a través de <code>InvoiceService</code>, recupera la lista de facturas/transacciones (de la base de datos local) para un cliente simulado y las devuelve en formato JSON.</li>
                        <li><strong><code>api-subscriptions.php</code>:</strong> Endpoint que, utilizando <code>SubscriptionService</code>, recupera la lista de suscripciones (de la base de datos local) para un cliente simulado y las devuelve en formato JSON.</li>
                        <li><strong><code>api-manage-subscription.php</code>:</strong> Endpoint que maneja acciones de gestión de suscripciones, como la cancelación o reactivación. Recibe el ID de la suscripción y la acción deseada. Utiliza <code>StripeSubscriptionManagementController</code> (y a su vez <code>StripeSubscriptionManagementService</code>) para interactuar con la API de Stripe y actualizar el estado de la suscripción.</li>
                    </ul>
                </section>
                <!-- Continuará con más subsecciones de 7... -->
            </section> <!-- Fin de PARTE II -->
            <section id="parte2-seccion7-5" class="mb-4">
                <h4 id="parte2-seccion7-5-title">7.5. Controladores (`src/Controller/`)</h4>
                <p>Los controladores son la primera capa de lógica de la aplicación que maneja las solicitudes HTTP entrantes, ya sea desde el frontend, desde APIs o desde los webhooks de Stripe. Su principal responsabilidad es validar la solicitud (si es necesario), delegar el trabajo pesado a los servicios o estrategias apropiadas, y luego formatear y devolver una respuesta HTTP.</p>
                <ul>
                    <li>
                        <strong><code>StripeWebhookController.php</code>:</strong>
                        <ul>
                            <li><strong>Rol:</strong> Punto central para el manejo de todos los webhooks entrantes de Stripe. Es invocado por el script <code>public/v1/webhook.php</code>.</li>
                            <li><strong>Lógica Principal:</strong>
                                <ol>
                                    <li>Recibe la solicitud HTTP (payload crudo y cabeceras).</li>
                                    <li>Delega la validación de la firma del webhook y la construcción del objeto Evento de Stripe al <code>StripeWebhookService</code>.</li>
                                    <li>Una vez que el <code>StripeWebhookService</code> ha identificado y procesado el evento a través de la estrategia correspondiente, el controlador se encarga de devolver la respuesta HTTP adecuada a Stripe.</li>
                                    <li>Generalmente, devuelve un código <code>200 OK</code> para acusar recibo del webhook si la firma es válida y el tipo de evento es reconocido, incluso si el procesamiento interno posterior falla (esos fallos se registran).</li>
                                    <li>Devuelve códigos de error HTTP (<code>400</code>, <code>401</code>, <code>500</code>) si hay problemas con la firma, el payload es inválido, o ocurre un error crítico irrecuperable durante la validación inicial.</li>
                                </ol>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <strong><code>StripeSubscriptionManagementController.php</code>:</strong> (Asumo que este sería el controlador para `api-manage-subscription.php`, si no, el nombre puede variar)
                        <ul>
                            <li><strong>Rol:</strong> Maneja las solicitudes del frontend para gestionar suscripciones, como cancelarlas o reactivarlas. Es invocado por endpoints como <code>public/v1/api/api-manage-subscription.php</code>.</li>
                            <li><strong>Lógica Principal:</strong>
                                <ol>
                                    <li>Recibe parámetros de la solicitud (ej. ID de la suscripción, acción a realizar).</li>
                                    <li>Valida los parámetros de entrada.</li>
                                    <li>Utiliza <code>StripeSubscriptionManagementService</code> para interactuar con la API de Stripe y realizar la acción solicitada (ej. cancelar una suscripción).</li>
                                    <li>Devuelve una respuesta JSON al frontend indicando el resultado de la operación (éxito o error).</li>
                                </ol>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <strong>Controladores Implícitos para Vistas (<code>StripeInvoiceController</code>, <code>StripeSubscriptionController</code>):</strong> Aunque no existan como clases separadas con estos nombres exactos, la lógica para obtener y mostrar datos en `invoices.php` y `view-subscriptions.php` actúa de manera similar a un controlador. Estos scripts:
                        <ul>
                            <li><strong>Rol:</strong> Manejan las solicitudes del frontend (a menudo a través de AJAX a los endpoints <code>api-*.php</code>) para obtener datos de facturas o suscripciones.</li>
                            <li><strong>Lógica Principal:</strong>
                                <ol>
                                    <li>Los endpoints <code>api-invoices.php</code> y <code>api-subscriptions.php</code> reciben la solicitud.</li>
                                    <li>Utilizan los servicios correspondientes (<code>InvoiceService</code>, <code>SubscriptionService</code>) y, a su vez, los repositorios (<code>InvoiceRepository</code>, <code>SubscriptionRepository</code>) para obtener los datos de la base de datos.</li>
                                    <li>Formatean los datos recuperados (generalmente DTOs) en una estructura JSON adecuada para la respuesta.</li>
                                    <li>Devuelven la respuesta JSON al frontend, que luego la renderiza en la página.</li>
                                </ol>
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section id="parte2-seccion7-6" class="mb-4">
                <h4 id="parte2-seccion7-6-title">7.6. Servicios (`src/Service/`)</h4>
                <p>Los servicios encapsulan la lógica de negocio y orquestan las interacciones entre diferentes componentes, como controladores, repositorios, mappers, factories y la API de Stripe. Mantienen a los controladores delgados y enfocados en la E/S HTTP.</p>
                <ul>
                    <li>
                        <strong><code>StripeWebhookService.php</code>:</strong>
                        <ul>
                            <li><strong>Rol:</strong> Orquesta la validación del payload del webhook, la construcción del objeto Evento de Stripe, la selección de la estrategia de manejo apropiada y la ejecución de dicha estrategia.</li>
                            <li><strong>Lógica Principal:</strong>
                                <ol>
                                    <li>Recibe el payload crudo y la firma del webhook desde el <code>StripeWebhookController</code>.</li>
                                    <li>Utiliza <code>\Stripe\Webhook::constructEvent()</code> con el secreto de webhook para verificar la firma y parsear el payload en un objeto <code>\Stripe\Event</code>. Si falla, lanza <code>\Stripe\Exception\SignatureVerificationException</code> o <code>InvalidWebhookPayloadException</code>.</li>
                                    <li>Utiliza <code>StripeEventMapper</code> para transformar el objeto <code>\Stripe\Event</code> en un <code>StripeEventDTO</code>.</li>
                                    <li>Utiliza <code>EventStrategyFactory</code> para obtener la instancia de la estrategia correcta basándose en el <code>type</code> del evento del DTO.</li>
                                    <li>Ejecuta el método <code>handle()</code> de la estrategia seleccionada, pasándole el <code>StripeEventDTO</code>.</li>
                                    <li>Captura cualquier excepción lanzada por la estrategia (ej. <code>WebhookProcessingException</code>, <code>DatabaseException</code>) y las registra apropiadamente usando los loggers. No relanza estas excepciones al controlador para asegurar que se envíe una respuesta 200 a Stripe si el evento fue inicialmente válido.</li>
                                </ol>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <strong><code>StripeCheckoutSessionService.php</code>:</strong>
                        <ul>
                            <li><strong>Rol:</strong> Responsable de interactuar con la API de Stripe para crear sesiones de Stripe Checkout, tanto para pagos únicos como para suscripciones.</li>
                            <li><strong>Lógica Principal:</strong>
                                <ol>
                                    <li>Recibe los parámetros necesarios para la sesión de Checkout (ej. ID del precio, modo - `payment` o `subscription`, URLs de éxito y cancelación).</li>
                                    <li>Construye el array de parámetros para la llamada a la API <code>\Stripe\Checkout\Session::create()</code>.</li>
                                    <li>Realiza la llamada a la API de Stripe.</li>
                                    <li>Maneja posibles excepciones de la API de Stripe (ej. <code>\Stripe\Exception\ApiErrorException</code>).</li>
                                    <li>Devuelve el objeto <code>\Stripe\Checkout\Session</code> creado (o su ID) al script del punto de entrada (ej. <code>create_payment_session.php</code>).</li>
                                </ol>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <strong><code>StripeSubscriptionManagementService.php</code>:</strong>
                        <ul>
                            <li><strong>Rol:</strong> Maneja operaciones de gestión de suscripciones que requieren interacción directa con la API de Stripe, como cancelar o reactivar una suscripción.</li>
                            <li><strong>Lógica Principal:</strong>
                                <ol>
                                    <li><strong>Cancelación:</strong> Recibe un ID de suscripción y un booleano indicando si la cancelación debe ser inmediata o al final del período. Llama a <code>\Stripe\Subscription::update()</code> (para <code>cancel_at_period_end = true</code>) o <code>\Stripe\Subscription::cancel()</code> (para cancelación inmediata).</li>
                                    <li><strong>Reactivación:</strong> Recibe un ID de suscripción (que estaba configurada para cancelarse al final del período). Llama a <code>\Stripe\Subscription::update()</code> con <code>cancel_at_period_end = false</code>.</li>
                                    <li>Maneja excepciones de la API de Stripe.</li>
                                    <li>Devuelve el objeto de suscripción actualizado o un indicador de éxito/fracaso.</li>
                                </ol>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <strong><code>InvoiceService.php</code> y <code>SubscriptionService.php</code>:</strong>
                        <ul>
                            <li><strong>Rol:</strong> Proporcionan una capa de abstracción para acceder a los datos de facturas y suscripciones almacenados localmente. Son utilizados principalmente por los endpoints API para la visualización de datos.</li>
                            <li><strong>Lógica Principal:</strong>
                                <ol>
                                    <li>Utilizan sus respectivos repositorios (<code>InvoiceRepository</code>, <code>SubscriptionRepository</code>) para obtener datos de la base de datos.</li>
                                    <li>Pueden incluir lógica para formatear los datos (ej. convertir entidades de la BD en DTOs si es necesario, aunque esto podría ser también responsabilidad del controlador/endpoint API).</li>
                                    <li>Implementan métodos para listar todas las facturas/suscripciones o filtrarlas (ej. por ID de cliente simulado).</li>
                                </ol>
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section id="parte2-seccion7-7" class="mb-4">
                <h4 id="parte2-seccion7-7-title">7.7. Estrategias (`src/Strategy/`)</h4>
                <p>StripeLabApp utiliza el <strong>Patrón Strategy</strong> para manejar los diferentes tipos de eventos de webhook de Stripe. Este patrón permite definir una familia de algoritmos (en este caso, la lógica para procesar cada tipo de evento), encapsular cada uno en una clase separada (la Estrategia), y hacerlos intercambiables. El <code>StripeWebhookService</code>, junto con <code>EventStrategyFactory</code>, selecciona y ejecuta la estrategia apropiada en tiempo de ejecución basándose en el tipo de evento recibido.</p>
                <p>Todas las estrategias implementan la interfaz <code>StripeEventStrategyInterface</code>, que define un método <code>handle(StripeEventDTO $eventDto): void</code>.</p>

                <h5>Detalle de Estrategias Implementadas:</h5>
                <div class="accordion" id="strategiesAccordion">

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingCheckoutSessionCompleted">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCheckoutSessionCompleted" aria-expanded="false" aria-controls="collapseCheckoutSessionCompleted">
                                <code>CheckoutSessionCompletedStrategyImpl</code>
                            </button>
                        </h2>
                        <div id="collapseCheckoutSessionCompleted" class="accordion-collapse collapse" aria-labelledby="headingCheckoutSessionCompleted" data-bs-parent="#strategiesAccordion">
                            <div class="accordion-body">
                                <p><strong>Clase:</strong> <code>CheckoutSessionCompletedStrategyImpl.php</code></p>
                                <p><strong>Evento de Stripe que maneja:</strong> <code>checkout.session.completed</code></p>
                                <p><strong>Dependencias Principales:</strong> <code>SubscriptionRepository</code>, <code>TransactionRepository</code>, <code>StripeEventMapper</code>, <code>SubscriptionMapper</code>, <code>InvoiceMapper</code>, <code>SubscriptionFactory</code>, <code>TransactionFactory</code>, Loggers.</p>
                                <p><strong>Resumen de Lógica Principal:</strong></p>
                                <ul>
                                    <li>Este evento es crucial ya que confirma que el usuario ha completado el flujo de Stripe Checkout.</li>
                                    <li><strong>Si el modo es <code>subscription</code>:</strong>
                                        <ul>
                                            <li>Extrae el <code>subscription_id</code> y <code>customer_id</code> del objeto Checkout Session.</li>
                                            <li>Verifica si la suscripción ya existe en la base de datos local por su <code>stripe_subscription_id</code>.</li>
                                            <li>Si no existe, y los datos necesarios están presentes, crea una nueva entidad <code>SubscriptionsModel</code> (usando Mapper y Factory) con un estado inicial (ej. `incomplete` o `active` dependiendo de otros eventos) y la guarda usando <code>SubscriptionRepository</code>. La idea es registrar la intención de suscripción. El estado final se actualizará con eventos posteriores como `customer.subscription.created` o `invoice.paid`.</li>
                                            <li>Registra la finalización de la sesión.</li>
                                        </ul>
                                    </li>
                                    <li><strong>Si el modo es <code>payment</code>:</strong>
                                        <ul>
                                            <li>Extrae el <code>payment_intent_id</code> y <code>customer_id</code> (si existe) del objeto Checkout Session.</li>
                                            <li>A menudo, para pagos únicos, la lógica principal de creación de la transacción se maneja en la estrategia <code>PaymentIntentSucceededStrategyImpl</code>, ya que <code>checkout.session.completed</code> ocurre antes y el PaymentIntent puede aún no estar <code>succeeded</code>.</li>
                                            <li>Esta estrategia podría registrar que la sesión se completó o preparar alguna entidad de pedido pendiente si la aplicación tuviera un concepto de pedidos antes del pago. En StripeLabApp, se enfoca más en suscripciones o delega a <code>PaymentIntentSucceededStrategyImpl</code>.</li>
                                        </ul>
                                    </li>
                                    <li>Registra un evento en <code>EventLogger</code>.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingCustomerCreatedOrUpdated">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCustomerCreatedOrUpdated" aria-expanded="false" aria-controls="collapseCustomerCreatedOrUpdated">
                                <code>CustomerCreatedOrUpdatedStrategyImpl</code>
                            </button>
                        </h2>
                        <div id="collapseCustomerCreatedOrUpdated" class="accordion-collapse collapse" aria-labelledby="headingCustomerCreatedOrUpdated" data-bs-parent="#strategiesAccordion">
                            <div class="accordion-body">
                                <p><strong>Clase:</strong> <code>CustomerCreatedOrUpdatedStrategyImpl.php</code></p>
                                <p><strong>Evento(s) de Stripe que maneja:</strong> <code>customer.created</code>, <code>customer.updated</code></p>
                                <p><strong>Dependencias Principales:</strong> (Potencialmente un <code>CustomerRepository</code> si se almacenaran clientes detalladamente, Mappers, Factories, Loggers).</p>
                                <p><strong>Resumen de Lógica Principal:</strong></p>
                                <ul>
                                    <li>StripeLabApp no almacena una entidad `Customer` separada en su base de datos, ya que el `stripe_customer_id` se guarda en las tablas de suscripciones y transacciones.</li>
                                    <li>Por lo tanto, esta estrategia principalmente:
                                        <ul>
                                            <li>Registra la ocurrencia del evento (<code>customer.created</code> o <code>customer.updated</code>) usando <code>EventLogger</code>.</li>
                                            <li>Extrae el ID del cliente y su email del payload del evento para propósitos de logging.</li>
                                            <li>No realiza operaciones de escritura en la base de datos en el contexto actual de StripeLabApp. En una aplicación más compleja, aquí se crearía o actualizaría el registro del cliente en la BD.</li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingPaymentIntentSucceeded">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePaymentIntentSucceeded" aria-expanded="false" aria-controls="collapsePaymentIntentSucceeded">
                                <code>PaymentIntentSucceededStrategyImpl</code>
                            </button>
                        </h2>
                        <div id="collapsePaymentIntentSucceeded" class="accordion-collapse collapse" aria-labelledby="headingPaymentIntentSucceeded" data-bs-parent="#strategiesAccordion">
                            <div class="accordion-body">
                                <p><strong>Clase:</strong> <code>PaymentIntentSucceededStrategyImpl.php</code></p>
                                <p><strong>Evento de Stripe que maneja:</strong> <code>payment_intent.succeeded</code></p>
                                <p><strong>Dependencias Principales:</strong> <code>TransactionRepository</code>, <code>InvoiceRepository</code> (para obtener el `invoice_id` de Stripe), <code>TransactionFactory</code>, <code>StripeEventMapper</code>, Loggers.</p>
                                <p><strong>Resumen de Lógica Principal:</strong></p>
                                <ul>
                                    <li>Este evento confirma que un pago ha sido exitoso.</li>
                                    <li>Extrae los detalles del PaymentIntent (ID, monto, moneda, ID de cliente, metadatos, ID del cargo).</li>
                                    <li><strong>Heurística para evitar duplicados y determinar el tipo de transacción:</strong>
                                        <ul>
                                            <li>Intenta obtener el <code>invoice_id</code> del PaymentIntent si está presente (generalmente para pagos de facturas de suscripción).</li>
                                            <li>Si hay un <code>invoice_id</code>, y ya existe una transacción en la BD para ese <code>stripe_transaction_id</code> (que sería el <code>payment_intent_id</code>), asume que ya fue procesada (posiblemente por <code>InvoicePaidStrategyImpl</code>) y solo registra el evento.</li>
                                            <li>Si no existe transacción o no hay <code>invoice_id</code> (pago único), verifica si ya existe una transacción con el mismo <code>stripe_transaction_id</code> (<code>payment_intent_id</code>). Si no, procede a crearla.</li>
                                        </ul>
                                    </li>
                                    <li>Crea una entidad <code>TransactionsModel</code>:
                                        <ul>
                                            <li>Tipo de transacción: <code>SINGLE_PAYMENT</code> si no hay factura asociada, o <code>SUBSCRIPTION_PAYMENT</code> si hay una factura.</li>
                                            <li>Estado: <code>PaymentStatusEnum::SUCCEEDED</code>.</li>
                                        </ul>
                                    </li>
                                    <li>Guarda la transacción usando <code>TransactionRepository</code>.</li>
                                    <li>Registra un evento en <code>EventLogger</code>.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingChargeSucceeded">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseChargeSucceeded" aria-expanded="false" aria-controls="collapseChargeSucceeded">
                                <code>ChargeSucceededStrategyImpl</code>
                            </button>
                        </h2>
                        <div id="collapseChargeSucceeded" class="accordion-collapse collapse" aria-labelledby="headingChargeSucceeded" data-bs-parent="#strategiesAccordion">
                            <div class="accordion-body">
                                <p><strong>Clase:</strong> <code>ChargeSucceededStrategyImpl.php</code></p>
                                <p><strong>Evento de Stripe que maneja:</strong> <code>charge.succeeded</code></p>
                                <p><strong>Dependencias Principales:</strong> <code>TransactionRepository</code>, <code>TransactionFactory</code>, <code>StripeEventMapper</code>, Loggers.</p>
                                <p><strong>Resumen de Lógica Principal:</strong></p>
                                <ul>
                                    <li>Aunque <code>payment_intent.succeeded</code> es a menudo el evento principal, <code>charge.succeeded</code> proporciona detalles del cargo específico, incluyendo la `receipt_url`.</li>
                                    <li>Extrae el <code>payment_intent_id</code> del objeto Charge.</li>
                                    <li>Busca una transacción existente en la BD usando el <code>payment_intent_id</code> (asumiendo que <code>PaymentIntentSucceededStrategyImpl</code> ya la creó o la creará).</li>
                                    <li>Si la transacción existe y no tiene una <code>receipt_url</code>, la actualiza con la URL del recibo del objeto Charge.</li>
                                    <li>Si la transacción no existe aún (lo cual sería menos común si se procesa <code>payment_intent.succeeded</code> primero), podría crearla, pero StripeLabApp tiende a priorizar el PaymentIntent para la creación de la transacción.</li>
                                    <li>Registra el evento y la actualización de la URL del recibo.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingSubscriptionCreated">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSubscriptionCreated" aria-expanded="false" aria-controls="collapseSubscriptionCreated">
                                <code>SubscriptionCreatedStrategyImpl</code>
                            </button>
                        </h2>
                        <div id="collapseSubscriptionCreated" class="accordion-collapse collapse" aria-labelledby="headingSubscriptionCreated" data-bs-parent="#strategiesAccordion">
                            <div class="accordion-body">
                                <p><strong>Clase:</strong> <code>SubscriptionCreatedStrategyImpl.php</code></p>
                                <p><strong>Evento de Stripe que maneja:</strong> <code>customer.subscription.created</code></p>
                                <p><strong>Dependencias Principales:</strong> <code>SubscriptionRepository</code>, <code>SubscriptionMapper</code>, <code>SubscriptionFactory</code>, Loggers.</p>
                                <p><strong>Resumen de Lógica Principal:</strong></p>
                                <ul>
                                    <li>Se dispara cuando la entidad de suscripción se crea en Stripe.</li>
                                    <li>Extrae los detalles de la suscripción del payload del evento.</li>
                                    <li>Verifica si la suscripción ya existe en la base de datos local usando <code>stripe_subscription_id</code>.</li>
                                    <li>Si no existe:
                                        <ul>
                                            <li>Usa <code>SubscriptionMapper</code> para convertir los datos del evento en un <code>SubscriptionDTO</code>.</li>
                                            <li>Usa <code>SubscriptionFactory</code> para crear una entidad <code>SubscriptionsModel</code> a partir del DTO.</li>
                                            <li>Guarda la nueva entidad de suscripción en la base de datos usando <code>SubscriptionRepository</code>. El estado inicial de la suscripción (`status` en el objeto de Stripe) se refleja en la entidad guardada (ej. `active`, `trialing`, `incomplete`).</li>
                                        </ul>
                                    </li>
                                    <li>Si ya existe (quizás creada por <code>CheckoutSessionCompletedStrategyImpl</code>), actualiza sus detalles (especialmente el estado) con la información más reciente del evento de suscripción.</li>
                                    <li>Registra la creación o actualización de la suscripción.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingSubscriptionUpdated">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSubscriptionUpdated" aria-expanded="false" aria-controls="collapseSubscriptionUpdated">
                                <code>SubscriptionUpdatedStrategyImpl</code>
                            </button>
                        </h2>
                        <div id="collapseSubscriptionUpdated" class="accordion-collapse collapse" aria-labelledby="headingSubscriptionUpdated" data-bs-parent="#strategiesAccordion">
                            <div class="accordion-body">
                                <p><strong>Clase:</strong> <code>SubscriptionUpdatedStrategyImpl.php</code></p>
                                <p><strong>Evento de Stripe que maneja:</strong> <code>customer.subscription.updated</code></p>
                                <p><strong>Dependencias Principales:</strong> <code>SubscriptionRepository</code>, <code>SubscriptionMapper</code>, <code>SubscriptionFactory</code>, Loggers.</p>
                                <p><strong>Resumen de Lógica Principal:</strong></p>
                                <ul>
                                    <li>Maneja cualquier cambio en una suscripción existente (cambio de plan, estado, <code>cancel_at_period_end</code>, etc.).</li>
                                    <li>Extrae los detalles actualizados de la suscripción.</li>
                                    <li>Busca la suscripción en la base de datos local por su <code>stripe_subscription_id</code>.</li>
                                    <li>Si la encuentra:
                                        <ul>
                                            <li>Usa <code>SubscriptionMapper</code> y <code>SubscriptionFactory</code> para crear una entidad <code>SubscriptionsModel</code> actualizada.</li>
                                            <li>Actualiza el registro existente en la base de datos con los nuevos detalles (especialmente el <code>status</code>, <code>current_period_end</code>, <code>cancel_at_period_end</code>, <code>plan_id</code>, etc.) usando <code>SubscriptionRepository</code>.</li>
                                        </ul>
                                    </li>
                                    <li>Si no la encuentra (poco probable si los flujos de creación funcionan bien), podría registrar un error o intentar crearla si tiene suficiente información.</li>
                                    <li>Registra los cambios detectados en la suscripción.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingSubscriptionDeleted">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSubscriptionDeleted" aria-expanded="false" aria-controls="collapseSubscriptionDeleted">
                                <code>SubscriptionDeletedStrategyImpl</code>
                            </button>
                        </h2>
                        <div id="collapseSubscriptionDeleted" class="accordion-collapse collapse" aria-labelledby="headingSubscriptionDeleted" data-bs-parent="#strategiesAccordion">
                            <div class="accordion-body">
                                <p><strong>Clase:</strong> <code>SubscriptionDeletedStrategyImpl.php</code></p>
                                <p><strong>Evento de Stripe que maneja:</strong> <code>customer.subscription.deleted</code></p>
                                <p><strong>Dependencias Principales:</strong> <code>SubscriptionRepository</code>, Loggers.</p>
                                <p><strong>Resumen de Lógica Principal:</strong></p>
                                <ul>
                                    <li>Se dispara cuando una suscripción es cancelada (ya sea inmediatamente o al final del período si <code>cancel_at_period_end</code> era true y el período concluyó).</li>
                                    <li>Extrae el <code>stripe_subscription_id</code> del evento.</li>
                                    <li>Busca la suscripción en la base de datos local.</li>
                                    <li>Si la encuentra, actualiza su estado a <code>SubscriptionStatusEnum::CANCELED</code> (o un estado similar) y posiblemente registra la fecha de finalización (<code>ended_at</code> del payload de Stripe) usando <code>SubscriptionRepository</code>.</li>
                                    <li>No elimina el registro de la base de datos, sino que marca la suscripción como cancelada para mantener el historial.</li>
                                    <li>Registra la cancelación.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingInvoicePaid">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInvoicePaid" aria-expanded="false" aria-controls="collapseInvoicePaid">
                                <code>InvoicePaidStrategyImpl</code>
                            </button>
                        </h2>
                        <div id="collapseInvoicePaid" class="accordion-collapse collapse" aria-labelledby="headingInvoicePaid" data-bs-parent="#strategiesAccordion">
                            <div class="accordion-body">
                                <p><strong>Clase:</strong> <code>InvoicePaidStrategyImpl.php</code></p>
                                <p><strong>Evento de Stripe que maneja:</strong> <code>invoice.paid</code></p>
                                <p><strong>Dependencias Principales:</strong> <code>TransactionRepository</code>, <code>SubscriptionRepository</code>, <code>InvoiceMapper</code>, <code>TransactionFactory</code>, Loggers.</p>
                                <p><strong>Resumen de Lógica Principal:</strong></p>
                                <ul>
                                    <li>Se dispara cuando una factura (Invoice) se paga con éxito. Esto es crucial para las renovaciones de suscripciones.</li>
                                    <li>Extrae los detalles de la factura (ID, ID de cliente, ID de suscripción si existe, monto pagado, ID del PaymentIntent asociado).</li>
                                    <li>Verifica si ya existe una transacción en la BD para el <code>payment_intent_id</code> asociado a esta factura. Si ya existe (posiblemente creada por <code>PaymentIntentSucceededStrategyImpl</code>), evita duplicar la transacción principal.</li>
                                    <li>Si no existe la transacción:
                                        <ul>
                                            <li>Usa <code>InvoiceMapper</code> para convertir los datos de la factura en un <code>InvoiceDTO</code>.</li>
                                            <li>Usa <code>TransactionFactory</code> para crear una entidad <code>TransactionsModel</code>.
                                                <ul>
                                                    <li><code>stripe_transaction_id</code> será el <code>payment_intent_id</code> de la factura.</li>
                                                    <li><code>type</code> será <code>TransactionTypeEnum::SUBSCRIPTION_PAYMENT</code> (o podría inferirse si <code>billing_reason</code> es <code>subscription_cycle</code> o <code>subscription_create</code>).</li>
                                                    <li><code>status</code> será <code>PaymentStatusEnum::SUCCEEDED</code>.</li>
                                                </ul>
                                            </li>
                                            <li>Guarda la transacción usando <code>TransactionRepository</code>.</li>
                                        </ul>
                                    </li>
                                    <li>Si la factura está asociada a una suscripción (<code>subscription_id</code> está presente):
                                        <ul>
                                            <li>Busca la suscripción en la BD local.</li>
                                            <li>Actualiza el <code>current_period_start</code> y <code>current_period_end</code> de la suscripción local con los de la línea de ítem de la factura (o del objeto de suscripción dentro de la factura, si está disponible y es más preciso). Esto mantiene la ventana de servicio activa actualizada.</li>
                                            <li>Asegura que el estado de la suscripción sea <code>SubscriptionStatusEnum::ACTIVE</code>.</li>
                                            <li>Guarda los cambios en la suscripción usando <code>SubscriptionRepository</code>.</li>
                                        </ul>
                                    </li>
                                    <li>Registra el pago de la factura.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <!-- Añadir más accordion-items para otras estrategias como InvoicePaymentFailedStrategyImpl si es necesario -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingUnhandledEvent">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUnhandledEvent" aria-expanded="false" aria-controls="collapseUnhandledEvent">
                                <code>UnhandledEventStrategyImpl</code>
                            </button>
                        </h2>
                        <div id="collapseUnhandledEvent" class="accordion-collapse collapse" aria-labelledby="headingUnhandledEvent" data-bs-parent="#strategiesAccordion">
                            <div class="accordion-body">
                                <p><strong>Clase:</strong> <code>UnhandledEventStrategyImpl.php</code></p>
                                <p><strong>Evento(s) de Stripe que maneja:</strong> Cualquier evento para el cual no exista una estrategia específica registrada en <code>EventStrategyFactory</code>.</p>
                                <p><strong>Dependencias Principales:</strong> <code>UnhandledStripeEventLogger</code>.</p>
                                <p><strong>Resumen de Lógica Principal:</strong></p>
                                <ul>
                                    <li>Actúa como un "catch-all" o estrategia por defecto.</li>
                                    <li>Su única acción es registrar el evento recibido (tipo e ID) en el <code>UnhandledStripeEventLogger</code>.</li>
                                    <li>Esto ayuda a los desarrolladores a identificar si Stripe está enviando eventos que la aplicación no está configurada para manejar, lo que podría indicar la necesidad de implementar nuevas estrategias o ajustar la configuración del endpoint de webhook.</li>
                                    <li>No realiza ninguna otra operación de negocio ni interactúa con la base de datos.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="parte2-seccion7-8" class="mb-4">
                <h4 id="parte2-seccion7-8-title">7.8. Mappers (`src/Mappers/`)</h4>
                <p>Los Mappers en StripeLabApp tienen la responsabilidad principal de transformar datos de una estructura a otra, específicamente:
                <ul>
                    <li>Convertir los objetos de payload de eventos de Stripe (que son arrays asociativos complejos después de la decodificación JSON y la construcción del objeto <code>\Stripe\Event</code>) en Data Transfer Objects (DTOs) fuertemente tipados y más manejables dentro de la aplicación.</li>
                    <li>Extraer y normalizar datos de los objetos de Stripe, manejando la complejidad de sus estructuras anidadas y la posible ausencia de campos opcionales.</li>
                </ul>
                </p>
                <p>Por ejemplo:</p>
                <ul>
                    <li><strong><code>StripeEventMapper.php</code>:</strong> Toma un objeto <code>\Stripe\Event</code> y lo transforma en un <code>StripeEventDTO</code>, asegurando que los campos esenciales como <code>id</code>, <code>type</code>, y <code>data->object</code> estén presentes y accesibles.</li>
                    <li><strong><code>SubscriptionMapper.php</code>:</strong> Toma el objeto <code>data->object</code> de un evento de suscripción (que es un <code>\Stripe\Subscription</code>) y lo mapea a un <code>SubscriptionDTO</code>, extrayendo el ID de Stripe, ID de cliente, ID de precio, estado, fechas de período, etc. Maneja la conversión de timestamps de Stripe a objetos <code>DateTimeImmutable</code>.</li>
                    <li><strong><code>InvoiceMapper.php</code>:</strong> Similarmente, mapea un objeto <code>\Stripe\Invoice</code> a un <code>InvoiceDTO</code>.</li>
                </ul>
                <p>Los mappers ayudan a desacoplar la lógica de negocio de la estructura específica de los objetos de la API de Stripe, facilitando las pruebas y permitiendo que la aplicación evolucione incluso si la estructura de los objetos de Stripe cambia ligeramente (siempre que el mapper se actualice en consecuencia).</p>
            </section>

            <section id="parte2-seccion7-9" class="mb-4">
                <h4 id="parte2-seccion7-9-title">7.9. Factories (`src/Factories/`)</h4>
                <p>Las Factories en StripeLabApp se encargan de la creación de objetos complejos, principalmente las entidades de la base de datos (Models) a partir de los DTOs (que a su vez fueron creados por los Mappers a partir de los datos de Stripe).</p>
                <ul>
                    <li><strong>Rol Principal:</strong>
                        <ul>
                            <li>Construir instancias de <code>TransactionsModel</code> y <code>SubscriptionsModel</code>.</li>
                            <li>Encapsular la lógica de cómo se mapean los datos de un DTO a las propiedades de una entidad del modelo.</li>
                        </ul>
                    </li>
                    <li><strong>Manejo de Conversiones:</strong>
                        <ul>
                            <li>Realizan conversiones de tipo necesarias, por ejemplo:
                                <ul>
                                    <li>Convertir objetos <code>DateTimeImmutable</code> (de los DTOs) a strings formateados para timestamps de MySQL (ej. 'Y-m-d H:i:s').</li>
                                    <li>Convertir valores de Enums (de los DTOs o de la lógica de negocio) a sus representaciones de string o entero para la base de datos.</li>
                                    <li>Asegurar que los tipos de datos numéricos (como montos) se manejen correctamente.</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li><strong>Ejemplos:</strong>
                        <ul>
                            <li><code>TransactionFactory</code> tomaría un <code>InvoiceDTO</code> (o datos directos de un PaymentIntent) y crearía un objeto <code>TransactionsModel</code> listo para ser persistido.</li>
                            <li><code>SubscriptionFactory</code> tomaría un <code>SubscriptionDTO</code> y crearía un objeto <code>SubscriptionsModel</code>.</li>
                            <li><code>EventStrategyFactory.php</code> es un tipo diferente de factory, responsable de crear la instancia de la estrategia de manejo de webhook correcta basada en el tipo de evento de Stripe, como se mencionó en la sección de Servicios y Estrategias.</li>
                            <li><code>LoggerFactory.php</code> crea instancias de los diferentes loggers.</li>
                        </ul>
                    </li>
                </ul>
                <p>El uso de Factories ayuda a mantener la lógica de creación de objetos centralizada y separada de las estrategias o servicios que los utilizan, siguiendo el principio de Responsabilidad Única.</p>
            </section>

            <section id="parte2-seccion7-10" class="mb-4">
                <h4 id="parte2-seccion7-10-title">7.10. Repositories (`src/Repository/`)</h4>
                <p>Los Repositorios actúan como una capa de abstracción entre la lógica de negocio de la aplicación y la capa de persistencia de datos (la base de datos MySQL). Encapsulan toda la lógica para acceder y manipular los datos, utilizando PDO para las interacciones con la base de datos.</p>
                <ul>
                    <li><strong>Abstracción de la Persistencia:</strong> Los servicios y estrategias no interactúan directamente con PDO o SQL; en su lugar, llaman a métodos en los repositorios (ej. <code>saveSubscription(SubscriptionsModel $subscription)</code>, <code>findTransactionByStripeId(string $stripeId)</code>).</li>
                    <li><strong>Métodos CRUD y de Búsqueda:</strong>
                        <ul>
                            <li><strong><code>TransactionRepository.php</code>:</strong>
                                <ul>
                                    <li><code>save(TransactionsModel $transaction)</code>: Inserta una nueva transacción. Maneja el <code>transaction_id</code> autoincremental de la base de datos.</li>
                                    <li><code>update(TransactionsModel $transaction)</code>: Actualiza una transacción existente.</li>
                                    <li><code>findByStripeTransactionId(string $stripeTransactionId)</code>: Busca una transacción por su ID de Stripe (ej. <code>pi_...</code> o <code>ch_...</code>).</li>
                                    <li><code>findByInvoiceId(string $stripeInvoiceId)</code>: Busca transacciones asociadas a un ID de factura de Stripe.</li>
                                    <li><code>findAllByCustomerId(string $stripeCustomerId)</code>: Lista todas las transacciones de un cliente.</li>
                                    <li><code>findAll(int $limit, int $offset)</code>: Lista todas las transacciones con paginación.</li>
                                    <li><code>countAll()</code>: Cuenta el total de transacciones.</li>
                                </ul>
                            </li>
                            <li><strong><code>SubscriptionRepository.php</code>:</strong>
                                <ul>
                                    <li><code>save(SubscriptionsModel $subscription)</code>: Inserta una nueva suscripción. El <code>stripe_subscription_id</code> es la clave primaria lógica desde la perspectiva de Stripe, pero la tabla puede tener un <code>id</code> autoincremental local.</li>
                                    <li><code>update(SubscriptionsModel $subscription)</code>: Actualiza una suscripción existente, identificada por <code>stripe_subscription_id</code>.</li>
                                    <li><code>findByStripeSubscriptionId(string $stripeSubscriptionId)</code>: Busca una suscripción por su ID de Stripe.</li>
                                    <li><code>findAllByCustomerId(string $stripeCustomerId)</code>: Lista todas las suscripciones de un cliente.</li>
                                    <li><code>findAll(int $limit, int $offset)</code>: Lista todas las suscripciones con paginación.</li>
                                    <li><code>countAll()</code>: Cuenta el total de suscripciones.</li>
                                </ul>
                            </li>
                            <li><strong><code>InvoiceRepository.php</code>:</strong> (Si se implementara un almacenamiento local detallado de facturas, tendría métodos similares para guardar, actualizar y buscar facturas. En StripeLabApp, las "facturas" mostradas a menudo son las transacciones con `receipt_url`).</li>
                        </ul>
                    </li>
                    <li><strong>Manejo de IDs:</strong>
                        <ul>
                            <li>Para <code>TransactionsModel</code>, el <code>transaction_id</code> es un autoincremental de MySQL, gestionado por la base de datos al insertar.</li>
                            <li>Para <code>SubscriptionsModel</code>, el <code>stripe_subscription_id</code> (ej. <code>sub_...</code>) es el identificador principal desde la perspectiva de Stripe y se usa para buscar y actualizar. La tabla también tiene un <code>id</code> autoincremental local.</li>
                        </ul>
                    </li>
                    <li><strong>Uso de PDO:</strong> Internamente, los repositorios construyen y ejecutan sentencias SQL preparadas usando la instancia de PDO obtenida de <code>DatabaseConnection::getInstance()</code>. Manejan el binding de parámetros para prevenir inyecciones SQL.</li>
                </ul>
            </section>
            </section> <!-- Fin de sección 7 -->

            <hr class="my-4">

            <section id="parte2-seccion8" class="mb-4">
                <h3>8. Flujos de Datos Específicos en StripeLabApp</h3>
                <p>Comprender cómo fluyen los datos a través de los diferentes componentes de StripeLabApp es crucial para entender su funcionamiento. A continuación, se presentan diagramas de secuencia para los flujos más importantes.</p>

                <h4 id="parte2-seccion8-1">8.1. Flujo de Pago Único</h4>
                <p>Este diagrama ilustra el proceso completo desde que el usuario inicia un pago único hasta que la transacción se registra en la base de datos.</p>
                <div class="mermaid">
                    sequenceDiagram
                    participant User
                    participant FrontendJS as "Frontend JS (single-payment.php)"
                    participant CreateSessionEP as "create_payment_session.php"
                    participant CheckoutSvc as "StripeCheckoutSessionService"
                    participant StripeAPI as "Stripe API"
                    participant WebhookEP as "webhook.php"
                    participant WebhookCtrl as "StripeWebhookController"
                    participant WebhookSvc as "StripeWebhookService"
                    participant PIStrategy as "PaymentIntentSucceededStrategy"
                    participant EventMapper as "StripeEventMapper"
                    participant TransFactory as "TransactionFactory"
                    participant TransRepo as "TransactionRepository"
                    participant DB as "MySQL Database"

                    User->>FrontendJS: Clic en "Pagar Ahora"
                    FrontendJS->>CreateSessionEP: POST (priceId)
                    CreateSessionEP->>CheckoutSvc: createCheckoutSessionForSinglePayment(priceId)
                    CheckoutSvc->>StripeAPI: POST /v1/checkout/sessions
                    StripeAPI-->>CheckoutSvc: Checkout Session Object
                    CheckoutSvc-->>CreateSessionEP: { sessionId: 'cs_...' }
                    CreateSessionEP-->>FrontendJS: { sessionId: 'cs_...' }
                    FrontendJS->>StripeAPI: stripe.redirectToCheckout({ sessionId })
                    User->>StripeAPI: Completa Pago
                    StripeAPI-->>User: Redirige a success.html

                    StripeAPI-->>WebhookEP: Webhook: payment_intent.succeeded
                    WebhookEP->>WebhookCtrl: handleWebhook(request)
                    WebhookCtrl->>WebhookSvc: processWebhook(payload, signature)
                    WebhookSvc->>EventMapper: mapToDto(stripeEventObject)
                    EventMapper-->>WebhookSvc: StripeEventDTO
                    WebhookSvc->>PIStrategy: handle(eventDto)
                    PIStrategy->>TransFactory: createFromPaymentIntent(paymentIntentData)
                    TransFactory-->>PIStrategy: TransactionsModel
                    PIStrategy->>TransRepo: save(transactionsModel)
                    TransRepo->>DB: INSERT INTO transactions
                    DB-->>TransRepo: Éxito
                    TransRepo-->>PIStrategy: Éxito
                    PIStrategy-->>WebhookSvc: void
                    WebhookSvc-->>WebhookCtrl: void
                    WebhookCtrl-->>WebhookEP: HTTP 200 OK
                </div>
            </section>

            <section id="parte2-seccion8-2" class="mb-4">
                <h4 id="parte2-seccion8-2-title">8.2. Flujo de Nueva Suscripción</h4>
                <p>Este flujo es más complejo ya que involucra múltiples eventos de webhook para confirmar la creación de la suscripción y el primer pago.</p>
                <div class="mermaid">
                    sequenceDiagram
                    participant User
                    participant FrontendJS as "Frontend JS (subscriptions-payment.php)"
                    participant CreateSubSessionEP as "create_subscription_session.php"
                    participant CheckoutSvc as "StripeCheckoutSessionService"
                    participant StripeAPI as "Stripe API"
                    participant WebhookEP as "webhook.php"
                    participant WebhookCtrl as "StripeWebhookController"
                    participant WebhookSvc as "StripeWebhookService"
                    participant CSSStrategy as "CheckoutSessionCompletedStrategy"
                    participant SubCreatedStrategy as "SubscriptionCreatedStrategy"
                    participant InvPaidStrategy as "InvoicePaidStrategy"
                    participant SubMapperFact as "SubscriptionMapper/Factory"
                    participant InvMapperFact as "InvoiceMapper/TransactionFactory"
                    participant SubRepo as "SubscriptionRepository"
                    participant TransRepo as "TransactionRepository"
                    participant DB as "MySQL Database"

                    User->>FrontendJS: Clic en "Suscribirse"
                    FrontendJS->>CreateSubSessionEP: POST (priceId)
                    CreateSubSessionEP->>CheckoutSvc: createCheckoutSessionForSubscription(priceId)
                    CheckoutSvc->>StripeAPI: POST /v1/checkout/sessions
                    StripeAPI-->>CheckoutSvc: Checkout Session Object
                    CheckoutSvc-->>CreateSubSessionEP: { sessionId: 'cs_...' }
                    CreateSubSessionEP-->>FrontendJS: { sessionId: 'cs_...' }
                    FrontendJS->>StripeAPI: stripe.redirectToCheckout({ sessionId })
                    User->>StripeAPI: Completa Pago
                    StripeAPI-->>User: Redirige a success.html

                    StripeAPI-->>WebhookEP: Webhook: checkout.session.completed
                    WebhookEP->>WebhookCtrl: handleWebhook(request)
                    WebhookCtrl->>WebhookSvc: processWebhook(payload, signature)
                    WebhookSvc->>CSSStrategy: handle(eventDto_cs_completed)
                    CSSStrategy->>SubMapperFact: map/create (intención de suscripción)
                    SubMapperFact-->>CSSStrategy: SubscriptionsModel (estado inicial)
                    CSSStrategy->>SubRepo: saveOrUpdate(subscriptionModel)
                    SubRepo->>DB: INSERT/UPDATE subscriptions
                    DB-->>SubRepo: Éxito
                    Note right of WebhookEP: Otros eventos pueden seguir...

                    StripeAPI-->>WebhookEP: Webhook: customer.subscription.created
                    WebhookEP->>WebhookCtrl: handleWebhook(request)
                    WebhookCtrl->>WebhookSvc: processWebhook(payload, signature)
                    WebhookSvc->>SubCreatedStrategy: handle(eventDto_sub_created)
                    SubCreatedStrategy->>SubMapperFact: mapToDto/createFromDto
                    SubMapperFact-->>SubCreatedStrategy: SubscriptionsModel (estado 'active' o 'trialing')
                    SubCreatedStrategy->>SubRepo: saveOrUpdate(subscriptionModel)
                    SubRepo->>DB: UPDATE subscriptions
                    DB-->>SubRepo: Éxito

                    StripeAPI-->>WebhookEP: Webhook: invoice.paid (primera factura)
                    WebhookEP->>WebhookCtrl: handleWebhook(request)
                    WebhookCtrl->>WebhookSvc: processWebhook(payload, signature)
                    WebhookSvc->>InvPaidStrategy: handle(eventDto_inv_paid)
                    InvPaidStrategy->>InvMapperFact: mapToDto/createFromDto
                    InvMapperFact-->>InvPaidStrategy: TransactionsModel
                    InvPaidStrategy->>TransRepo: save(transactionModel)
                    TransRepo->>DB: INSERT INTO transactions
                    DB-->>TransRepo: Éxito
                    InvPaidStrategy->>SubRepo: updateSubscriptionPeriod(subscriptionId, periodData)
                    SubRepo->>DB: UPDATE subscriptions (current_period_start/end)
                    DB-->>SubRepo: Éxito
                </div>
            </section>

            <section id="parte2-seccion8-3" class="mb-4">
                <h4 id="parte2-seccion8-3-title">8.3. Flujo de Cancelación de Suscripción</h4>
                <p>Este diagrama muestra cómo un usuario cancela una suscripción a través de la interfaz de StripeLabApp.</p>
                <div class="mermaid">
                    sequenceDiagram
                    participant User
                    participant FrontendJS as "Frontend JS (view-subscriptions.php)"
                    participant ManageSubEP as "api-manage-subscription.php"
                    participant SubMgmtCtrl as "StripeSubscriptionManagementController"
                    participant SubMgmtSvc as "StripeSubscriptionManagementService"
                    participant StripeAPI as "Stripe API"
                    participant WebhookEP as "webhook.php"
                    participant WebhookCtrl as "StripeWebhookController"
                    participant WebhookSvc as "StripeWebhookService"
                    participant SubUpdatedStrategy as "SubscriptionUpdatedStrategy"
                    participant SubDeletedStrategy as "SubscriptionDeletedStrategy"
                    participant SubMapperFact as "SubscriptionMapper/Factory"
                    participant SubRepo as "SubscriptionRepository"
                    participant DB as "MySQL Database"

                    User->>FrontendJS: Clic en "Cancelar Suscripción" (subscriptionId, immediate=true/false)
                    FrontendJS->>ManageSubEP: POST (action='cancel', subscriptionId, immediate)
                    ManageSubEP->>SubMgmtCtrl: handleRequest()
                    SubMgmtCtrl->>SubMgmtSvc: cancelSubscription(subscriptionId, immediate)
                    alt Cancelación Inmediata
                    SubMgmtSvc->>StripeAPI: POST /v1/subscriptions/{subId}/cancel
                    else Cancelación al Final del Período
                    SubMgmtSvc->>StripeAPI: POST /v1/subscriptions/{subId} (body: {cancel_at_period_end: true})
                    end
                    StripeAPI-->>SubMgmtSvc: Subscription Object (updated)
                    SubMgmtSvc-->>SubMgmtCtrl: Success/Failure
                    SubMgmtCtrl-->>ManageSubEP: JSON Response
                    ManageSubEP-->>FrontendJS: JSON Response (actualizar UI)

                    StripeAPI-->>WebhookEP: Webhook: customer.subscription.updated OR customer.subscription.deleted
                    WebhookEP->>WebhookCtrl: handleWebhook(request)
                    WebhookCtrl->>WebhookSvc: processWebhook(payload, signature)
                    alt Si fue customer.subscription.updated (cancel_at_period_end=true)
                    WebhookSvc->>SubUpdatedStrategy: handle(eventDto_sub_updated)
                    SubUpdatedStrategy->>SubMapperFact: map/create
                    SubMapperFact-->>SubUpdatedStrategy: SubscriptionsModel
                    SubUpdatedStrategy->>SubRepo: update(subscriptionModel)
                    SubRepo->>DB: UPDATE subscriptions (status, cancel_at_period_end)
                    else Si fue customer.subscription.deleted (cancelación inmediata o fin de período)
                    WebhookSvc->>SubDeletedStrategy: handle(eventDto_sub_deleted)
                    SubDeletedStrategy->>SubRepo: updateStatusToCanceled(subscriptionId, ended_at)
                    SubRepo->>DB: UPDATE subscriptions (status='canceled', ended_at)
                    end
                    DB-->>SubRepo: Éxito
                </div>
            </section> <!-- Fin de sección 8 -->

            <hr class="my-4">

            <section id="parte2-seccion9" class="mb-4">
                <h3>9. Visualización de Datos en StripeLabApp</h3>
                <p>StripeLabApp proporciona interfaces sencillas para que un usuario (simulado, ya que no hay un sistema de autenticación de usuarios real) pueda ver las transacciones (facturas/recibos) y suscripciones que se han registrado en la base de datos local.</p>

                <h4 id="parte2-seccion9-1">9.1. Página de Facturas/Recibos (`invoices.php`)</h4>
                <p>Esta página muestra una lista de todas las transacciones registradas en la tabla <code>transactions</code> de la base de datos local.</p>
                <ul>
                    <li><strong>Obtención de Datos:</strong>
                        <ul>
                            <li>Al cargar la página, JavaScript realiza una solicitud AJAX (<code>fetch</code>) al endpoint <code>public/v1/api/api-invoices.php</code>.</li>
                            <li>Por defecto, se solicita una lista paginada de todas las transacciones del sistema (<code>action=list_all</code>).</li>
                            <li>La página también podría tener (o se podría implementar) un filtro para ver transacciones de un <code>stripe_customer_id</code> específico si se introduce uno (<code>action=list_customer&customer_id=cus_...</code>), aunque el ejemplo principal es <code>list_all</code>.</li>
                        </ul>
                    </li>
                    <li><strong>Información Clave Mostrada por Transacción:</strong>
                        <ul>
                            <li><strong>ID Documento:</strong> El <code>stripe_transaction_id</code> (ej. <code>pi_...</code> o <code>ch_...</code>).</li>
                            <li><strong>ID Cliente Stripe:</strong> El <code>stripe_customer_id</code> asociado, si existe.</li>
                            <li><strong>Email Cliente:</strong> El email del cliente (obtenido de <code>billing_details</code> o del objeto Customer si estuviera disponible y se guardara). En StripeLabApp, este puede ser un placeholder o el email de la sesión de Checkout.</li>
                            <li><strong>Fecha:</strong> La fecha de creación de la transacción.</li>
                            <li><strong>Importe:</strong> Monto y moneda de la transacción.</li>
                            <li><strong>Tipo:</strong> Tipo de transacción (<code>Pago Único</code>, <code>Suscripción</code>) según el <code>TransactionTypeEnum</code>.</li>
                            <li><strong>Estado:</strong> Estado del pago (<code>Pagado</code>, <code>Fallido</code>, etc.) según el <code>PaymentStatusEnum</code>.</li>
                            <li><strong>Enlace al Documento:</strong> Si la <code>receipt_url</code> (para Charges) o <code>hosted_invoice_url</code> (para Invoices, si se guardara este dato en la transacción) está disponible, se muestra un enlace para ver el recibo/factura en Stripe.</li>
                        </ul>
                    </li>
                    <li><strong>Funcionalidad de Paginación:</strong>
                        <ul>
                            <li>El endpoint <code>api-invoices.php</code> soporta parámetros de paginación (<code>page</code>, <code>limit</code>).</li>
                            <li>El frontend incluye controles de "Anterior" y "Siguiente" que realizan nuevas solicitudes AJAX con el número de página correspondiente para cargar el siguiente conjunto de resultados.</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section id="parte2-seccion9-2" class="mb-4">
                <h4 id="parte2-seccion9-2-title">9.2. Página de Suscripciones (`view-subscriptions.php`)</h4>
                <p>Esta página permite visualizar y gestionar (de forma básica) las suscripciones registradas en la tabla <code>subscriptions</code>.</p>
                <ul>
                    <li><strong>Obtención de Datos:</strong>
                        <ul>
                            <li>La página puede tener pestañas o filtros para diferentes vistas:
                                <ul>
                                    <li><strong>"Todas las Suscripciones del Sistema":</strong> Realiza una solicitud AJAX a <code>public/v1/api/api-subscriptions.php?action=list_all_system</code> para obtener todas las suscripciones con paginación.</li>
                                    <li><strong>"Suscripciones por Cliente":</strong> Permite introducir un <code>stripe_customer_id</code> y luego llama a <code>public/v1/api/api-subscriptions.php?action=list_customer&customer_id=cus_...</code>.</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li><strong>Información Clave Mostrada por Suscripción:</strong>
                        <ul>
                            <li><strong>ID Suscripción Stripe:</strong> El <code>stripe_subscription_id</code>.</li>
                            <li><strong>ID Cliente Stripe:</strong> El <code>stripe_customer_id</code>.</li>
                            <li><strong>Email Cliente:</strong> (Similar a facturas, depende de cómo se obtenga y guarde).</li>
                            <li><strong>ID Plan/Precio:</strong> El <code>stripe_price_id</code>.</li>
                            <li><strong>Estado:</strong> El estado actual de la suscripción (<code>active</code>, <code>canceled</code>, <code>past_due</code>, etc.) según <code>SubscriptionStatusEnum</code>.</li>
                            <li><strong>Fecha Inicio Período:</strong> <code>current_period_start</code>.</li>
                            <li><strong>Fecha Fin Período:</strong> <code>current_period_end</code>.</li>
                            <li><strong>Cancelar al Final del Período:</strong> Indicador si <code>cancel_at_period_end</code> es true.</li>
                            <li><strong>Acciones:</strong> Botones para "Cancelar Suscripción" o "Reactivar Suscripción".</li>
                        </ul>
                    </li>
                    <li><strong>Funcionalidad de Gestión (Cancelación/Reactivación):</strong>
                        <ul>
                            <li>Al hacer clic en "Cancelar Suscripción", JavaScript realiza una solicitud AJAX (<code>fetch</code>) al endpoint <code>public/v1/api/api-manage-subscription.php</code>.</li>
                            <li>Se envía <code>action=cancel</code>, el <code>subscription_id</code> y un parámetro opcional para indicar si la cancelación es inmediata o al final del período.</li>
                            <li>El backend (<code>StripeSubscriptionManagementController</code> y <code>Service</code>) interactúa con la API de Stripe.</li>
                            <li>Los webhooks (<code>customer.subscription.updated</code> o <code>.deleted</code>) actualizan el estado en la base de datos, y la UI se refresca para reflejar el cambio.</li>
                            <li>La reactivación sigue un flujo similar con <code>action=reactivate</code>.</li>
                        </ul>
                    </li>
                </ul>
            </section> <!-- Fin de sección 9 y PARTE II -->

            <hr class="my-5">

            <!-- ============================================================================== -->
            <!-- PARTE III: Propuesta para la integración con ILIAS                           -->
            <!-- ============================================================================== -->
            <section id="parte3" class="mb-5">
                <h2>PARTE III: Propuesta para la Integración con ILIAS</h2>
                <hr>
                <p><em>Esta sección describe una propuesta conceptual para integrar StripeLabApp, o una funcionalidad similar de gestión de pagos y suscripciones con Stripe, dentro del Learning Management System (LMS) ILIAS. El contenido detallado de estas subsecciones se desarrollará en el futuro.</em></p>

                <section id="parte3-seccion10" class="mb-4">
                    <h3>10. Conceptos de Integración: StripeLabApp e ILIAS</h3>
                    <p class="text-muted">Contenido a desarrollar en el futuro...</p>
                    <ul>
                        <li>10.1. Objetivos de la Integración (ej. venta de cursos, suscripciones a categorías, acceso premium).</li>
                        <li>10.2. Identificación de Puntos de Contacto en ILIAS (ej. compra desde el Repositorio, perfiles de usuario).</li>
                        <li>10.3. Mapeo de Usuarios Stripe (Customers) a Usuarios ILIAS.</li>
                    </ul>
                </section>

                <section id="parte3-seccion11" class="mb-4">
                    <h3>11. Estrategias de Integración (Propuestas)</h3>
                    <p class="text-muted">Contenido a desarrollar en el futuro...</p>
                    <ul>
                        <li>11.1. Integración mediante Plugins de ILIAS.
                            <ul>
                                <li>11.1.1. Plugin de Servicio (Service Hook) para lógica de negocio.</li>
                                <li>11.1.2. Plugin de UI (UI Hook) para añadir botones/interfaces de compra.</li>
                            </ul>
                        </li>
                        <li>11.2. Sincronización de Estados de Acceso Basada en Webhooks.</li>
                        <li>11.3. Uso de Metadatos de Stripe para enlazar con Objetos de ILIAS.</li>
                    </ul>
                </section>

                <section id="parte3-seccion12" class="mb-4">
                    <h3>12. Modificaciones Necesarias en StripeLabApp para la Integración con ILIAS (Ejemplos)</h3>
                    <p class="text-muted">Contenido a desarrollar en el futuro...</p>
                    <ul>
                        <li>12.1. Adaptación de Servicios para interactuar con APIs de ILIAS (ej. gestión de roles/membresías).</li>
                        <li>12.2. Extensión de Estrategias de Webhook para disparar acciones en ILIAS.</li>
                        <li>12.3. Gestión de la configuración específica de ILIAS (ej. IDs de cursos/objetos mapeados a Productos/Precios de Stripe).</li>
                    </ul>
                </section>

                <section id="parte3-seccion13" class="mb-4">
                    <h3>13. Modificaciones Necesarias en ILIAS para la Integración</h3>
                    <p class="text-muted">Contenido a desarrollar en el futuro...</p>
                    <ul>
                        <li>13.1. Desarrollo de los Plugins mencionados (Servicio, UI).</li>
                        <li>13.2. Posibles ajustes en el sistema de roles y permisos de ILIAS.</li>
                        <li>13.3. Creación de interfaces administrativas en ILIAS para gestionar la configuración de Stripe y ver transacciones.</li>
                    </ul>
                </section>

                <section id="parte3-seccion14" class="mb-4">
                    <h3>14. Consideraciones de Seguridad para la Integración</h3>
                    <p class="text-muted">Contenido a desarrollar en el futuro...</p>
                    <ul>
                        <li>14.1. Protección de Claves API de Stripe en el entorno ILIAS.</li>
                        <li>14.2. Seguridad del Endpoint de Webhook dentro de ILIAS.</li>
                        <li>14.3. Manejo seguro de datos de usuario entre Stripe e ILIAS.</li>
                        <li>14.4. Cumplimiento normativo (GDPR, PCI DSS si se manejan datos de tarjeta directamente, aunque Stripe lo simplifica).</li>
                    </ul>
                </section>

            </section> <!-- Fin de PARTE III -->

        </main>
    </div>
</div>

<!-- Bootstrap 5 JS Bundle (Popper.js anidado) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<!-- Mermaid JS -->
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true, theme: 'base', themeVariables: {
            'primaryColor': '#F8F9FA', // Un fondo más claro para los nodos
            'primaryTextColor': '#333',
            'lineColor': '#666',
            'textColor': '#333',
            'fontSize': '13px',
            'actorBkg': '#FFF',
            'actorBorder': '#00D4B1',
            'actorTextColor': 'black',
            'sequenceNUMBERColor': 'black'
        } });
</script>
<script>
    // Script para activar el enlace del sidebar según el scroll (opcional, pero mejora la UX)
    const sidebarLinks = document.querySelectorAll('#sidebarMenu .nav-link');
    const mainContentSections = document.querySelectorAll('main section[id^="parte"]');
    const allNavLinks = document.querySelectorAll('#sidebarMenu .nav-link');

    function updateActiveLink() {
        let currentSectionId = '';
        const scrollPosition = window.pageYOffset;

        mainContentSections.forEach(section => {
            const sectionTop = section.offsetTop - 70;
            if (scrollPosition >= sectionTop) {
                currentSectionId = section.getAttribute('id');
            }
        });

        if (scrollPosition < 200 && !currentSectionId) {
            currentSectionId = "parte1";
        }

        allNavLinks.forEach(link => {
            const linkHref = link.getAttribute('href').substring(1);
            const parentLi = link.closest('li.nav-item');
            const parentUl = link.closest('ul.nav.flex-column.ms-3');
            const mainParentLink = parentUl ? parentUl.previousElementSibling : (parentLi ? link : null);

            link.classList.remove('active');
            if (mainParentLink && mainParentLink.classList.contains('nav-link')) {
                mainParentLink.classList.remove('active');
            }

            if (currentSectionId && mainParentLink && mainParentLink.getAttribute('href').substring(1).startsWith(currentSectionId.split('-seccion')[0])) { // Activa el padre de la parte
                mainParentLink.classList.add('active');
            }

            let specificSectionVisible = '';
            document.querySelectorAll('main h3[id], main h4[id]').forEach(subSectionHeading => {
                const sectionTop = subSectionHeading.offsetTop - 150;
                const sectionHeight = subSectionHeading.parentElement.clientHeight; // Height of parent section
                if (scrollPosition >= sectionTop && scrollPosition < (sectionTop + sectionHeight)) {
                    specificSectionVisible = subSectionHeading.getAttribute('id');
                }
            });

            if (linkHref === specificSectionVisible) {
                link.classList.add('active');
                if (mainParentLink && mainParentLink.classList.contains('nav-link')) {
                    mainParentLink.classList.add('active');
                }
            }
        });

        const anyActive = document.querySelector('#sidebarMenu .nav-link.active');
        if (!anyActive) {
            const firstPartLink = document.querySelector('#sidebarMenu a.nav-link[href="#parte1"]');
            if (firstPartLink) {
                firstPartLink.classList.add('active');
            }
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    window.addEventListener('load', updateActiveLink);
</script>
</body>
</html>